var worker=function(e){"use strict";function t(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function s(e,t){return e(t={exports:{}},t.exports),t.exports}var r=s((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var s=[];function r(e){return s[e]||(s[e]=function(e){for(var t="return function dispatcher"+e+"(payload) {\n",s=[],r=[],i=0;i<e;i++)s.push("cb"+i),r.push("ctx"+i),t+="    cb"+i+"(payload, ctx"+i+");\n";return t+="};",new(Function.bind.apply(Function,[void 0].concat(s.concat(r),[t])))}(e)),s[e]}s[0]=function(){return function(){}},s[1]=function(e,t){return void 0===t?e:function(s){e(s,t)}};var i=function(){function e(){this.hasHandlers=!1,this._handlers=[],this._contexts=[],this._createDispatcher()}return e.prototype.addHandler=function(e,t){return this.isHandlerAttached(e,t)||(this._handlers.push(e),this._contexts.push(t),this._createDispatcher(),this._updateHasHandlers()),this},e.prototype.removeHandler=function(e,t){var s=this._getHandlerIndex(e,t);return void 0!==s&&(this._handlers.splice(s,1),this._contexts.splice(s,1),this._createDispatcher(),this._updateHasHandlers()),this},e.prototype.isHandlerAttached=function(e,t){return void 0!==this._getHandlerIndex(e,t)},e.prototype._updateHasHandlers=function(){this.hasHandlers=!!this._handlers.length},e.prototype._getHandlerIndex=function(e,t){var s,r=this._handlers.length;for(s=0;s<r&&(this._handlers[s]!==e||this._contexts[s]!==t);s++);return s<r?s:void 0},e.prototype._createDispatcher=function(){this.dispatch=r(this._handlers.length).apply(this,this._handlers.concat(this._contexts))},e}();t.default=i}));t(r);var i=s((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Event=r.default}));t(i);var n=i.Event,a=s((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){void 0===t&&(t=0),this._dispatch=e,this._rpcTimeout=t,this.error=new i.Event,this._rpcHandlers={},this._signalHandlers={},this._pendingTransactions={},this._nextTransactionId=0}return e.prototype.dispatch=function(t){var s=t;switch(s.type){case e.MessageType.signal:return this._handleSignal(s);case e.MessageType.rpc:return this._handeRpc(s);case e.MessageType.internal:return this._handleInternal(s);default:this._raiseError("invalid message type "+s.type)}},e.prototype.rpc=function(t,s,r){var i=this,n=this._nextTransactionId++;return this._dispatch({type:e.MessageType.rpc,transactionId:n,id:t,payload:s},r||void 0),new Promise((function(e,t){var s=i._pendingTransactions[n]={id:n,resolve:e,reject:t};i._rpcTimeout>0&&(i._pendingTransactions[n].timeoutHandle=setTimeout((function(){return i._transactionTimeout(s)}),i._rpcTimeout))}))},e.prototype.signal=function(t,s,r){return this._dispatch({type:e.MessageType.signal,id:t,payload:s},r||void 0),this},e.prototype.registerRpcHandler=function(e,t){if(this._rpcHandlers[e])throw new Error("rpc handler for "+e+" already registered");return this._rpcHandlers[e]=t,this},e.prototype.registerSignalHandler=function(e,t){return this._signalHandlers[e]||(this._signalHandlers[e]=[]),this._signalHandlers[e].push(t),this},e.prototype.deregisterRpcHandler=function(e,t){return this._rpcHandlers[e]&&delete this._rpcHandlers[e],this},e.prototype.deregisterSignalHandler=function(e,t){return this._signalHandlers[e]&&(this._signalHandlers[e]=this._signalHandlers[e].filter((function(e){return t!==e}))),this},e.prototype._raiseError=function(t){this.error.dispatch(new Error(t)),this._dispatch({type:e.MessageType.internal,id:"error",payload:t})},e.prototype._handleSignal=function(e){if(!this._signalHandlers[e.id])return this._raiseError("invalid signal "+e.id);this._signalHandlers[e.id].forEach((function(t){return t(e.payload)}))},e.prototype._handeRpc=function(t){var s=this;if(!this._rpcHandlers[t.id])return this._raiseError("invalid rpc "+t.id);Promise.resolve(this._rpcHandlers[t.id](t.payload)).then((function(r){return s._dispatch({type:e.MessageType.internal,id:"resolve_transaction",transactionId:t.transactionId,payload:r})}),(function(r){return s._dispatch({type:e.MessageType.internal,id:"reject_transaction",transactionId:t.transactionId,payload:r})}))},e.prototype._handleInternal=function(e){var t=void 0!==e.transactionId?this._pendingTransactions[e.transactionId]:void 0;switch(e.id){case"resolve_transaction":if(!t||void 0===e.transactionId)return this._raiseError("no pending transaction with id "+e.transactionId);t.resolve(e.payload),this._clearTransaction(this._pendingTransactions[e.transactionId]);break;case"reject_transaction":if(!t||void 0===e.transactionId)return this._raiseError("no pending transaction with id "+e.transactionId);this._pendingTransactions[e.transactionId].reject(e.payload),this._clearTransaction(this._pendingTransactions[e.transactionId]);break;case"error":this.error.dispatch(new Error("remote error: "+e.payload));break;default:this._raiseError("unhandled internal message "+e.id)}},e.prototype._transactionTimeout=function(e){e.reject("transaction timed out"),this._raiseError("transaction "+e.id+" timed out"),delete this._pendingTransactions[e.id]},e.prototype._clearTransaction=function(e){void 0!==e.timeoutHandle&&clearTimeout(e.timeoutHandle),delete this._pendingTransactions[e.id]},e}();!function(e){!function(e){e[e.signal=0]="signal",e[e.rpc=1]="rpc",e[e.internal=2]="internal"}(e.MessageType||(e.MessageType={}))}(s||(s={})),t.default=s}));t(a);var o=s((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.RpcProvider=a.default}));t(o);var h=o.RpcProvider;let l=null,c=null,d=null;l=new h((function(e,t){c?c.postMessage(e,t):postMessage(e,t),d&&(c=d,c.onmessage=e=>l.dispatch(e.data)),d=null})),l.error.addHandler(e=>{console.log(e?e.message:"unknown rpc error")}),onmessage=e=>c||l.dispatch(e.data),l.registerRpcHandler("/use-port",e=>c||d?Promise.reject("RPC already switched to message port"):(d=e,Promise.resolve()));class p{constructor(){this._height=0,this._width=0,this._buffer=null}static createFromArrayBuffer(e,t,s){return(new p).replaceUnderlyingBuffer(e,t,s)}replaceUnderlyingBuffer(e,t,s){if(e*t*4!==s.byteLength)throw new Error("surface size mismatch");return this._width=e,this._height=t,this._underlyingBuffer=s,this._buffer=new Uint32Array(this._underlyingBuffer),this}getUnderlyingBuffer(){return this._underlyingBuffer}resetUnderlyingBuffer(){return this._width=this._height=0,this._underlyingBuffer=this._buffer=null,this}getWidth(){return this._width}getHeight(){return this._height}getBuffer(){return this._buffer}getByteOrder(){return 0}fill(e){for(let t=0;t<this._buffer.length;t++)this._buffer[t]=e;return this}}class u{constructor(e,t,s){this._value=e,this._releaseCB=t,this._disposeCB=s,this._isAvailable=!1,this._isDisposed=!1}adopt(e){this._value=e}get(){return this._value}release(){this._releaseCB(this)}dispose(){this._disposeCB(this)}}class _{constructor(e){this._factory=e,this.event={release:new n,dispose:new n},this._pool=[],this._poolSize=0}get(){let e;if(0===this._poolSize){const t=this._factory();e=new u(t,e=>this._releaseMember(e),e=>this._disposeMember(e))}else e=this._pool[--this._poolSize],e._isAvailable=!1;return e}_releaseMember(e){if(e._isAvailable)throw new Error("Trying to release an already released pool member");if(e._isDisposed)throw new Error("Trying to release an already disposed pool member");const t=this._poolSize++;this._pool[t]=e,e._isAvailable=!0,e._poolPosition=t,this.event.release.dispatch(e.get())}_disposeMember(e){if(e._isDisposed)throw new Error("Trying to dispose of an already disposed pool member");e._isAvailable&&(this._poolSize>1&&(this._pool[e._poolPosition]=this._pool[this._poolSize-1]),this._poolSize--),e._isDisposed=!0,this.event.dispose.dispatch(e.get())}}const f={configure:"pipeline/configure",flush:"pipeline/flush",process:"pipeline/process",emit:"pipeline/emit",release:"pipeline/release"};Object.freeze(f);class g{constructor(){this.emit=new n}init(){}flush(){}processSurface(e){this.emit.dispatch(e)}}class y{constructor(){this.emit=new n,this._framesOnHold=new Array(2),this._nFramesOnHold=0,this._width=0,this._height=0}init(e,t){this.flush(),this._width=e,this._height=t}flush(){for(let e=0;e<this._nFramesOnHold;e++)this._framesOnHold[e].release(),this._framesOnHold[e]=null;this._nFramesOnHold=0}processSurface(e){const t=e.get();if(t.getHeight()!==this._height||t.getWidth()!==this._width)throw new Error("surface dimensions do not match");this._framesOnHold[this._nFramesOnHold++]=e,2===this._nFramesOnHold&&this._process()}_process(){const e=this._framesOnHold[0].get().getBuffer(),t=this._framesOnHold[1].get().getBuffer();for(let s=0;s<this._width*this._height;s++)e[s]=4278190080|(16711680&e[s])+(16711680&t[s])>>>1&16711680|(65280&e[s])+(65280&t[s])>>>1&65280|(255&e[s])+(255&t[s])>>>1&255;this.emit.dispatch(this._framesOnHold[0]),this._framesOnHold[1].release(),this._nFramesOnHold=0}}class m{create(e){switch(e.type){case 0:return new g;case 1:return new y;default:throw new Error("cannot happen: invalid processor type")}}}class H{constructor(e){e&&0!==e.length||(e=[{type:0}]);const t=new m;this._processors=e.map(e=>t.create(e));for(let e=1;e<this._processors.length;e++)this._processors[e-1].emit.addHandler(t=>this._processors[e].processSurface(t));this.emit=this._processors[this._processors.length-1].emit}init(e,t){this._processors.forEach(s=>s.init(e,t))}flush(){this._processors.forEach(e=>e.flush())}processSurface(e){this._processors[0].processSurface(e)}}class v{constructor(e){this._rpc=e,this._pipeline=null,this._surfacePool=new _(()=>new p),this._bufferIds=new WeakMap,this._rpc.registerRpcHandler(f.configure,this._onConfigure.bind(this)).registerRpcHandler(f.flush,this._onFlush.bind(this)).registerSignalHandler(f.process,this._onProcess.bind(this)),this._surfacePool.event.release.addHandler(v._onReleaseSurface,this)}static _onReleaseSurface(e,t){const s=e.getUnderlyingBuffer();if(!s)return;if(!t._bufferIds.has(s))throw new Error("double release");const r=t._bufferIds.get(s);t._bufferIds.delete(s),t._rpc.signal(f.release,{id:r,buffer:s},[s])}static _onEmitSurface(e,t){const s=e.get().getUnderlyingBuffer();if(!t._bufferIds.has(s))throw new Error("double release");const r=t._bufferIds.get(s);t._bufferIds.delete(s),t._rpc.signal(f.emit,{id:r,buffer:s},[s]),e.get().resetUnderlyingBuffer(),e.release()}_onConfigure(e){this._pipeline&&(this._pipeline.flush(),this._pipeline.emit.removeHandler(v._onEmitSurface,this)),this._pipeline=new H(e.config),this._pipeline.init(e.width,e.height),this._pipeline.emit.addHandler(v._onEmitSurface,this)}_onFlush(e){this._pipeline&&this._pipeline.flush()}_onProcess(e){if(!this._pipeline)return;this._bufferIds.set(e.buffer,e.id);const t=this._surfacePool.get();t.get().replaceUnderlyingBuffer(e.width,e.height,e.buffer),this._pipeline.processSurface(t)}}const w=new v(l);return e.pipelineHost=w,e}({});
//# sourceMappingURL=video-pipeline.min.js.map

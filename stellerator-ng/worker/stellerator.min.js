!function(){"use strict";var commonjsGlobal="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function unwrapExports(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function createCommonjsModule(e,t){return e(t={exports:{}},t.exports),t.exports}var Event_1=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var s=[];function i(e){return s[e]||(s[e]=function(e){for(var t="return function dispatcher"+e+"(payload) {\n",s=[],i=[],r=0;r<e;r++)s.push("cb"+r),i.push("ctx"+r),t+="    cb"+r+"(payload, ctx"+r+");\n";return t+="};",new(Function.bind.apply(Function,[void 0].concat(s.concat(i),[t])))}(e)),s[e]}s[0]=function(){return function(){}},s[1]=function(e,t){return void 0===t?e:function(s){e(s,t)}};var r=function(){function e(){this.hasHandlers=!1,this._handlers=[],this._contexts=[],this._createDispatcher()}return e.prototype.addHandler=function(e,t){return this.isHandlerAttached(e,t)||(this._handlers.push(e),this._contexts.push(t),this._createDispatcher(),this._updateHasHandlers()),this},e.prototype.removeHandler=function(e,t){var s=this._getHandlerIndex(e,t);return void 0!==s&&(this._handlers.splice(s,1),this._contexts.splice(s,1),this._createDispatcher(),this._updateHasHandlers()),this},e.prototype.isHandlerAttached=function(e,t){return void 0!==this._getHandlerIndex(e,t)},e.prototype._updateHasHandlers=function(){this.hasHandlers=!!this._handlers.length},e.prototype._getHandlerIndex=function(e,t){var s,i=this._handlers.length;for(s=0;s<i&&(this._handlers[s]!==e||this._contexts[s]!==t);s++);return s<i?s:void 0},e.prototype._createDispatcher=function(){this.dispatch=i(this._handlers.length).apply(this,this._handlers.concat(this._contexts))},e}();t.default=r}));unwrapExports(Event_1);var lib=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Event=Event_1.default}));unwrapExports(lib);var lib_1=lib.Event,RpcProvider_1=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){void 0===t&&(t=0),this._dispatch=e,this._rpcTimeout=t,this.error=new lib.Event,this._rpcHandlers={},this._signalHandlers={},this._pendingTransactions={},this._nextTransactionId=0}return e.prototype.dispatch=function(t){var s=t;switch(s.type){case e.MessageType.signal:return this._handleSignal(s);case e.MessageType.rpc:return this._handeRpc(s);case e.MessageType.internal:return this._handleInternal(s);default:this._raiseError("invalid message type "+s.type)}},e.prototype.rpc=function(t,s,i){var r=this,a=this._nextTransactionId++;return this._dispatch({type:e.MessageType.rpc,transactionId:a,id:t,payload:s},i||void 0),new Promise((function(e,t){var s=r._pendingTransactions[a]={id:a,resolve:e,reject:t};r._rpcTimeout>0&&(r._pendingTransactions[a].timeoutHandle=setTimeout((function(){return r._transactionTimeout(s)}),r._rpcTimeout))}))},e.prototype.signal=function(t,s,i){return this._dispatch({type:e.MessageType.signal,id:t,payload:s},i||void 0),this},e.prototype.registerRpcHandler=function(e,t){if(this._rpcHandlers[e])throw new Error("rpc handler for "+e+" already registered");return this._rpcHandlers[e]=t,this},e.prototype.registerSignalHandler=function(e,t){return this._signalHandlers[e]||(this._signalHandlers[e]=[]),this._signalHandlers[e].push(t),this},e.prototype.deregisterRpcHandler=function(e,t){return this._rpcHandlers[e]&&delete this._rpcHandlers[e],this},e.prototype.deregisterSignalHandler=function(e,t){return this._signalHandlers[e]&&(this._signalHandlers[e]=this._signalHandlers[e].filter((function(e){return t!==e}))),this},e.prototype._raiseError=function(t){this.error.dispatch(new Error(t)),this._dispatch({type:e.MessageType.internal,id:"error",payload:t})},e.prototype._handleSignal=function(e){if(!this._signalHandlers[e.id])return this._raiseError("invalid signal "+e.id);this._signalHandlers[e.id].forEach((function(t){return t(e.payload)}))},e.prototype._handeRpc=function(t){var s=this;if(!this._rpcHandlers[t.id])return this._raiseError("invalid rpc "+t.id);Promise.resolve(this._rpcHandlers[t.id](t.payload)).then((function(i){return s._dispatch({type:e.MessageType.internal,id:"resolve_transaction",transactionId:t.transactionId,payload:i})}),(function(i){return s._dispatch({type:e.MessageType.internal,id:"reject_transaction",transactionId:t.transactionId,payload:i})}))},e.prototype._handleInternal=function(e){var t=void 0!==e.transactionId?this._pendingTransactions[e.transactionId]:void 0;switch(e.id){case"resolve_transaction":if(!t||void 0===e.transactionId)return this._raiseError("no pending transaction with id "+e.transactionId);t.resolve(e.payload),this._clearTransaction(this._pendingTransactions[e.transactionId]);break;case"reject_transaction":if(!t||void 0===e.transactionId)return this._raiseError("no pending transaction with id "+e.transactionId);this._pendingTransactions[e.transactionId].reject(e.payload),this._clearTransaction(this._pendingTransactions[e.transactionId]);break;case"error":this.error.dispatch(new Error("remote error: "+e.payload));break;default:this._raiseError("unhandled internal message "+e.id)}},e.prototype._transactionTimeout=function(e){e.reject("transaction timed out"),this._raiseError("transaction "+e.id+" timed out"),delete this._pendingTransactions[e.id]},e.prototype._clearTransaction=function(e){void 0!==e.timeoutHandle&&clearTimeout(e.timeoutHandle),delete this._pendingTransactions[e.id]},e}();!function(e){!function(e){e[e.signal=0]="signal",e[e.rpc=1]="rpc",e[e.internal=2]="internal"}(e.MessageType||(e.MessageType={}))}(s||(s={})),t.default=s}));unwrapExports(RpcProvider_1);var lib$1=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.RpcProvider=RpcProvider_1.default}));unwrapExports(lib$1);var lib_1$1=lib$1.RpcProvider;let rpcProvider=null,port=null,portPending=null;function send(e,t){port?port.postMessage(e,t):postMessage(e,t),portPending&&(port=portPending,port.onmessage=e=>rpcProvider.dispatch(e.data)),portPending=null}function getRpc(){return rpcProvider}
/*! *****************************************************************************
	Copyright (c) Microsoft Corporation. All rights reserved.
	Licensed under the Apache License, Version 2.0 (the "License"); you may not use
	this file except in compliance with the License. You may obtain a copy of the
	License at http://www.apache.org/licenses/LICENSE-2.0

	THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
	KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
	WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
	MERCHANTABLITY OR NON-INFRINGEMENT.

	See the Apache Version 2.0 License for specific language governing permissions
	and limitations under the License.
	***************************************************************************** */rpcProvider=new lib_1$1(send),rpcProvider.error.addHandler(e=>{console.log(e?e.message:"unknown rpc error")}),onmessage=e=>port||rpcProvider.dispatch(e.data),rpcProvider.registerRpcHandler("/use-port",e=>port||portPending?Promise.reject("RPC already switched to message port"):(portPending=e,Promise.resolve()));var extendStatics=function(e,t){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var s in t)t.hasOwnProperty(s)&&(e[s]=t[s])})(e,t)};function __extends(e,t){function s(){this.constructor=e}extendStatics(e,t),e.prototype=null===t?Object.create(t):(s.prototype=t.prototype,new s)}var __assign=function(){return(__assign=Object.assign||function(e){for(var t,s=1,i=arguments.length;s<i;s++)for(var r in t=arguments[s])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)};function __rest(e,t){var s={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(s[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(s[i[r]]=e[i[r]])}return s}function __decorate(e,t,s,i){var r,a=arguments.length,n=a<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,s):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,s,i);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(n=(a<3?r(n):a>3?r(t,s,n):r(t,s))||n);return a>3&&n&&Object.defineProperty(t,s,n),n}function __param(e,t){return function(s,i){t(s,i,e)}}function __metadata(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function __awaiter(e,t,s,i){return new(s||(s=Promise))((function(r,a){function n(e){try{h(i.next(e))}catch(e){a(e)}}function o(e){try{h(i.throw(e))}catch(e){a(e)}}function h(e){e.done?r(e.value):new s((function(t){t(e.value)})).then(n,o)}h((i=i.apply(e,t||[])).next())}))}function __generator(e,t){var s,i,r,a,n={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return a={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function o(a){return function(o){return function(a){if(s)throw new TypeError("Generator is already executing.");for(;n;)try{if(s=1,i&&(r=2&a[0]?i.return:a[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,a[1])).done)return r;switch(i=0,r&&(a=[2&a[0],r.value]),a[0]){case 0:case 1:r=a;break;case 4:return n.label++,{value:a[1],done:!1};case 5:n.label++,i=a[1],a=[0];continue;case 7:a=n.ops.pop(),n.trys.pop();continue;default:if(!(r=(r=n.trys).length>0&&r[r.length-1])&&(6===a[0]||2===a[0])){n=0;continue}if(3===a[0]&&(!r||a[1]>r[0]&&a[1]<r[3])){n.label=a[1];break}if(6===a[0]&&n.label<r[1]){n.label=r[1],r=a;break}if(r&&n.label<r[2]){n.label=r[2],n.ops.push(a);break}r[2]&&n.ops.pop(),n.trys.pop();continue}a=t.call(e,n)}catch(e){a=[6,e],i=0}finally{s=r=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,o])}}}function __exportStar(e,t){for(var s in e)t.hasOwnProperty(s)||(t[s]=e[s])}function __values(e){var t="function"==typeof Symbol&&e[Symbol.iterator],s=0;return t?t.call(e):{next:function(){return e&&s>=e.length&&(e=void 0),{value:e&&e[s++],done:!e}}}}function __read(e,t){var s="function"==typeof Symbol&&e[Symbol.iterator];if(!s)return e;var i,r,a=s.call(e),n=[];try{for(;(void 0===t||t-- >0)&&!(i=a.next()).done;)n.push(i.value)}catch(e){r={error:e}}finally{try{i&&!i.done&&(s=a.return)&&s.call(a)}finally{if(r)throw r.error}}return n}function __spread(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(__read(arguments[t]));return e}function __spreadArrays(){for(var e=0,t=0,s=arguments.length;t<s;t++)e+=arguments[t].length;var i=Array(e),r=0;for(t=0;t<s;t++)for(var a=arguments[t],n=0,o=a.length;n<o;n++,r++)i[r]=a[n];return i}function __await(e){return this instanceof __await?(this.v=e,this):new __await(e)}function __asyncGenerator(e,t,s){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var i,r=s.apply(e,t||[]),a=[];return i={},n("next"),n("throw"),n("return"),i[Symbol.asyncIterator]=function(){return this},i;function n(e){r[e]&&(i[e]=function(t){return new Promise((function(s,i){a.push([e,t,s,i])>1||o(e,t)}))})}function o(e,t){try{(s=r[e](t)).value instanceof __await?Promise.resolve(s.value.v).then(h,c):u(a[0][2],s)}catch(e){u(a[0][3],e)}var s}function h(e){o("next",e)}function c(e){o("throw",e)}function u(e,t){e(t),a.shift(),a.length&&o(a[0][0],a[0][1])}}function __asyncDelegator(e){var t,s;return t={},i("next"),i("throw",(function(e){throw e})),i("return"),t[Symbol.iterator]=function(){return this},t;function i(i,r){t[i]=e[i]?function(t){return(s=!s)?{value:__await(e[i](t)),done:"return"===i}:r?r(t):t}:r}}function __asyncValues(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,s=e[Symbol.asyncIterator];return s?s.call(e):(e="function"==typeof __values?__values(e):e[Symbol.iterator](),t={},i("next"),i("throw"),i("return"),t[Symbol.asyncIterator]=function(){return this},t);function i(s){t[s]=e[s]&&function(t){return new Promise((function(i,r){(function(e,t,s,i){Promise.resolve(i).then((function(t){e({value:t,done:s})}),t)})(i,r,(t=e[s](t)).done,t.value)}))}}}function __makeTemplateObject(e,t){return Object.defineProperty?Object.defineProperty(e,"raw",{value:t}):e.raw=t,e}function __importStar(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t}function __importDefault(e){return e&&e.__esModule?e:{default:e}}var tslib_es6=Object.freeze({__proto__:null,__extends:__extends,get __assign(){return __assign},__rest:__rest,__decorate:__decorate,__param:__param,__metadata:__metadata,__awaiter:__awaiter,__generator:__generator,__exportStar:__exportStar,__values:__values,__read:__read,__spread:__spread,__spreadArrays:__spreadArrays,__await:__await,__asyncGenerator:__asyncGenerator,__asyncDelegator:__asyncDelegator,__asyncValues:__asyncValues,__makeTemplateObject:__makeTemplateObject,__importStar:__importStar,__importDefault:__importDefault}),EmulationServiceInterface,BoardInterface,CpuInterface;!function(e){let t;!function(e){e[e.stopped=0]="stopped",e[e.running=1]="running",e[e.paused=2]="paused",e[e.error=3]="error"}(t=e.State||(e.State={}))}(EmulationServiceInterface||(EmulationServiceInterface={}));class PoolMember{constructor(e,t,s){this._value=e,this._releaseCB=t,this._disposeCB=s,this._isAvailable=!1,this._isDisposed=!1}adopt(e){this._value=e}get(){return this._value}release(){this._releaseCB(this)}dispose(){this._disposeCB(this)}}class Pool{constructor(e){this._factory=e,this.event={release:new lib_1,dispose:new lib_1},this._pool=[],this._poolSize=0}get(){let e;if(0===this._poolSize){const t=this._factory();e=new PoolMember(t,e=>this._releaseMember(e),e=>this._disposeMember(e))}else e=this._pool[--this._poolSize],e._isAvailable=!1;return e}_releaseMember(e){if(e._isAvailable)throw new Error("Trying to release an already released pool member");if(e._isDisposed)throw new Error("Trying to release an already disposed pool member");const t=this._poolSize++;this._pool[t]=e,e._isAvailable=!0,e._poolPosition=t,this.event.release.dispatch(e.get())}_disposeMember(e){if(e._isDisposed)throw new Error("Trying to dispose of an already disposed pool member");e._isAvailable&&(this._poolSize>1&&(this._pool[e._poolPosition]=this._pool[this._poolSize-1]),this._poolSize--),e._isDisposed=!0,this.event.dispose.dispatch(e.get())}}class ArrayBufferSurface{constructor(){this._height=0,this._width=0,this._buffer=null}static createFromArrayBuffer(e,t,s){return(new ArrayBufferSurface).replaceUnderlyingBuffer(e,t,s)}replaceUnderlyingBuffer(e,t,s){if(e*t*4!==s.byteLength)throw new Error("surface size mismatch");return this._width=e,this._height=t,this._underlyingBuffer=s,this._buffer=new Uint32Array(this._underlyingBuffer),this}getUnderlyingBuffer(){return this._underlyingBuffer}resetUnderlyingBuffer(){return this._width=this._height=0,this._underlyingBuffer=this._buffer=null,this}getWidth(){return this._width}getHeight(){return this._height}getBuffer(){return this._buffer}getByteOrder(){return 0}fill(e){for(let t=0;t<this._buffer.length;t++)this._buffer[t]=e;return this}}class InducedMember{constructor(e,t,s){this._value=e,this._mapper=t,this._adopter=s}adopt(e){this._adopter(this._value,e)}get(){return this._mapper(this._value.get())}release(){this._value.release()}dispose(){this._value.dispose()}}class InducedPool{constructor(e,t=(()=>{throw new Error("adopt is not supported")})){this._mapper=e,this._adopter=t,this._map=new WeakMap}get(e){return this._map.has(e)||this._map.set(e,new InducedMember(e,this._mapper,this._adopter)),this._map.get(e)}}class PassthroughProcessor{constructor(){this.emit=new lib_1}init(){}flush(){}processSurface(e){this.emit.dispatch(e)}}class FrameMergeProcessor{constructor(){this.emit=new lib_1,this._framesOnHold=new Array(2),this._nFramesOnHold=0,this._width=0,this._height=0}init(e,t){this.flush(),this._width=e,this._height=t}flush(){for(let e=0;e<this._nFramesOnHold;e++)this._framesOnHold[e].release(),this._framesOnHold[e]=null;this._nFramesOnHold=0}processSurface(e){const t=e.get();if(t.getHeight()!==this._height||t.getWidth()!==this._width)throw new Error("surface dimensions do not match");this._framesOnHold[this._nFramesOnHold++]=e,2===this._nFramesOnHold&&this._process()}_process(){const e=this._framesOnHold[0].get().getBuffer(),t=this._framesOnHold[1].get().getBuffer();for(let s=0;s<this._width*this._height;s++)e[s]=4278190080|(16711680&e[s])+(16711680&t[s])>>>1&16711680|(65280&e[s])+(65280&t[s])>>>1&65280|(255&e[s])+(255&t[s])>>>1&255;this.emit.dispatch(this._framesOnHold[0]),this._framesOnHold[1].release(),this._nFramesOnHold=0}}class ProcessorFactory{create(e){switch(e.type){case 0:return new PassthroughProcessor;case 1:return new FrameMergeProcessor;default:throw new Error("cannot happen: invalid processor type")}}}class ProcessorPipeline{constructor(e){e&&0!==e.length||(e=[{type:0}]);const t=new ProcessorFactory;this._processors=e.map(e=>t.create(e));for(let e=1;e<this._processors.length;e++)this._processors[e-1].emit.addHandler(t=>this._processors[e].processSurface(t));this.emit=this._processors[this._processors.length-1].emit}init(e,t){this._processors.forEach(s=>s.init(e,t))}flush(){this._processors.forEach(e=>e.flush())}processSurface(e){this._processors[0].processSurface(e)}}class VideoEndpoint{constructor(e,t){this._video=e,this.newFrame=new lib_1,this._poolMembers=new WeakMap,this._surfaces=new WeakMap,this._surfacePool=new InducedPool(e=>this._surfaces.get(e)),this._videoProcessor=new ProcessorPipeline(t),this._videoProcessor.init(this._video.getWidth(),this._video.getHeight()),this._pool=new Pool(()=>new ImageData(this._video.getWidth(),this._video.getHeight())),this._video.setSurfaceFactory(()=>{const e=this._pool.get(),t=e.get();if(!this._surfaces.has(t)){const e=ArrayBufferSurface.createFromArrayBuffer(t.width,t.height,t.data.buffer);this._surfaces.set(t,e.fill(4278190080))}const s=this._surfaces.get(t);return this._poolMembers.set(s,e),s}),this._video.newFrame.addHandler(e=>this._videoProcessor.processSurface(this._surfacePool.get(this._poolMembers.get(e)))),this._videoProcessor.emit.addHandler(e=>this.newFrame.dispatch(this._poolMembers.get(e.get())))}getWidth(){return this._video.getWidth()}getHeight(){return this._video.getHeight()}}class AudioOutputBuffer{constructor(e,t){this._content=e,this._sampleRate=t}getLength(){return this._content.length}getContent(){return this._content}getSampleRate(){return this._sampleRate}replaceUnderlyingBuffer(e){this._content=e}}class PCMAudioEndpoint{constructor(e){this._output=e,this.newFrame=new lib_1,this.togglePause=new lib_1,this._audioBufferPool=new Pool(()=>new AudioOutputBuffer(new Float32Array(this.getFrameSize()),this.getSampleRate())),this._audioBufferMap=new WeakMap,this._pcmDataPool=new InducedPool(e=>e.getContent(),(e,t)=>e.get().replaceUnderlyingBuffer(t)),this._output.newFrame.addHandler(e=>this.newFrame.dispatch(this._pcmDataPool.get(this._audioBufferMap.get(e)))),this._output.togglePause.addHandler(e=>this.togglePause.dispatch(e)),this._output.setFrameBufferFactory(()=>{const e=this._audioBufferPool.get();return this._audioBufferMap.has(e.get())||this._audioBufferMap.set(e.get(),e),e.get()})}getSampleRate(){return this._output.getSampleRate()}getFrameSize(){return this._output.getFrameSize()}isPaused(){return this._output.isPaused()}}class EmulationContext{constructor(e,t){this._board=e,this._videoProcessing=t,this._videoEndpoint=null,this._audioEndpoint=null}getConfig(){return this._board.getConfig()}getVideo(){return this._videoEndpoint||(this._videoEndpoint=new VideoEndpoint(this._board.getVideoOutput(),this._videoProcessing)),this._videoEndpoint}getJoystick(e){switch(e){case 0:return this._board.getJoystick0();case 1:return this._board.getJoystick1();default:throw new Error(`invalid joystick index ${e}`)}}getControlPanel(){return this._board.getControlPanel()}getPaddle(e){if(e>=0&&e<4)return this._board.getPaddle(e);throw new Error(`invalid paddle index ${e}`)}getWaveformChannels(){return this._board.getWaveformChannels()}getPCMChannel(){return this._audioEndpoint||(this._audioEndpoint=new PCMAudioEndpoint(this._board.getPCMChannel())),this._audioEndpoint}getRawVideo(){if(this._videoEndpoint)throw new Error("video endpoint already initialized; raw video unavailable");return this._board.getVideoOutput()}}!function(e){e.TrapPayload=class{constructor(e,t,s){this.reason=e,this.board=t,this.message=s}}}(BoardInterface||(BoardInterface={}));class Bus{constructor(){this.event={trap:new lib_1,read:new lib_1,write:new lib_1},this._tia=null,this._pia=null,this._cartridge=null,this._lastDataBusValue=0,this._lastAddressBusValue=0}setTia(e){return e.trap.addHandler(e=>this.triggerTrap(0,"TIA: "+(e.message||""))),this._tia=e,this}setPia(e){return e.trap.addHandler(e=>this.triggerTrap(1,"PIA: "+(e.message||""))),this._pia=e,this}setCartridge(e){return e.trap.addHandler(e=>this.triggerTrap(2,"CARTRIDGE: "+(e.message||""))),this._cartridge=e,this}readWord(e){return this.read(e)|this.read(e+1&65535)<<8}read(e){return this._lastAddressBusValue=e,4096&(e&=8191)?(this._lastDataBusValue=this._cartridge.read(e),this.event.read.dispatch(2)):128&e?(this._lastDataBusValue=this._pia.read(e),this.event.read.dispatch(1)):(this._lastDataBusValue=this._tia.read(e),this.event.read.dispatch(0)),this._lastDataBusValue}write(e,t){this._lastDataBusValue=t,this._lastAddressBusValue=e,4096&(e&=8191)?(this._cartridge.write(e,t),this.event.write.dispatch(2)):128&e?(this._pia.write(e,t),this.event.write.dispatch(1)):(this._tia.write(e,t),this.event.write.dispatch(0))}peek(e){return 4096&(e&=8191)?this._cartridge.peek(e):128&e?this._pia.peek(e):this._tia.peek(e)}poke(e,t){}getLastDataBusValue(){return this._lastDataBusValue}getLastAddresBusValue(){return this._lastAddressBusValue}triggerTrap(e,t){if(!this.event.trap.hasHandlers)throw new Error(t);this.event.trap.dispatch(new Bus.TrapPayload(e,this,t))}}!function(e){e.TrapPayload=class{constructor(e,t,s){this.reason=e,this.bus=t,this.message=s}}}(Bus||(Bus={}));class Pia{constructor(e,t,s,i){this._controlPanel=e,this._joystick0=t,this._joystick1=s,this._rng=i,this.trap=new lib_1,this.ram=new Uint8Array(128),this._bus=null,this._timerValue=255,this._subTimer=0,this._timerDivide=1024,this._interruptFlag=0,this._timerWrapped=!1,this._flagSetDuringThisCycle=!1,this.reset()}reset(){for(let e=0;e<128;e++)this.ram[e]=this._rng?this._rng.int(255):0;this._interruptFlag=0,this._flagSetDuringThisCycle=!1,this._timerDivide=1024,this._subTimer=0,this._rng.int(255),this._timerValue=0,this._timerWrapped=!1}read(e){return 512&e?4&e?this._readTimer(e):this._readIo(e):this.ram[127&e]}peek(e){return 512&e?4&e?this._peekTimer(e):this._readIo(e):this.ram[127&e]}write(e,t){if(512&e)return 4&e?this._writeTimer(e,t):this._writeIo(e,t);this.ram[127&e]=t}cycle(){this._cycleTimer()}getDebugState(){return`divider: ${this._timerDivide} raw timer: INTIM: ${this._timerValue}`}setBus(e){return this._bus=e,this}_writeIo(e,t){}_writeTimer(e,t){switch(this._interruptFlag=0,663&e){case 663:return this._setTimer(1024,t);case 662:return this._setTimer(64,t);case 661:return this._setTimer(8,t);case 660:return this._setTimer(1,t)}}_setTimer(e,t){this._timerDivide=e,this._timerValue=t,this._subTimer=0,this._timerWrapped=!1}_readIo(e){switch(643&e){case 640:return(this._joystick1.getUp().read()?0:1)|(this._joystick1.getDown().read()?0:2)|(this._joystick1.getLeft().read()?0:4)|(this._joystick1.getRight().read()?0:8)|(this._joystick0.getUp().read()?0:16)|(this._joystick0.getDown().read()?0:32)|(this._joystick0.getLeft().read()?0:64)|(this._joystick0.getRight().read()?0:128);case 642:return(this._controlPanel.getResetButton().read()?0:1)|(this._controlPanel.getSelectSwitch().read()?0:2)|(this._controlPanel.getColorSwitch().read()?0:8)|(this._controlPanel.getDifficultySwitchP0().read()?0:64)|(this._controlPanel.getDifficultySwitchP1().read()?0:128)}return this._bus.getLastDataBusValue()}_readTimer(e){if(1&e){return 128&this._interruptFlag}return this._flagSetDuringThisCycle||(this._interruptFlag=0,this._timerWrapped=!1),this._timerValue}_peekTimer(e){return 1&e?128&this._interruptFlag:this._timerValue}_cycleTimer(){this._flagSetDuringThisCycle=!1,this._timerWrapped?this._timerValue=this._timerValue+255&255:0===this._subTimer&&--this._timerValue<0&&(this._timerValue=255,this._flagSetDuringThisCycle=!0,this._interruptFlag=255,this._timerWrapped=!0),++this._subTimer===this._timerDivide&&(this._subTimer=0)}}!function(e){e.TrapPayload=class{constructor(e,t,s){this.reason=e,this.pia=t,this.message=s}}}(Pia||(Pia={})),function(e){e.State=class{constructor(){this.a=0,this.x=0,this.y=0,this.s=0,this.p=0,this.flags=0,this.irq=!1,this.nmi=!1}}}(CpuInterface||(CpuInterface={}));class ResultImpl{constructor(){this.cycleType=0,this.address=0,this.value=0,this.pollInterrupts=!1,this.nextStep=null}read(e,t){return this.cycleType=0,this.address=t,this.nextStep=e,this}write(e,t,s){return this.cycleType=1,this.address=t,this.value=s,this.nextStep=e,this}poll(e){return this.pollInterrupts=e,this}}const immutables=Symbol("immutable properties");function freezeImmutables(e){const t=e[immutables];if(t)for(const s of t)Object.defineProperty(e,s,{writable:!1,configurable:!1})}function Immutable(e,t){e[immutables]||Object.defineProperty(e,immutables,{value:[],writable:!1,enumerable:!1}),e[immutables].push(t)}class Boot{constructor(e){this.reset=()=>this._result.read(this._pre1Step,255),this._pre1Step=()=>this._result.read(this._pre2Step,255),this._pre2Step=()=>this._result.read(this._stack1Step,256),this._stack1Step=()=>this._result.read(this._stack2Step,511),this._stack2Step=()=>(this._state.s=253,this._result.read(this._stack3Step,510)),this._stack3Step=()=>this._result.read(this._readTargetLoStep,65532),this._readTargetLoStep=e=>(this._targetAddress=e,this._result.read(this._readTargetHiStep,65533)),this._readTargetHiStep=e=>(this._targetAddress|=e<<8,this._state.p=this._targetAddress,null),this._targetAddress=0,this._result=new ResultImpl,this._state=e,freezeImmutables(this)}}__decorate([Immutable,__metadata("design:type",Object)],Boot.prototype,"reset",void 0),__decorate([Immutable,__metadata("design:type",Object)],Boot.prototype,"_pre1Step",void 0),__decorate([Immutable,__metadata("design:type",Object)],Boot.prototype,"_pre2Step",void 0),__decorate([Immutable,__metadata("design:type",Object)],Boot.prototype,"_stack1Step",void 0),__decorate([Immutable,__metadata("design:type",Object)],Boot.prototype,"_stack2Step",void 0),__decorate([Immutable,__metadata("design:type",Object)],Boot.prototype,"_stack3Step",void 0),__decorate([Immutable,__metadata("design:type",Object)],Boot.prototype,"_readTargetLoStep",void 0),__decorate([Immutable,__metadata("design:type",Object)],Boot.prototype,"_readTargetHiStep",void 0),__decorate([Immutable,__metadata("design:type",Object)],Boot.prototype,"_result",void 0),__decorate([Immutable,__metadata("design:type",CpuInterface.State)],Boot.prototype,"_state",void 0);const boot=e=>new Boot(e);class Interrupt{constructor(e,t,s){this.reset=()=>this._result.read(this._dummyRead,this._state.p),this._dummyRead=()=>(this._isBrk&&(this._state.p=this._state.p+1&65535),this._result.write(this._pushPch,256+this._state.s,this._state.p>>>8)),this._pushPch=()=>(this._state.s=this._state.s-1&255,this._result.write(this._pushPcl,256+this._state.s,255&this._state.p).poll(!0)),this._pushPcl=()=>(this._state.s=this._state.s-1&255,this._vector=this._state.nmi?65530:this._defaultVector,this._result.write(this._pushFlags,256+this._state.s,this._isBrk?16|this._state.flags:-17&this._state.flags)),this._pushFlags=()=>(this._state.s=this._state.s-1&255,this._result.read(this._fetchPcl,this._vector)),this._fetchPcl=e=>(this._state.flags|=4,this._state.p=e,this._result.read(this._fetchPch,++this._vector)),this._fetchPch=e=>(this._state.p=this._state.p|e<<8,this._state.nmi=this._state.irq=!1,null),this._vector=0,this._result=new ResultImpl,this._state=e,this._defaultVector=t,this._isBrk=s,freezeImmutables(this)}}__decorate([Immutable,__metadata("design:type",Object)],Interrupt.prototype,"reset",void 0),__decorate([Immutable,__metadata("design:type",Object)],Interrupt.prototype,"_dummyRead",void 0),__decorate([Immutable,__metadata("design:type",Object)],Interrupt.prototype,"_pushPch",void 0),__decorate([Immutable,__metadata("design:type",Object)],Interrupt.prototype,"_pushPcl",void 0),__decorate([Immutable,__metadata("design:type",Object)],Interrupt.prototype,"_pushFlags",void 0),__decorate([Immutable,__metadata("design:type",Object)],Interrupt.prototype,"_fetchPcl",void 0),__decorate([Immutable,__metadata("design:type",Object)],Interrupt.prototype,"_fetchPch",void 0),__decorate([Immutable,__metadata("design:type",Object)],Interrupt.prototype,"_result",void 0),__decorate([Immutable,__metadata("design:type",CpuInterface.State)],Interrupt.prototype,"_state",void 0),__decorate([Immutable,__metadata("design:type",Number)],Interrupt.prototype,"_defaultVector",void 0),__decorate([Immutable,__metadata("design:type",Boolean)],Interrupt.prototype,"_isBrk",void 0);const brk=e=>new Interrupt(e,65534,!0),irq=e=>new Interrupt(e,65534,!1),nmi=e=>new Interrupt(e,65530,!1);class Instruction{constructor(e,t,s=t){this.operation=e,this.addressingMode=t,this.effectiveAddressingMode=s}getSize(){switch(this.effectiveAddressingMode){case 1:case 2:case 6:case 9:case 8:case 11:case 5:return 2;case 3:case 7:case 10:case 4:return 3;default:return 1}}}!function(e){let t;!function(e){e[e.adc=0]="adc",e[e.and=1]="and",e[e.asl=2]="asl",e[e.bcc=3]="bcc",e[e.bcs=4]="bcs",e[e.beq=5]="beq",e[e.bit=6]="bit",e[e.bmi=7]="bmi",e[e.bne=8]="bne",e[e.bpl=9]="bpl",e[e.brk=10]="brk",e[e.bvc=11]="bvc",e[e.bvs=12]="bvs",e[e.clc=13]="clc",e[e.cld=14]="cld",e[e.cli=15]="cli",e[e.clv=16]="clv",e[e.cmp=17]="cmp",e[e.cpx=18]="cpx",e[e.cpy=19]="cpy",e[e.dec=20]="dec",e[e.dex=21]="dex",e[e.dey=22]="dey",e[e.eor=23]="eor",e[e.inc=24]="inc",e[e.inx=25]="inx",e[e.iny=26]="iny",e[e.jmp=27]="jmp",e[e.jsr=28]="jsr",e[e.lda=29]="lda",e[e.ldx=30]="ldx",e[e.ldy=31]="ldy",e[e.lsr=32]="lsr",e[e.nop=33]="nop",e[e.ora=34]="ora",e[e.pha=35]="pha",e[e.php=36]="php",e[e.pla=37]="pla",e[e.plp=38]="plp",e[e.rol=39]="rol",e[e.ror=40]="ror",e[e.rti=41]="rti",e[e.rts=42]="rts",e[e.sbc=43]="sbc",e[e.sec=44]="sec",e[e.sed=45]="sed",e[e.sei=46]="sei",e[e.sta=47]="sta",e[e.stx=48]="stx",e[e.sty=49]="sty",e[e.tax=50]="tax",e[e.tay=51]="tay",e[e.tsx=52]="tsx",e[e.txa=53]="txa",e[e.txs=54]="txs",e[e.tya=55]="tya",e[e.dop=56]="dop",e[e.top=57]="top",e[e.alr=58]="alr",e[e.axs=59]="axs",e[e.dcp=60]="dcp",e[e.lax=61]="lax",e[e.arr=62]="arr",e[e.slo=63]="slo",e[e.aax=64]="aax",e[e.lar=65]="lar",e[e.isc=66]="isc",e[e.aac=67]="aac",e[e.atx=68]="atx",e[e.rra=69]="rra",e[e.rla=70]="rla",e[e.invalid=71]="invalid"}(t=e.OperationMap||(e.OperationMap={})),e.opcodes=new Array(256)}(Instruction||(Instruction={})),function(e){let t;!function(t){for(let t=0;t<256;t++)e.opcodes[t]=new e(71,12);let s,i,r;for(let t=0;t<8;t++){switch(t){case 0:s=34;break;case 1:s=1;break;case 2:s=23;break;case 3:s=0;break;case 4:s=47;break;case 5:s=29;break;case 6:s=17;break;case 7:s=43}for(let a=0;a<8;a++){switch(a){case 0:i=8;break;case 1:i=2;break;case 2:i=1;break;case 3:i=3;break;case 4:i=11;break;case 5:i=6;break;case 6:i=10;break;case 7:i=7}47===s&&1===i&&(i=12),71!==s&&12!==i&&(r=t<<5|a<<2|1,e.opcodes[r]=new e(s,i))}}function a(t,s,i,r){if(71!==e.opcodes[t].operation)throw new Error("entry for opcode "+t+" already exists");e.opcodes[t]=new e(s,i,r)}a(6,2,2),a(10,2,0),a(14,2,3),a(22,2,6),a(30,2,7),a(38,39,2),a(42,39,0),a(46,39,3),a(54,39,6),a(62,39,7),a(70,32,2),a(74,32,0),a(78,32,3),a(86,32,6),a(94,32,7),a(102,40,2),a(106,40,0),a(110,40,3),a(118,40,6),a(126,40,7),a(134,48,2),a(142,48,3),a(150,48,9),a(162,30,1),a(166,30,2),a(174,30,3),a(182,30,9),a(190,30,10),a(198,20,2),a(206,20,3),a(214,20,6),a(222,20,7),a(230,24,2),a(238,24,3),a(246,24,6),a(254,24,7),a(36,6,2),a(44,6,3),a(76,27,3),a(108,27,4),a(132,49,2),a(140,49,3),a(148,49,6),a(160,31,1),a(164,31,2),a(172,31,3),a(180,31,6),a(188,31,7),a(192,19,1),a(196,19,2),a(204,19,3),a(224,18,1),a(228,18,2),a(236,18,3),a(16,9,5),a(48,7,5),a(80,11,5),a(112,12,5),a(144,3,5),a(176,4,5),a(208,8,5),a(240,5,5),a(0,10,0),a(32,28,0,3),a(64,41,0),a(96,42,0),a(8,36,0),a(40,38,0),a(72,35,0),a(104,37,0),a(136,22,0),a(168,51,0),a(200,26,0),a(232,25,0),a(24,13,0),a(56,44,0),a(88,15,0),a(120,46,0),a(152,55,0),a(184,16,0),a(216,14,0),a(248,45,0),a(138,53,0),a(154,54,0),a(170,50,0),a(186,52,0),a(202,21,0),a(234,33,0),a(26,33,0),a(58,33,0),a(90,33,0),a(122,33,0),a(218,33,0),a(250,33,0),a(4,56,2),a(20,56,6),a(52,56,6),a(68,56,2),a(84,56,6),a(100,56,2),a(116,56,6),a(128,56,1),a(130,56,1),a(137,56,1),a(194,56,1),a(212,56,6),a(226,56,1),a(244,56,6),a(12,57,3),a(28,57,7),a(60,57,7),a(92,57,7),a(124,57,7),a(220,57,7),a(252,57,7),a(235,43,1),a(75,58,1),a(203,59,1),a(199,60,2),a(215,60,6),a(207,60,3),a(223,60,7),a(219,60,10),a(195,60,8),a(211,60,11),a(167,61,2),a(183,61,9),a(175,61,3),a(191,61,10),a(163,61,8),a(179,61,11),a(107,62,1),a(7,63,2),a(23,63,6),a(15,63,3),a(31,63,7),a(27,63,10),a(3,63,8),a(19,63,11),a(135,64,2),a(151,64,9),a(131,64,8),a(143,64,3),a(187,65,10),a(231,66,2),a(247,66,6),a(239,66,3),a(255,66,7),a(251,66,10),a(227,66,8),a(243,66,11),a(11,67,1),a(43,67,1),a(171,68,1),a(103,69,2),a(119,69,6),a(111,69,3),a(127,69,7),a(123,69,10),a(99,69,8),a(115,69,11),a(39,70,2),a(55,70,6),a(47,70,3),a(63,70,7),a(59,70,10),a(35,70,8),a(51,70,11)}(t=e.__init||(e.__init={}))}(Instruction||(Instruction={}));class Absolute{constructor(e,t=(()=>null)){this.reset=()=>this._result.read(this._fetchLo,this._state.p),this._fetchLo=e=>(this._operand=e,this._state.p=this._state.p+1&65535,this._result.read(this._fetchHi,this._state.p)),this._fetchHi=e=>(this._operand|=e<<8,this._state.p=this._state.p+1&65535,this._next(this._operand,this._state)),this._operand=0,this._result=new ResultImpl,this._state=e,this._next=t,freezeImmutables(this)}}__decorate([Immutable,__metadata("design:type",Object)],Absolute.prototype,"reset",void 0),__decorate([Immutable,__metadata("design:type",Object)],Absolute.prototype,"_fetchLo",void 0),__decorate([Immutable,__metadata("design:type",Object)],Absolute.prototype,"_fetchHi",void 0),__decorate([Immutable,__metadata("design:type",Object)],Absolute.prototype,"_result",void 0),__decorate([Immutable,__metadata("design:type",CpuInterface.State)],Absolute.prototype,"_state",void 0),__decorate([Immutable,__metadata("design:type",Function)],Absolute.prototype,"_next",void 0);const absolute=(e,t)=>new Absolute(e,t);class AbsoluteIndexed{constructor(e,t,s=(()=>null),i=!1){this.reset=()=>this._result.read(this._fetchLo,this._state.p),this._fetchLo=e=>(this._operand=e,this._state.p=this._state.p+1&65535,this._result.read(this._fetchHi,this._state.p)),this._fetchHi=e=>{this._operand|=e<<8,this._state.p=this._state.p+1&65535;const t=this._indexExtractor(this._state);return this._carry=(255&this._operand)+t>255,this._operand=65280&this._operand|this._operand+t&255,this._carry||this._writeOp?this._result.read(this._dereferenceAndCarry,this._operand):this._next(this._operand,this._state)},this._dereferenceAndCarry=e=>(this._carry&&(this._operand=this._operand+256&65535),this._next(this._operand,this._state)),this._operand=0,this._carry=!1,this._result=new ResultImpl,this._state=e,this._indexExtractor=t,this._next=s,this._writeOp=i,freezeImmutables(this)}static absoluteX(e,t,s){return new AbsoluteIndexed(e,e=>e.x,t,s)}static absoluteY(e,t,s){return new AbsoluteIndexed(e,e=>e.y,t,s)}}__decorate([Immutable,__metadata("design:type",Object)],AbsoluteIndexed.prototype,"reset",void 0),__decorate([Immutable,__metadata("design:type",Object)],AbsoluteIndexed.prototype,"_fetchLo",void 0),__decorate([Immutable,__metadata("design:type",Object)],AbsoluteIndexed.prototype,"_fetchHi",void 0),__decorate([Immutable,__metadata("design:type",Object)],AbsoluteIndexed.prototype,"_dereferenceAndCarry",void 0),__decorate([Immutable,__metadata("design:type",Object)],AbsoluteIndexed.prototype,"_result",void 0),__decorate([Immutable,__metadata("design:type",CpuInterface.State)],AbsoluteIndexed.prototype,"_state",void 0),__decorate([Immutable,__metadata("design:type",Function)],AbsoluteIndexed.prototype,"_indexExtractor",void 0),__decorate([Immutable,__metadata("design:type",Function)],AbsoluteIndexed.prototype,"_next",void 0),__decorate([Immutable,__metadata("design:type",Boolean)],AbsoluteIndexed.prototype,"_writeOp",void 0),__decorate([Immutable,__metadata("design:type",Function),__metadata("design:paramtypes",[CpuInterface.State,Function,Boolean]),__metadata("design:returntype",AbsoluteIndexed)],AbsoluteIndexed,"absoluteX",null),__decorate([Immutable,__metadata("design:type",Function),__metadata("design:paramtypes",[CpuInterface.State,Function,Boolean]),__metadata("design:returntype",AbsoluteIndexed)],AbsoluteIndexed,"absoluteY",null);const absoluteX=(e,t,s)=>AbsoluteIndexed.absoluteX(e,t,s),absoluteY=(e,t,s)=>AbsoluteIndexed.absoluteY(e,t,s);class Dereference{constructor(e,t=(()=>null)){this.reset=e=>this._result.read(this._dereference,e),this._dereference=e=>this._next(e,this._state),this._result=new ResultImpl,this._next=t,this._state=e,freezeImmutables(this)}}__decorate([Immutable,__metadata("design:type",Object)],Dereference.prototype,"reset",void 0),__decorate([Immutable,__metadata("design:type",Object)],Dereference.prototype,"_dereference",void 0),__decorate([Immutable,__metadata("design:type",Object)],Dereference.prototype,"_result",void 0),__decorate([Immutable,__metadata("design:type",CpuInterface.State)],Dereference.prototype,"_state",void 0),__decorate([Immutable,__metadata("design:type",Function)],Dereference.prototype,"_next",void 0);const dereference=(e,t)=>new Dereference(e,t);class Immediate{constructor(e,t=(()=>null)){this.reset=()=>this._result.read(this._fetchOperand,this._state.p),this._fetchOperand=e=>(this._operand=e,this._state.p=this._state.p+1&65535,this._next(this._operand,this._state)),this._operand=0,this._result=new ResultImpl,this._state=e,this._next=t,freezeImmutables(this)}}__decorate([Immutable,__metadata("design:type",Object)],Immediate.prototype,"reset",void 0),__decorate([Immutable,__metadata("design:type",Object)],Immediate.prototype,"_fetchOperand",void 0),__decorate([Immutable,__metadata("design:type",Object)],Immediate.prototype,"_result",void 0),__decorate([Immutable,__metadata("design:type",CpuInterface.State)],Immediate.prototype,"_state",void 0),__decorate([Immutable,__metadata("design:type",Function)],Immediate.prototype,"_next",void 0);const immediate=(e,t)=>new Immediate(e,t);class IndexedIndirectX{constructor(e,t=(()=>null)){this.reset=()=>this._result.read(this._fetchAddress,this._state.p),this._fetchAddress=e=>(this._address=e,this._state.p=this._state.p+1&65535,this._result.read(this._addIndex,this._address)),this._addIndex=e=>(this._address=this._address+this._state.x&255,this._result.read(this._fetchLo,this._address)),this._fetchLo=e=>(this._operand=e,this._address=this._address+1&255,this._result.read(this._fetchHi,this._address)),this._fetchHi=e=>(this._operand|=e<<8,this._next(this._operand,this._state)),this._operand=0,this._address=0,this._result=new ResultImpl,this._state=e,this._next=t,freezeImmutables(this)}}__decorate([Immutable,__metadata("design:type",Object)],IndexedIndirectX.prototype,"reset",void 0),__decorate([Immutable,__metadata("design:type",Object)],IndexedIndirectX.prototype,"_fetchAddress",void 0),__decorate([Immutable,__metadata("design:type",Object)],IndexedIndirectX.prototype,"_addIndex",void 0),__decorate([Immutable,__metadata("design:type",Object)],IndexedIndirectX.prototype,"_fetchLo",void 0),__decorate([Immutable,__metadata("design:type",Object)],IndexedIndirectX.prototype,"_fetchHi",void 0),__decorate([Immutable,__metadata("design:type",Object)],IndexedIndirectX.prototype,"_result",void 0),__decorate([Immutable,__metadata("design:type",CpuInterface.State)],IndexedIndirectX.prototype,"_state",void 0),__decorate([Immutable,__metadata("design:type",Function)],IndexedIndirectX.prototype,"_next",void 0);const indexedIndirectX=(e,t)=>new IndexedIndirectX(e,t);class IndexedIndirectY{constructor(e,t=(()=>null),s){this.reset=()=>this._result.read(this._fetchAddress,this._state.p),this._fetchAddress=e=>(this._address=e,this._state.p=this._state.p+1&65535,this._result.read(this._fetchLo,this._address)),this._fetchLo=e=>(this._operand=e,this._address=this._address+1&255,this._result.read(this._fetchHi,this._address)),this._fetchHi=e=>(this._operand|=e<<8,this._carry=(255&this._operand)+this._state.y>255,this._operand=65280&this._operand|this._operand+this._state.y&255,this._carry||this._writeOp?this._result.read(this._dereferenceAndCarry,this._operand):this._next(this._operand,this._state)),this._dereferenceAndCarry=e=>(this._carry&&(this._operand=this._operand+256&65535),this._next(this._operand,this._state)),this._operand=0,this._address=0,this._carry=!1,this._result=new ResultImpl,this._state=e,this._next=t,this._writeOp=s,freezeImmutables(this)}}__decorate([Immutable,__metadata("design:type",Object)],IndexedIndirectY.prototype,"reset",void 0),__decorate([Immutable,__metadata("design:type",Object)],IndexedIndirectY.prototype,"_fetchAddress",void 0),__decorate([Immutable,__metadata("design:type",Object)],IndexedIndirectY.prototype,"_fetchLo",void 0),__decorate([Immutable,__metadata("design:type",Object)],IndexedIndirectY.prototype,"_fetchHi",void 0),__decorate([Immutable,__metadata("design:type",Object)],IndexedIndirectY.prototype,"_dereferenceAndCarry",void 0),__decorate([Immutable,__metadata("design:type",Object)],IndexedIndirectY.prototype,"_result",void 0),__decorate([Immutable,__metadata("design:type",CpuInterface.State)],IndexedIndirectY.prototype,"_state",void 0),__decorate([Immutable,__metadata("design:type",Function)],IndexedIndirectY.prototype,"_next",void 0),__decorate([Immutable,__metadata("design:type",Boolean)],IndexedIndirectY.prototype,"_writeOp",void 0);const indirectIndexedY=(e,t,s)=>new IndexedIndirectY(e,t,s);class ZeroPage{constructor(e,t=(()=>null)){this.reset=()=>this._result.read(this._fetchAddress,this._state.p),this._fetchAddress=e=>(this._operand=e,this._state.p=this._state.p+1&65535,this._next(this._operand,this._state)),this._operand=0,this._result=new ResultImpl,this._state=e,this._next=t,freezeImmutables(this)}}__decorate([Immutable,__metadata("design:type",Object)],ZeroPage.prototype,"reset",void 0),__decorate([Immutable,__metadata("design:type",Object)],ZeroPage.prototype,"_fetchAddress",void 0),__decorate([Immutable,__metadata("design:type",Object)],ZeroPage.prototype,"_result",void 0),__decorate([Immutable,__metadata("design:type",CpuInterface.State)],ZeroPage.prototype,"_state",void 0),__decorate([Immutable,__metadata("design:type",Function)],ZeroPage.prototype,"_next",void 0);const zeroPage=(e,t)=>new ZeroPage(e,t);class ZeroPageIndexed{constructor(e,t,s){this.reset=()=>this._result.read(this._fetchAddress,this._state.p),this._fetchAddress=e=>(this._operand=e,this._state.p=this._state.p+1&65535,this._result.read(this._addIndex,this._operand)),this._addIndex=e=>(this._operand=this._operand+this._indexExtractor(this._state)&255,this._next(this._operand,this._state)),this._operand=0,this._result=new ResultImpl,this._state=e,this._indexExtractor=t,this._next=s,freezeImmutables(this)}static zeroPageX(e,t=(()=>null)){return new ZeroPageIndexed(e,e=>e.x,t)}static zeroPageY(e,t=(()=>null)){return new ZeroPageIndexed(e,e=>e.y,t)}}__decorate([Immutable,__metadata("design:type",Object)],ZeroPageIndexed.prototype,"reset",void 0),__decorate([Immutable,__metadata("design:type",Object)],ZeroPageIndexed.prototype,"_fetchAddress",void 0),__decorate([Immutable,__metadata("design:type",Object)],ZeroPageIndexed.prototype,"_addIndex",void 0),__decorate([Immutable,__metadata("design:type",Object)],ZeroPageIndexed.prototype,"_result",void 0),__decorate([Immutable,__metadata("design:type",CpuInterface.State)],ZeroPageIndexed.prototype,"_state",void 0),__decorate([Immutable,__metadata("design:type",Function)],ZeroPageIndexed.prototype,"_next",void 0),__decorate([Immutable,__metadata("design:type",Function)],ZeroPageIndexed.prototype,"_indexExtractor",void 0);const zeroPageX=(e,t)=>ZeroPageIndexed.zeroPageX(e,t),zeroPageY=(e,t)=>ZeroPageIndexed.zeroPageY(e,t);class Branch{constructor(e,t){this.reset=()=>this._result.read(this._fetchTarget,this._state.p).poll(!0),this._fetchTarget=e=>(this._operand=e,this._state.p=this._state.p+1&65535,this._predicate(this._state.flags)?this._result.read(this._firstDummyRead,this._state.p):null),this._firstDummyRead=e=>(this._target=this._state.p+(128&this._operand?this._operand-256:this._operand)&65535,(65280&this._target)==(65280&this._state.p)?(this._state.p=this._target,null):this._result.read(this._secondDummyRead,65280&this._state.p|255&this._target).poll(!0)),this._secondDummyRead=e=>(this._state.p=this._target,null),this._target=0,this._operand=0,this._result=new ResultImpl,this._state=e,this._predicate=t,freezeImmutables(this)}}__decorate([Immutable,__metadata("design:type",Object)],Branch.prototype,"reset",void 0),__decorate([Immutable,__metadata("design:type",Object)],Branch.prototype,"_fetchTarget",void 0),__decorate([Immutable,__metadata("design:type",Object)],Branch.prototype,"_firstDummyRead",void 0),__decorate([Immutable,__metadata("design:type",Object)],Branch.prototype,"_secondDummyRead",void 0),__decorate([Immutable,__metadata("design:type",Object)],Branch.prototype,"_result",void 0),__decorate([Immutable,__metadata("design:type",CpuInterface.State)],Branch.prototype,"_state",void 0),__decorate([Immutable,__metadata("design:type",Function)],Branch.prototype,"_predicate",void 0);const branch=(e,t)=>new Branch(e,t);class Jsr{constructor(e){this.reset=()=>this._result.read(this._fetchPcl,this._state.p),this._fetchPcl=e=>(this._addressLo=e,this._state.p=this._state.p+1&65535,this._result.read(this._dummyStackRead,256+this._state.s)),this._dummyStackRead=()=>this._result.write(this._pushPch,256+this._state.s,this._state.p>>>8),this._pushPch=()=>(this._state.s=this._state.s-1&255,this._result.write(this._pushPcl,256+this._state.s,255&this._state.p)),this._pushPcl=()=>(this._state.s=this._state.s-1&255,this._result.read(this._fetchPch,this._state.p)),this._fetchPch=e=>(this._state.p=this._addressLo|e<<8,null),this._addressLo=0,this._result=new ResultImpl,this._state=e,freezeImmutables(this)}}__decorate([Immutable,__metadata("design:type",Object)],Jsr.prototype,"_fetchPcl",void 0),__decorate([Immutable,__metadata("design:type",Object)],Jsr.prototype,"_dummyStackRead",void 0),__decorate([Immutable,__metadata("design:type",Object)],Jsr.prototype,"_pushPch",void 0),__decorate([Immutable,__metadata("design:type",Object)],Jsr.prototype,"_pushPcl",void 0),__decorate([Immutable,__metadata("design:type",Object)],Jsr.prototype,"_fetchPch",void 0),__decorate([Immutable,__metadata("design:type",Object)],Jsr.prototype,"_result",void 0),__decorate([Immutable,__metadata("design:type",CpuInterface.State)],Jsr.prototype,"_state",void 0);const jsr=e=>new Jsr(e);class ReadModifyWrite{constructor(e,t){this.reset=e=>(this._address=e,this._result.read(this._read,e)),this._read=e=>(this._operand=e,this._result.write(this._dummyWrite,this._address,this._operand)),this._dummyWrite=e=>this._result.write(this._write,this._address,this._operation(this._operand,this._state)),this._write=()=>null,this._result=new ResultImpl,this._state=e,this._operation=t,freezeImmutables(this)}}__decorate([Immutable,__metadata("design:type",Object)],ReadModifyWrite.prototype,"reset",void 0),__decorate([Immutable,__metadata("design:type",Object)],ReadModifyWrite.prototype,"_read",void 0),__decorate([Immutable,__metadata("design:type",Object)],ReadModifyWrite.prototype,"_dummyWrite",void 0),__decorate([Immutable,__metadata("design:type",Object)],ReadModifyWrite.prototype,"_write",void 0),__decorate([Immutable,__metadata("design:type",Object)],ReadModifyWrite.prototype,"_result",void 0),__decorate([Immutable,__metadata("design:type",CpuInterface.State)],ReadModifyWrite.prototype,"_state",void 0),__decorate([Immutable,__metadata("design:type",Function)],ReadModifyWrite.prototype,"_operation",void 0);const readModifyWrite=(e,t)=>new ReadModifyWrite(e,t);class Rts{constructor(e){this.reset=()=>this._result.read(this._dummyOperandRead,this._state.p),this._dummyOperandRead=()=>this._result.read(this._dummyStackRead,256+this._state.s),this._dummyStackRead=()=>(this._state.s=this._state.s+1&255,this._result.read(this._popPcl,256+this._state.s)),this._popPcl=e=>(this._state.p=65280&this._state.p|e,this._state.s=this._state.s+1&255,this._result.read(this._popPch,256+this._state.s)),this._popPch=e=>(this._state.p=255&this._state.p|e<<8,this._result.read(this._incrementP,this._state.p)),this._incrementP=()=>(this._state.p=this._state.p+1&65535,null),this._result=new ResultImpl,this._state=e,freezeImmutables(this)}}__decorate([Immutable,__metadata("design:type",Object)],Rts.prototype,"reset",void 0),__decorate([Immutable,__metadata("design:type",Object)],Rts.prototype,"_dummyOperandRead",void 0),__decorate([Immutable,__metadata("design:type",Object)],Rts.prototype,"_dummyStackRead",void 0),__decorate([Immutable,__metadata("design:type",Object)],Rts.prototype,"_popPcl",void 0),__decorate([Immutable,__metadata("design:type",Object)],Rts.prototype,"_popPch",void 0),__decorate([Immutable,__metadata("design:type",Object)],Rts.prototype,"_incrementP",void 0),__decorate([Immutable,__metadata("design:type",Object)],Rts.prototype,"_result",void 0),__decorate([Immutable,__metadata("design:type",CpuInterface.State)],Rts.prototype,"_state",void 0);const rts=e=>new Rts(e);class NullaryOneCycle{constructor(e,t){this.reset=()=>this._result.read(this._executeOperation,this._state.p).poll(!0),this._executeOperation=()=>(this._operation(this._state),null),this._result=new ResultImpl,this._state=e,this._operation=t,freezeImmutables(this)}}__decorate([Immutable,__metadata("design:type",Object)],NullaryOneCycle.prototype,"reset",void 0),__decorate([Immutable,__metadata("design:type",Object)],NullaryOneCycle.prototype,"_executeOperation",void 0),__decorate([Immutable,__metadata("design:type",Object)],NullaryOneCycle.prototype,"_result",void 0),__decorate([Immutable,__metadata("design:type",CpuInterface.State)],NullaryOneCycle.prototype,"_state",void 0),__decorate([Immutable,__metadata("design:type",Function)],NullaryOneCycle.prototype,"_operation",void 0);const nullaryOneCycle=(e,t)=>new NullaryOneCycle(e,t);class Pull{constructor(e,t){this.reset=()=>this._result.read(this._dummyRead,this._state.p).poll(!0),this._dummyRead=()=>this._result.read(this._incrementS,256+this._state.s),this._incrementS=()=>(this._state.s=this._state.s+1&255,this._result.read(this._pull,256+this._state.s)),this._pull=e=>(this._operation(this._state,e),null),this._result=new ResultImpl,this._state=e,this._operation=t,freezeImmutables(this)}}__decorate([Immutable,__metadata("design:type",Object)],Pull.prototype,"reset",void 0),__decorate([Immutable,__metadata("design:type",Object)],Pull.prototype,"_dummyRead",void 0),__decorate([Immutable,__metadata("design:type",Object)],Pull.prototype,"_incrementS",void 0),__decorate([Immutable,__metadata("design:type",Object)],Pull.prototype,"_pull",void 0),__decorate([Immutable,__metadata("design:type",Object)],Pull.prototype,"_result",void 0),__decorate([Immutable,__metadata("design:type",CpuInterface.State)],Pull.prototype,"_state",void 0),__decorate([Immutable,__metadata("design:type",Function)],Pull.prototype,"_operation",void 0);const pull=(e,t)=>new Pull(e,t);class Push{constructor(e,t){this.reset=()=>this._result.read(this._dummyRead,this._state.p),this._dummyRead=()=>this._result.write(this._push,256+this._state.s,this._operation(this._state)),this._push=()=>(this._state.s=this._state.s-1&255,null),this._result=new ResultImpl,this._state=e,this._operation=t,freezeImmutables(this)}}__decorate([Immutable,__metadata("design:type",Object)],Push.prototype,"reset",void 0),__decorate([Immutable,__metadata("design:type",Object)],Push.prototype,"_dummyRead",void 0),__decorate([Immutable,__metadata("design:type",Object)],Push.prototype,"_push",void 0),__decorate([Immutable,__metadata("design:type",Object)],Push.prototype,"_result",void 0),__decorate([Immutable,__metadata("design:type",CpuInterface.State)],Push.prototype,"_state",void 0),__decorate([Immutable,__metadata("design:type",Function)],Push.prototype,"_operation",void 0);const push=(e,t)=>new Push(e,t);class Rti{constructor(e){this.reset=()=>this._result.read(this._dummyOperandRead,this._state.p),this._dummyOperandRead=()=>this._result.read(this._dummyStackRead,256+this._state.s),this._dummyStackRead=()=>(this._state.s=this._state.s+1&255,this._result.read(this._popP,256+this._state.s)),this._popP=e=>(this._state.flags=-17&(32|e),this._state.s=this._state.s+1&255,this._result.read(this._popPcl,256+this._state.s)),this._popPcl=e=>(this._state.p=65280&this._state.p|e,this._state.s=this._state.s+1&255,this._result.read(this._popPch,256+this._state.s)),this._popPch=e=>(this._state.p=255&this._state.p|e<<8,null),this._result=new ResultImpl,this._state=e,freezeImmutables(this)}}__decorate([Immutable,__metadata("design:type",Object)],Rti.prototype,"reset",void 0),__decorate([Immutable,__metadata("design:type",Object)],Rti.prototype,"_dummyOperandRead",void 0),__decorate([Immutable,__metadata("design:type",Object)],Rti.prototype,"_dummyStackRead",void 0),__decorate([Immutable,__metadata("design:type",Object)],Rti.prototype,"_popP",void 0),__decorate([Immutable,__metadata("design:type",Object)],Rti.prototype,"_popPcl",void 0),__decorate([Immutable,__metadata("design:type",Object)],Rti.prototype,"_popPch",void 0),__decorate([Immutable,__metadata("design:type",Object)],Rti.prototype,"_result",void 0),__decorate([Immutable,__metadata("design:type",CpuInterface.State)],Rti.prototype,"_state",void 0);const rti=e=>new Rti(e);class Write{constructor(e,t){this.reset=e=>this._result.write(()=>null,e,this._operation(this._state)),this._result=new ResultImpl,this._state=e,this._operation=t,freezeImmutables(this)}}__decorate([Immutable,__metadata("design:type",Object)],Write.prototype,"reset",void 0),__decorate([Immutable,__metadata("design:type",Object)],Write.prototype,"_result",void 0),__decorate([Immutable,__metadata("design:type",CpuInterface.State)],Write.prototype,"_state",void 0),__decorate([Immutable,__metadata("design:type",Function)],Write.prototype,"_operation",void 0);const write=(e,t)=>new Write(e,t);function setFlagsNZ(e,t){t.flags=-131&t.flags|128&e|(e?0:2)}function genRmw(e,t,s){const i=s(e);return setFlagsNZ(i,t),i}function genNullary(e,t){setFlagsNZ(t(e),e)}function genUnary(e,t,s){return setFlagsNZ(s(e,t),t),null}function adc(e,t){if(8&t.flags){const s=(15&e)+(15&t.a)+(1&t.flags),i=(e>>>4)+(t.a>>>4)+(s>9?1:0);t.a=s%10|i%10<<4,t.flags=-132&t.flags|128&t.a|(t.a?0:2)|(i>9?1:0)}else{const s=t.a+e+(1&t.flags),i=255&s;t.flags=-196&t.flags|128&i|(i?0:2)|s>>>8|(~(e^t.a)&(i^e)&128)>>>1,t.a=i}return null}function aslImmediate(e){const t=e.a;e.a=e.a<<1&255,e.flags=-132&e.flags|128&e.a|(e.a?0:2)|t>>>7}function aslRmw(e,t){const s=e<<1&255;return t.flags=-132&t.flags|128&s|(s?0:2)|e>>>7,s}function bit(e,t){return t.flags=-195&t.flags|192&e|(e&t.a?0:2),null}function cmp(e,t,s){const i=s(t)+(255&~e)+1;t.flags=-132&t.flags|128&i|(255&i?0:2)|i>>>8}function sbc(e,t){if(8&t.flags){const s=(15&t.a)-(15&e)-(1&~t.flags),i=(t.a>>>4)-(e>>>4)-(s<0?1:0);t.a=(s<0?10+s:s)|(i<0?10+i:i)<<4,t.flags=-132&t.flags|128&t.a|(t.a?0:2)|(i<0?0:1)}else{e=255&~e;const s=t.a+e+(1&t.flags),i=255&s;t.flags=-196&t.flags|128&i|(i?0:2)|s>>>8|(~(e^t.a)&(i^e)&128)>>>1,t.a=i}return null}function lsrImmediate(e){const t=e.a;e.a=e.a>>>1,e.flags=-132&e.flags|128&e.a|(e.a?0:2)|1&t}function lsrRmw(e,t){const s=e>>>1;return t.flags=-132&t.flags|128&s|(s?0:2)|1&e,s}function rolImmediate(e){const t=e.a;e.a=e.a<<1&255|1&e.flags,e.flags=-132&e.flags|128&e.a|(e.a?0:2)|t>>>7}function rolRmw(e,t){const s=e<<1&255|1&t.flags;return t.flags=-132&t.flags|128&s|(s?0:2)|e>>>7,s}function rorImmediate(e){const t=e.a;e.a=e.a>>>1|(1&e.flags)<<7,e.flags=-132&e.flags|128&e.a|(e.a?0:2)|1&t}function rorRmw(e,t){const s=e>>>1|(1&t.flags)<<7;return t.flags=-132&t.flags|128&s|(s?0:2)|1&e,s}function arr(e,t){t.a=(t.a&e)>>>1|(1&t.flags?128:0),t.flags=-196&t.flags|(64&t.a)>>>6|(t.a?0:2)|128&t.a|64&t.a^(32&t.a)<<1}function alr(e,t){const s=t.a&e;return t.a=s>>>1,t.flags=-132&t.flags|128&t.a|(t.a?0:2)|1&s,null}function dcp(e,t){const s=e+255&255,i=t.a+(255&~s)+1;return t.flags=-132&t.flags|128&i|(255&i?0:2)|i>>>8,s}function axs(e,t){const s=(t.a&t.x)+(255&~e)+1;return t.x=255&s,t.flags=-132&t.flags|128&t.x|(255&t.x?0:2)|s>>>8,null}function rra(e,t){const s=e>>>1|(1&t.flags)<<7;return t.flags=-2&t.flags|1&e,adc(s,t),s}function rla(e,t){const s=e<<1&255|1&t.flags;return t.flags=-2&t.flags|e>>>7,setFlagsNZ(t.a&=s,t),s}function slo(e,t){t.flags=-2&t.flags|e>>>7;const s=e<<1&255;return t.a=t.a|s,setFlagsNZ(t.a,t),s}function aax(e){const t=e.a&e.x;return setFlagsNZ(t,e),t}function isc(e,t){const s=e+1&255;return sbc(s,t),s}function aac(e,t){return t.a&=e,setFlagsNZ(t.a,t),t.flags=-2&t.flags|(128&t.a)>>>7,null}class Indirect{constructor(e,t=(()=>null)){this.reset=()=>this._result.read(this._fetchAddressLo,this._state.p),this._fetchAddressLo=e=>(this._address=e,this._state.p=this._state.p+1&65535,this._result.read(this._fetchAddressHi,this._state.p)),this._fetchAddressHi=e=>(this._address|=e<<8,this._state.p=this._state.p+1&65535,this._result.read(this._fetchLo,this._address)),this._fetchLo=e=>(this._operand=e,255==(255&this._address)?this._address&=65280:this._address=this._address+1&65535,this._result.read(this._fetchHi,this._address)),this._fetchHi=e=>(this._operand|=e<<8,this._next(this._operand,this._state)),this._operand=0,this._address=0,this._result=new ResultImpl,this._state=e,this._next=t,freezeImmutables(this)}}__decorate([Immutable,__metadata("design:type",Object)],Indirect.prototype,"reset",void 0),__decorate([Immutable,__metadata("design:type",Object)],Indirect.prototype,"_fetchAddressLo",void 0),__decorate([Immutable,__metadata("design:type",Object)],Indirect.prototype,"_fetchAddressHi",void 0),__decorate([Immutable,__metadata("design:type",Object)],Indirect.prototype,"_fetchLo",void 0),__decorate([Immutable,__metadata("design:type",Object)],Indirect.prototype,"_fetchHi",void 0),__decorate([Immutable,__metadata("design:type",Object)],Indirect.prototype,"_result",void 0),__decorate([Immutable,__metadata("design:type",CpuInterface.State)],Indirect.prototype,"_state",void 0),__decorate([Immutable,__metadata("design:type",Function)],Indirect.prototype,"_next",void 0);const indirect=(e,t)=>new Indirect(e,t);class Compiler{constructor(e){this._state=e}compile(e){const t=Instruction.opcodes[e];switch(t.operation){case 0:return this._createAddressing(t.addressingMode,adc,{deref:!0});case 1:return this._createAddressing(t.addressingMode,(e,t)=>genUnary(e,t,(e,t)=>t.a=t.a&e),{deref:!0});case 2:return 0===t.addressingMode?nullaryOneCycle(this._state,aslImmediate):this._createAddressing(t.addressingMode,readModifyWrite(this._state,aslRmw).reset,{writeOp:!0});case 6:return this._createAddressing(t.addressingMode,bit,{deref:!0});case 10:return brk(this._state);case 17:return this._createAddressing(t.addressingMode,(e,t)=>(cmp(e,t,e=>e.a),null),{deref:!0});case 18:return this._createAddressing(t.addressingMode,(e,t)=>(cmp(e,t,e=>e.x),null),{deref:!0});case 19:return this._createAddressing(t.addressingMode,(e,t)=>(cmp(e,t,e=>e.y),null),{deref:!0});case 20:return this._createAddressing(t.addressingMode,readModifyWrite(this._state,(e,t)=>genRmw(e,t,e=>e-1&255)).reset,{writeOp:!0});case 21:return nullaryOneCycle(this._state,e=>genNullary(e,e=>e.x=e.x-1&255));case 22:return nullaryOneCycle(this._state,e=>genNullary(e,e=>e.y=e.y-1&255));case 24:return this._createAddressing(t.addressingMode,readModifyWrite(this._state,(e,t)=>genRmw(e,t,e=>e+1&255)).reset,{writeOp:!0});case 25:return nullaryOneCycle(this._state,e=>genNullary(e,e=>e.x=e.x+1&255));case 26:return nullaryOneCycle(this._state,e=>genNullary(e,e=>e.y=e.y+1&255));case 23:return this._createAddressing(t.addressingMode,(e,t)=>genUnary(e,t,(e,t)=>t.a=t.a^e),{deref:!0});case 27:return this._createAddressing(t.addressingMode,(e,t)=>(t.p=e,null));case 28:return jsr(this._state);case 29:return this._createAddressing(t.addressingMode,(e,t)=>genUnary(e,t,(e,t)=>t.a=e),{deref:!0});case 30:return this._createAddressing(t.addressingMode,(e,t)=>genUnary(e,t,(e,t)=>t.x=e),{deref:!0});case 31:return this._createAddressing(t.addressingMode,(e,t)=>genUnary(e,t,(e,t)=>t.y=e),{deref:!0});case 32:return 0===t.addressingMode?nullaryOneCycle(this._state,lsrImmediate):this._createAddressing(t.addressingMode,readModifyWrite(this._state,lsrRmw).reset,{writeOp:!0});case 33:return nullaryOneCycle(this._state,()=>void 0);case 34:return this._createAddressing(t.addressingMode,(e,t)=>genUnary(e,t,(e,t)=>t.a|=e),{deref:!0});case 35:return push(this._state,e=>e.a);case 36:return push(this._state,e=>16|e.flags);case 37:return pull(this._state,(e,t)=>genNullary(e,e=>e.a=t));case 38:return pull(this._state,(e,t)=>e.flags=-17&(32|t));case 39:return 0===t.addressingMode?nullaryOneCycle(this._state,rolImmediate):this._createAddressing(t.addressingMode,readModifyWrite(this._state,rolRmw).reset,{writeOp:!0});case 40:return 0===t.addressingMode?nullaryOneCycle(this._state,rorImmediate):this._createAddressing(t.addressingMode,readModifyWrite(this._state,rorRmw).reset,{writeOp:!0});case 41:return rti(this._state);case 42:return rts(this._state);case 43:return this._createAddressing(t.addressingMode,sbc,{deref:!0});case 48:return this._createAddressing(t.addressingMode,write(this._state,e=>e.x).reset,{writeOp:!0});case 49:return this._createAddressing(t.addressingMode,write(this._state,e=>e.y).reset,{writeOp:!0});case 50:return nullaryOneCycle(this._state,e=>genNullary(e,e=>e.x=e.a));case 51:return nullaryOneCycle(this._state,e=>genNullary(e,e=>e.y=e.a));case 52:return nullaryOneCycle(this._state,e=>genNullary(e,e=>e.x=e.s));case 53:return nullaryOneCycle(this._state,e=>genNullary(e,e=>e.a=e.x));case 54:return nullaryOneCycle(this._state,e=>e.s=e.x);case 55:return nullaryOneCycle(this._state,e=>genNullary(e,e=>e.a=e.y));case 3:return branch(this._state,e=>0==(1&e));case 4:return branch(this._state,e=>(1&e)>0);case 8:return branch(this._state,e=>0==(2&e));case 5:return branch(this._state,e=>(2&e)>0);case 9:return branch(this._state,e=>0==(128&e));case 7:return branch(this._state,e=>(128&e)>0);case 11:return branch(this._state,e=>0==(64&e));case 12:return branch(this._state,e=>(64&e)>0);case 44:return nullaryOneCycle(this._state,e=>e.flags|=1);case 45:return nullaryOneCycle(this._state,e=>e.flags|=8);case 46:return nullaryOneCycle(this._state,e=>e.flags|=4);case 47:return this._createAddressing(t.addressingMode,write(this._state,e=>e.a).reset,{writeOp:!0});case 13:return nullaryOneCycle(this._state,e=>e.flags&=-2);case 14:return nullaryOneCycle(this._state,e=>e.flags&=-9);case 15:return nullaryOneCycle(this._state,e=>e.flags&=-5);case 16:return nullaryOneCycle(this._state,e=>e.flags&=-65);case 56:case 57:return this._createAddressing(t.addressingMode,()=>null,{deref:!0});case 67:return this._createAddressing(t.addressingMode,aac);case 64:return this._createAddressing(t.addressingMode,write(this._state,aax).reset,{writeOp:!0});case 58:return this._createAddressing(t.addressingMode,alr,{deref:!0});case 62:return this._createAddressing(t.addressingMode,(e,t)=>(arr(e,t),null),{deref:!0});case 59:return this._createAddressing(t.addressingMode,axs,{deref:!0});case 68:return this._createAddressing(t.addressingMode,(e,t)=>genUnary(e,t,(e,t)=>t.x=t.a=t.a&e),{deref:!0});case 60:return this._createAddressing(t.addressingMode,readModifyWrite(this._state,dcp).reset,{writeOp:!0});case 66:return this._createAddressing(t.addressingMode,readModifyWrite(this._state,isc).reset,{writeOp:!0});case 61:return this._createAddressing(t.addressingMode,(e,t)=>genUnary(e,t,(e,t)=>t.a=t.x=e),{deref:!0});case 65:return this._createAddressing(t.addressingMode,(e,t)=>genUnary(e,t,(e,t)=>t.s=t.x=t.a=t.s&e),{deref:!0});case 70:return this._createAddressing(t.addressingMode,readModifyWrite(this._state,rla).reset,{writeOp:!0});case 69:return this._createAddressing(t.addressingMode,readModifyWrite(this._state,rra).reset,{writeOp:!0});case 63:return this._createAddressing(t.addressingMode,readModifyWrite(this._state,slo).reset,{writeOp:!0});default:return null}}_createAddressing(e,t,{deref:s=!1,writeOp:i=!1}={}){switch(s&&1!==e&&(t=dereference(this._state,t).reset),e){case 1:return immediate(this._state,t);case 2:return zeroPage(this._state,t);case 3:return absolute(this._state,t);case 6:return zeroPageX(this._state,t);case 9:return zeroPageY(this._state,t);case 7:return absoluteX(this._state,t,i);case 10:return absoluteY(this._state,t,i);case 8:return indexedIndirectX(this._state,t);case 11:return indirectIndexedY(this._state,t,i);case 4:return indirect(this._state,t);default:throw new Error(`invalid addressing mode ${e}`)}}}class StateMachineCpu{constructor(e,t){this._bus=e,this._rng=t,this.executionState=0,this.state=new CpuInterface.State,this._invalidInstructionCallback=null,this._interruptPending=!1,this._nmiPending=!1,this._halt=!1,this._pollInterruptsAfterLastInstruction=!1,this._lastInstructionPointer=0,this._operations=new Array(255),this._opBoot=boot(this.state),this._opIrq=irq(this.state),this._opNmi=nmi(this.state);const s=new Compiler(this.state);for(let e=0;e<256;e++)this._operations[e]=s.compile(e);this.reset()}reset(){return this.state.a=this._rng?this._rng.int(255):0,this.state.x=this._rng?this._rng.int(255):0,this.state.y=this._rng?this._rng.int(255):0,this.state.s=253,this.state.p=this._rng?this._rng.int(65535):0,this.state.flags=52|(this._rng?this._rng.int(255):0),this.state.irq=!1,this.state.nmi=!1,this.executionState=0,this._interruptPending=!1,this._nmiPending=!1,this._halt=!1,this._lastResult=this._opBoot.reset(void 0),this._lastInstructionPointer=0,this}setInterrupt(e){return this._interruptPending=e,this}isInterrupt(){return this._interruptPending}nmi(){return this._nmiPending=!0,this}halt(){return this._halt=!0,this}resume(){return this._halt=!1,this}isHalt(){return this._halt}setInvalidInstructionCallback(e){return this._invalidInstructionCallback=e,this}getInvalidInstructionCallback(){return this._invalidInstructionCallback}getLastInstructionPointer(){return this._lastInstructionPointer}cycle(){if(this._halt&&(!this._lastResult||0===this._lastResult.cycleType))return this;if(1===this.executionState)return this._fetch(),this;let e;switch(this._lastResult.cycleType){case 0:e=this._bus.read(this._lastResult.address);break;case 1:e=this._lastResult.value,this._bus.write(this._lastResult.address,e);break;default:throw new Error("invalid cycle type")}return this._lastResult.pollInterrupts&&(this._pollInterrupts(),this._lastResult.pollInterrupts=!1,this._pollInterruptsAfterLastInstruction=!1),this._lastResult=this._lastResult.nextStep(e),null===this._lastResult&&(this.executionState=1),this}_fetch(){let e;this._pollInterruptsAfterLastInstruction&&this._pollInterrupts(),this._lastInstructionPointer=this.state.p;const t=this._bus.read(this.state.p);this.state.nmi?(e=this._opNmi,this._pollInterruptsAfterLastInstruction=!1):this.state.irq?(e=this._opIrq,this._pollInterruptsAfterLastInstruction=!1):(e=this._operations[t],this.state.p=this.state.p+1&65535,this._pollInterruptsAfterLastInstruction=!0),e?(this.executionState=2,this._lastResult=e.reset(void 0)):this._invalidInstructionCallback&&this._invalidInstructionCallback(this)}_pollInterrupts(){if(this.state.irq=!1,this._nmiPending)return this.state.nmi=!0,void(this._nmiPending=!1);!this._interruptPending||this.state.nmi||4&this.state.flags||(this.state.irq=!0)}}function restoreFlagsFromStack(e,t){e.s=e.s+1&255,e.flags=-17&(32|t.read(256+e.s))}function setFlagsNZ$1(e,t){e.flags=-131&e.flags|128&t|(t?0:2)}function opAdc(e,t,s){if(8&e.flags){const t=(15&s)+(15&e.a)+(1&e.flags),i=(s>>>4)+(e.a>>>4)+(t>9?1:0);e.a=t%10|i%10<<4,e.flags=-132&e.flags|128&e.a|(e.a?0:2)|(i>9?1:0)}else{const t=e.a+s+(1&e.flags),i=255&t;e.flags=-196&e.flags|128&i|(i?0:2)|t>>>8|(~(s^e.a)&(i^s)&128)>>>1,e.a=i}}function opAnd(e,t,s){e.a&=s,setFlagsNZ$1(e,e.a)}function opAslAcc(e){const t=e.a;e.a=e.a<<1&255,e.flags=-132&e.flags|128&e.a|(e.a?0:2)|t>>>7}function opAslMem(e,t,s){const i=t.read(s),r=i<<1&255;t.write(s,r),e.flags=-132&e.flags|128&r|(r?0:2)|i>>>7}function opBit(e,t,s){e.flags=-195&e.flags|192&s|(s&e.a?0:2)}function opBrk(e,t){const s=e.p+1&65535;let i=65534;e.nmi&&(i=65530,e.nmi=!1),e.nmi=e.irq=!1,t.write(e.s+256,s>>>8&255),e.s=e.s+255&255,t.write(e.s+256,255&s),e.s=e.s+255&255,t.write(e.s+256,16|e.flags),e.s=e.s+255&255,e.flags|=4,e.p=t.readWord(i)}function opClc(e){e.flags&=-2}function opCld(e){e.flags&=-9}function opCli(e){e.flags&=-5}function opClv(e){e.flags&=-65}function opCmp(e,t,s){const i=e.a+(255&~s)+1;e.flags=-132&e.flags|128&i|(255&i?0:2)|i>>>8}function opCpx(e,t,s){const i=e.x+(255&~s)+1;e.flags=-132&e.flags|128&i|(255&i?0:2)|i>>>8}function opCpy(e,t,s){const i=e.y+(255&~s)+1;e.flags=-132&e.flags|128&i|(255&i?0:2)|i>>>8}function opDec(e,t,s){const i=t.read(s)+255&255;t.write(s,i),setFlagsNZ$1(e,i)}function opDex(e){e.x=e.x+255&255,setFlagsNZ$1(e,e.x)}function opEor(e,t,s){e.a=e.a^s,setFlagsNZ$1(e,e.a)}function opDey(e){e.y=e.y+255&255,setFlagsNZ$1(e,e.y)}function opInc(e,t,s){const i=t.read(s)+1&255;t.write(s,i),setFlagsNZ$1(e,i)}function opInx(e){e.x=e.x+1&255,setFlagsNZ$1(e,e.x)}function opIny(e){e.y=e.y+1&255,setFlagsNZ$1(e,e.y)}function opJmp(e,t,s){e.p=s}function opJsr(e,t,s){const i=e.p+1&65535,r=t.read(e.p);t.read(256+e.s),t.write(256+e.s,i>>>8),e.s=e.s+255&255,t.write(256+e.s,255&i),e.s=e.s+255&255,e.p=r|t.read(e.p+1&65535)<<8}function opLda(e,t,s,i){e.a=1===i?s:t.read(s),setFlagsNZ$1(e,e.a)}function opLdx(e,t,s,i){e.x=1===i?s:t.read(s),setFlagsNZ$1(e,e.x)}function opLdy(e,t,s,i){e.y=1===i?s:t.read(s),setFlagsNZ$1(e,e.y)}function opLsrAcc(e){const t=e.a;e.a=e.a>>>1,e.flags=-132&e.flags|128&e.a|(e.a?0:2)|1&t}function opLsrMem(e,t,s){const i=t.read(s),r=i>>>1;t.write(s,r),e.flags=-132&e.flags|128&r|(r?0:2)|1&i}function opNop(){}function opOra(e,t,s){e.a|=s,setFlagsNZ$1(e,e.a)}function opPhp(e,t){t.write(256+e.s,16|e.flags),e.s=e.s+255&255}function opPlp(e,t){restoreFlagsFromStack(e,t)}function opPha(e,t){t.write(256+e.s,e.a),e.s=e.s+255&255}function opPla(e,t){e.s=e.s+1&255,e.a=t.read(256+e.s),setFlagsNZ$1(e,e.a)}function opRolAcc(e){const t=e.a;e.a=e.a<<1&255|1&e.flags,e.flags=-132&e.flags|128&e.a|(e.a?0:2)|t>>>7}function opRolMem(e,t,s){const i=t.read(s),r=i<<1&255|1&e.flags;t.write(s,r),e.flags=-132&e.flags|128&r|(r?0:2)|i>>>7}function opRorAcc(e){const t=e.a;e.a=e.a>>>1|(1&e.flags)<<7,e.flags=-132&e.flags|128&e.a|(e.a?0:2)|1&t}function opRorMem(e,t,s){const i=t.read(s),r=i>>>1|(1&e.flags)<<7;t.write(s,r),e.flags=-132&e.flags|128&r|(r?0:2)|1&i}function opRti(e,t){let s;restoreFlagsFromStack(e,t),e.s=e.s+1&255,s=t.read(256+e.s),e.s=e.s+1&255,s|=t.read(256+e.s)<<8,e.p=s}function opRts(e,t){let s;t.read(256+e.s),e.s=e.s+1&255,s=t.read(256+e.s),e.s=e.s+1&255,s+=t.read(256+e.s)<<8,e.p=s+1&65535}function opSbc(e,t,s){if(8&e.flags){const t=(15&e.a)-(15&s)-(1&~e.flags),i=(e.a>>>4)-(s>>>4)-(t<0?1:0);e.a=(t<0?10+t:t)|(i<0?10+i:i)<<4,e.flags=-132&e.flags|128&e.a|(e.a?0:2)|(i<0?0:1)}else{s=255&~s;const t=e.a+s+(1&e.flags),i=255&t;e.flags=-196&e.flags|128&i|(i?0:2)|t>>>8|(~(s^e.a)&(i^s)&128)>>>1,e.a=i}}function opSec(e){e.flags|=1}function opSed(e){e.flags|=8}function opSei(e){e.flags|=4}function opSta(e,t,s){t.write(s,e.a)}function opStx(e,t,s){t.write(s,e.x)}function opSty(e,t,s){t.write(s,e.y)}function opTax(e){e.x=e.a,setFlagsNZ$1(e,e.a)}function opTay(e){e.y=e.a,setFlagsNZ$1(e,e.a)}function opTsx(e){e.x=e.s,setFlagsNZ$1(e,e.x)}function opTxa(e){e.a=e.x,setFlagsNZ$1(e,e.a)}function opTxs(e){e.s=e.x}function opTya(e){e.a=e.y,setFlagsNZ$1(e,e.a)}function opAlr(e,t,s){const i=e.a&s;e.a=i>>>1,e.flags=-132&e.flags|128&e.a|(e.a?0:2)|1&i}function opAxs(e,t,s){const i=(e.a&e.x)+(255&~s)+1;e.x=255&i,e.flags=-132&e.flags|128&e.x|(255&e.x?0:2)|i>>>8}function opDcp(e,t,s){const i=t.read(s)+255&255;t.write(s,i);const r=e.a+(255&~i)+1;e.flags=-132&e.flags|128&r|(255&r?0:2)|r>>>8}function opLax(e,t,s){e.a=s,e.x=s,setFlagsNZ$1(e,s)}function opArr(e,t,s){e.a=(e.a&s)>>>1|(1&e.flags?128:0),e.flags=-196&e.flags|(64&e.a)>>>6|(e.a?0:2)|128&e.a|64&e.a^(32&e.a)<<1}function opSlo(e,t,s){let i=t.read(s);e.flags=-2&e.flags|i>>>7,i=i<<1&255,t.write(s,i),e.a=e.a|i,setFlagsNZ$1(e,e.a)}function opAax(e,t,s){const i=e.x&e.a;t.write(s,i),setFlagsNZ$1(e,i)}function opLar(e,t,s){e.s=e.a=e.x=e.s&s,setFlagsNZ$1(e,e.a)}function opIsc(e,t,s){const i=t.read(s)+1&255;t.write(s,i),opSbc(e,t,i)}function opAac(e,t,s){e.a&=s,setFlagsNZ$1(e,e.a),e.flags=-2&e.flags|(128&e.a)>>>7}function opAtx(e,t,s){e.a&=s,e.x=e.a,setFlagsNZ$1(e,e.a)}function opRra(e,t,s){const i=t.read(s),r=i>>>1|(1&e.flags)<<7;t.write(s,r),e.flags=-2&e.flags|1&i,opAdc(e,t,r)}function opRla(e,t,s){const i=t.read(s),r=i<<1&255|1&e.flags;t.write(s,r),e.flags=-2&e.flags|i>>>7,opAnd(e,t,r)}function opBoot(e,t){e.p=t.readWord(65532)}function dispatchInterrupt(e,t,s){const i=e.p;e.nmi&&(s=65530),e.nmi=e.irq=!1,t.write(e.s+256,i>>>8&255),e.s=e.s+255&255,t.write(e.s+256,255&i),e.s=e.s+255&255,t.write(e.s+256,-17&e.flags),e.s=e.s+255&255,e.flags|=4,e.p=t.readWord(s)}function opIrq(e,t){dispatchInterrupt(e,t,65534)}function opNmi(e,t){dispatchInterrupt(e,t,65530)}class BatchedAccessCpu{constructor(e,t){this._bus=e,this._rng=t,this.executionState=0,this.state=new CpuInterface.State,this._opCycles=0,this._instructionCallback=null,this._invalidInstructionCallback=null,this._interruptPending=!1,this._nmiPending=!1,this._interuptCheck=0,this._halted=!1,this._operand=0,this._lastInstructionPointer=0,this._currentAddressingMode=12,this._dereference=!1,this.reset()}setInterrupt(e){return this._interruptPending=e,this}isInterrupt(){return this._interruptPending}nmi(){return this._nmiPending=!0,this}halt(){return this._halted=!0,this}resume(){return this._halted=!1,this}isHalt(){return this._halted}setInvalidInstructionCallback(e){return this._invalidInstructionCallback=e,this}getInvalidInstructionCallback(){return this._invalidInstructionCallback}getLastInstructionPointer(){return this._lastInstructionPointer}reset(){return this.state.a=this._rng?this._rng.int(255):0,this.state.x=this._rng?this._rng.int(255):0,this.state.y=this._rng?this._rng.int(255):0,this.state.s=253,this.state.p=this._rng?this._rng.int(65535):0,this.state.flags=52|(this._rng?this._rng.int(255):0),this.state.irq=!1,this.state.nmi=!1,this.executionState=0,this._opCycles=7,this._interruptPending=!1,this._nmiPending=!1,this._instructionCallback=opBoot,this}cycle(){if(this._halted)return this;switch(this.executionState){case 0:case 2:0==--this._opCycles&&(this._dereference&&(this._operand=this._bus.read(this._operand)),1===this._interuptCheck&&this._checkForInterrupts(),this._instructionCallback(this.state,this._bus,this._operand,this._currentAddressingMode),this.executionState=1,0===this._interuptCheck&&this._checkForInterrupts());break;case 1:if(this.state.nmi)return this._instructionCallback=opNmi,this._opCycles=6,this.state.nmi=this.state.irq=!1,this._interuptCheck=1,this.executionState=2,this;if(this.state.irq)return this._instructionCallback=opIrq,this._opCycles=6,this.state.nmi=this.state.irq=!1,this._interuptCheck=1,this.executionState=2,this;this._fetch()}return this}_fetch(){const e=Instruction.opcodes[this._bus.read(this.state.p)];let t,s,i=e.addressingMode,r=!1,a=!1;switch(this._lastInstructionPointer=this.state.p,this._currentAddressingMode=i,this._interuptCheck=0,e.operation){case 0:this._opCycles=0,this._instructionCallback=opAdc,r=!0;break;case 1:this._opCycles=0,this._instructionCallback=opAnd,r=!0;break;case 2:0===i?(this._opCycles=1,this._instructionCallback=opAslAcc):(this._opCycles=3,this._instructionCallback=opAslMem,a=!0);break;case 3:1&this.state.flags?(i=0,this._instructionCallback=opNop,this.state.p=this.state.p+1&65535,this._opCycles=1):(this._instructionCallback=opJmp,this._opCycles=0);break;case 4:1&this.state.flags?(this._instructionCallback=opJmp,this._opCycles=0):(i=0,this._instructionCallback=opNop,this.state.p=this.state.p+1&65535,this._opCycles=1);break;case 5:2&this.state.flags?(this._instructionCallback=opJmp,this._opCycles=0):(i=0,this._instructionCallback=opNop,this.state.p=this.state.p+1&65535,this._opCycles=1);break;case 6:this._opCycles=0,this._instructionCallback=opBit,r=!0;break;case 7:128&this.state.flags?(this._instructionCallback=opJmp,this._opCycles=0):(i=0,this._instructionCallback=opNop,this.state.p=this.state.p+1&65535,this._opCycles=1);break;case 8:2&this.state.flags?(i=0,this._instructionCallback=opNop,this.state.p=this.state.p+1&65535,this._opCycles=1):(this._instructionCallback=opJmp,this._opCycles=0);break;case 9:128&this.state.flags?(i=0,this._instructionCallback=opNop,this.state.p=this.state.p+1&65535,this._opCycles=1):(this._instructionCallback=opJmp,this._opCycles=0);break;case 11:64&this.state.flags?(i=0,this._instructionCallback=opNop,this.state.p=this.state.p+1&65535,this._opCycles=1):(this._instructionCallback=opJmp,this._opCycles=0);break;case 12:64&this.state.flags?(this._instructionCallback=opJmp,this._opCycles=0):(i=0,this._instructionCallback=opNop,this.state.p=this.state.p+1&65535,this._opCycles=1);break;case 10:this._opCycles=6,this._instructionCallback=opBrk,this._interuptCheck=1;break;case 13:this._opCycles=1,this._instructionCallback=opClc;break;case 14:this._opCycles=1,this._instructionCallback=opCld;break;case 15:this._opCycles=1,this._instructionCallback=opCli,this._interuptCheck=1;break;case 16:this._opCycles=1,this._instructionCallback=opClv;break;case 17:this._opCycles=0,this._instructionCallback=opCmp,r=!0;break;case 18:this._opCycles=0,this._instructionCallback=opCpx,r=!0;break;case 19:this._opCycles=0,this._instructionCallback=opCpy,r=!0;break;case 20:this._opCycles=3,this._instructionCallback=opDec,a=!0;break;case 21:this._opCycles=1,this._instructionCallback=opDex;break;case 22:this._opCycles=1,this._instructionCallback=opDey;break;case 23:this._opCycles=0,this._instructionCallback=opEor,r=!0;break;case 24:this._opCycles=3,this._instructionCallback=opInc,a=!0;break;case 25:this._opCycles=1,this._instructionCallback=opInx;break;case 26:this._opCycles=1,this._instructionCallback=opIny;break;case 27:this._opCycles=0,this._instructionCallback=opJmp;break;case 28:this._opCycles=5,this._instructionCallback=opJsr;break;case 29:this._opCycles=1===i?0:1,this._instructionCallback=opLda;break;case 30:this._opCycles=1===i?0:1,this._instructionCallback=opLdx;break;case 31:this._opCycles=1===i?0:1,this._instructionCallback=opLdy;break;case 32:0===i?(this._opCycles=1,this._instructionCallback=opLsrAcc):(this._opCycles=3,this._instructionCallback=opLsrMem,a=!0);break;case 33:this._opCycles=1,this._instructionCallback=opNop;break;case 56:case 57:this._opCycles=0,r=!0,this._instructionCallback=opNop;break;case 34:this._opCycles=0,this._instructionCallback=opOra,r=!0;break;case 36:this._opCycles=2,this._instructionCallback=opPhp;break;case 35:this._opCycles=2,this._instructionCallback=opPha;break;case 37:this._opCycles=3,this._instructionCallback=opPla;break;case 38:this._opCycles=3,this._instructionCallback=opPlp,this._interuptCheck=1;break;case 39:0===i?(this._opCycles=1,this._instructionCallback=opRolAcc):(this._opCycles=3,this._instructionCallback=opRolMem,a=!0);break;case 40:0===i?(this._opCycles=1,this._instructionCallback=opRorAcc):(this._opCycles=3,this._instructionCallback=opRorMem,a=!0);break;case 41:this._opCycles=5,this._instructionCallback=opRti;break;case 42:this._opCycles=5,this._instructionCallback=opRts;break;case 43:this._opCycles=0,this._instructionCallback=opSbc,r=!0;break;case 44:this._opCycles=1,this._instructionCallback=opSec;break;case 45:this._opCycles=1,this._instructionCallback=opSed;break;case 46:this._opCycles=1,this._instructionCallback=opSei,this._interuptCheck=1;break;case 47:this._opCycles=1,this._instructionCallback=opSta,a=!0;break;case 48:this._opCycles=1,this._instructionCallback=opStx,a=!0;break;case 49:this._opCycles=1,this._instructionCallback=opSty,a=!0;break;case 50:this._opCycles=1,this._instructionCallback=opTax;break;case 51:this._opCycles=1,this._instructionCallback=opTay;break;case 52:this._opCycles=1,this._instructionCallback=opTsx;break;case 53:this._opCycles=1,this._instructionCallback=opTxa;break;case 54:this._opCycles=1,this._instructionCallback=opTxs;break;case 55:this._opCycles=1,this._instructionCallback=opTya;break;case 62:this._opCycles=0,this._instructionCallback=opArr;break;case 58:this._opCycles=0,this._instructionCallback=opAlr;break;case 59:this._opCycles=0,this._instructionCallback=opAxs;break;case 60:this._opCycles=3,this._instructionCallback=opDcp,a=!0;break;case 61:this._opCycles=0,this._instructionCallback=opLax,r=!0;break;case 63:this._opCycles=3,this._instructionCallback=opSlo,a=!0,r=!1;break;case 64:this._opCycles=1,this._instructionCallback=opAax;break;case 65:this._opCycles=0,this._instructionCallback=opLar,r=!0;break;case 66:this._opCycles=3,this._instructionCallback=opIsc,a=!0;break;case 67:this._opCycles=0,this._instructionCallback=opAac;break;case 68:this._opCycles=0,this._instructionCallback=opAtx;break;case 69:this._opCycles=3,r=!1,a=!0,this._instructionCallback=opRra;break;case 70:this._opCycles=3,r=!1,a=!0,this._instructionCallback=opRla;break;default:return void(this._invalidInstructionCallback&&this._invalidInstructionCallback(this))}switch(this.state.p=this.state.p+1&65535,i){case 1:this._operand=this._bus.read(this.state.p),r=!1,this.state.p=this.state.p+1&65535,this._opCycles++;break;case 2:this._operand=this._bus.read(this.state.p),this.state.p=this.state.p+1&65535,this._opCycles++;break;case 3:this._operand=this._bus.readWord(this.state.p),this.state.p=this.state.p+2&65535,this._opCycles+=2;break;case 4:t=this._bus.readWord(this.state.p),this._operand=255==(255&t)?this._bus.read(t)+(this._bus.read(65280&t)<<8):this._bus.readWord(t),this.state.p=this.state.p+2&65535,this._opCycles+=4;break;case 5:t=this._bus.read(this.state.p),t=128&t?-(255&~(t-1)):t,this._operand=this.state.p+t+65537&65535,this.state.p=this.state.p+1&65535,this._opCycles+=(65280&this._operand)!=(65280&this.state.p)?3:2;break;case 6:s=this._bus.read(this.state.p),this._bus.read(s),this._operand=s+this.state.x&255,this.state.p=this.state.p+1&65535,this._opCycles+=2;break;case 7:t=this._bus.readWord(this.state.p),this._operand=t+this.state.x&65535,(65280&this._operand)!=(65280&t)&&this._bus.read(65280&t|255&this._operand),this._opCycles+=a||(65280&this._operand)!=(65280&t)?3:2,this.state.p=this.state.p+2&65535;break;case 9:s=this._bus.read(this.state.p),this._bus.read(s),this._operand=s+this.state.y&255,this.state.p=this.state.p+1&65535,this._opCycles+=2;break;case 10:t=this._bus.readWord(this.state.p),this._operand=t+this.state.y&65535,(65280&this._operand)!=(65280&t)&&this._bus.read(65280&t|255&this._operand),this._opCycles+=a||(65280&this._operand)!=(65280&t)?3:2,this.state.p=this.state.p+2&65535;break;case 8:s=this._bus.read(this.state.p),this._bus.read(s),t=s+this.state.x&255,this._operand=255===t?this._bus.read(255)+(this._bus.read(0)<<8):this._bus.readWord(t),this._opCycles+=4,this.state.p=this.state.p+1&65535;break;case 11:t=this._bus.read(this.state.p),t=255===t?this._bus.read(255)+(this._bus.read(0)<<8):this._bus.readWord(t),this._operand=t+this.state.y&65535,(65280&this._operand)!=(65280&t)&&this._bus.read(65280&t|255&this._operand),this._opCycles+=a||(65280&t)!=(65280&this._operand)?4:3,this.state.p=this.state.p+1&65535}this._dereference=r,r&&this._opCycles++,this.executionState=2}_checkForInterrupts(){this._nmiPending&&(this.state.irq=!1,this.state.nmi=!0,this._nmiPending=!1),!this._interruptPending||this.state.nmi||4&this.state.flags||(this.state.irq=!0)}}class Factory{constructor(e){this._type=e}create(e,t){switch(this._type){case Factory.Type.stateMachine:return new StateMachineCpu(e,t);case Factory.Type.batchedAccess:return new BatchedAccessCpu(e,t);default:throw new Error("invalid CPU type")}}}!function(e){let t;!function(e){e[e.stateMachine=0]="stateMachine",e[e.batchedAccess=1]="batchedAccess"}(t=e.Type||(e.Type={}))}(Factory||(Factory={}));var CpuFactory=Factory,Config;!function(e){e.create=function(e={}){return Object.assign({tvMode:0,enableAudio:!0,randomSeed:-1,emulatePaddles:!0,frameStart:-1,pcmAudio:!1,cpuType:CpuFactory.Type.stateMachine},e)},e.getClockHz=function(e){switch(e.tvMode){case 0:return 3584160;case 1:case 2:return 3556800}}}(Config||(Config={}));const encodingsString="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",encodings=new Uint8Array(256);function decodeChar(e,t){const s=encodings[e.charCodeAt(t)];if(s>63)throw new Error('invalid base64 character "'+e[t]+'" at index '+t);return s}function decodeNibble(e,t){return(decodeChar(e,t)<<18)+(decodeChar(e,t+1)<<12)+(decodeChar(e,t+2)<<6)+decodeChar(e,t+3)}function getPadding(e){let t=0,s=e.length-1;for(;s>=0&&"="===e[s--];)t++;return t}function decode(e){if(e.length%4!=0)throw new Error("invalid base64 data --- char count mismatch");const t=e.length/4,s=3*t-getPadding(e),i=new Uint8Array(s);let r=0;for(let a=0;a<t;a++){const t=decodeNibble(e,4*a);for(let e=0;e<3&&r<s;e++)i[r++]=t>>>8*(2-e)&255}return i}!function(e){let t;for(t=0;t<256;t++)encodings[t]=255;for(t=0;t<64;t++)encodings[encodingsString.charCodeAt(t)]=t;encodings["=".charCodeAt(0)]=0}();const FREQUENCY_DIVISIORS=decode("AQEPAQEBAQEBAQEBAwMDAQ=="),POLY0=new Int8Array([1]),POLY1=new Int8Array([1,1]),POLY2=new Int8Array([16,15]),POLY4=decode("AQICAQEBBAM="),POLY5=decode("AQIBAQICBQQCAQMBAQEBBA=="),POLY9=decode("AQQBAwIEAQIDAgEBAQEBAQIEAgEEAQECAgEDAgEDAQEBBAEBAQECAQECBgECAgECAQIBAQIBBgIBAgIBAQEBAgICAgcCAwICAQEBAwIBAQIBAQcBAQMBAQIDAwEBAQICAQECAgQDBQEDAQEFAgEBAQIBAgEDAQIFAQECAQEBBQEBAQEBAQEBBgEBAQIBAQEBBAIBAQMBAwYDAgMBAQIBAgQBAQEDAQEBAQMBAgEEAgIDBAEBBAECAQICAgEBBAMBBAQJBQQBBQMBAQMCAgIBBQECAQEBAgMBAgEBAwQCBQICAQIDAQEBAQECAQMDAwIBAgEBAQEBAwMBAgIDAQMBCA=="),POLY68=decode("BQYEBQoFAwcECgYDBgQJBg=="),POLY465=decode("AgMCAQQBBgoCBAIBAQQFCQMDBAEBAQgFBQUEAQEBCAQCCAMDAQEHBAIHBQEDAQcEAQQIAgEDBAcBAwcDAgEGBgICBAUDAgYGAQMDAgUDBwMEAwICAgUJAwEFAwECAgsFAQUDAQECDAUBAgUCAQEMBgECBQECAQoGAwICBAECBgo="),POLYS=[POLY0,POLY4,POLY4,POLY465,POLY1,POLY1,POLY2,POLY5,POLY9,POLY5,POLY2,POLY0,POLY1,POLY1,POLY2,POLY68];class ToneGenerator{constructor(e){this._config=e}setConfig(e){this._config=e}getKey(e,t){return POLYS[e]===POLY1&&FREQUENCY_DIVISIORS[e]*(t+1)==1?0:e<<5|t}getBuffer(e){const t=e>>>5&15,s=31&e,i=POLYS[t];let r=0;for(let e=0;e<i.length;e++)r+=i[e];r=r*FREQUENCY_DIVISIORS[t]*(s+1);const a=new Float32Array(r),n=Config.getClockHz(this._config)/114;let o=0,h=0,c=0,u=!0;for(let e=0;e<r;e++)o++,o===FREQUENCY_DIVISIORS[t]*(s+1)&&(o=0,h++,h===i[c]&&(c++,h=0,i.length===c&&(c=0)),u=!(1&c)),a[e]=u?1:-1;return new AudioOutputBuffer(a,n)}}class WaveformAudio{constructor(e){this._config=e,this.bufferChanged=new lib_1,this.volumeChanged=new lib_1,this.stop=new lib_1,this._volume=-1,this._tone=-1,this._frequency=-1,this._active=!1,this._toneGenerator=null,this._toneGenerator=new ToneGenerator(this._config),this.reset()}reset(){this._volume=-1,this._tone=-1,this._frequency=-1}audc(e){(e&=15)!==this._tone&&(this._tone=e,this._dispatchBufferChanged())}audf(e){(e&=31)!==this._frequency&&(this._frequency=e,this._dispatchBufferChanged())}audv(e){(e&=15)!==this._volume&&(this._volume=e/15,this.volumeChanged.dispatch(this._volume))}setActive(e){this._active=e,e?this._dispatchBufferChanged():this.stop.dispatch(void 0)}getVolume(){return this._volume>=0?this._volume:0}getBuffer(e){return this._toneGenerator.getBuffer(e)}_getKey(){return this._toneGenerator.getKey(this._tone,this._frequency)}_dispatchBufferChanged(){this._active&&this.bufferChanged.hasHandlers&&this.bufferChanged.dispatch(this._getKey())}}class PCMChannel{constructor(){this._audv=0,this._audc=0,this._audf=0,this._clkEnable=!1,this._noiseFeedback=!1,this._noiseCounterBit4=!1,this._pulseCounterHold=!1,this._divCounter=0,this._noiseCounter=0,this._pulseCounter=0,this.reset()}reset(){this._audc=this._audf=this._audv=0,this._clkEnable=!1,this._noiseFeedback=!1,this._noiseCounterBit4=!1,this._pulseCounterHold=!1,this._divCounter=0,this._noiseCounter=0,this._pulseCounter=0}phase0(){if(this._clkEnable){switch(this._noiseCounterBit4=!!(1&this._noiseCounter),3&this._audc){case 0:case 1:this._pulseCounterHold=!1;break;case 2:this._pulseCounterHold=2!=(30&this._noiseCounter);break;case 3:this._pulseCounterHold=!this._noiseCounterBit4}switch(3&this._audc){case 0:this._noiseFeedback=!(!(1&(this._pulseCounter^this._noiseCounter))&&(0!==this._noiseCounter||10!==this._pulseCounter)&&12&this._audc);break;default:this._noiseFeedback=!!((4&this._noiseCounter?1:0)^1&this._noiseCounter)||0===this._noiseCounter}}this._clkEnable=this._divCounter===this._audf,this._divCounter===this._audf||31===this._divCounter?this._divCounter=0:this._divCounter++}phase1(){let e=!1;if(this._clkEnable){switch(this._audc>>>2){case 0:e=!!((2&this._pulseCounter?1:0)^1&this._pulseCounter)&&10!==this._pulseCounter&&!!(3&this._audc);break;case 1:e=!(8&this._pulseCounter);break;case 2:e=!this._noiseCounterBit4;break;case 3:e=!(2&this._pulseCounter||!(14&this._pulseCounter))}this._noiseCounter>>>=1,this._noiseFeedback&&(this._noiseCounter|=16),this._pulseCounterHold||(this._pulseCounter=7&~(this._pulseCounter>>>1),e&&(this._pulseCounter|=8))}return(1&this._pulseCounter)*this._audv}audc(e){this._audc=15&e}audf(e){this._audf=31&e}audv(e){this._audv=15&e}}const R_MAX=30,R=1,VOL_MAX=30,mixingTable=new Float32Array(VOL_MAX+1);!function(e){for(let e=0;e<=VOL_MAX;e++)mixingTable[e]=e/VOL_MAX*(R_MAX+R*VOL_MAX)/(R_MAX+R*e)}();class PCMAudio{constructor(e){this._config=e,this.newFrame=new lib_1,this.togglePause=new lib_1,this._currentOutputBuffer=null,this._bufferIndex=0,this._sampleRate=0,this._counter=0,this._isActive=!1,this._channel0=new PCMChannel,this._channel1=new PCMChannel,this._sampleRate=2*(0===this._config.tvMode?15720:15600),this._frameSize=4*(0===this._config.tvMode?262:312),this.reset()}getChannels(){return[{audv:e=>this._channel0.audv(e),audc:e=>this._channel0.audc(e),audf:e=>this._channel0.audf(e),reset:()=>this.reset(),setActive:e=>this.setActive(e)},{audv:e=>this._channel1.audv(e),audc:e=>this._channel1.audc(e),audf:e=>this._channel1.audf(e),reset:()=>void 0,setActive:()=>void 0}]}reset(){this._bufferIndex=0,this._counter=0,this._channel0.reset(),this._channel1.reset()}tick(){switch(this._counter){case 9:case 81:this._channel0.phase0(),this._channel1.phase0();break;case 37:case 149:this._currentOutputBuffer.getContent()[this._bufferIndex++]=mixingTable[this._channel0.phase1()+this._channel1.phase1()],this._bufferIndex===this._currentOutputBuffer.getLength()&&this._dispatchBuffer()}228==++this._counter&&(this._counter=0)}isPaused(){return!this._isActive}setActive(e){e!==this._isActive&&(this._isActive=e,this.togglePause.dispatch(!e))}getSampleRate(){return this._sampleRate}getFrameSize(){return this._frameSize}setFrameBufferFactory(e){this._bufferFactory=e,!this._currentOutputBuffer&&e&&(this._currentOutputBuffer=e(),this._bufferIndex=0)}_dispatchBuffer(){this.newFrame.dispatch(this._currentOutputBuffer),this._currentOutputBuffer=this._bufferFactory?this._bufferFactory():null,this._bufferIndex=0}}const decodes0=new Uint8Array(160),decodes1=new Uint8Array(160),decodes2=new Uint8Array(160),decodes3=new Uint8Array(160),decodes4=new Uint8Array(160),decodes6=new Uint8Array(160),decodesMissile=[decodes0,decodes1,decodes2,decodes3,decodes4,decodes0,decodes6,decodes0],decodesPlayer=[decodes0,decodes1,decodes2,decodes3,decodes4,decodes0,decodes6,decodes0];[decodes0,decodes1,decodes2,decodes3,decodes4,decodes6].forEach(e=>{for(let t=0;t<160;t++)e[t]=0;e[156]=1}),decodes1[12]=1,decodes2[28]=1,decodes3[12]=decodes3[28]=1,decodes4[60]=1,decodes6[28]=decodes6[60]=1;class Missile{constructor(e,t){this._collisionMask=e,this._flushLineCache=t,this.color=4294967295,this.collision=0,this._enabled=!1,this._enam=!1,this._resmp=-1,this._hmmClocks=0,this._counter=0,this._moving=!1,this._width=1,this._effectiveWidth=0,this._lastMovementTick=0,this._rendering=!1,this._renderCounter=-4,this._widths=new Uint8Array([1,2,4,8]),this.reset()}reset(){this.color=4294967295,this._width=1,this._enabled=!1,this._counter=0,this._rendering=!1,this._renderCounter=-4,this._moving=!1,this._hmmClocks=0,this._decodes=decodesMissile[0],this._resmp=-1,this._enam=!1,this._effectiveWidth=0,this._lastMovementTick=0}enam(e){const t=(2&e)>0,s=t&&0===this._resmp;t===this._enam&&s===this._enabled||this._flushLineCache(),this._enam=t,this._enabled=s}hmm(e){this._hmmClocks=e>>>4^8}resm(e,t){if(this._counter=e,this._rendering)if(this._renderCounter<0)this._renderCounter=e-157-4;else switch(this._width){case 8:this._renderCounter=e-157+(this._renderCounter>=4?4:0);break;case 4:this._renderCounter=e-157;break;case 2:t?this._rendering=this._renderCounter>1:0===this._renderCounter&&this._renderCounter++;break;default:t&&(this._rendering=this._renderCounter>0)}}resmp(e,t){const s=2&e;s!==this._resmp&&(this._flushLineCache(),this._resmp=s,s?this._enabled=!1:(this._enabled=this._enam,this._counter=t.getRespClock()))}nusiz(e){this._width=this._widths[(48&e)>>>4],this._decodes=decodesMissile[7&e],this._rendering&&this._renderCounter>=this._width&&(this._rendering=!1)}startMovement(){this._moving=!0}movementTick(e,t){return this._lastMovementTick=this._counter,e===this._hmmClocks&&(this._moving=!1),this._moving&&t&&this.tick(!1),this._moving}tick(e){this.collision=this._rendering&&this._renderCounter>=0&&this._enabled?0:this._collisionMask;const t=this._moving&&e;if(this._decodes[this._counter]&&!this._resmp){const e=(this._counter-this._lastMovementTick+160)%4;switch(this._rendering=!0,this._renderCounter=-4,t&&3===e&&this._width<4&&this._renderCounter++,e){case 3:this._effectiveWidth=1===this._width?2:this._width;break;case 2:this._effectiveWidth=0;break;default:this._effectiveWidth=this._width}}else this._rendering&&++this._renderCounter>=(t?this._effectiveWidth:this._width)&&(this._rendering=!1);++this._counter>=160&&(this._counter=0)}getPixel(e){return this.collision?e:this.color}setColor(e){e!==this.color&&this._enabled&&this._flushLineCache(),this.color=e}}class Playfield{constructor(e,t){this._collisionMask=e,this._flushLineCache=t,this.collision=0,this._colorLeft=0,this._colorRight=0,this._color=0,this._colorP0=0,this._colorP1=0,this._colorMode=0,this._pattern=0,this._refp=!1,this._reflected=!1,this._pf0=0,this._pf1=0,this._pf2=0,this._x=0,this.reset()}reset(){this._pattern=0,this._reflected=!1,this._refp=!1,this._pf0=0,this._pf1=0,this._pf2=0,this._color=0,this._colorP0=0,this._colorP1=0,this._colorMode=0,this._applyColors()}pf0(e){this._pf0!==e>>>4&&(this._flushLineCache(),this._pf0=e>>>4,this._pattern=1048560&this._pattern|this._pf0)}pf1(e){this._pf1!==e&&(this._flushLineCache(),this._pf1=e,this._pattern=1044495&this._pattern|(128&e)>>>3|(64&e)>>>1|(32&e)<<1|(16&e)<<3|(8&e)<<5|(4&e)<<7|(2&e)<<9|(1&e)<<11)}pf2(e){this._pf2!==e&&(this._flushLineCache(),this._pf2=e,this._pattern=4095&this._pattern|(255&e)<<12)}ctrlpf(e){const t=(1&e)>0,s=2==(6&e)?1:0;t===this._reflected&&s===this._colorMode||(this._flushLineCache(),this._reflected=t,this._colorMode=s,this._applyColors())}setColor(e){e!==this._color&&0===this._colorMode&&this._flushLineCache(),this._color=e,this._applyColors()}setColorP0(e){e!==this._colorP0&&1===this._colorMode&&this._flushLineCache(),this._colorP0=e,this._applyColors()}setColorP1(e){e!==this._colorP1&&1===this._colorMode&&this._flushLineCache(),this._colorP1=e,this._applyColors()}tick(e){if(this._x=e,80!==e&&0!==e||(this._refp=this._reflected),3&e)return;let t;t=0===this._pattern?0:e<80?this._pattern&1<<(e>>>2):this._refp?this._pattern&1<<39-(e>>>2):this._pattern&1<<(e>>>2)-20,this.collision=t?0:this._collisionMask}getPixel(e){return this.collision?e:this._x<80?this._colorLeft:this._colorRight}_applyColors(){switch(this._colorMode){case 0:this._colorLeft=this._colorRight=this._color;break;case 1:this._colorLeft=this._colorP0,this._colorRight=this._colorP1}}}class Player{constructor(e,t){this._collisionMask=e,this._flushLineCache=t,this.color=4294967295,this.collision=0,this._hmmClocks=0,this._counter=0,this._moving=!1,this._divider=1,this._dividerPending=1,this._dividerChangeCounter=-1,this._sampleCounter=0,this._rendering=!1,this._renderCounter=-5,this._renderCounterTripPoint=0,this._patternNew=0,this._patternOld=0,this._pattern=0,this._reflected=!1,this._delaying=!1,this.reset()}reset(){this.color=4294967295,this.collision=0,this._hmmClocks=0,this._counter=0,this._moving=!1,this._rendering=!1,this._renderCounter=-5,this._decodes=decodesPlayer[0],this._patternNew=0,this._patternOld=0,this._pattern=0,this._reflected=!1,this._delaying=!1,this._sampleCounter=0,this._dividerPending=0,this._dividerChangeCounter=-1,this._setDivider(1)}grp(e){e!==this._patternNew&&(this._patternNew=e,this._delaying||(this._flushLineCache(),this._updatePattern()))}hmp(e){this._hmmClocks=e>>>4^8}nusiz(e,t){const s=7&e;switch(s){case 5:this._dividerPending=2;break;case 7:this._dividerPending=4;break;default:this._dividerPending=1}const i=this._decodes;if(this._decodes=decodesPlayer[s],this._decodes!==i&&this._rendering&&this._renderCounter- -5<2&&!this._decodes[(this._counter-this._renderCounter-5+159)%160]&&(this._rendering=!1),this._dividerPending===this._divider)return;if(!this._rendering)return void this._setDivider(this._dividerPending);const r=this._renderCounter- -5;switch(this._divider<<4|this._dividerPending){case 18:case 20:t?r<4?this._setDivider(this._dividerPending):this._dividerChangeCounter=r<5?1:0:r<3?this._setDivider(this._dividerPending):this._dividerChangeCounter=1;break;case 33:case 65:r<(t?4:3)?this._setDivider(this._dividerPending):r<(t?6:5)?(this._setDivider(this._dividerPending),this._renderCounter--):this._dividerChangeCounter=t?0:1;break;case 66:case 36:this._renderCounter<1||t&&this._renderCounter%this._divider==1?this._setDivider(this._dividerPending):this._dividerChangeCounter=this._divider-(this._renderCounter-1)%this._divider;break;default:throw new Error("cannot happen")}}resp(e){this._counter=e,this._rendering&&this._renderCounter- -5<4&&(this._renderCounter=e-157-5)}refp(e){const t=this._reflected;this._reflected=(8&e)>0,this._reflected!==t&&(this._flushLineCache(),this._updatePattern())}vdelp(e){const t=this._delaying;this._delaying=(1&e)>0,this._delaying!==t&&(this._flushLineCache(),this._updatePattern())}startMovement(){this._moving=!0}movementTick(e,t){return e===this._hmmClocks&&(this._moving=!1),this._moving&&t&&this.tick(),this._moving}tick(){if(this.collision=this._rendering&&this._renderCounter>=this._renderCounterTripPoint&&this._pattern&1<<this._sampleCounter?0:this._collisionMask,this._decodes[this._counter])this._rendering=!0,this._renderCounter=-5,this._sampleCounter=0;else if(this._rendering){switch(this._renderCounter++,this._divider){case 1:this._renderCounter>0&&this._sampleCounter++,this._renderCounter>=0&&this._dividerChangeCounter>=0&&0==this._dividerChangeCounter--&&this._setDivider(this._dividerPending);break;default:this._renderCounter>1&&(this._renderCounter-1)%this._divider==0&&this._sampleCounter++,this._renderCounter>0&&this._dividerChangeCounter>=0&&0==this._dividerChangeCounter--&&this._setDivider(this._dividerPending)}this._sampleCounter>7&&(this._rendering=!1)}++this._counter>=160&&(this._counter=0)}getPixel(e){return this.collision?e:this.color}shufflePatterns(){const e=this._patternOld;this._patternOld=this._patternNew,this._delaying&&e!==this._patternOld&&(this._flushLineCache(),this._updatePattern())}getRespClock(){switch(this._divider){case 1:return(this._counter-5+160)%160;case 2:return(this._counter-9+160)%160;case 4:return(this._counter-12+160)%160;default:throw new Error(`cannot happen: invalid divider ${this._divider}`)}}setColor(e){e!==this.color&&this._pattern&&this._flushLineCache(),this.color=e}_updatePattern(){this._pattern=this._delaying?this._patternOld:this._patternNew,this._reflected||(this._pattern=(1&this._pattern)<<7|(2&this._pattern)<<5|(4&this._pattern)<<3|(8&this._pattern)<<1|(16&this._pattern)>>>1|(32&this._pattern)>>>3|(64&this._pattern)>>>5|(128&this._pattern)>>>7)}_setDivider(e){this._divider=e,this._renderCounterTripPoint=1===e?0:1}}class Ball{constructor(e,t){this._collisionMask=e,this._flushLineCache=t,this.color=4294967295,this.collision=0,this._enabledOld=!1,this._enabledNew=!1,this._enabled=!1,this._hmmClocks=0,this._counter=0,this._moving=!1,this._width=1,this._effectiveWidth=0,this._lastMovementTick=0,this._rendering=!1,this._renderCounter=-4,this._widths=new Uint8Array([1,2,4,8]),this._delaying=!1,this.reset()}reset(){this.color=4294967295,this.collision=0,this._width=1,this._enabledOld=!1,this._enabledNew=!1,this._enabled=!1,this._counter=0,this._rendering=!1,this._renderCounter=-4,this._moving=!1,this._hmmClocks=0,this._delaying=!1,this._effectiveWidth=0,this._lastMovementTick=0}enabl(e){const t=this._enabledNew;this._enabledNew=(2&e)>0,t===this._enabledNew||this._delaying||(this._flushLineCache(),this._updateEnabled())}hmbl(e){this._hmmClocks=e>>>4^8}resbl(e){this._counter=e,this._rendering=!0,this._renderCounter=e-157-4}ctrlpf(e){const t=this._widths[(48&e)>>>4];t!==this._width&&this._flushLineCache(),this._width=t}vdelbl(e){const t=this._delaying;this._delaying=(1&e)>0,t!==this._delaying&&(this._flushLineCache(),this._updateEnabled())}startMovement(){this._moving=!0}movementTick(e,t){return this._lastMovementTick=this._counter,e===this._hmmClocks&&(this._moving=!1),this._moving&&t&&this.tick(!1),this._moving}tick(e){this.collision=this._rendering&&this._renderCounter>=0&&this._enabled?0:this._collisionMask;const t=this._moving&&e;if(156===this._counter){const e=(this._counter-this._lastMovementTick+160)%4;switch(this._rendering=!0,this._renderCounter=-4,t&&3===e&&this._width<4&&this._renderCounter++,e){case 3:this._effectiveWidth=1===this._width?2:this._width;break;case 2:this._effectiveWidth=0;break;default:this._effectiveWidth=this._width}}else this._rendering&&++this._renderCounter>=(t?this._effectiveWidth:this._width)&&(this._rendering=!1);++this._counter>=160&&(this._counter=0)}getPixel(e){return this.collision?e:this.color}shuffleStatus(){const e=this._enabledOld;this._enabledOld=this._enabledNew,this._delaying&&this._enabledOld!==e&&(this._flushLineCache(),this._updateEnabled())}setColor(e){e!==this.color&&this._enabled&&this._flushLineCache(),this.color=e}_updateEnabled(){this._enabled=this._delaying?this._enabledOld:this._enabledNew}}class LatchedInput{constructor(e){this._switch=e,this._modeLatched=!1,this._latchedValue=0,this.reset()}reset(){this._modeLatched=!1,this._latchedValue=0}vblank(e){64&e?this._modeLatched=!0:(this._modeLatched=!1,this._latchedValue=128)}inpt(){let e=this._switch.read()?0:128;return this._modeLatched&&(this._latchedValue&=e,e=this._latchedValue),e}}const C=68e-9,RPOT=1e6,R0=1800,U=5,LINES_FULL=380;class PaddleReader{constructor(e,t){this._paddle=t,this._uThresh=0,this._u=0,this._dumped=!1,this._value=.5,this._timestamp=0,this._cpuTimeProvider=null,this._uThresh=U*(1-Math.exp(228*-LINES_FULL/e/(RPOT+R0)/C)),this._paddle.valueChanged.addHandler(e=>{this._updateValue(),this._value=e}),this.reset()}setCpuTimeProvider(e){this._cpuTimeProvider=e,this._timestamp=this._cpuTimeProvider()}reset(){this._u=0,this._value=this._paddle.getValue(),this._dumped=!1,this._timestamp=this._cpuTimeProvider?this._cpuTimeProvider():0}vblank(e){const t=this._dumped;128&e?(this._dumped=!0,this._u=0):t&&(this._dumped=!1,this._timestamp=this._cpuTimeProvider())}inpt(){return this._updateValue(),!this._dumped&&this._u>=this._uThresh?128:0}_updateValue(){if(this._dumped)return;const e=this._cpuTimeProvider();this._u=U*(1-(1-this._u/U)*Math.exp(-(e-this._timestamp)/(this._value*RPOT+R0)/C)),this._timestamp=e}}class FrameManager{constructor(e){switch(this._config=e,this.newFrame=new lib_1,this.vblank=!1,this.surfaceBuffer=null,this._vblankLines=0,this._kernelLines=0,this._overscanLines=0,this._linesWithoutVsync=0,this._state=0,this._vsync=!1,this._lineInState=0,this._surfaceFactory=null,this._surface=null,this._frameStart=-1,this._config.tvMode){case 0:this._vblankLines=40,this._kernelLines=192,this._overscanLines=30;break;case 1:case 2:this._vblankLines=48,this._kernelLines=228,this._overscanLines=36;break;default:throw new Error(`invalid tv mode ${this._config.tvMode}`)}this._frameStart=this._config.frameStart,this.reset()}reset(){this.vblank=!1,this.surfaceBuffer=null,this._linesWithoutVsync=0,this._state=0,this._vsync=!1,this._lineInState=0,this._surface=null}nextLine(){if(this._surfaceFactory)switch(this._lineInState++,this._state){case 0:case 1:++this._linesWithoutVsync>150&&this._setState(2);break;case 2:this._frameStart>=0?this._lineInState>this._frameStart&&this._startFrame():this._lineInState>=(this.vblank?this._vblankLines:this._vblankLines-10)&&this._startFrame();break;case 3:this._lineInState>=this._kernelLines+20&&this._finalizeFrame();break;case 4:this._lineInState>=this._overscanLines-20&&this._setState(0)}}isRendering(){return 3===this._state&&!!this._surface}setVblank(e){this._surfaceFactory&&(this.vblank=e)}setVsync(e){if(this._surfaceFactory&&e!==this._vsync)switch(this._vsync=e,this._state){case 0:this._linesWithoutVsync=0;case 2:case 4:e&&this._setState(1);break;case 1:e||this._setState(2);break;case 3:e&&this._finalizeFrame()}}getHeight(){return this._kernelLines+20}setSurfaceFactory(e){this._surfaceFactory=e}getCurrentLine(){return 3===this._state?this._lineInState:0}getDebugState(){return`${this._getReadableState()}, line = ${this._lineInState}, `+`vblank = ${this.vblank?"1":"0"}`}_getReadableState(){switch(this._state){case 0:return"wait for vsync start";case 1:return"wait for vsync end";case 2:return"wait for frame start";case 3:return"frame";case 4:return"overscan"}}_startFrame(){this._setState(3),this._surface=this._surfaceFactory(),this.surfaceBuffer=this._surface.getBuffer()}_finalizeFrame(){if(3!==this._state)throw new Error(`finalize frame in invalid state ${this._state}`);this.newFrame.dispatch(this._surface),this._setState(4)}_setState(e){this._state=e,this._lineInState=0}}class DelayQueue{constructor(e,t){this._length=e,this._nextIndex=0,this._indices=new Uint8Array(255),this._queue=new Array(this._length);for(let e=0;e<this._length;e++)this._queue[e]=new QueueEntry(t)}reset(){for(let e=0;e<this._length;e++)this._queue[e].nextIndex=0}push(e,t,s){if(s>=this._length)throw new Error("delay exceeds queue length");const i=this._indices[e];i<this._length&&this._queue[i].remove(e);const r=(this._nextIndex+s)%this._length;return this._queue[r].push(e,t),this._indices[e]=r,this}execute(e,t){const s=this._queue[this._nextIndex];this._nextIndex=(this._nextIndex+1)%this._length;for(let i=0;i<s.nextIndex;i++)e(s.addresses[i],s.values[i],t),this._indices[s.addresses[i]]=255;s.nextIndex=0}}class QueueEntry{constructor(e){this.size=e,this.nextIndex=0,this.addresses=new Uint8Array(e),this.values=new Uint8Array(e)}push(e,t){if(this.nextIndex>=this.size)throw new Error("delay queue overflow");this.addresses[this.nextIndex]=e,this.values[this.nextIndex]=t,this.nextIndex++}remove(e){let t;for(t=0;t<this.nextIndex&&this.addresses[t]!==e;t++);t<this.nextIndex&&(this.addresses[t]=this.addresses[this.nextIndex-1],this.values[t]=this.values[this.nextIndex-1],this.nextIndex--)}}const NTSC=new Uint32Array([4278190080,4283058762,4285493103,4287532686,4289374890,4290822336,4292269782,4293717228,4278208584,4279200105,4280125062,4280984226,4281711547,4282438354,4283099368,4283759868,4278201468,4279322768,4280378018,4281367220,4282224835,4283081938,4283807711,4284532972,4278197392,4279581091,4280832949,4282019014,4283073237,4284061667,4284984048,4285840636,4278190228,4279900839,4281479864,4282927304,4284243158,4285493220,4286611696,4287664380,4284743812,4286192023,4287574184,4288825016,4289944006,4290997460,4291984608,4292906220,4286840912,4288289128,4289540221,4290791058,4291844516,4292897973,4293819589,4294741204,4287627284,4288879155,4290064974,4291184744,4292172927,4293095317,4293951657,4294742204,4287889408,4289141272,4290261549,4291315778,4292238420,4293160805,4293951605,4294742148,4287110144,4288494360,4289746733,4290933314,4291988052,4292976741,4293899637,4294756484,4284755968,4286599192,4288179501,4289759298,4291141716,4292458341,4293643381,4294762628,4281352192,4283327e3,4285104429,4286750274,4288264276,4289646949,4290963317,4292148356,4278207488,4279920154,4281500722,4282949704,4284267100,4285518447,4286638208,4287691920,4278205460,4279787317,4281171538,4282555502,4283742087,4284862622,4285917108,4286905544,4278204464,4279654736,4281038445,4282290824,4283411360,4284465847,4285454540,4286377184,4278201416,4279520617,4280707718,4281894562,4282884027,4283872978,4284730600,4285587708]),PAL=new Uint32Array([4278190080,4281019179,4283585106,4285953654,4288124823,4290164406,4292006610,4293717228,4278190080,4281019179,4283585106,4285953654,4288124823,4290164406,4292006610,4293717228,4278212736,4279923094,4281501611,4282948798,4284264399,4285513951,4286632430,4287684860,4278213700,4279925086,4281504630,4282952844,4284269216,4285519795,4286638788,4287691988,4278203504,4279914889,4281494432,4282942646,4284259017,4285509596,4286628588,4287681788,4279526400,4281696282,4283602994,4285444168,4287087964,4288600431,4290046848,4291361936,4279500912,4281670281,4283576992,4285417654,4287061193,4288573404,4290019564,4291334396,4284242944,4285953562,4287532594,4288980040,4290295900,4291545967,4292664448,4293717136,4284219504,4285799044,4287181462,4288563368,4289748151,4290867142,4291920083,4292907232,4285545472,4287191577,4288705839,4290154052,4291405143,4292655720,4293709433,4294762632,4285530200,4287175278,4288688771,4290136214,4291386535,4292636599,4293689542,4294742228,4285538304,4287184665,4288698927,4290147396,4291398487,4292649320,4293703033,4294756488,4286578740,4288027210,4289409631,4290660466,4291779715,4292833171,4293820578,4294742192,4287102976,4288485914,4289737266,4290922568,4291976284,4292964207,4293886080,4294742160,4278190080,4281019179,4283585106,4285953654,4288124823,4290164406,4292006610,4293717228,4278190080,4281019179,4283585106,4285953654,4288124823,4290164406,4292006610,4293717228]),SECAM=new Uint32Array([4278190080,4294910241,4286135536,4294922495,4278255487,4294967167,4282384383,4294967295,4278190080,4294910241,4286135536,4294922495,4278255487,4294967167,4282384383,4294967295,4278190080,4294910241,4286135536,4294922495,4278255487,4294967167,4282384383,4294967295,4278190080,4294910241,4286135536,4294922495,4278255487,4294967167,4282384383,4294967295,4278190080,4294910241,4286135536,4294922495,4278255487,4294967167,4282384383,4294967295,4278190080,4294910241,4286135536,4294922495,4278255487,4294967167,4282384383,4294967295,4278190080,4294910241,4286135536,4294922495,4278255487,4294967167,4282384383,4294967295,4278190080,4294910241,4286135536,4294922495,4278255487,4294967167,4282384383,4294967295,4278190080,4294910241,4286135536,4294922495,4278255487,4294967167,4282384383,4294967295,4278190080,4294910241,4286135536,4294922495,4278255487,4294967167,4282384383,4294967295,4278190080,4294910241,4286135536,4294922495,4278255487,4294967167,4282384383,4294967295,4278190080,4294910241,4286135536,4294922495,4278255487,4294967167,4282384383,4294967295,4278190080,4294910241,4286135536,4294922495,4278255487,4294967167,4282384383,4294967295,4278190080,4294910241,4286135536,4294922495,4278255487,4294967167,4282384383,4294967295,4278190080,4294910241,4286135536,4294922495,4278255487,4294967167,4282384383,4294967295,4278190080,4294910241,4286135536,4294922495,4278255487,4294967167,4282384383,4294967295]);class Tia{constructor(e,t,s,i){this._config=e,this.newFrame=new lib_1,this.trap=new lib_1,this._cpu=null,this._bus=null,this._delayQueue=new DelayQueue(10,20),this._hstate=0,this._hctr=0,this._collisionUpdateRequired=!1,this._movementClock=0,this._movementInProgress=!1,this._extendedHblank=!1,this._xDelta=0,this._linesSinceChange=0,this._maxLinesTotal=0,this._colorBk=4278190080,this._priority=0,this._collisionMask=0,this._player0=new Player(31744,()=>this._flushLineCache()),this._player1=new Player(17344,()=>this._flushLineCache()),this._missile0=new Missile(8760,()=>this._flushLineCache()),this._missile1=new Missile(4390,()=>this._flushLineCache()),this._playfield=new Playfield(1099,()=>this._flushLineCache()),this._ball=new Ball(2197,()=>this._flushLineCache()),this._waveformAudio=new Array(2),this._pcmAudio=null,this._audio=new Array(2),this._frameManager=new FrameManager(this._config),this._frameManager.newFrame.addHandler(Tia._onNewFrame,this),this._palette=this._getPalette(this._config),this._input0=new LatchedInput(t.getFire()),this._input1=new LatchedInput(s.getFire()),this._pcmAudio=new PCMAudio(this._config);const r=this._pcmAudio.getChannels();for(let e=0;e<2;e++)this._waveformAudio[e]=new WaveformAudio(this._config),this._audio[e]=this._config.pcmAudio?r[e]:this._waveformAudio[e];const a=this._getClockFreq(this._config);this._paddles=new Array(4);for(let e=0;e<4;e++)this._paddles[e]=new PaddleReader(a,i[e]);this.reset()}reset(){this._hctr=0,this._movementInProgress=!1,this._extendedHblank=!1,this._movementClock=0,this._priority=0,this._hstate=0,this._collisionMask=0,this._colorBk=4278190080,this._linesSinceChange=0,this._collisionUpdateRequired=!1,this._maxLinesTotal=0,this._xDelta=0,this._delayQueue.reset(),this._frameManager.reset(),this._missile0.reset(),this._missile1.reset(),this._player0.reset(),this._player1.reset(),this._playfield.reset(),this._ball.reset(),this._audio[0].reset(),this._audio[1].reset(),this._input0.reset(),this._input1.reset();for(let e=0;e<4;e++)this._paddles[e].reset();this._cpu&&this._cpu.resume()}setCpu(e){return this._cpu=e,this}setCpuTimeProvider(e){for(let t=0;t<4;t++)this._paddles[t].setCpuTimeProvider(e);return this}getWidth(){return 160}getHeight(){return this._frameManager.getHeight()}setSurfaceFactory(e){return this._frameManager.setSurfaceFactory(e),this}getWaveformChannel(e){return this._waveformAudio[e]}getPCMChannel(){return this._pcmAudio}setAudioEnabled(e){this._audio[0].setActive(e&&this._config.enableAudio),this._audio[1].setActive(e&&this._config.enableAudio)}read(e){const t=this._bus.getLastDataBusValue();let s;switch(15&e){case 8:s=this._config.emulatePaddles?this._paddles[0].inpt():0;break;case 9:s=this._config.emulatePaddles?this._paddles[1].inpt():0;break;case 10:s=this._config.emulatePaddles?this._paddles[2].inpt():0;break;case 11:s=this._config.emulatePaddles?this._paddles[3].inpt():0;break;case 12:s=this._input0.inpt();break;case 13:s=this._input1.inpt();break;case 0:s=(8192&this._collisionMask?64:0)|(512&this._collisionMask?128:0);break;case 1:s=(256&this._collisionMask?64:0)|(4096&this._collisionMask?128:0);break;case 2:s=(2048&this._collisionMask?64:0)|(1024&this._collisionMask?128:0);break;case 3:s=(128&this._collisionMask?64:0)|(64&this._collisionMask?128:0);break;case 4:s=(16&this._collisionMask?64:0)|(8&this._collisionMask?128:0);break;case 5:s=(4&this._collisionMask?64:0)|(2&this._collisionMask?128:0);break;case 7:s=(32&this._collisionMask?64:0)|(16384&this._collisionMask?128:0);break;case 6:s=1&this._collisionMask?128:0;break;default:s=0}return 192&s|63&t}peek(e){return this.read(e)}write(e,t){let s=0;switch(63&e){case 2:this._cpu.halt();break;case 3:this._flushLineCache(),this._rsync();break;case 0:this._frameManager.setVsync((2&t)>0);break;case 1:this._input0.vblank(t),this._input1.vblank(t);for(let e=0;e<4;e++)this._paddles[e].vblank(t);this._delayQueue.push(1,t,1);break;case 29:this._delayQueue.push(29,t,1);break;case 30:this._delayQueue.push(30,t,1);break;case 34:this._delayQueue.push(34,t,2);break;case 35:this._delayQueue.push(35,t,2);break;case 18:this._flushLineCache(),this._missile0.resm(this._resxCounter(),0===this._hstate);break;case 19:this._flushLineCache(),this._missile1.resm(this._resxCounter(),0===this._hstate);break;case 40:this._missile0.resmp(t,this._player0);break;case 41:this._missile1.resmp(t,this._player1);break;case 43:this._delayQueue.push(43,t,2);break;case 4:this._flushLineCache(),this._missile0.nusiz(t),this._player0.nusiz(t,0===this._hstate);break;case 5:this._flushLineCache(),this._missile1.nusiz(t),this._player1.nusiz(t,0===this._hstate);break;case 42:this._delayQueue.push(42,t,6);break;case 9:this._flushLineCache(),this._colorBk=this._palette[(255&t)>>>1];break;case 6:s=this._palette[(255&t)>>>1],this._missile0.setColor(s),this._player0.setColor(s),this._playfield.setColorP0(s);break;case 7:s=this._palette[(255&t)>>>1],this._missile1.setColor(s),this._player1.setColor(s),this._playfield.setColorP1(s);break;case 13:this._delayQueue.push(13,t,2);break;case 14:this._delayQueue.push(14,t,2);break;case 15:this._delayQueue.push(15,t,2);break;case 10:this._setPriority(t),this._playfield.ctrlpf(t),this._ball.ctrlpf(t);break;case 8:this._flushLineCache(),s=this._palette[(255&t)>>>1],this._playfield.setColor(s),this._ball.color=s;break;case 27:this._delayQueue.push(27,t,1).push(241,0,1);break;case 28:this._delayQueue.push(28,t,1).push(240,0,1).push(242,0,1);break;case 16:this._flushLineCache(),this._player0.resp(this._resxCounter());break;case 17:this._flushLineCache(),this._player1.resp(this._resxCounter());break;case 11:this._delayQueue.push(11,t,1);break;case 12:this._delayQueue.push(12,t,1);break;case 32:this._delayQueue.push(32,t,2);break;case 33:this._delayQueue.push(33,t,2);break;case 37:this._player0.vdelp(t);break;case 38:this._player1.vdelp(t);break;case 31:this._delayQueue.push(31,t,1);break;case 36:this._delayQueue.push(36,t,2);break;case 20:this._flushLineCache(),this._ball.resbl(this._resxCounter());break;case 39:this._ball.vdelbl(t);break;case 44:this._flushLineCache(),this._collisionMask=0;break;case 21:this._audio[0].audc(t);break;case 22:this._audio[1].audc(t);break;case 23:this._audio[0].audf(t);break;case 24:this._audio[1].audf(t);break;case 25:this._audio[0].audv(t);break;case 26:this._audio[1].audv(t)}}getDebugState(){return""+`hclock: ${this._hctr}   line: ${this._frameManager.getCurrentLine()}\n`+this._frameManager.getDebugState()}setBus(e){return this._bus=e,this}cycle(){this._delayQueue.execute(Tia._delayedWrite,this),this._collisionUpdateRequired=!1,this._linesSinceChange<2?(this._tickMovement(),0===this._hstate?this._tickHblank():this._tickHframe(),this._collisionUpdateRequired&&!this._frameManager.vblank&&this._updateCollision()):0===this._hctr&&this._cpu.resume(),++this._hctr>=228&&this._nextLine(),this._config.pcmAudio&&this._pcmAudio.tick()}static _delayedWrite(e,t,s){switch(e){case 1:s._flushLineCache(),s._frameManager.setVblank((2&t)>0);break;case 42:s._flushLineCache(),s._movementClock=0,s._movementInProgress=!0,s._extendedHblank||(s._clearHmoveComb(),s._extendedHblank=!0),s._missile0.startMovement(),s._missile1.startMovement(),s._player0.startMovement(),s._player1.startMovement(),s._ball.startMovement();break;case 13:s._playfield.pf0(t);break;case 14:s._playfield.pf1(t);break;case 15:s._playfield.pf2(t);break;case 27:s._player0.grp(t);break;case 28:s._player1.grp(t);break;case 240:s._player0.shufflePatterns();break;case 241:s._player1.shufflePatterns();break;case 32:s._player0.hmp(t);break;case 33:s._player1.hmp(t);break;case 34:s._missile0.hmm(t);break;case 35:s._missile1.hmm(t);break;case 36:s._ball.hmbl(t);break;case 43:s._missile0.hmm(0),s._missile1.hmm(0),s._player0.hmp(0),s._player1.hmp(0),s._ball.hmbl(0);break;case 11:s._player0.refp(t);break;case 12:s._player1.refp(t);break;case 242:s._ball.shuffleStatus();break;case 31:s._ball.enabl(t);break;case 29:s._missile0.enam(t);break;case 30:s._missile1.enam(t)}}static _onNewFrame(e,t){const s=t._frameManager.getCurrentLine();if(s>t._maxLinesTotal&&(t._maxLinesTotal=s),s<t._maxLinesTotal){const i=e.getBuffer(),r=160*s,a=160*t._maxLinesTotal;for(let e=r;e<a;e++)i[e]=4278190080}t.newFrame.dispatch(e)}_tickMovement(){if(this._movementInProgress&&0==(3&this._hctr)){const e=0===this._hstate;let t=!1;const s=this._movementClock>15?0:this._movementClock;t=this._missile0.movementTick(s,e)||t,t=this._missile1.movementTick(s,e)||t,t=this._player0.movementTick(s,e)||t,t=this._player1.movementTick(s,e)||t,t=this._ball.movementTick(s,e)||t,this._movementInProgress=t,this._collisionUpdateRequired=t,this._movementClock++}}_tickHblank(){switch(this._hctr){case 0:this._extendedHblank=!1,this._cpu.resume();break;case 67:this._extendedHblank||(this._hstate=1);break;case 75:this._extendedHblank&&(this._hstate=1)}this._extendedHblank&&this._hctr>67&&this._playfield.tick(this._hctr-68+this._xDelta)}_tickHframe(){const e=this._frameManager.getCurrentLine(),t=this._hctr-68+this._xDelta;this._collisionUpdateRequired=!0,this._playfield.tick(t),this._tickSprites(),this._frameManager.isRendering()&&this._renderPixel(t,e)}_tickSprites(){this._missile0.tick(!0),this._missile1.tick(!0),this._player0.tick(),this._player1.tick(),this._ball.tick(!0)}_nextLine(){this._linesSinceChange>=2&&this._cloneLastLine(),this._hctr=0,this._playfield.tick(0),this._movementInProgress||this._linesSinceChange++,this._hstate=0,this._xDelta=0,this._frameManager.nextLine(),this._frameManager.isRendering()&&0===this._frameManager.getCurrentLine()&&this._flushLineCache()}_cloneLastLine(){const e=this._frameManager.getCurrentLine();if(!this._frameManager.isRendering()||0===e)return;const t=160*e,s=160*(e-1);for(let e=0;e<160;e++)this._frameManager.surfaceBuffer[t+e]=this._frameManager.surfaceBuffer[s+e]}_getPalette(e){switch(e.tvMode){case 0:return NTSC;case 1:return PAL;case 2:return SECAM;default:throw new Error("invalid TV mode")}}_getClockFreq(e){return 0===e.tvMode?3584160:3556800}_renderPixel(e,t){if(this._frameManager.vblank)return void(this._frameManager.surfaceBuffer[160*t+e]=4278190080);let s=this._colorBk;switch(this._priority){case 0:s=this._playfield.getPixel(s),s=this._ball.getPixel(s),s=this._missile1.getPixel(s),s=this._player1.getPixel(s),s=this._missile0.getPixel(s),s=this._player0.getPixel(s);break;case 1:s=this._missile1.getPixel(s),s=this._player1.getPixel(s),s=this._missile0.getPixel(s),s=this._player0.getPixel(s),s=this._playfield.getPixel(s),s=this._ball.getPixel(s);break;case 2:s=this._ball.getPixel(s),s=this._missile1.getPixel(s),s=this._player1.getPixel(s),s=this._playfield.getPixel(s),s=this._missile0.getPixel(s),s=this._player0.getPixel(s);break;default:throw new Error("invalid priority")}this._frameManager.surfaceBuffer[160*t+e]=s}_updateCollision(){this._collisionMask|=~this._player0.collision&~this._player1.collision&~this._missile0.collision&~this._missile1.collision&~this._ball.collision&~this._playfield.collision}_clearHmoveComb(){if(this._frameManager.isRendering()&&0===this._hstate){const e=160*this._frameManager.getCurrentLine();for(let t=0;t<8;t++)this._frameManager.surfaceBuffer[e+t]=4278190080}}_resxCounter(){return 0===this._hstate?this._hctr>=73?158:159:157}_rsync(){const e=this._hctr>68?this._hctr-68:0;if(this._xDelta=157-e,this._frameManager.isRendering()){const t=this._frameManager.getCurrentLine(),s=160*t+e,i=s+160*(t+1);for(let e=s;e<i;e++)this._frameManager.surfaceBuffer[e]=4278190080}this._hctr=225}_setPriority(e){const t=4&e?1:2&e?2:0;t!==this._priority&&(this._flushLineCache(),this._priority=t)}_flushLineCache(){const e=this._linesSinceChange>=2;if(this._linesSinceChange=0,e){const e=this._hctr;for(this._hctr=0;this._hctr<e;this._hctr++)0===this._hstate?this._tickHblank():this._tickHframe()}}}!function(e){e.TrapPayload=class{constructor(e,t,s){this.reason=e,this.tia=t,this.message=s}}}(Tia||(Tia={}));class Switch{constructor(e=!1){this._state=e,this.stateChanged=new lib_1,this.beforeRead=new lib_1}read(){return this.beforeRead.dispatch(this),this._state}peek(){return this._state}toggle(e){this._state!==e&&(this._state=e,this.stateChanged.dispatch(e))}}class ControlPanel{constructor(){this._selectSwitch=new Switch,this._resetButton=new Switch,this._colorSwitch=new Switch,this._difficutlyP0=new Switch,this._difficutlyP1=new Switch}getSelectSwitch(){return this._selectSwitch}getResetButton(){return this._resetButton}getColorSwitch(){return this._colorSwitch}getDifficultySwitchP0(){return this._difficutlyP0}getDifficultySwitchP1(){return this._difficutlyP1}}class DigitalJoystick{constructor(){this._left=new Switch,this._right=new Switch,this._up=new Switch,this._down=new Switch,this._fire=new Switch}getLeft(){return this._left}getRight(){return this._right}getUp(){return this._up}getDown(){return this._down}getFire(){return this._fire}}class Paddle{constructor(){this.valueChanged=new lib_1,this._fireSwitch=new Switch,this._value=.5}setValue(e){this._value=e,this.valueChanged.dispatch(e)}getValue(){return this._value}getFire(){return this._fireSwitch}}var alea=createCommonjsModule((function(e){!function(e,t,s){function i(e){var t,s=this,i=(t=4022871197,function(e){e=String(e);for(var s=0;s<e.length;s++){var i=.02519603282416938*(t+=e.charCodeAt(s));i-=t=i>>>0,t=(i*=t)>>>0,t+=4294967296*(i-=t)}return 2.3283064365386963e-10*(t>>>0)});s.next=function(){var e=2091639*s.s0+2.3283064365386963e-10*s.c;return s.s0=s.s1,s.s1=s.s2,s.s2=e-(s.c=0|e)},s.c=1,s.s0=i(" "),s.s1=i(" "),s.s2=i(" "),s.s0-=i(e),s.s0<0&&(s.s0+=1),s.s1-=i(e),s.s1<0&&(s.s1+=1),s.s2-=i(e),s.s2<0&&(s.s2+=1),i=null}function r(e,t){return t.c=e.c,t.s0=e.s0,t.s1=e.s1,t.s2=e.s2,t}function a(e,t){var s=new i(e),a=t&&t.state,n=s.next;return n.int32=function(){return 4294967296*s.next()|0},n.double=function(){return n()+11102230246251565e-32*(2097152*n()|0)},n.quick=n,a&&("object"==typeof a&&r(a,s),n.state=function(){return r(s,{})}),n}t&&t.exports?t.exports=a:s&&s.amd?s((function(){return a})):this.alea=a}(0,e,!1)})),xor128=createCommonjsModule((function(e){!function(e,t,s){function i(e){var t=this,s="";t.x=0,t.y=0,t.z=0,t.w=0,t.next=function(){var e=t.x^t.x<<11;return t.x=t.y,t.y=t.z,t.z=t.w,t.w^=t.w>>>19^e^e>>>8},e===(0|e)?t.x=e:s+=e;for(var i=0;i<s.length+64;i++)t.x^=0|s.charCodeAt(i),t.next()}function r(e,t){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t}function a(e,t){var s=new i(e),a=t&&t.state,n=function(){return(s.next()>>>0)/4294967296};return n.double=function(){do{var e=((s.next()>>>11)+(s.next()>>>0)/4294967296)/(1<<21)}while(0===e);return e},n.int32=s.next,n.quick=n,a&&("object"==typeof a&&r(a,s),n.state=function(){return r(s,{})}),n}t&&t.exports?t.exports=a:s&&s.amd?s((function(){return a})):this.xor128=a}(0,e,!1)})),xorwow=createCommonjsModule((function(e){!function(e,t,s){function i(e){var t=this,s="";t.next=function(){var e=t.x^t.x>>>2;return t.x=t.y,t.y=t.z,t.z=t.w,t.w=t.v,(t.d=t.d+362437|0)+(t.v=t.v^t.v<<4^e^e<<1)|0},t.x=0,t.y=0,t.z=0,t.w=0,t.v=0,e===(0|e)?t.x=e:s+=e;for(var i=0;i<s.length+64;i++)t.x^=0|s.charCodeAt(i),i==s.length&&(t.d=t.x<<10^t.x>>>4),t.next()}function r(e,t){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t.v=e.v,t.d=e.d,t}function a(e,t){var s=new i(e),a=t&&t.state,n=function(){return(s.next()>>>0)/4294967296};return n.double=function(){do{var e=((s.next()>>>11)+(s.next()>>>0)/4294967296)/(1<<21)}while(0===e);return e},n.int32=s.next,n.quick=n,a&&("object"==typeof a&&r(a,s),n.state=function(){return r(s,{})}),n}t&&t.exports?t.exports=a:s&&s.amd?s((function(){return a})):this.xorwow=a}(0,e,!1)})),xorshift7=createCommonjsModule((function(e){!function(e,t,s){function i(e){var t=this;t.next=function(){var e,s,i=t.x,r=t.i;return e=i[r],s=(e^=e>>>7)^e<<24,s^=(e=i[r+1&7])^e>>>10,s^=(e=i[r+3&7])^e>>>3,s^=(e=i[r+4&7])^e<<7,e=i[r+7&7],s^=(e^=e<<13)^e<<9,i[r]=s,t.i=r+1&7,s},function(e,t){var s,i=[];if(t===(0|t))i[0]=t;else for(t=""+t,s=0;s<t.length;++s)i[7&s]=i[7&s]<<15^t.charCodeAt(s)+i[s+1&7]<<13;for(;i.length<8;)i.push(0);for(s=0;s<8&&0===i[s];++s);for(8==s?i[7]=-1:i[s],e.x=i,e.i=0,s=256;s>0;--s)e.next()}(t,e)}function r(e,t){return t.x=e.x.slice(),t.i=e.i,t}function a(e,t){null==e&&(e=+new Date);var s=new i(e),a=t&&t.state,n=function(){return(s.next()>>>0)/4294967296};return n.double=function(){do{var e=((s.next()>>>11)+(s.next()>>>0)/4294967296)/(1<<21)}while(0===e);return e},n.int32=s.next,n.quick=n,a&&(a.x&&r(a,s),n.state=function(){return r(s,{})}),n}t&&t.exports?t.exports=a:s&&s.amd?s((function(){return a})):this.xorshift7=a}(0,e,!1)})),xor4096=createCommonjsModule((function(e){!function(e,t,s){function i(e){var t=this;t.next=function(){var e,s,i=t.w,r=t.X,a=t.i;return t.w=i=i+1640531527|0,s=r[a+34&127],e=r[a=a+1&127],s^=s<<13,e^=e<<17,s^=s>>>15,e^=e>>>12,s=r[a]=s^e,t.i=a,s+(i^i>>>16)|0},function(e,t){var s,i,r,a,n,o=[],h=128;for(t===(0|t)?(i=t,t=null):(t+="\0",i=0,h=Math.max(h,t.length)),r=0,a=-32;a<h;++a)t&&(i^=t.charCodeAt((a+32)%t.length)),0===a&&(n=i),i^=i<<10,i^=i>>>15,i^=i<<4,i^=i>>>13,a>=0&&(n=n+1640531527|0,r=0==(s=o[127&a]^=i+n)?r+1:0);for(r>=128&&(o[127&(t&&t.length||0)]=-1),r=127,a=512;a>0;--a)i=o[r+34&127],s=o[r=r+1&127],i^=i<<13,s^=s<<17,i^=i>>>15,s^=s>>>12,o[r]=i^s;e.w=n,e.X=o,e.i=r}(t,e)}function r(e,t){return t.i=e.i,t.w=e.w,t.X=e.X.slice(),t}function a(e,t){null==e&&(e=+new Date);var s=new i(e),a=t&&t.state,n=function(){return(s.next()>>>0)/4294967296};return n.double=function(){do{var e=((s.next()>>>11)+(s.next()>>>0)/4294967296)/(1<<21)}while(0===e);return e},n.int32=s.next,n.quick=n,a&&(a.X&&r(a,s),n.state=function(){return r(s,{})}),n}t&&t.exports?t.exports=a:s&&s.amd?s((function(){return a})):this.xor4096=a}(0,e,!1)})),tychei=createCommonjsModule((function(e){!function(e,t,s){function i(e){var t=this,s="";t.next=function(){var e=t.b,s=t.c,i=t.d,r=t.a;return e=e<<25^e>>>7^s,s=s-i|0,i=i<<24^i>>>8^r,r=r-e|0,t.b=e=e<<20^e>>>12^s,t.c=s=s-i|0,t.d=i<<16^s>>>16^r,t.a=r-e|0},t.a=0,t.b=0,t.c=-1640531527,t.d=1367130551,e===Math.floor(e)?(t.a=e/4294967296|0,t.b=0|e):s+=e;for(var i=0;i<s.length+20;i++)t.b^=0|s.charCodeAt(i),t.next()}function r(e,t){return t.a=e.a,t.b=e.b,t.c=e.c,t.d=e.d,t}function a(e,t){var s=new i(e),a=t&&t.state,n=function(){return(s.next()>>>0)/4294967296};return n.double=function(){do{var e=((s.next()>>>11)+(s.next()>>>0)/4294967296)/(1<<21)}while(0===e);return e},n.int32=s.next,n.quick=n,a&&("object"==typeof a&&r(a,s),n.state=function(){return r(s,{})}),n}t&&t.exports?t.exports=a:s&&s.amd?s((function(){return a})):this.tychei=a}(0,e,!1)})),require$$0={},seedrandom=createCommonjsModule((function(e){!function(t,s,i){var r,a=256,n=6,o="random",h=i.pow(a,n),c=i.pow(2,52),u=2*c,_=a-1;function l(e,_,l){var g=[],b=p(function e(t,s){var i,r=[],a=typeof t;if(s&&"object"==a)for(i in t)try{r.push(e(t[i],s-1))}catch(e){}return r.length?r:"string"==a?t:t+"\0"}((_=1==_?{entropy:!0}:_||{}).entropy?[e,m(s)]:null==e?function(){try{var e;return r&&(e=r.randomBytes)?e=e(a):(e=new Uint8Array(a),(t.crypto||t.msCrypto).getRandomValues(e)),m(e)}catch(e){var i=t.navigator,n=i&&i.plugins;return[+new Date,t,n,t.screen,m(s)]}}():e,3),g),k=new d(g),y=function(){for(var e=k.g(n),t=h,s=0;e<c;)e=(e+s)*a,t*=a,s=k.g(1);for(;e>=u;)e/=2,t/=2,s>>>=1;return(e+s)/t};return y.int32=function(){return 0|k.g(4)},y.quick=function(){return k.g(4)/4294967296},y.double=y,p(m(k.S),s),(_.pass||l||function(e,t,s,r){return r&&(r.S&&f(r,k),e.state=function(){return f(k,{})}),s?(i[o]=e,t):e})(y,b,"global"in _?_.global:this==i,_.state)}function d(e){var t,s=e.length,i=this,r=0,n=i.i=i.j=0,o=i.S=[];for(s||(e=[s++]);r<a;)o[r]=r++;for(r=0;r<a;r++)o[r]=o[n=_&n+e[r%s]+(t=o[r])],o[n]=t;(i.g=function(e){for(var t,s=0,r=i.i,n=i.j,o=i.S;e--;)t=o[r=_&r+1],s=s*a+o[_&(o[r]=o[n=_&n+t])+(o[n]=t)];return i.i=r,i.j=n,s})(a)}function f(e,t){return t.i=e.i,t.j=e.j,t.S=e.S.slice(),t}function p(e,t){for(var s,i=e+"",r=0;r<i.length;)t[_&r]=_&(s^=19*t[_&r])+i.charCodeAt(r++);return m(t)}function m(e){return String.fromCharCode.apply(0,e)}if(p(i.random(),s),e.exports){e.exports=l;try{r=require$$0}catch(e){}}else i["seed"+o]=l}("undefined"!=typeof self?self:commonjsGlobal,[],Math)}));seedrandom.alea=alea,seedrandom.xor128=xor128,seedrandom.xorwow=xorwow,seedrandom.xorshift7=xorshift7,seedrandom.xor4096=xor4096,seedrandom.tychei=tychei;var seedrandom$1=seedrandom,seedrandom_1=seedrandom$1.alea,CartridgeInterface,CartridgeInfo;class SeedrandomGenerator{constructor(e){this._rng=e}single(){return this._rng.quick()}double(){return this._rng.double()}int32(){return this._rng.int32()}int(e){return(this._rng.int32()>>>0)%(e+1)}saveState(){return this._rng.state()}}function createRng(e){return e<0&&(e=Math.random()),new SeedrandomGenerator(seedrandom_1(e,{state:!0}))}class Board{constructor(e,t,s){this._config=e,this.trap=new lib_1,this.clock=new lib_1,this.cpuClock=new lib_1,this._clockMode=1,this._cpuCycles=0,this._trap=!1,this._audioEnabled=!0,this._suspended=!0,this._subClock=0,this._clockHz=0,this._sliceSize=0,this._timer={tick:e=>this._tick(e),start:e=>this._start(e),stop:()=>this._stop(),isRunning:()=>!!this._runTask},this._rng=createRng(e.randomSeed<0?Math.random():e.randomSeed),t.randomize(this._rng);const i=new Bus;void 0===s&&(s=(t,s)=>new CpuFactory(e.cpuType).create(t,s));const r=new ControlPanel,a=new DigitalJoystick,n=new DigitalJoystick,o=new Array(4);for(let e=0;e<4;e++)o[e]=new Paddle;const h=s(i,this._rng),c=new Pia(r,a,n,this._rng),u=new Tia(e,a,n,o);h.setInvalidInstructionCallback(()=>this._onInvalidInstruction()),u.setCpu(h).setBus(i).setCpuTimeProvider(()=>this.getCpuTime()),t.setCpu(h).setBus(i).setCpuTimeProvider(()=>this.getCpuTime()).setRng(this._rng),c.setBus(i),i.setTia(u).setPia(c).setCartridge(t),this._bus=i,this._cpu=h,this._tia=u,this._pia=c,this._cartridge=t,this._controlPanel=r,this._joystick0=a,this._joystick1=n,this._paddles=o,this._bus.event.trap.addHandler(e=>this.triggerTrap(1,e.message)),this._clockHz=Config.getClockHz(e),this._sliceSize=228*(0===e.tvMode?262:312),this.reset()}getCpu(){return this._cpu}getBus(){return this._bus}getVideoOutput(){return this._tia}getWaveformChannels(){return[0,1].map(e=>this._tia.getWaveformChannel(e))}getPCMChannel(){return this._tia.getPCMChannel()}getTimer(){return this._timer}getConfig(){return this._config}reset(){return this._cpu.reset(),this._tia.reset(),this._pia.reset(),this._cartridge.reset(),this._controlPanel.getResetButton().toggle(!1),this._controlPanel.getSelectSwitch().toggle(!1),this._controlPanel.getColorSwitch().toggle(!1),this._controlPanel.getDifficultySwitchP0().toggle(!0),this._controlPanel.getDifficultySwitchP1().toggle(!0),this._subClock=0,this._cpuCycles=0,this}boot(){let e=0,t=0;if(this.reset(),0!==this._cpu.executionState)throw new Error("Already booted!");for(;1!==this._cpu.executionState;)this._cycle(),e++,0===this._subClock&&t++;return this.cpuClock.dispatch(t),this.clock.dispatch(e),this}suspend(){this._suspended=!0,this._updateAudioState()}resume(){this._suspended=!1,this._updateAudioState()}setAudioEnabled(e){this._audioEnabled=e,this._updateAudioState()}triggerTrap(e,t){if(this._stop(),this._trap=!0,!this.trap.hasHandlers)throw new Error(t);return this.trap.dispatch(new BoardInterface.TrapPayload(e,this,t)),this}getControlPanel(){return this._controlPanel}getJoystick0(){return this._joystick0}getJoystick1(){return this._joystick1}getBoardStateDebug(){const e="============";return"TIA:\n"+e+"\n"+this._tia.getDebugState()+"\n\nPIA:\n"+`${e}\n`+`${this._pia.getDebugState()}\n`}setClockMode(e){return this._clockMode=e,this}getClockMode(){return this._clockMode}getPaddle(e){return this._paddles[e]}getCpuTime(){return this._cpuCycles/Config.getClockHz(this._config)*3}static _executeSlice(e,t){const s=t?Math.round(t*e._clockHz/1e3):e._sliceSize;return e._tick(s)/e._clockHz*1e3}_updateAudioState(){this._tia.setAudioEnabled(this._audioEnabled&&!this._suspended)}_cycle(){this._tia.cycle(),this._subClock++>=2&&(this._pia.cycle(),this._cpu.cycle(),this._subClock=0)}_tick(e){let t=0,s=0,i=0,r=this._cpu.executionState;for(this._trap=!1;t++<e&&!this._trap;)this._cycle(),s++,0===this._subClock&&(i++,this._cpuCycles++),r!==this._cpu.executionState&&(r=this._cpu.executionState,1===this._cpu.executionState&&(this._cartridge.notifyCpuCycleComplete(),0===this._clockMode&&i>0&&this.cpuClock.hasHandlers&&(this.cpuClock.dispatch(i),i=0)));return i>0&&this.cpuClock.hasHandlers&&this.cpuClock.dispatch(i),s>0&&this.clock.hasHandlers&&this.clock.dispatch(s),s}_start(e){this._runTask||(this._runTask=e.start(Board._executeSlice,this,1e3/(0===this._config.tvMode?60:50)))}_stop(){this._runTask&&(this._runTask.stop(),this._runTask=void 0)}_onInvalidInstruction(){this.triggerTrap(0,"invalid instruction")}}!function(e){e.TrapPayload=class{constructor(e,t,s){this.reason=e,this.cartridge=t,this.message=s}}}(CartridgeInterface||(CartridgeInterface={})),function(e){let t;!function(e){e.vanilla_2k="vanilla_2k",e.vanilla_4k="vanilla_4k",e.bankswitch_2k_cv="bankswitch_2k_cv",e.bankswitch_8k_F8="bankswitch_8k_F8",e.bankswitch_8k_E0="bankswitch_8k_E0",e.bankswitch_8k_3F="bankswitch_8k_3F",e.bankswitch_8k_FE="bankswitch_8k_FE",e.bankswitch_8k_UA="bankswitch_8k_UA",e.bankswitch_8k_DPC="bankswitch_8k_DPC",e.bankswitch_8k_econobanking="bankswitch_8k_econobanking",e.bankswitch_8k_pp="bankswitch_8k_pp",e.bankswitch_12k_FA="bankswitch_12k_FA",e.bankswitch_16k_F6="bankswitch_16k_F6",e.bankswitch_16k_E7="bankswitch_16k_E7",e.bankswitch_FA2="bankswitch_FA2",e.bankswitch_32k_F4="bankswitch_32k_F4",e.bankswitch_64k_F0="bankswitch_64k_F0",e.bankswitch_64k_EF="bankswitch_64k_EF",e.bankswitch_3E="bankswitch_3E",e.bankswitch_supercharger="bankswitch_supercharger",e.bankswitch_dpc_plus="bankswitch_dpc_plus",e.bankswitch_cdf="bankswitch_cdf",e.unknown="unknown"}(t=e.CartridgeType||(e.CartridgeType={})),e.getAllTypes=function(){return[t.vanilla_2k,t.vanilla_4k,t.bankswitch_2k_cv,t.bankswitch_8k_F8,t.bankswitch_8k_E0,t.bankswitch_8k_3F,t.bankswitch_8k_FE,t.bankswitch_8k_UA,t.bankswitch_8k_econobanking,t.bankswitch_8k_pp,t.bankswitch_12k_FA,t.bankswitch_8k_DPC,t.bankswitch_16k_F6,t.bankswitch_16k_E7,t.bankswitch_FA2,t.bankswitch_32k_F4,t.bankswitch_3E,t.bankswitch_64k_F0,t.bankswitch_64k_EF,t.bankswitch_supercharger,t.bankswitch_dpc_plus,t.bankswitch_cdf,t.unknown]},e.describeCartridgeType=function(e){switch(e){case t.vanilla_2k:return"plain 2k";case t.vanilla_4k:return"plain 4k";case t.bankswitch_2k_cv:return"2k CommaVideo scheme";case t.bankswitch_8k_F8:return"bankswitched 8k, F8 (Atari) scheme";case t.bankswitch_8k_E0:return"bankswitched 8k, E0 (Parker Bros.) scheme";case t.bankswitch_8k_3F:return"bankswitched 8k, 3F (Tigervision) scheme";case t.bankswitch_8k_FE:return"bankswitched 8k, FE (Activision) scheme";case t.bankswitch_8k_UA:return"bankswitched 8k, UA (Pleiades) scheme";case t.bankswitch_8k_pp:return"bankswitched 8k, Pink Panther scheme";case t.bankswitch_12k_FA:return"bankswitched 12k, FA (CBS) scheme";case t.bankswitch_8k_DPC:return"bankswitched 8k + DPC";case t.bankswitch_8k_econobanking:return"bankswitched 8k, econobanking scheme";case t.bankswitch_16k_F6:return"bankswitched 16k, F6 (Atari) scheme";case t.bankswitch_16k_E7:return"bankswitched 16k, E7 (M-Network) scheme";case t.bankswitch_FA2:return"bankswitched 28k/29k, FA2 (modified CBS) scheme";case t.bankswitch_32k_F4:return"bankswitched 32k, F4 (Atari) scheme";case t.bankswitch_3E:return"bankswitched 3E (Tigervision + RAM) scheme";case t.bankswitch_64k_F0:return"bankswitched 64k, F0 (Megaboy) scheme";case t.bankswitch_64k_EF:return"bankswitched 64k, EFSC (Homestar Runner) scheme";case t.bankswitch_supercharger:return"bankswitched supercharger";case t.bankswitch_dpc_plus:return"bankswitched DPC+";case t.bankswitch_cdf:return"bankswitched CDF";case t.unknown:return"unknown"}}}(CartridgeInfo||(CartridgeInfo={}));class AbstractCartridge{constructor(){this.trap=new lib_1}init(){return __awaiter(this,void 0,void 0,(function*(){}))}reset(){}read(e){return 0}peek(e){return this.read(e)}write(e,t){}getType(){return CartridgeInfo.CartridgeType.unknown}setCpu(e){return this}setBus(e){return this}setRng(e){return this}setCpuTimeProvider(e){return this}notifyCpuCycleComplete(){}randomize(e){}triggerTrap(e,t){if(!this.trap.hasHandlers)throw new Error(t);this.trap.dispatch(new CartridgeInterface.TrapPayload(e,this,t))}}function nextPowerOfTwo(e){let t=1;for(;t<e;)t*=2;return t}function padBuffer(e){const t=nextPowerOfTwo(e.length);if(t===e.length)return e;const s=new Uint8Array(t);for(let i=0;i<t;i++)s[t-i-1]=i<e.length?e[e.length-i-1]:0;return s}class Cartridge2k extends AbstractCartridge{constructor(e){if(super(),this._rom=new Uint8Array(2048),e.length>2048)throw new Error(`buffer is not a 2k cartridge image: wrong length ${e.length}`);const t=padBuffer(e);for(let s=0;s<2048;s++)this._rom[s]=e[s%t.length]}read(e){return this._rom[2047&e]}getType(){return CartridgeInfo.CartridgeType.vanilla_2k}}class Cartridge4k extends AbstractCartridge{constructor(e){super(),this._rom=new Uint8Array(4096),4096!==e.length&&console.warn(`buffer has invalid size for 4K image: ${e.length} bytes`);const t=Math.min(4096,e.length);for(let s=0;s<4096&&s<e.length;s++)this._rom[4095-s]=e[t-1-s]}read(e){return this._rom[4095&e]}getType(){return CartridgeInfo.CartridgeType.vanilla_4k}}function searchForSignatures(e,t){const s=[],i=t.map(e=>0);for(let r=0;r<e.length;r++){for(let a=0;a<s.length;a++){const n=s[a],o=t[n.signature];e[r]===o[n.nextIndex]?++n.nextIndex===o.length&&(i[n.signature]++,s.splice(a,1),a--):(s.splice(a,1),a--)}for(let a=0;a<t.length;a++){const n=t[a];n.length>0&&e[r]===n[0]&&(1===n.length?i[a]++:s.push({signature:a,nextIndex:1}))}}return i}function searchForSignature(e,t){for(let s=0;s<e.length;s++){let i;for(i=0;i<t.length&&(e[s+i]===t[i]||t[i]<0);i++);if(i===t.length)return s}return-1}class CartridgeCV extends AbstractCartridge{constructor(e){if(super(),this._rom=new Uint8Array(2048),this._ram=new Uint8Array(1024),2048!==e.length)throw new Error(`buffer is not a 2k cartridge image: wrong length ${e.length}`);for(let t=0;t<2048;t++)this._rom[t]=e[t]}static matchesBuffer(e){const t=searchForSignatures(e,[[157,255,243],[153,0,244]]);return t[0]>0||t[1]>0}setBus(e){return this._bus=e,this}randomize(e){for(let t=0;t<1024;t++)this._ram[t]=e.int(255)}read(e){return(e&=4095)<1024?this._ram[e]:e<2048?this._ram[1023&e]=this._bus.getLastDataBusValue():this._rom[2047&e]}write(e,t){(e&=4095)>=1024&&e<2048&&(this._ram[1023&e]=t)}peek(e){return(e&=4095)<1024?this._ram[e]:e<2048?0:this._rom[2047&e]}getType(){return CartridgeInfo.CartridgeType.bankswitch_2k_cv}}class CartridgeF8 extends AbstractCartridge{constructor(e,t=!0){if(super(),this._supportSC=t,this._bank=null,this._bank0=new Uint8Array(4096),this._bank1=new Uint8Array(4096),this._hasSC=!1,this._saraRAM=new Uint8Array(128),this._bus=null,8192!==e.length)throw new Error(`buffer is not an 8k cartridge image: wrong length ${e.length}`);for(let t=0;t<4096;t++)this._bank0[t]=e[t],this._bank1[t]=e[4096+t];this.reset()}static matchesBuffer(e){return searchForSignatures(e,[[141,249,31]])[0]>=2}reset(){this._bank=this._bank1,this._hasSC=!1}read(e){return this._access(4095&e,this._bus.getLastDataBusValue()),this.peek(e)}peek(e){return e&=4095,this._hasSC&&e>=128&&e<256?this._saraRAM[e-128]:this._bank[e]}write(e,t){(e&=4095)<128&&this._supportSC&&(this._hasSC=!0),this._access(e,t)}getType(){return CartridgeInfo.CartridgeType.bankswitch_8k_F8}randomize(e){for(let t=0;t<this._saraRAM.length;t++)this._saraRAM[t]=e.int(255)}setBus(e){return this._bus=e,this}_access(e,t){if(e<128&&this._hasSC)this._saraRAM[e]=255&t;else switch(e){case 4088:this._bank=this._bank0;break;case 4089:this._bank=this._bank1}}}class CartridgeF6 extends AbstractCartridge{constructor(e,t=!0){if(super(),this._supportSC=t,this._bank=null,this._bank0=new Uint8Array(4096),this._bank1=new Uint8Array(4096),this._bank2=new Uint8Array(4096),this._bank3=new Uint8Array(4096),this._hasSC=!1,this._saraRAM=new Uint8Array(128),this._bus=null,16384!==e.length)throw new Error(`buffer is not a 16k cartridge image: wrong length ${e.length}`);for(let t=0;t<4096;t++)this._bank0[t]=e[t],this._bank1[t]=e[4096+t],this._bank2[t]=e[8192+t],this._bank3[t]=e[12288+t];this.reset()}reset(){this._bank=this._bank0,this._hasSC=!1}read(e){return this._access(4095&e,this._bus.getLastDataBusValue()),this.peek(e)}peek(e){return e&=4095,this._hasSC&&e>=128&&e<256?this._saraRAM[e-128]:this._bank[e]}write(e,t){(e&=4095)<128&&this._supportSC&&(this._hasSC=!0),this._access(e,t)}getType(){return CartridgeInfo.CartridgeType.bankswitch_16k_F6}randomize(e){for(let t=0;t<this._saraRAM.length;t++)this._saraRAM[t]=e.int(255)}setBus(e){return this._bus=e,this}_access(e,t){if(e<128&&this._hasSC)this._saraRAM[e]=255&t;else switch(e){case 4086:this._bank=this._bank0;break;case 4087:this._bank=this._bank1;break;case 4088:this._bank=this._bank2;break;case 4089:this._bank=this._bank3}}}class CartridgeE0 extends AbstractCartridge{constructor(e){if(super(),this._banks=new Array(8),this._activeBanks=new Array(4),8192!==e.length)throw new Error(`buffer is not an 8k cartridge image: invalid length ${e.length}`);for(let e=0;e<8;e++)this._banks[e]=new Uint8Array(1024);for(let t=0;t<1024;t++)for(let s=0;s<8;s++)this._banks[s][t]=e[1024*s+t];this.reset()}static matchesBuffer(e){const t=searchForSignatures(e,[[141,224,31],[141,224,95],[141,233,255],[12,224,31],[173,224,31],[173,233,255],[173,237,255],[173,243,191]]);for(let e=0;e<t.length;e++)if(t[e]>0)return!0;return!1}reset(){for(let e=0;e<4;e++)this._activeBanks[e]=this._banks[7]}read(e){return(e&=4095)>=4064&&e<4088&&this._handleBankswitch(e),this._activeBanks[e>>10][1023&e]}peek(e){return e&=4095,this._activeBanks[e>>10][1023&e]}write(e,t){const s=4095&e;return s>=4064&&s<4088&&this._handleBankswitch(s),super.write(e,t)}getType(){return CartridgeInfo.CartridgeType.bankswitch_8k_E0}_handleBankswitch(e){e<4072?this._activeBanks[0]=this._banks[e-4064]:e<4080?this._activeBanks[1]=this._banks[e-4072]:this._activeBanks[2]=this._banks[e-4080]}}class CartridgeFE extends AbstractCartridge{constructor(e){if(super(),this._bank0=new Uint8Array(4096),this._bank1=new Uint8Array(4096),this._lastAccessWasFE=!1,this._lastAddressBusValue=-1,8192!==e.length)throw new Error(`buffer is not an 8k cartridge image: wrong length ${e.length}`);for(let t=0;t<4096;t++)this._bank0[t]=e[t],this._bank1[t]=e[4096+t];this.reset()}static matchesBuffer(e){const t=searchForSignatures(e,[[32,0,208,198,197],[32,195,248,165,130],[208,251,32,115,254],[32,0,240,132,214]]);for(let e=0;e<t.length;e++)if(t[e]>0)return!0;return!1}reset(){this._bank=this._bank0,this._lastAccessWasFE=!1,this._lastAddressBusValue=-1}read(e){return this._bank[4095&e]}write(e,t){super.write(e,t)}setBus(e){return this._bus=e,this._bus.event.read.addHandler(CartridgeFE._onBusAccess,this),this._bus.event.write.addHandler(CartridgeFE._onBusAccess,this),this}getType(){return CartridgeInfo.CartridgeType.bankswitch_8k_FE}static _onBusAccess(e,t){const s=t._lastAddressBusValue;if(t._lastAddressBusValue=8191&t._bus.getLastAddresBusValue(),t._lastAddressBusValue!==s){if(t._lastAccessWasFE){const e=224&t._bus.getLastDataBusValue();t._bank=0===e?t._bank0:(32&t._bus.getLastDataBusValue())>0?t._bank0:t._bank1}t._lastAccessWasFE=510===t._lastAddressBusValue}}}class Cartridge3F extends AbstractCartridge{constructor(e){if(super(),this._banks=new Array(4),this._bus=null,8192!==e.length)throw new Error(`buffer is not an 8k cartridge image: invalid length ${e.length}`);for(let e=0;e<4;e++)this._banks[e]=new Uint8Array(2048);this._bank1=this._banks[3],this._bank0=this._banks[0];for(let t=0;t<2048;t++)for(let s=0;s<4;s++)this._banks[s][t]=e[2048*s+t]}static matchesBuffer(e){return searchForSignatures(e,[[133,63]])[0]>=2}reset(){this._bank0=this._banks[0]}setBus(e){return this._bus=e,this._bus.event.read.addHandler(Cartridge3F._onBusAccess,this),this._bus.event.write.addHandler(Cartridge3F._onBusAccess,this),this}read(e){return(e&=4095)<2048?this._bank0[e]:this._bank1[2047&e]}getType(){return CartridgeInfo.CartridgeType.bankswitch_8k_3F}static _onBusAccess(e,t){63===t._bus.getLastAddresBusValue()&&(t._bank0=t._banks[3&t._bus.getLastDataBusValue()])}}class Cartridge3E extends AbstractCartridge{constructor(e){if(super(),this._banks=null,this._ramSelect=!1,this._ramBanks=new Array(256),this._bus=null,0!=(2047&e.length))throw new Error(`buffer length ${e.length} is not a multiple of 2k`);const t=e.length>>>11;if(t<2)throw new Error("image must have at least 2k");this._banks=new Array(t);for(let e=0;e<t;e++)this._banks[e]=new Uint8Array(2048);for(let e=0;e<=255;e++)this._ramBanks[e]=new Uint8Array(1024);this._ramBank=this._ramBanks[0],this._bank1=this._banks[t-1],this._bank0=this._banks[0];for(let s=0;s<2048;s++)for(let i=0;i<t;i++)this._banks[i][s]=e[2048*i+s]}static matchesBuffer(e){return searchForSignatures(e,[[133,62,169,0]])[0]>=1}reset(){this._bank0=this._banks[0]}randomize(e){for(let t=0;t<this._ramBanks.length;t++)for(let s=0;s<1024;s++)this._ramBanks[t][s]=e.int(255)}setBus(e){return this._bus=e,this._bus.event.read.addHandler(Cartridge3E._onBusAccess,this),this._bus.event.write.addHandler(Cartridge3E._onBusAccess,this),this}read(e){return e&=4095,this._ramSelect?e<1024?this._ramBank[e]:e<2048?this._ramBank[1023&e]=this._bus.getLastDataBusValue():this._bank1[2047&e]:e<2048?this._bank0[e]:this._bank1[2047&e]}peek(e){return e&=4095,this._ramSelect?e<1024?this._ramBank[e]:e<2048?this._bus.getLastDataBusValue():this._bank1[2047&e]:e<2048?this._bank0[e]:this._bank1[2047&e]}write(e,t){this._ramSelect&&(e&=4095)>=1024&&e<2048&&(this._ramBank[1023&e]=t)}getType(){return CartridgeInfo.CartridgeType.bankswitch_3E}static _onBusAccess(e,t){switch(t._bus.getLastAddresBusValue()){case 63:t._ramSelect=!1,t._bank0=t._banks[t._bus.getLastDataBusValue()%t._banks.length];break;case 62:t._ramSelect=!0,t._ramBank=t._ramBanks[t._bus.getLastDataBusValue()%32]}}}class CartridgeUA extends AbstractCartridge{constructor(e){if(super(),this._bus=null,this._bank=null,this._bank0=new Uint8Array(4096),this._bank1=new Uint8Array(4096),8192!==e.length)throw new Error(`buffer is not an 8k cartridge image: wrong length ${e.length}`);for(let t=0;t<4096;t++)this._bank0[t]=e[t],this._bank1[t]=e[4096+t];this.reset()}static matchesBuffer(e){const t=searchForSignatures(e,[[141,64,2],[173,64,2],[189,31,2]]);for(let e=0;e<t.length;e++)if(t[e]>0)return!0;return!1}reset(){this._bank=this._bank0}read(e){return this._bank[4095&e]}setBus(e){return this._bus=e,e.event.read.addHandler(CartridgeUA._onBusAccess,this),e.event.write.addHandler(CartridgeUA._onBusAccess,this),this}getType(){return CartridgeInfo.CartridgeType.bankswitch_8k_UA}static _onBusAccess(e,t){switch(t._bus.getLastAddresBusValue()){case 544:t._bank=t._bank0;break;case 576:t._bank=t._bank1}}}class CartridgeFA extends AbstractCartridge{constructor(e){if(super(),this._bank0=new Uint8Array(4096),this._bank1=new Uint8Array(4096),this._bank2=new Uint8Array(4096),this._ram=new Uint8Array(256),12288!==e.length)throw new Error(`buffer is not a 12k cartridge image: wrong length ${e.length}`);for(let t=0;t<4096;t++)this._bank0[t]=e[t],this._bank1[t]=e[4096+t],this._bank2[t]=e[8192+t];this.reset()}reset(){this._bank=this._bank0}randomize(e){for(let t=0;t<this._ram.length;t++)this._ram[t]=e.int(255)}read(e){return this._handleBankswitch(4095&e),this.peek(e)}peek(e){return(e&=4095)>=256&&e<512?this._ram[255&e]:this._bank[e]}write(e,t){e&=4095,this._handleBankswitch(e),e<256?this._ram[e]=255&t:super.write(e,t)}getType(){return CartridgeInfo.CartridgeType.bankswitch_12k_FA}_handleBankswitch(e){switch(e){case 4088:this._bank=this._bank0;break;case 4089:this._bank=this._bank1;break;case 4090:this._bank=this._bank2}}}class CartrdigeE7 extends AbstractCartridge{constructor(e){if(super(),this._banks=new Array(8),this._ram0=new Uint8Array(1024),this._ram1Banks=new Array(4),this._ram0Enabled=!1,16384!==e.length)throw new Error(`buffer is not a 16k cartridge image: wrong length ${e.length}`);for(let e=0;e<8;e++)this._banks[e]=new Uint8Array(2048);for(let e=0;e<4;e++)this._ram1Banks[e]=new Uint8Array(256);for(let t=0;t<2048;t++)for(let s=0;s<8;s++)this._banks[s][t]=e[2048*s+t];this.reset()}static matchesBuffer(e){const t=searchForSignatures(e,[[173,226,255],[173,229,255],[173,229,31],[173,231,31],[12,231,31],[141,231,255],[141,231,31]]);for(let e=0;e<t.length;e++)if(t[e]>0)return!0;return!1}reset(){this._bank0=this._banks[0],this._ram1=this._ram1Banks[0],this._ram0Enabled=!1}read(e){return this._handleBankswitch(4095&e),this.peek(e)}peek(e){return(e&=4095)<2048?this._ram0Enabled?e>=1024?this._ram0[e-1024]:0:this._bank0[e]:e<=2559?e>=2304?this._ram1[e-2304]:0:this._banks[7][2047-(4095-e)]}write(e,t){e&=4095,this._handleBankswitch(e),e<1024?this._ram0Enabled?this._ram0[e]=t:super.write(e,t):e<2048?super.write(e,t):e<2303?this._ram1[e-2048]=t:super.write(e,t)}getType(){return CartridgeInfo.CartridgeType.bankswitch_16k_E7}randomize(e){for(let t=0;t<4;t++)for(let s=0;s<this._ram1Banks[t].length;s++)this._ram1Banks[t][s]=e.int(255);for(let t=0;t<this._ram0.length;t++)this._ram0[t]=e.int(255)}_handleBankswitch(e){e<4064||(e<=4070?(this._bank0=this._banks[15&e],this._ram0Enabled=!1):4071===e?this._ram0Enabled=!0:e<=4075&&(this._ram1=this._ram1Banks[e-4072]))}}class CartridgeF0 extends AbstractCartridge{constructor(e){if(super(),this._banks=new Array(16),this._bankIdx=0,65536!==e.length)throw new Error(`buffer is not a 64k cartridge image: wrong length ${e.length}`);for(let e=0;e<16;e++)this._banks[e]=new Uint8Array(4096);for(let t=0;t<4096;t++)for(let s=0;s<16;s++)this._banks[s][t]=e[4096*s+t];this.reset()}reset(){this._bankIdx=0,this._currentBank=this._banks[this._bankIdx]}read(e){return e&=4095,this._handleBankswitch(e),this._currentBank[e]}peek(e){return this._currentBank[4095&e]}write(e,t){e&=4095,this._handleBankswitch(e),super.write(e,t)}getType(){return CartridgeInfo.CartridgeType.bankswitch_64k_F0}_handleBankswitch(e){4080===e&&(this._bankIdx=this._bankIdx+1&15,this._currentBank=this._banks[this._bankIdx])}}class CartridgeEF extends AbstractCartridge{constructor(e,t=!0){if(super(),this._supportSC=t,this._bus=null,this._banks=new Array(16),this._ram=new Uint8Array(128),this._hasSC=!1,65536!==e.length)throw new Error(`buffer is not a 64k cartridge image: wrong length ${e.length}`);for(let e=0;e<16;e++)this._banks[e]=new Uint8Array(4096);for(let t=0;t<4096;t++)for(let s=0;s<16;s++)this._banks[s][t]=e[4096*s+t];this.reset()}static matchesBuffer(e){const t=t=>{const s=t.split("").map(e=>e.charCodeAt(0));for(let t=0;t<s.length;t++)if(s[t]!==e[65528+t])return!1;return!0};if(65536!==e.length)return!1;if(t("efef")||t("efsc"))return!0;const s=searchForSignatures(e,[[12,224,255],[173,224,255],[12,224,31],[173,224,31]]);for(let e=0;e<4;e++)if(s[e]>0)return!0;return!1}reset(){this._bank=this._banks[15],this._hasSC=!1}getType(){return CartridgeInfo.CartridgeType.bankswitch_64k_EF}randomize(e){for(let t=0;t<this._ram.length;t++)this._ram[t]=e.int(255)}setBus(e){return this._bus=e,this}read(e){return this._access(4095&e,this._bus.getLastDataBusValue()),this.peek(e)}peek(e){return e&=4095,this._hasSC&&e>=128&&e<256?this._ram[e-128]:this._bank[e]}write(e,t){(e&=4095)<128&&this._supportSC&&(this._hasSC=!0),this._access(e,t)}_access(e,t){e<128&&this._hasSC?this._ram[e]=t:e>=4064&&e<=4079&&(this._bank=this._banks[e-4064])}}class CartridgeF4 extends AbstractCartridge{constructor(e,t=!0){if(super(),this._supportSC=t,this._bus=null,this._banks=new Array(8),this._ram=new Uint8Array(128),this._hasSC=!1,32768!==e.length)throw new Error(`buffer is not a 32k cartridge image: wrong length ${e.length}`);for(let e=0;e<8;e++)this._banks[e]=new Uint8Array(4096);for(let t=0;t<4096;t++)for(let s=0;s<8;s++)this._banks[s][t]=e[4096*s+t];this.reset()}reset(){this._bank=this._banks[0],this._hasSC=!1}getType(){return CartridgeInfo.CartridgeType.bankswitch_32k_F4}randomize(e){for(let t=0;t<this._ram.length;t++)this._ram[t]=e.int(255)}setBus(e){return this._bus=e,this}read(e){return this._access(4095&e,this._bus.getLastDataBusValue()),this.peek(e)}peek(e){return e&=4095,this._hasSC&&e>=128&&e<256?this._ram[e-128]:this._bank[e]}write(e,t){(e&=4095)<128&&this._supportSC&&(this._hasSC=!0),this._access(e,t)}_access(e,t){e<128&&this._hasSC?this._ram[e]=t:e>=4084&&e<=4091&&(this._bank=this._banks[e-4084])}}class CartridgeFA2 extends AbstractCartridge{constructor(e){if(super(),this._banks=new Array(7),this._ram=new Uint8Array(256),this._savedRam=new Uint8Array(256),this._accessCounter=0,this._accessCounterLimit=0,28672!==e.length&&29696!==e.length)throw new Error(`buffer is not a 28k/29k cartridge image: wrong length ${e.length}`);for(let e=0;e<7;e++)this._banks[e]=new Uint8Array(4096);const t=28672===e.length?0:1024;for(let s=0;s<4096;s++)for(let i=0;i<7;i++)this._banks[i][s]=e[4096*i+s+t];this.reset()}static matchesBuffer(e){const t=searchForSignatures(e,[[160,193,31,224],[0,128,2,224]]);return t[0]>0||t[1]>0}reset(){this._accessCounter=0,this._accessCounterLimit=0,this._bank=this._banks[0]}getType(){return CartridgeInfo.CartridgeType.bankswitch_FA2}randomize(e){for(let t=0;t<this._ram.length;t++)this._ram[t]=e.int(255)}setBus(e){return this._bus=e,this}read(e){return this.write(4095&e,this._bus.getLastDataBusValue()),this.peek(e)}peek(e){return(e&=4095)>=256&&e<512?this._ram[e-256]:4084===e?this._accessCounter>=this._accessCounterLimit?-65&this._bank[e]:64|this._bank[e]:this._bank[e]}write(e,t){if(e&=4095,this._accessCounter++,!(e<256))return 4084===e?this._handleIo():void(e>=4085&&e<=4091&&(this._bank=this._banks[e-4085]));this._ram[e]=t}_handleIo(){if(!(this._accessCounter<this._accessCounterLimit)){if(1===this._ram[255]){for(let e=0;e<256;e++)this._ram[e]=this._savedRam[e];this._accessCounterLimit=10}else{if(2!==this._ram[255])return;for(let e=0;e<256;e++)this._savedRam[e]=this._ram[e];this._accessCounterLimit=100}this._accessCounter=0,this._ram[255]=0}}}class Header{constructor(e){this.blockLocation=null,this.blockChecksum=null,this.startAddressLow=e[8192],this.startAddressHigh=e[8193],this.controlWord=e[8194],this.blockCount=e[8195],this.checksum=e[8196],this.multiloadId=e[8197],this.progressBarSpeedLow=e[8198],this.progressBarSpeedHigh=e[8199],this.blockLocation=new Uint8Array(this.blockCount),this.blockChecksum=new Uint8Array(this.blockCount);for(let t=0;t<this.blockCount;t++)this.blockLocation[t]=e[8208+t],this.blockChecksum[t]=e[8256+t]}verify(){return 85==(255&this.startAddressLow+this.startAddressHigh+this.controlWord+this.blockCount+this.checksum+this.multiloadId+this.progressBarSpeedLow+this.progressBarSpeedHigh)}}const bios=decode("pfqFgEwY+HjYqQCi/5qqqJUA6ND7TBj4ogCtBvCN+P+gAKIolATKEPuiHJSByhD7qQCFG4UchR2FHoUfhRmFGoUIhQGpEIUhhQKiB8rK0P2pAIUghRCFEYUChSqpBYUKqf+FDYUOhQ+FhIWFqfCFg6l0hQmpDIUVqR+FF4WCqQeFGaIIoACFAojQ+4UChQKpAoUChQCFAoUChQKpAIUAyhDkBoNmhCaFpYOFDaWEhQ6lhYUPpoLKhoKGF+AK0MOpAoUBohygAIQZhAmUgcoQ+6IArADw6rwA9+jQ9qILvRL5lfDKEPilgEzwAKIGvR35lfDKEPiu8P+GgLwA8K3x/67y/4b0rvP/hvWi/6AAmkzwAI35/637/9D7TOv4jfj/TAAA");class CartridgeSupercharger extends AbstractCartridge{constructor(e){if(super(),this._loadCount=0,this._loads=null,this._headers=null,this._rom=new Uint8Array(2048),this._ramBanks=new Array(3),this._bank0=null,this._bank1=null,this._bank1Type=1,this._transitionCount=0,this._pendingWriteData=0,this._pendingWrite=!1,this._lastAddressBusValue=-1,this._writeRamEnabled=!1,this._loadInProgress=!1,this._loadTimestamp=0,this._cpuTimeProvider=null,e.length%8448!=0)throw new Error("not a supercharger image --- invalid size");this._loadCount=e.length/8448,this._loads=new Array(this._loadCount),this._headers=new Array(this._loadCount);for(let e=0;e<this._loadCount;e++)this._loads[e]=new Uint8Array(8448);for(let t=0;t<8448;t++)for(let s=0;s<this._loadCount;s++)this._loads[s][t]=e[8448*s+t];for(let e=0;e<this._loadCount;e++)this._headers[e]=new Header(this._loads[e]),this._headers[e].verify()||console.log(`load ${e} has invalid checksum`);for(let e=0;e<3;e++)this._ramBanks[e]=new Uint8Array(2048);this._setupRom(),this.reset()}reset(){this._setBankswitchMode(0),this._transitionCount=0,this._pendingWrite=!1,this._pendingWriteData=0,this._lastAddressBusValue=-1,this._writeRamEnabled=!1,this._loadInProgress=!1,this._loadTimestamp=0}setBus(e){return this._bus=e,this._bus.event.read.addHandler(CartridgeSupercharger._onBusAccess,this),this._bus.event.write.addHandler(CartridgeSupercharger._onBusAccess,this),this}setCpuTimeProvider(e){return this._cpuTimeProvider=e,this}setRng(e){return this._rng=e,this}read(e){return this._access(e,this._bus.getLastDataBusValue())}peek(e){return(e&=4095)<2048?this._bank0[e]:this._bank1[2047&e]}write(e,t){this._access(e,t)}getType(){return CartridgeInfo.CartridgeType.bankswitch_supercharger}static _onBusAccess(e,t){const s=t._bus.getLastAddresBusValue();s===t._lastAddressBusValue||t._loadInProgress||(t._transitionCount<=5&&t._transitionCount++,t._lastAddressBusValue=s)}_access(e,t){if(e&=4095,this._loadInProgress){if(!(this._cpuTimeProvider()-this._loadTimestamp>.001))return t;this._loadInProgress=!1}const s=e<2048?this._bank0[e]:this._bank1[2047&e];if(!(0!=(3840&e)||this._pendingWrite&&this._writeRamEnabled))return this._pendingWriteData=255&e,this._transitionCount=0,this._pendingWrite=!0,s;if(4088===e)return this._setBankswitchMode((28&this._pendingWriteData)>>>2),this._writeRamEnabled=(2&this._pendingWriteData)>0,this._pendingWrite=!1,s;if(4089===e&&1===this._bank1Type&&(8191&this._lastAddressBusValue)<255)return this._loadIntoRam(t),s;if(this._pendingWrite&&this._writeRamEnabled&&5===this._transitionCount){if(this._pendingWrite=!1,e<2048)this._bank0[e]=this._pendingWriteData;else{if(0!==this._bank1Type)return s;this._bank1[2047&e]=this._pendingWriteData}return this._pendingWriteData}return s}_setBankswitchMode(e){switch(e){case 0:return this._configureBanks(2,1);case 1:return this._configureBanks(0,1);case 2:return this._configureBanks(2,0,0);case 3:return this._configureBanks(0,0,2);case 4:return this._configureBanks(2,1);case 5:return this._configureBanks(1,1);case 6:return this._configureBanks(2,0,1);case 7:return this._configureBanks(1,0,2);default:throw new Error("invalid bankswitching mode")}}_configureBanks(e,t,s=0){this._bank0=this._ramBanks[e],this._bank1Type=t,this._bank1=0===t?this._ramBanks[s]:this._rom}_setupRom(){for(let e=0;e<2048;e++)this._rom[e]=0;for(let e=0;e<bios.length;e++)this._rom[e]=bios[e];this._rom[2047]=this._rom[2045]=248,this._rom[2046]=this._rom[2044]=7}_loadIntoRam(e){let t;for(t=0;t<this._loadCount&&(this._headers[t].multiloadId!==e&&1!==this._loadCount);t++);t>=this._loadCount&&console.log(`no load with id ${e}`);const s=this._headers[t],i=this._loads[t];for(let e=0;e<s.blockCount;e++){const r=s.blockLocation[e];let a=3&r;a>2&&(a=0,console.log(`invalid bank for block ${e}, load ${t}`));const n=256*((28&r)>>>2);let o=r+s.blockChecksum[e];for(let t=0;t<256;t++)o+=i[256*e+t],this._ramBanks[a][n+t]=i[256*e+t];85!=(255&o)&&console.log(`load ${t}, block ${e}: invalid checksum`)}this._rom[2032]=s.controlWord,this._rom[2033]=this._rng.int(255),this._rom[2034]=s.startAddressLow,this._rom[2035]=s.startAddressHigh,this._loadInProgress=!0,this._loadTimestamp=this._cpuTimeProvider()}}const mixerTable=new Uint8Array([0,4,5,9,6,10,11,15]);class CartridgeDPC extends AbstractCartridge{constructor(e){if(super(),this._bank0=new Uint8Array(4096),this._bank1=new Uint8Array(4096),this._fetcherData=new Uint8Array(2048),this._fetchers=new Array(8),this._rng=1,this._cpuTimeProvider=null,this._lastCpuTime=0,this._clockAccumulator=0,e.length<10240)throw new Error(`buffer is not a DPC image: too small ${e.length}`);for(let e=0;e<8;e++)this._fetchers[e]=new Fetcher;for(let t=0;t<4096;t++)this._bank0[t]=e[t],this._bank1[t]=e[4096+t];for(let t=0;t<2048;t++)this._fetcherData[t]=e[8192+t];this.reset()}reset(){this._bank=this._bank1,this._rng=1,this._fetchers.forEach(e=>e.reset()),this._lastCpuTime=0,this._clockAccumulator=0}getType(){return CartridgeInfo.CartridgeType.bankswitch_8k_DPC}setBus(e){return this._bus=e,this}setCpuTimeProvider(e){return this._cpuTimeProvider=e,this}read(e){return this._access(e,this._bus.getLastDataBusValue())}peek(e){return this._bank[4095&e]}write(e,t){this._access(e,t)}_access(e,t){if((e&=4095)>127){switch(e){case 4088:this._bank=this._bank0;break;case 4089:this._bank=this._bank1}return this._bank[e]}if(e<8)return 4&e?(this._clockMusicFetchers(),mixerTable[4&this._fetchers[5].mask|2&this._fetchers[6].mask|1&this._fetchers[7].mask]):this._randomNext();if(e<64){const t=this._fetchers[e-8&7],s=t.mask;let i=this._fetcherData[2047-t.pointer];switch(t.next(),e-8>>>3){case 0:return i;case 1:return i&s;case 2:return i&=s,255&(i<<4|i>>>4);case 3:return i&=s,(1&i)<<7|(2&i)<<5|(4&i)<<3|(8&i)<<1|(16&i)>>>1|(32&i)>>>3|(64&i)>>>5|(128&i)>>>7;case 4:return(i&s)>>>1;case 5:return i<<1&s;case 6:return s}}if(e<96){const s=this._fetchers[e-64&7];switch(e-64>>>3){case 0:this._clockMusicFetchers(),s.setStart(t);break;case 1:this._clockMusicFetchers(),s.setEnd(t);break;case 2:s.setLow(t);break;case 3:s.setHigh(t),e>92&&s.setMusicMode(t)}return this._bank[e]}return e>=112&&e<120?(this._rng=1,this._bank[e]):this._bank[e]}_randomNext(){const e=this._rng;return this._rng=255&(this._rng<<1|1&~(this._rng>>>7^this._rng>>>5^this._rng>>>4^this._rng>>>3)),e}_clockMusicFetchers(){const e=this._cpuTimeProvider();this._clockAccumulator+=2e4*(e-this._lastCpuTime),this._lastCpuTime=e;const t=Math.floor(this._clockAccumulator);if(this._clockAccumulator-=t,0!==t)for(let e=5;e<8;e++)this._fetchers[e].forwardClock(t)}}class Fetcher{constructor(){this.pointer=0,this.start=0,this.end=0,this.musicMode=!1,this.mask=0}contructor(){this.reset()}reset(){this.pointer=this.start=this.end=this.mask=0,this.musicMode=!1}next(){this.musicMode||(this.pointer=this.pointer+2047&2047,this._updateMask())}setStart(e){this.start=e,this.mask=0,this._updateMask()}setEnd(e){this.end=e,this._updateMask()}setLow(e){this.pointer=1792&this.pointer|e,this._updateMask()}setHigh(e){this.pointer=255&this.pointer|(7&e)<<8,this._updateMask()}setMusicMode(e){this.musicMode=0!=(16&e)}forwardClock(e){if(!this.musicMode)return;const t=this.start+1,s=((255&this.pointer)+t-e%t)%t,i=256+this.start-s&255,r=256+this.end-s&255;this.pointer=1792&this.pointer|s,this.mask=i>r?0:255}_updateMask(){(255&this.pointer)===this.start&&(this.mask=255),(255&this.pointer)===this.end&&(this.mask=0)}}var global$1="undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{};function defaultSetTimout(){throw new Error("setTimeout has not been defined")}function defaultClearTimeout(){throw new Error("clearTimeout has not been defined")}var cachedSetTimeout=defaultSetTimout,cachedClearTimeout=defaultClearTimeout;function runTimeout(e){if(cachedSetTimeout===setTimeout)return setTimeout(e,0);if((cachedSetTimeout===defaultSetTimout||!cachedSetTimeout)&&setTimeout)return cachedSetTimeout=setTimeout,setTimeout(e,0);try{return cachedSetTimeout(e,0)}catch(t){try{return cachedSetTimeout.call(null,e,0)}catch(t){return cachedSetTimeout.call(this,e,0)}}}function runClearTimeout(e){if(cachedClearTimeout===clearTimeout)return clearTimeout(e);if((cachedClearTimeout===defaultClearTimeout||!cachedClearTimeout)&&clearTimeout)return cachedClearTimeout=clearTimeout,clearTimeout(e);try{return cachedClearTimeout(e)}catch(t){try{return cachedClearTimeout.call(null,e)}catch(t){return cachedClearTimeout.call(this,e)}}}"function"==typeof global$1.setTimeout&&(cachedSetTimeout=setTimeout),"function"==typeof global$1.clearTimeout&&(cachedClearTimeout=clearTimeout);var queue=[],draining=!1,currentQueue,queueIndex=-1;function cleanUpNextTick(){draining&&currentQueue&&(draining=!1,currentQueue.length?queue=currentQueue.concat(queue):queueIndex=-1,queue.length&&drainQueue())}function drainQueue(){if(!draining){var e=runTimeout(cleanUpNextTick);draining=!0;for(var t=queue.length;t;){for(currentQueue=queue,queue=[];++queueIndex<t;)currentQueue&&currentQueue[queueIndex].run();queueIndex=-1,t=queue.length}currentQueue=null,draining=!1,runClearTimeout(e)}}function nextTick(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var s=1;s<arguments.length;s++)t[s-1]=arguments[s];queue.push(new Item(e,t)),1!==queue.length||draining||runTimeout(drainQueue)}function Item(e,t){this.fun=e,this.array=t}Item.prototype.run=function(){this.fun.apply(null,this.array)};var title="browser",platform="browser",browser=!0,env={},argv=[],version="",versions={},release={},config={};function noop(){}var on=noop,addListener=noop,once=noop,off=noop,removeListener=noop,removeAllListeners=noop,emit=noop;function binding(e){throw new Error("process.binding is not supported")}function cwd(){return"/"}function chdir(e){throw new Error("process.chdir is not supported")}function umask(){return 0}var performance=global$1.performance||{},performanceNow=performance.now||performance.mozNow||performance.msNow||performance.oNow||performance.webkitNow||function(){return(new Date).getTime()};function hrtime(e){var t=.001*performanceNow.call(performance),s=Math.floor(t),i=Math.floor(t%1*1e9);return e&&(s-=e[0],(i-=e[1])<0&&(s--,i+=1e9)),[s,i]}var startTime=new Date;function uptime(){return(new Date-startTime)/1e3}var process={nextTick:nextTick,title:title,browser:browser,env:env,argv:argv,version:version,versions:versions,on:on,addListener:addListener,once:once,off:off,removeListener:removeListener,removeAllListeners:removeAllListeners,emit:emit,binding:binding,cwd:cwd,chdir:chdir,umask:umask,hrtime:hrtime,platform:platform,release:release,config:config,uptime:uptime};function normalizeArray(e,t){for(var s=0,i=e.length-1;i>=0;i--){var r=e[i];"."===r?e.splice(i,1):".."===r?(e.splice(i,1),s++):s&&(e.splice(i,1),s--)}if(t)for(;s--;s)e.unshift("..");return e}var splitPathRe=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/,splitPath=function(e){return splitPathRe.exec(e).slice(1)};function resolve(){for(var e="",t=!1,s=arguments.length-1;s>=-1&&!t;s--){var i=s>=0?arguments[s]:"/";if("string"!=typeof i)throw new TypeError("Arguments to path.resolve must be strings");i&&(e=i+"/"+e,t="/"===i.charAt(0))}return(t?"/":"")+(e=normalizeArray(filter(e.split("/"),(function(e){return!!e})),!t).join("/"))||"."}function normalize(e){var t=isAbsolute(e),s="/"===substr(e,-1);return(e=normalizeArray(filter(e.split("/"),(function(e){return!!e})),!t).join("/"))||t||(e="."),e&&s&&(e+="/"),(t?"/":"")+e}function isAbsolute(e){return"/"===e.charAt(0)}function join(){return normalize(filter(Array.prototype.slice.call(arguments,0),(function(e,t){if("string"!=typeof e)throw new TypeError("Arguments to path.join must be strings");return e})).join("/"))}function relative(e,t){function s(e){for(var t=0;t<e.length&&""===e[t];t++);for(var s=e.length-1;s>=0&&""===e[s];s--);return t>s?[]:e.slice(t,s-t+1)}e=resolve(e).substr(1),t=resolve(t).substr(1);for(var i=s(e.split("/")),r=s(t.split("/")),a=Math.min(i.length,r.length),n=a,o=0;o<a;o++)if(i[o]!==r[o]){n=o;break}var h=[];for(o=n;o<i.length;o++)h.push("..");return(h=h.concat(r.slice(n))).join("/")}var sep="/",delimiter=":";function dirname(e){var t=splitPath(e),s=t[0],i=t[1];return s||i?(i&&(i=i.substr(0,i.length-1)),s+i):"."}function basename(e,t){var s=splitPath(e)[2];return t&&s.substr(-1*t.length)===t&&(s=s.substr(0,s.length-t.length)),s}function extname(e){return splitPath(e)[3]}var require$$1={extname:extname,basename:basename,dirname:dirname,sep:sep,delimiter:delimiter,relative:relative,join:join,isAbsolute:isAbsolute,normalize:normalize,resolve:resolve};function filter(e,t){if(e.filter)return e.filter(t);for(var s=[],i=0;i<e.length;i++)t(e[i],i,e)&&s.push(e[i]);return s}var substr="b"==="ab".substr(-1)?function(e,t,s){return e.substr(t,s)}:function(e,t,s){return t<0&&(t=e.length+t),e.substr(t,s)},thumbulator=createCommonjsModule((function(module){var Module=function(Module){Module=Module||{};var Module=Module,Module;Module||(Module=(void 0!==Module?Module:null)||{});var moduleOverrides={};for(var key in Module)Module.hasOwnProperty(key)&&(moduleOverrides[key]=Module[key]);var ENVIRONMENT_IS_WEB=!1,ENVIRONMENT_IS_WORKER=!1,ENVIRONMENT_IS_NODE=!1,ENVIRONMENT_IS_SHELL=!1,nodeFS,nodePath;if(Module.ENVIRONMENT)if("WEB"===Module.ENVIRONMENT)ENVIRONMENT_IS_WEB=!0;else if("WORKER"===Module.ENVIRONMENT)ENVIRONMENT_IS_WORKER=!0;else if("NODE"===Module.ENVIRONMENT)ENVIRONMENT_IS_NODE=!0;else{if("SHELL"!==Module.ENVIRONMENT)throw new Error("The provided Module['ENVIRONMENT'] value is not valid. It must be one of: WEB|WORKER|NODE|SHELL.");ENVIRONMENT_IS_SHELL=!0}else ENVIRONMENT_IS_WEB="object"==typeof window,ENVIRONMENT_IS_WORKER="function"==typeof importScripts,ENVIRONMENT_IS_NODE="object"==typeof process&&"function"==typeof require&&!ENVIRONMENT_IS_WEB&&!ENVIRONMENT_IS_WORKER,ENVIRONMENT_IS_SHELL=!ENVIRONMENT_IS_WEB&&!ENVIRONMENT_IS_NODE&&!ENVIRONMENT_IS_WORKER;if(ENVIRONMENT_IS_NODE)Module.print||(Module.print=console.log),Module.printErr||(Module.printErr=console.warn),Module.read=function(e,t){nodeFS||(nodeFS=require$$0),nodePath||(nodePath=require$$1),e=nodePath.normalize(e);var s=nodeFS.readFileSync(e);return t?s:s.toString()},Module.readBinary=function(e){var t=Module.read(e,!0);return t.buffer||(t=new Uint8Array(t)),assert(t.buffer),t},Module.load=function(e){globalEval(read(e))},Module.thisProgram||(process.argv.length>1?Module.thisProgram=process.argv[1].replace(/\\/g,"/"):Module.thisProgram="unknown-program"),Module.arguments=process.argv.slice(2),Module.inspect=function(){return"[Emscripten Module object]"};else if(ENVIRONMENT_IS_SHELL)Module.print||(Module.print=print),"undefined"!=typeof printErr&&(Module.printErr=printErr),"undefined"!=typeof read?Module.read=read:Module.read=function(){throw"no read() available"},Module.readBinary=function(e){if("function"==typeof readbuffer)return new Uint8Array(readbuffer(e));var t=read(e,"binary");return assert("object"==typeof t),t},"undefined"!=typeof scriptArgs?Module.arguments=scriptArgs:void 0!==arguments&&(Module.arguments=arguments),"function"==typeof quit&&(Module.quit=function(e,t){quit(e)});else{if(!ENVIRONMENT_IS_WEB&&!ENVIRONMENT_IS_WORKER)throw"Unknown runtime environment. Where are we?";if(Module.read=function(e){var t=new XMLHttpRequest;return t.open("GET",e,!1),t.send(null),t.responseText},ENVIRONMENT_IS_WORKER&&(Module.readBinary=function(e){var t=new XMLHttpRequest;return t.open("GET",e,!1),t.responseType="arraybuffer",t.send(null),new Uint8Array(t.response)}),Module.readAsync=function(e,t,s){var i=new XMLHttpRequest;i.open("GET",e,!0),i.responseType="arraybuffer",i.onload=function(){200==i.status||0==i.status&&i.response?t(i.response):s()},i.onerror=s,i.send(null)},void 0!==arguments&&(Module.arguments=arguments),"undefined"!=typeof console)Module.print||(Module.print=function(e){console.log(e)}),Module.printErr||(Module.printErr=function(e){console.warn(e)});else{var TRY_USE_DUMP=!1;Module.print||(Module.print=TRY_USE_DUMP&&"undefined"!=typeof dump?function(e){dump(e)}:function(e){})}ENVIRONMENT_IS_WORKER&&(Module.load=importScripts),void 0===Module.setWindowTitle&&(Module.setWindowTitle=function(e){document.title=e})}function globalEval(e){eval.call(null,e)}for(var key in!Module.load&&Module.read&&(Module.load=function(e){globalEval(Module.read(e))}),Module.print||(Module.print=function(){}),Module.printErr||(Module.printErr=Module.print),Module.arguments||(Module.arguments=[]),Module.thisProgram||(Module.thisProgram="./this.program"),Module.quit||(Module.quit=function(e,t){throw t}),Module.print=Module.print,Module.printErr=Module.printErr,Module.preRun=[],Module.postRun=[],moduleOverrides)moduleOverrides.hasOwnProperty(key)&&(Module[key]=moduleOverrides[key]);moduleOverrides=void 0;var Runtime={setTempRet0:function(e){return tempRet0=e,e},getTempRet0:function(){return tempRet0},stackSave:function(){return STACKTOP},stackRestore:function(e){STACKTOP=e},getNativeTypeSize:function(e){switch(e){case"i1":case"i8":return 1;case"i16":return 2;case"i32":return 4;case"i64":return 8;case"float":return 4;case"double":return 8;default:if("*"===e[e.length-1])return Runtime.QUANTUM_SIZE;if("i"===e[0]){var t=parseInt(e.substr(1));return assert(t%8==0),t/8}return 0}},getNativeFieldSize:function(e){return Math.max(Runtime.getNativeTypeSize(e),Runtime.QUANTUM_SIZE)},STACK_ALIGN:16,prepVararg:function(e,t){return"double"===t||"i64"===t?7&e&&(assert(4==(7&e)),e+=4):assert(0==(3&e)),e},getAlignSize:function(e,t,s){return s||"i64"!=e&&"double"!=e?e?Math.min(t||(e?Runtime.getNativeFieldSize(e):0),Runtime.QUANTUM_SIZE):Math.min(t,8):8},dynCall:function(e,t,s){return s&&s.length?Module["dynCall_"+e].apply(null,[t].concat(s)):Module["dynCall_"+e].call(null,t)},functionPointers:[],addFunction:function(e){for(var t=0;t<Runtime.functionPointers.length;t++)if(!Runtime.functionPointers[t])return Runtime.functionPointers[t]=e,2*(1+t);throw"Finished up all reserved function pointers. Use a higher value for RESERVED_FUNCTION_POINTERS."},removeFunction:function(e){Runtime.functionPointers[(e-2)/2]=null},warnOnce:function(e){Runtime.warnOnce.shown||(Runtime.warnOnce.shown={}),Runtime.warnOnce.shown[e]||(Runtime.warnOnce.shown[e]=1,Module.printErr(e))},funcWrappers:{},getFuncWrapper:function(e,t){if(e){assert(t),Runtime.funcWrappers[t]||(Runtime.funcWrappers[t]={});var s=Runtime.funcWrappers[t];return s[e]||(1===t.length?s[e]=function(){return Runtime.dynCall(t,e)}:2===t.length?s[e]=function(s){return Runtime.dynCall(t,e,[s])}:s[e]=function(){return Runtime.dynCall(t,e,Array.prototype.slice.call(arguments))}),s[e]}},getCompilerSetting:function(e){throw"You must build with -s RETAIN_COMPILER_SETTINGS=1 for Runtime.getCompilerSetting or emscripten_get_compiler_setting to work"},stackAlloc:function(e){var t=STACKTOP;return STACKTOP=(STACKTOP=STACKTOP+e|0)+15&-16,t},staticAlloc:function(e){var t=STATICTOP;return STATICTOP=(STATICTOP=STATICTOP+e|0)+15&-16,t},dynamicAlloc:function(e){var t=HEAP32[DYNAMICTOP_PTR>>2],s=-16&(t+e+15|0);if((HEAP32[DYNAMICTOP_PTR>>2]=s,s>=TOTAL_MEMORY)&&!enlargeMemory())return HEAP32[DYNAMICTOP_PTR>>2]=t,0;return t},alignMemory:function(e,t){return e=Math.ceil(e/(t||16))*(t||16)},makeBigInt:function(e,t,s){return s?+(e>>>0)+4294967296*+(t>>>0):+(e>>>0)+4294967296*+(0|t)},GLOBAL_BASE:8,QUANTUM_SIZE:4,__dummy__:0};Module.Runtime=Runtime;var ABORT=0,cwrap,ccall;function assert(e,t){e||abort("Assertion failed: "+t)}function getCFunc(ident){var func=Module["_"+ident];if(!func)try{func=eval("_"+ident)}catch(e){}return assert(func,"Cannot call unknown function "+ident+" (perhaps LLVM optimizations or closure removed it?)"),func}function setValue(e,t,s,i){switch("*"===(s=s||"i8").charAt(s.length-1)&&(s="i32"),s){case"i1":case"i8":HEAP8[e>>0]=t;break;case"i16":HEAP16[e>>1]=t;break;case"i32":HEAP32[e>>2]=t;break;case"i64":tempI64=[t>>>0,(tempDouble=t,+Math_abs(tempDouble)>=1?tempDouble>0?(0|Math_min(+Math_floor(tempDouble/4294967296),4294967295))>>>0:~~+Math_ceil((tempDouble-+(~~tempDouble>>>0))/4294967296)>>>0:0)],HEAP32[e>>2]=tempI64[0],HEAP32[e+4>>2]=tempI64[1];break;case"float":HEAPF32[e>>2]=t;break;case"double":HEAPF64[e>>3]=t;break;default:abort("invalid type for setValue: "+s)}}function getValue(e,t,s){switch("*"===(t=t||"i8").charAt(t.length-1)&&(t="i32"),t){case"i1":case"i8":return HEAP8[e>>0];case"i16":return HEAP16[e>>1];case"i32":case"i64":return HEAP32[e>>2];case"float":return HEAPF32[e>>2];case"double":return HEAPF64[e>>3];default:abort("invalid type for setValue: "+t)}return null}!function(){var JSfuncs={stackSave:function(){Runtime.stackSave()},stackRestore:function(){Runtime.stackRestore()},arrayToC:function(e){var t=Runtime.stackAlloc(e.length);return writeArrayToMemory(e,t),t},stringToC:function(e){var t=0;if(null!=e&&0!==e){var s=1+(e.length<<2);stringToUTF8(e,t=Runtime.stackAlloc(s),s)}return t}},toC={string:JSfuncs.stringToC,array:JSfuncs.arrayToC};ccall=function(e,t,s,i,r){var a=getCFunc(e),n=[],o=0;if(i)for(var h=0;h<i.length;h++){var c=toC[s[h]];c?(0===o&&(o=Runtime.stackSave()),n[h]=c(i[h])):n[h]=i[h]}var u=a.apply(null,n);if("string"===t&&(u=Pointer_stringify(u)),0!==o){if(r&&r.async)return void EmterpreterAsync.asyncFinalizers.push((function(){Runtime.stackRestore(o)}));Runtime.stackRestore(o)}return u};var sourceRegex=/^function\s*[a-zA-Z$_0-9]*\s*\(([^)]*)\)\s*{\s*([^*]*?)[\s;]*(?:return\s*(.*?)[;\s]*)?}$/;function parseJSFunc(e){var t=e.toString().match(sourceRegex).slice(1);return{arguments:t[0],body:t[1],returnValue:t[2]}}var JSsource=null;function ensureJSsource(){if(!JSsource)for(var e in JSsource={},JSfuncs)JSfuncs.hasOwnProperty(e)&&(JSsource[e]=parseJSFunc(JSfuncs[e]))}cwrap=function cwrap(ident,returnType,argTypes){argTypes=argTypes||[];var cfunc=getCFunc(ident),numericArgs=argTypes.every((function(e){return"number"===e})),numericRet="string"!==returnType;if(numericRet&&numericArgs)return cfunc;var argNames=argTypes.map((function(e,t){return"$"+t})),funcstr="(function("+argNames.join(",")+") {",nargs=argTypes.length;if(!numericArgs){ensureJSsource(),funcstr+="var stack = "+JSsource.stackSave.body+";";for(var i=0;i<nargs;i++){var arg=argNames[i],type=argTypes[i];if("number"!==type){var convertCode=JSsource[type+"ToC"];funcstr+="var "+convertCode.arguments+" = "+arg+";",funcstr+=convertCode.body+";",funcstr+=arg+"=("+convertCode.returnValue+");"}}}var cfuncname=parseJSFunc((function(){return cfunc})).returnValue;if(funcstr+="var ret = "+cfuncname+"("+argNames.join(",")+");",!numericRet){var strgfy=parseJSFunc((function(){return Pointer_stringify})).returnValue;funcstr+="ret = "+strgfy+"(ret);"}return numericArgs||(ensureJSsource(),funcstr+=JSsource.stackRestore.body.replace("()","(stack)")+";"),funcstr+="return ret})",eval(funcstr)}}(),Module.ccall=ccall,Module.cwrap=cwrap,Module.setValue=setValue,Module.getValue=getValue;var ALLOC_NORMAL=0,ALLOC_STACK=1,ALLOC_STATIC=2,ALLOC_DYNAMIC=3,ALLOC_NONE=4;function allocate(e,t,s,i){var r,a;"number"==typeof e?(r=!0,a=e):(r=!1,a=e.length);var n,o="string"==typeof t?t:null;if(n=s==ALLOC_NONE?i:["function"==typeof _malloc?_malloc:Runtime.staticAlloc,Runtime.stackAlloc,Runtime.staticAlloc,Runtime.dynamicAlloc][void 0===s?ALLOC_STATIC:s](Math.max(a,o?1:t.length)),r){var h;i=n;for(assert(0==(3&n)),h=n+(-4&a);i<h;i+=4)HEAP32[i>>2]=0;for(h=n+a;i<h;)HEAP8[i++>>0]=0;return n}if("i8"===o)return e.subarray||e.slice?HEAPU8.set(e,n):HEAPU8.set(new Uint8Array(e),n),n;for(var c,u,_,l=0;l<a;){var d=e[l];"function"==typeof d&&(d=Runtime.getFunctionIndex(d)),0!==(c=o||t[l])?("i64"==c&&(c="i32"),setValue(n+l,d,c),_!==c&&(u=Runtime.getNativeTypeSize(c),_=c),l+=u):l++}return n}function getMemory(e){return staticSealed?runtimeInitialized?_malloc(e):Runtime.dynamicAlloc(e):Runtime.staticAlloc(e)}function Pointer_stringify(e,t){if(0===t||!e)return"";for(var s,i=0,r=0;i|=s=HEAPU8[e+r>>0],(0!=s||t)&&(r++,!t||r!=t););t||(t=r);var a="";if(i<128){for(var n;t>0;)n=String.fromCharCode.apply(String,HEAPU8.subarray(e,e+Math.min(t,1024))),a=a?a+n:n,e+=1024,t-=1024;return a}return Module.UTF8ToString(e)}function AsciiToString(e){for(var t="";;){var s=HEAP8[e++>>0];if(!s)return t;t+=String.fromCharCode(s)}}function stringToAscii(e,t){return writeAsciiToMemory(e,t,!1)}Module.ALLOC_NORMAL=ALLOC_NORMAL,Module.ALLOC_STACK=ALLOC_STACK,Module.ALLOC_STATIC=ALLOC_STATIC,Module.ALLOC_DYNAMIC=ALLOC_DYNAMIC,Module.ALLOC_NONE=ALLOC_NONE,Module.allocate=allocate,Module.getMemory=getMemory,Module.Pointer_stringify=Pointer_stringify,Module.AsciiToString=AsciiToString,Module.stringToAscii=stringToAscii;var UTF8Decoder="undefined"!=typeof TextDecoder?new TextDecoder("utf8"):void 0;function UTF8ArrayToString(e,t){for(var s=t;e[s];)++s;if(s-t>16&&e.subarray&&UTF8Decoder)return UTF8Decoder.decode(e.subarray(t,s));for(var i,r,a,n,o,h="";;){if(!(i=e[t++]))return h;if(128&i)if(r=63&e[t++],192!=(224&i))if(a=63&e[t++],224==(240&i)?i=(15&i)<<12|r<<6|a:(n=63&e[t++],240==(248&i)?i=(7&i)<<18|r<<12|a<<6|n:(o=63&e[t++],i=248==(252&i)?(3&i)<<24|r<<18|a<<12|n<<6|o:(1&i)<<30|r<<24|a<<18|n<<12|o<<6|63&e[t++])),i<65536)h+=String.fromCharCode(i);else{var c=i-65536;h+=String.fromCharCode(55296|c>>10,56320|1023&c)}else h+=String.fromCharCode((31&i)<<6|r);else h+=String.fromCharCode(i)}}function UTF8ToString(e){return UTF8ArrayToString(HEAPU8,e)}function stringToUTF8Array(e,t,s,i){if(!(i>0))return 0;for(var r=s,a=s+i-1,n=0;n<e.length;++n){var o=e.charCodeAt(n);if(o>=55296&&o<=57343&&(o=65536+((1023&o)<<10)|1023&e.charCodeAt(++n)),o<=127){if(s>=a)break;t[s++]=o}else if(o<=2047){if(s+1>=a)break;t[s++]=192|o>>6,t[s++]=128|63&o}else if(o<=65535){if(s+2>=a)break;t[s++]=224|o>>12,t[s++]=128|o>>6&63,t[s++]=128|63&o}else if(o<=2097151){if(s+3>=a)break;t[s++]=240|o>>18,t[s++]=128|o>>12&63,t[s++]=128|o>>6&63,t[s++]=128|63&o}else if(o<=67108863){if(s+4>=a)break;t[s++]=248|o>>24,t[s++]=128|o>>18&63,t[s++]=128|o>>12&63,t[s++]=128|o>>6&63,t[s++]=128|63&o}else{if(s+5>=a)break;t[s++]=252|o>>30,t[s++]=128|o>>24&63,t[s++]=128|o>>18&63,t[s++]=128|o>>12&63,t[s++]=128|o>>6&63,t[s++]=128|63&o}}return t[s]=0,s-r}function stringToUTF8(e,t,s){return stringToUTF8Array(e,HEAPU8,t,s)}function lengthBytesUTF8(e){for(var t=0,s=0;s<e.length;++s){var i=e.charCodeAt(s);i>=55296&&i<=57343&&(i=65536+((1023&i)<<10)|1023&e.charCodeAt(++s)),i<=127?++t:t+=i<=2047?2:i<=65535?3:i<=2097151?4:i<=67108863?5:6}return t}Module.UTF8ArrayToString=UTF8ArrayToString,Module.UTF8ToString=UTF8ToString,Module.stringToUTF8Array=stringToUTF8Array,Module.stringToUTF8=stringToUTF8,Module.lengthBytesUTF8=lengthBytesUTF8;var UTF16Decoder="undefined"!=typeof TextDecoder?new TextDecoder("utf-16le"):void 0,HEAP,buffer,HEAP8,HEAPU8,HEAP16,HEAPU16,HEAP32,HEAPU32,HEAPF32,HEAPF64,STATIC_BASE,STATICTOP,staticSealed,STACK_BASE,STACKTOP,STACK_MAX,DYNAMIC_BASE,DYNAMICTOP_PTR;function demangle(e){var t=Module.___cxa_demangle||Module.__cxa_demangle;if(t){try{var s=e.substr(1),i=lengthBytesUTF8(s)+1,r=_malloc(i);stringToUTF8(s,r,i);var a=_malloc(4),n=t(r,0,0,a);if(0===getValue(a,"i32")&&n)return Pointer_stringify(n)}catch(e){}finally{r&&_free(r),a&&_free(a),n&&_free(n)}return e}return Runtime.warnOnce("warning: build with  -s DEMANGLE_SUPPORT=1  to link in libcxxabi demangling"),e}function demangleAll(e){return e.replace(/__Z[\w\d_]+/g,(function(e){var t=demangle(e);return e===t?e:e+" ["+t+"]"}))}function jsStackTrace(){var e=new Error;if(!e.stack){try{throw new Error(0)}catch(t){e=t}if(!e.stack)return"(no stack trace available)"}return e.stack.toString()}function stackTrace(){var e=jsStackTrace();return Module.extraStackTrace&&(e+="\n"+Module.extraStackTrace()),demangleAll(e)}function updateGlobalBufferViews(){Module.HEAP8=HEAP8=new Int8Array(buffer),Module.HEAP16=HEAP16=new Int16Array(buffer),Module.HEAP32=HEAP32=new Int32Array(buffer),Module.HEAPU8=HEAPU8=new Uint8Array(buffer),Module.HEAPU16=HEAPU16=new Uint16Array(buffer),Module.HEAPU32=HEAPU32=new Uint32Array(buffer),Module.HEAPF32=HEAPF32=new Float32Array(buffer),Module.HEAPF64=HEAPF64=new Float64Array(buffer)}function abortOnCannotGrowMemory(){abort("Cannot enlarge memory arrays. Either (1) compile with  -s TOTAL_MEMORY=X  with X higher than the current value "+TOTAL_MEMORY+", (2) compile with  -s ALLOW_MEMORY_GROWTH=1  which allows increasing the size at runtime but prevents some optimizations, (3) set Module.TOTAL_MEMORY to a higher value before the program runs, or (4) if you want malloc to return NULL (0) instead of this abort, compile with  -s ABORTING_MALLOC=0 ")}function enlargeMemory(){abortOnCannotGrowMemory()}Module.stackTrace=stackTrace,STATIC_BASE=STATICTOP=STACK_BASE=STACKTOP=STACK_MAX=DYNAMIC_BASE=DYNAMICTOP_PTR=0,staticSealed=!1;var TOTAL_STACK=Module.TOTAL_STACK||10240,TOTAL_MEMORY=Module.TOTAL_MEMORY||16777216;function getTotalMemory(){return TOTAL_MEMORY}if(TOTAL_MEMORY<TOTAL_STACK&&Module.printErr("TOTAL_MEMORY should be larger than TOTAL_STACK, was "+TOTAL_MEMORY+"! (TOTAL_STACK="+TOTAL_STACK+")"),buffer=Module.buffer?Module.buffer:new ArrayBuffer(TOTAL_MEMORY),updateGlobalBufferViews(),HEAP32[0]=1668509029,HEAP16[1]=25459,115!==HEAPU8[2]||99!==HEAPU8[3])throw"Runtime error: expected the system to be little-endian!";function callRuntimeCallbacks(e){for(;e.length>0;){var t=e.shift();if("function"!=typeof t){var s=t.func;"number"==typeof s?void 0===t.arg?Module.dynCall_v(s):Module.dynCall_vi(s,t.arg):s(void 0===t.arg?null:t.arg)}else t()}}Module.HEAP=HEAP,Module.buffer=buffer,Module.HEAP8=HEAP8,Module.HEAP16=HEAP16,Module.HEAP32=HEAP32,Module.HEAPU8=HEAPU8,Module.HEAPU16=HEAPU16,Module.HEAPU32=HEAPU32,Module.HEAPF32=HEAPF32,Module.HEAPF64=HEAPF64;var __ATPRERUN__=[],__ATINIT__=[],__ATMAIN__=[],__ATEXIT__=[],__ATPOSTRUN__=[],runtimeInitialized=!1;function preRun(){if(Module.preRun)for("function"==typeof Module.preRun&&(Module.preRun=[Module.preRun]);Module.preRun.length;)addOnPreRun(Module.preRun.shift());callRuntimeCallbacks(__ATPRERUN__)}function ensureInitRuntime(){runtimeInitialized||(runtimeInitialized=!0,callRuntimeCallbacks(__ATINIT__))}function preMain(){callRuntimeCallbacks(__ATMAIN__)}function exitRuntime(){callRuntimeCallbacks(__ATEXIT__)}function postRun(){if(Module.postRun)for("function"==typeof Module.postRun&&(Module.postRun=[Module.postRun]);Module.postRun.length;)addOnPostRun(Module.postRun.shift());callRuntimeCallbacks(__ATPOSTRUN__)}function addOnPreRun(e){__ATPRERUN__.unshift(e)}function addOnInit(e){__ATINIT__.unshift(e)}function addOnPreMain(e){__ATMAIN__.unshift(e)}function addOnExit(e){__ATEXIT__.unshift(e)}function addOnPostRun(e){__ATPOSTRUN__.unshift(e)}function intArrayFromString(e,t,s){var i=s>0?s:lengthBytesUTF8(e)+1,r=new Array(i),a=stringToUTF8Array(e,r,0,r.length);return t&&(r.length=a),r}function intArrayToString(e){for(var t=[],s=0;s<e.length;s++){var i=e[s];i>255&&(i&=255),t.push(String.fromCharCode(i))}return t.join("")}function writeStringToMemory(e,t,s){var i,r;Runtime.warnOnce("writeStringToMemory is deprecated and should not be called! Use stringToUTF8() instead!"),s&&(r=t+lengthBytesUTF8(e),i=HEAP8[r]),stringToUTF8(e,t,1/0),s&&(HEAP8[r]=i)}function writeArrayToMemory(e,t){HEAP8.set(e,t)}function writeAsciiToMemory(e,t,s){for(var i=0;i<e.length;++i)HEAP8[t++>>0]=e.charCodeAt(i);s||(HEAP8[t>>0]=0)}Module.addOnPreRun=addOnPreRun,Module.addOnInit=addOnInit,Module.addOnPreMain=addOnPreMain,Module.addOnExit=addOnExit,Module.addOnPostRun=addOnPostRun,Module.intArrayFromString=intArrayFromString,Module.intArrayToString=intArrayToString,Module.writeStringToMemory=writeStringToMemory,Module.writeArrayToMemory=writeArrayToMemory,Module.writeAsciiToMemory=writeAsciiToMemory,Math.imul&&-5===Math.imul(4294967295,5)||(Math.imul=function(e,t){var s=65535&e,i=65535&t;return s*i+((e>>>16)*i+s*(t>>>16)<<16)|0}),Math.imul=Math.imul,Math.clz32||(Math.clz32=function(e){e>>>=0;for(var t=0;t<32;t++)if(e&1<<31-t)return t;return 32}),Math.clz32=Math.clz32,Math.trunc||(Math.trunc=function(e){return e<0?Math.ceil(e):Math.floor(e)}),Math.trunc=Math.trunc;var Math_abs=Math.abs,Math_ceil=Math.ceil,Math_floor=Math.floor,Math_min=Math.min,runDependencies=0,runDependencyWatcher=null,dependenciesFulfilled=null;function addRunDependency(e){runDependencies++,Module.monitorRunDependencies&&Module.monitorRunDependencies(runDependencies)}function removeRunDependency(e){if(runDependencies--,Module.monitorRunDependencies&&Module.monitorRunDependencies(runDependencies),0==runDependencies&&(null!==runDependencyWatcher&&(clearInterval(runDependencyWatcher),runDependencyWatcher=null),dependenciesFulfilled)){var t=dependenciesFulfilled;dependenciesFulfilled=null,t()}}Module.addRunDependency=addRunDependency,Module.removeRunDependency=removeRunDependency,Module.preloadedImages={},Module.preloadedAudios={};var ASM_CONSTS=[function(e){return Module.trapOnInstructionFetch(e)},function(e){return Module.busRead32(e)},function(e,t){Module.busWrite32(e,t)},function(e){return Module.busRead16(e)},function(e,t){return Module.trapOnBx32(e,t)},function(e,t){Module.busWrite16(e,t)}];function _emscripten_asm_const_ii(e,t){return ASM_CONSTS[e](t)}function _emscripten_asm_const_iii(e,t,s){return ASM_CONSTS[e](t,s)}STATIC_BASE=Runtime.GLOBAL_BASE,STATICTOP=STATIC_BASE+5312,__ATINIT__.push(),allocate([12,0,0,0,5,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,2,0,0,0,189,20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,156,20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,116,104,117,109,98,117,108,97,116,111,114,0,123,32,114,101,116,117,114,110,32,77,111,100,117,108,101,46,98,117,115,82,101,97,100,49,54,40,36,48,41,59,32,125,0,123,32,114,101,116,117,114,110,32,77,111,100,117,108,101,46,98,117,115,82,101,97,100,51,50,40,36,48,41,59,32,125,0,123,32,77,111,100,117,108,101,46,98,117,115,87,114,105,116,101,49,54,40,36,48,44,32,36,49,41,59,32,125,0,123,32,77,111,100,117,108,101,46,98,117,115,87,114,105,116,101,51,50,40,36,48,44,32,36,49,41,59,32,125,0,112,99,32,104,97,115,32,108,115,98,105,116,32,115,101,116,32,48,120,37,48,56,88,10,0,123,32,114,101,116,117,114,110,32,77,111,100,117,108,101,46,116,114,97,112,79,110,73,110,115,116,114,117,99,116,105,111,110,70,101,116,99,104,40,36,48,41,59,32,125,0,45,45,45,32,48,120,37,48,56,88,58,32,48,120,37,48,52,88,32,0,97,100,99,32,114,37,117,44,114,37,117,10,0,97,100,100,115,32,114,37,117,44,114,37,117,44,35,48,120,37,88,10,0,97,100,100,115,32,114,37,117,44,35,48,120,37,48,50,88,10,0,97,100,100,115,32,114,37,117,44,114,37,117,44,114,37,117,10,0,97,100,100,32,114,37,117,44,114,37,117,10,0,97,100,100,32,112,99,44,46,46,46,32,112,114,111,100,117,99,101,100,32,97,110,32,97,114,109,32,97,100,100,114,101,115,115,32,48,120,37,48,56,88,32,48,120,37,48,56,88,10,0,97,100,100,32,114,37,117,44,80,67,44,35,48,120,37,48,50,88,10,0,97,100,100,32,114,37,117,44,83,80,44,35,48,120,37,48,50,88,10,0,97,100,100,32,83,80,44,35,48,120,37,48,50,88,10,0,97,110,100,115,32,114,37,117,44,114,37,117,10,0,97,115,114,115,32,114,37,117,44,114,37,117,44,35,48,120,37,88,10,0,97,115,114,115,32,114,37,117,44,114,37,117,10,0,98,101,113,32,48,120,37,48,56,88,10,0,98,110,101,32,48,120,37,48,56,88,10,0,98,99,115,32,48,120,37,48,56,88,10,0,98,99,99,32,48,120,37,48,56,88,10,0,98,109,105,32,48,120,37,48,56,88,10,0,98,112,108,32,48,120,37,48,56,88,10,0,98,118,115,32,48,120,37,48,56,88,10,0,98,118,99,32,48,120,37,48,56,88,10,0,98,104,105,32,48,120,37,48,56,88,10,0,98,108,115,32,48,120,37,48,56,88,10,0,98,103,101,32,48,120,37,48,56,88,10,0,98,108,116,32,48,120,37,48,56,88,10,0,98,103,116,32,48,120,37,48,56,88,10,0,98,108,101,32,48,120,37,48,56,88,10,0,66,32,48,120,37,48,56,88,10,0,98,105,99,115,32,114,37,117,44,114,37,117,10,0,98,107,112,116,32,48,120,37,48,50,88,10,0,98,108,32,48,120,37,48,56,88,10,0,98,108,120,32,114,37,117,10,0,99,97,110,110,111,116,32,98,114,97,110,99,104,32,116,111,32,97,114,109,32,48,120,37,48,56,88,32,48,120,37,48,52,88,10,0,98,120,32,114,37,117,10,0,123,32,114,101,116,117,114,110,32,77,111,100,117,108,101,46,116,114,97,112,79,110,66,120,51,50,40,36,48,44,32,36,49,41,59,32,125,0,99,109,110,115,32,114,37,117,44,114,37,117,10,0,99,109,112,32,114,37,117,44,35,48,120,37,48,50,88,10,0,99,109,112,115,32,114,37,117,44,114,37,117,10,0,99,112,115,32,84,79,68,79,10,0,99,112,121,32,114,37,117,44,114,37,117,10,0,101,111,114,115,32,114,37,117,44,114,37,117,10,0,108,100,109,105,97,32,114,37,117,33,44,123,0,114,37,117,0,125,10,0,108,100,114,32,114,37,117,44,91,114,37,117,44,35,48,120,37,88,93,10,0,108,100,114,32,114,37,117,44,91,114,37,117,44,114,37,117,93,10,0,108,100,114,32,114,37,117,44,91,80,67,43,35,48,120,37,88,93,32,0,59,64,32,48,120,37,88,10,0,108,100,114,32,114,37,117,44,91,83,80,43,35,48,120,37,88,93,10,0,108,100,114,98,32,114,37,117,44,91,114,37,117,44,35,48,120,37,88,93,10,0,108,100,114,98,32,114,37,117,44,91,114,37,117,44,114,37,117,93,10,0,108,100,114,104,32,114,37,117,44,91,114,37,117,44,35,48,120,37,88,93,10,0,108,100,114,104,32,114,37,117,44,91,114,37,117,44,114,37,117,93,10,0,108,100,114,115,98,32,114,37,117,44,91,114,37,117,44,114,37,117,93,10,0,108,100,114,115,104,32,114,37,117,44,91,114,37,117,44,114,37,117,93,10,0,108,115,108,115,32,114,37,117,44,114,37,117,44,35,48,120,37,88,10,0,108,115,108,115,32,114,37,117,44,114,37,117,10,0,108,115,114,115,32,114,37,117,44,114,37,117,44,35,48,120,37,88,10,0,108,115,114,115,32,114,37,117,44,114,37,117,10,0,109,111,118,115,32,114,37,117,44,35,48,120,37,48,50,88,10,0,109,111,118,115,32,114,37,117,44,114,37,117,10,0,109,111,118,32,114,37,117,44,114,37,117,10,0,109,117,108,115,32,114,37,117,44,114,37,117,10,0,109,118,110,115,32,114,37,117,44,114,37,117,10,0,110,101,103,115,32,114,37,117,44,114,37,117,10,0,111,114,114,115,32,114,37,117,44,114,37,117,10,0,112,111,112,32,123,0,112,99,0,112,111,112,32,123,114,99,125,32,119,105,116,104,32,97,110,32,65,82,77,32,97,100,100,114,101,115,115,32,112,99,32,48,120,37,48,56,88,32,112,111,112,112,101,100,32,48,120,37,48,56,88,10,0,112,117,115,104,32,123,0,108,114,0,112,117,115,104,32,123,108,114,125,32,119,105,116,104,32,97,110,32,65,82,77,32,97,100,100,114,101,115,115,32,112,99,32,48,120,37,48,56,88,32,112,111,112,112,101,100,32,48,120,37,48,56,88,10,0,114,101,118,32,114,37,117,44,114,37,117,10,0,114,101,118,49,54,32,114,37,117,44,114,37,117,10,0,114,101,118,115,104,32,114,37,117,44,114,37,117,10,0,114,111,114,115,32,114,37,117,44,114,37,117,10,0,115,98,99,32,114,37,117,44,114,37,117,10,0,115,101,116,101,110,100,32,110,111,116,32,105,109,112,108,101,109,101,110,116,101,100,10,0,115,116,109,105,97,32,114,37,117,33,44,123,0,115,116,114,32,114,37,117,44,91,114,37,117,44,35,48,120,37,88,93,10,0,115,116,114,32,114,37,117,44,91,114,37,117,44,114,37,117,93,10,0,115,116,114,32,114,37,117,44,91,83,80,44,35,48,120,37,88,93,10,0,115,116,114,98,32,114,37,117,44,91,114,37,117,44,35,48,120,37,88,93,10,0,115,116,114,98,32,114,37,117,44,91,114,37,117,44,114,37,117,93,10,0,115,116,114,104,32,114,37,117,44,91,114,37,117,44,35,48,120,37,88,93,10,0,115,116,114,104,32,114,37,117,44,91,114,37,117,44,114,37,117,93,10,0,115,117,98,115,32,114,37,117,44,114,37,117,44,35,48,120,37,88,10,0,115,117,98,115,32,114,37,117,44,35,48,120,37,48,50,88,10,0,115,117,98,115,32,114,37,117,44,114,37,117,44,114,37,117,10,0,115,117,98,32,83,80,44,35,48,120,37,48,50,88,10,0,115,119,105,32,48,120,37,48,50,88,10,0,10,10,115,119,105,32,48,120,37,48,50,88,10,0,115,120,116,98,32,114,37,117,44,114,37,117,10,0,115,120,116,104,32,114,37,117,44,114,37,117,10,0,116,115,116,32,114,37,117,44,114,37,117,10,0,117,120,116,98,32,114,37,117,44,114,37,117,10,0,117,120,116,104,32,114,37,117,44,114,37,117,10,0,105,110,118,97,108,105,100,32,105,110,115,116,114,117,99,116,105,111,110,32,48,120,37,48,56,88,32,48,120,37,48,52,88,10,0,17,0,10,0,17,17,17,0,0,0,0,5,0,0,0,0,0,0,9,0,0,0,0,11,0,0,0,0,0,0,0,0,17,0,15,10,17,17,17,3,10,7,0,1,19,9,11,11,0,0,9,6,11,0,0,11,0,6,17,0,0,0,17,17,17,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,11,0,0,0,0,0,0,0,0,17,0,10,10,17,17,17,0,10,0,0,2,0,9,11,0,0,0,9,0,11,0,0,11,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,12,0,0,0,0,0,0,0,0,0,0,0,12,0,0,0,0,12,0,0,0,0,9,12,0,0,0,0,0,12,0,0,12,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,14,0,0,0,0,0,0,0,0,0,0,0,13,0,0,0,4,13,0,0,0,0,9,14,0,0,0,0,0,14,0,0,14,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,16,0,0,0,0,0,0,0,0,0,0,0,15,0,0,0,0,15,0,0,0,0,9,16,0,0,0,0,0,16,0,0,16,0,0,18,0,0,0,18,18,18,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,18,0,0,0,18,18,18,0,0,0,0,0,0,9,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,11,0,0,0,0,0,0,0,0,0,0,0,10,0,0,0,0,10,0,0,0,0,9,11,0,0,0,0,0,11,0,0,11,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,12,0,0,0,0,0,0,0,0,0,0,0,12,0,0,0,0,12,0,0,0,0,9,12,0,0,0,0,0,12,0,0,12,0,0,45,43,32,32,32,48,88,48,120,0,40,110,117,108,108,41,0,45,48,88,43,48,88,32,48,88,45,48,120,43,48,120,32,48,120,0,105,110,102,0,73,78,70,0,110,97,110,0,78,65,78,0,48,49,50,51,52,53,54,55,56,57,65,66,67,68,69,70,46,0,84,33,34,25,13,1,2,3,17,75,28,12,16,4,11,29,18,30,39,104,110,111,112,113,98,32,5,6,15,19,20,21,26,8,22,7,40,36,23,24,9,10,14,27,31,37,35,131,130,125,38,42,43,60,61,62,63,67,71,74,77,88,89,90,91,92,93,94,95,96,97,99,100,101,102,103,105,106,107,108,114,115,116,121,122,123,124,0,73,108,108,101,103,97,108,32,98,121,116,101,32,115,101,113,117,101,110,99,101,0,68,111,109,97,105,110,32,101,114,114,111,114,0,82,101,115,117,108,116,32,110,111,116,32,114,101,112,114,101,115,101,110,116,97,98,108,101,0,78,111,116,32,97,32,116,116,121,0,80,101,114,109,105,115,115,105,111,110,32,100,101,110,105,101,100,0,79,112,101,114,97,116,105,111,110,32,110,111,116,32,112,101,114,109,105,116,116,101,100,0,78,111,32,115,117,99,104,32,102,105,108,101,32,111,114,32,100,105,114,101,99,116,111,114,121,0,78,111,32,115,117,99,104,32,112,114,111,99,101,115,115,0,70,105,108,101,32,101,120,105,115,116,115,0,86,97,108,117,101,32,116,111,111,32,108,97,114,103,101,32,102,111,114,32,100,97,116,97,32,116,121,112,101,0,78,111,32,115,112,97,99,101,32,108,101,102,116,32,111,110,32,100,101,118,105,99,101,0,79,117,116,32,111,102,32,109,101,109,111,114,121,0,82,101,115,111,117,114,99,101,32,98,117,115,121,0,73,110,116,101,114,114,117,112,116,101,100,32,115,121,115,116,101,109,32,99,97,108,108,0,82,101,115,111,117,114,99,101,32,116,101,109,112,111,114,97,114,105,108,121,32,117,110,97,118,97,105,108,97,98,108,101,0,73,110,118,97,108,105,100,32,115,101,101,107,0,67,114,111,115,115,45,100,101,118,105,99,101,32,108,105,110,107,0,82,101,97,100,45,111,110,108,121,32,102,105,108,101,32,115,121,115,116,101,109,0,68,105,114,101,99,116,111,114,121,32,110,111,116,32,101,109,112,116,121,0,67,111,110,110,101,99,116,105,111,110,32,114,101,115,101,116,32,98,121,32,112,101,101,114,0,79,112,101,114,97,116,105,111,110,32,116,105,109,101,100,32,111,117,116,0,67,111,110,110,101,99,116,105,111,110,32,114,101,102,117,115,101,100,0,72,111,115,116,32,105,115,32,100,111,119,110,0,72,111,115,116,32,105,115,32,117,110,114,101,97,99,104,97,98,108,101,0,65,100,100,114,101,115,115,32,105,110,32,117,115,101,0,66,114,111,107,101,110,32,112,105,112,101,0,73,47,79,32,101,114,114,111,114,0,78,111,32,115,117,99,104,32,100,101,118,105,99,101,32,111,114,32,97,100,100,114,101,115,115,0,66,108,111,99,107,32,100,101,118,105,99,101,32,114,101,113,117,105,114,101,100,0,78,111,32,115,117,99,104,32,100,101,118,105,99,101,0,78,111,116,32,97,32,100,105,114,101,99,116,111,114,121,0,73,115,32,97,32,100,105,114,101,99,116,111,114,121,0,84,101,120,116,32,102,105,108,101,32,98,117,115,121,0,69,120,101,99,32,102,111,114,109,97,116,32,101,114,114,111,114,0,73,110,118,97,108,105,100,32,97,114,103,117,109,101,110,116,0,65,114,103,117,109,101,110,116,32,108,105,115,116,32,116,111,111,32,108,111,110,103,0,83,121,109,98,111,108,105,99,32,108,105,110,107,32,108,111,111,112,0,70,105,108,101,110,97,109,101,32,116,111,111,32,108,111,110,103,0,84,111,111,32,109,97,110,121,32,111,112,101,110,32,102,105,108,101,115,32,105,110,32,115,121,115,116,101,109,0,78,111,32,102,105,108,101,32,100,101,115,99,114,105,112,116,111,114,115,32,97,118,97,105,108,97,98,108,101,0,66,97,100,32,102,105,108,101,32,100,101,115,99,114,105,112,116,111,114,0,78,111,32,99,104,105,108,100,32,112,114,111,99,101,115,115,0,66,97,100,32,97,100,100,114,101,115,115,0,70,105,108,101,32,116,111,111,32,108,97,114,103,101,0,84,111,111,32,109,97,110,121,32,108,105,110,107,115,0,78,111,32,108,111,99,107,115,32,97,118,97,105,108,97,98,108,101,0,82,101,115,111,117,114,99,101,32,100,101,97,100,108,111,99,107,32,119,111,117,108,100,32,111,99,99,117,114,0,83,116,97,116,101,32,110,111,116,32,114,101,99,111,118,101,114,97,98,108,101,0,80,114,101,118,105,111,117,115,32,111,119,110,101,114,32,100,105,101,100,0,79,112,101,114,97,116,105,111,110,32,99,97,110,99,101,108,101,100,0,70,117,110,99,116,105,111,110,32,110,111,116,32,105,109,112,108,101,109,101,110,116,101,100,0,78,111,32,109,101,115,115,97,103,101,32,111,102,32,100,101,115,105,114,101,100,32,116,121,112,101,0,73,100,101,110,116,105,102,105,101,114,32,114,101,109,111,118,101,100,0,68,101,118,105,99,101,32,110,111,116,32,97,32,115,116,114,101,97,109,0,78,111,32,100,97,116,97,32,97,118,97,105,108,97,98,108,101,0,68,101,118,105,99,101,32,116,105,109,101,111,117,116,0,79,117,116,32,111,102,32,115,116,114,101,97,109,115,32,114,101,115,111,117,114,99,101,115,0,76,105,110,107,32,104,97,115,32,98,101,101,110,32,115,101,118,101,114,101,100,0,80,114,111,116,111,99,111,108,32,101,114,114,111,114,0,66,97,100,32,109,101,115,115,97,103,101,0,70,105,108,101,32,100,101,115,99,114,105,112,116,111,114,32,105,110,32,98,97,100,32,115,116,97,116,101,0,78,111,116,32,97,32,115,111,99,107,101,116,0,68,101,115,116,105,110,97,116,105,111,110,32,97,100,100,114,101,115,115,32,114,101,113,117,105,114,101,100,0,77,101,115,115,97,103,101,32,116,111,111,32,108,97,114,103,101,0,80,114,111,116,111,99,111,108,32,119,114,111,110,103,32,116,121,112,101,32,102,111,114,32,115,111,99,107,101,116,0,80,114,111,116,111,99,111,108,32,110,111,116,32,97,118,97,105,108,97,98,108,101,0,80,114,111,116,111,99,111,108,32,110,111,116,32,115,117,112,112,111,114,116,101,100,0,83,111,99,107,101,116,32,116,121,112,101,32,110,111,116,32,115,117,112,112,111,114,116,101,100,0,78,111,116,32,115,117,112,112,111,114,116,101,100,0,80,114,111,116,111,99,111,108,32,102,97,109,105,108,121,32,110,111,116,32,115,117,112,112,111,114,116,101,100,0,65,100,100,114,101,115,115,32,102,97,109,105,108,121,32,110,111,116,32,115,117,112,112,111,114,116,101,100,32,98,121,32,112,114,111,116,111,99,111,108,0,65,100,100,114,101,115,115,32,110,111,116,32,97,118,97,105,108,97,98,108,101,0,78,101,116,119,111,114,107,32,105,115,32,100,111,119,110,0,78,101,116,119,111,114,107,32,117,110,114,101,97,99,104,97,98,108,101,0,67,111,110,110,101,99,116,105,111,110,32,114,101,115,101,116,32,98,121,32,110,101,116,119,111,114,107,0,67,111,110,110,101,99,116,105,111,110,32,97,98,111,114,116,101,100,0,78,111,32,98,117,102,102,101,114,32,115,112,97,99,101,32,97,118,97,105,108,97,98,108,101,0,83,111,99,107,101,116,32,105,115,32,99,111,110,110,101,99,116,101,100,0,83,111,99,107,101,116,32,110,111,116,32,99,111,110,110,101,99,116,101,100,0,67,97,110,110,111,116,32,115,101,110,100,32,97,102,116,101,114,32,115,111,99,107,101,116,32,115,104,117,116,100,111,119,110,0,79,112,101,114,97,116,105,111,110,32,97,108,114,101,97,100,121,32,105,110,32,112,114,111,103,114,101,115,115,0,79,112,101,114,97,116,105,111,110,32,105,110,32,112,114,111,103,114,101,115,115,0,83,116,97,108,101,32,102,105,108,101,32,104,97,110,100,108,101,0,82,101,109,111,116,101,32,73,47,79,32,101,114,114,111,114,0,81,117,111,116,97,32,101,120,99,101,101,100,101,100,0,78,111,32,109,101,100,105,117,109,32,102,111,117,110,100,0,87,114,111,110,103,32,109,101,100,105,117,109,32,116,121,112,101,0,78,111,32,101,114,114,111,114,32,105,110,102,111,114,109,97,116,105,111,110,0,0],"i8",ALLOC_NONE,Runtime.GLOBAL_BASE);var tempDoublePtr=STATICTOP;function _emscripten_memcpy_big(e,t,s){return HEAPU8.set(HEAPU8.subarray(t,t+s),e),e}STATICTOP+=16;var SYSCALLS={varargs:0,get:function(e){return SYSCALLS.varargs+=4,HEAP32[SYSCALLS.varargs-4>>2]},getStr:function(){return Pointer_stringify(SYSCALLS.get())},get64:function(){var e=SYSCALLS.get(),t=SYSCALLS.get();return assert(e>=0?0===t:-1===t),e},getZero:function(){assert(0===SYSCALLS.get())}};function ___syscall6(e,t){SYSCALLS.varargs=t;try{var s=SYSCALLS.getStreamFromFD();return FS.close(s),0}catch(e){return"undefined"!=typeof FS&&e instanceof FS.ErrnoError||abort(e),-e.errno}}var cttz_i8=allocate([8,0,1,0,2,0,1,0,3,0,1,0,2,0,1,0,4,0,1,0,2,0,1,0,3,0,1,0,2,0,1,0,5,0,1,0,2,0,1,0,3,0,1,0,2,0,1,0,4,0,1,0,2,0,1,0,3,0,1,0,2,0,1,0,6,0,1,0,2,0,1,0,3,0,1,0,2,0,1,0,4,0,1,0,2,0,1,0,3,0,1,0,2,0,1,0,5,0,1,0,2,0,1,0,3,0,1,0,2,0,1,0,4,0,1,0,2,0,1,0,3,0,1,0,2,0,1,0,7,0,1,0,2,0,1,0,3,0,1,0,2,0,1,0,4,0,1,0,2,0,1,0,3,0,1,0,2,0,1,0,5,0,1,0,2,0,1,0,3,0,1,0,2,0,1,0,4,0,1,0,2,0,1,0,3,0,1,0,2,0,1,0,6,0,1,0,2,0,1,0,3,0,1,0,2,0,1,0,4,0,1,0,2,0,1,0,3,0,1,0,2,0,1,0,5,0,1,0,2,0,1,0,3,0,1,0,2,0,1,0,4,0,1,0,2,0,1,0,3,0,1,0,2,0,1,0],"i8",ALLOC_STATIC);function ___setErrNo(e){return Module.___errno_location&&(HEAP32[Module.___errno_location()>>2]=e),e}function __exit(e){Module.exit(e)}function _exit(e){__exit(e)}function ___syscall140(e,t){SYSCALLS.varargs=t;try{var s=SYSCALLS.getStreamFromFD(),i=(SYSCALLS.get(),SYSCALLS.get()),r=SYSCALLS.get(),a=SYSCALLS.get(),n=i;return FS.llseek(s,n,a),HEAP32[r>>2]=s.position,s.getdents&&0===n&&0===a&&(s.getdents=null),0}catch(e){return"undefined"!=typeof FS&&e instanceof FS.ErrnoError||abort(e),-e.errno}}function ___syscall146(e,t){SYSCALLS.varargs=t;try{var s=SYSCALLS.get(),i=SYSCALLS.get(),r=SYSCALLS.get(),a=0;___syscall146.buffer||(___syscall146.buffers=[null,[],[]],___syscall146.printChar=function(e,t){var s=___syscall146.buffers[e];assert(s),0===t||10===t?((1===e?Module.print:Module.printErr)(UTF8ArrayToString(s,0)),s.length=0):s.push(t)});for(var n=0;n<r;n++){for(var o=HEAP32[i+8*n>>2],h=HEAP32[i+(8*n+4)>>2],c=0;c<h;c++)___syscall146.printChar(s,HEAPU8[o+c]);a+=h}return a}catch(e){return"undefined"!=typeof FS&&e instanceof FS.ErrnoError||abort(e),-e.errno}}function invoke_ii(e,t){try{return Module.dynCall_ii(e,t)}catch(e){if("number"!=typeof e&&"longjmp"!==e)throw e;Module.setThrew(1,0)}}function invoke_iiii(e,t,s,i){try{return Module.dynCall_iiii(e,t,s,i)}catch(e){if("number"!=typeof e&&"longjmp"!==e)throw e;Module.setThrew(1,0)}}__ATEXIT__.push((function(){var e=Module._fflush;e&&e(0);var t=___syscall146.printChar;if(t){var s=___syscall146.buffers;s[1].length&&t(1,10),s[2].length&&t(2,10)}})),DYNAMICTOP_PTR=allocate(1,"i32",ALLOC_STATIC),STACK_BASE=STACKTOP=Runtime.alignMemory(STATICTOP),STACK_MAX=STACK_BASE+TOTAL_STACK,DYNAMIC_BASE=Runtime.alignMemory(STACK_MAX),HEAP32[DYNAMICTOP_PTR>>2]=DYNAMIC_BASE,staticSealed=!0,Module.asmGlobalArg={Math:Math,Int8Array:Int8Array,Int16Array:Int16Array,Int32Array:Int32Array,Uint8Array:Uint8Array,Uint16Array:Uint16Array,Uint32Array:Uint32Array,Float32Array:Float32Array,Float64Array:Float64Array,NaN:NaN,Infinity:1/0},Module.asmLibraryArg={abort:abort,assert:assert,enlargeMemory:enlargeMemory,getTotalMemory:getTotalMemory,abortOnCannotGrowMemory:abortOnCannotGrowMemory,invoke_ii:invoke_ii,invoke_iiii:invoke_iiii,_emscripten_asm_const_ii:_emscripten_asm_const_ii,___syscall6:___syscall6,___setErrNo:___setErrNo,___syscall146:___syscall146,_emscripten_memcpy_big:_emscripten_memcpy_big,___syscall140:___syscall140,_exit:_exit,__exit:__exit,_emscripten_asm_const_iii:_emscripten_asm_const_iii,DYNAMICTOP_PTR:DYNAMICTOP_PTR,tempDoublePtr:tempDoublePtr,ABORT:ABORT,STACKTOP:STACKTOP,STACK_MAX:STACK_MAX,cttz_i8:cttz_i8};var asm=function(e,t,s){"use asm";var i=new e.Int8Array(s);var r=new e.Int16Array(s);var a=new e.Int32Array(s);var n=new e.Uint8Array(s);var o=new e.Uint16Array(s);var h=new e.Uint32Array(s);var c=new e.Float32Array(s);var u=new e.Float64Array(s);var _=t.DYNAMICTOP_PTR|0;var l=t.tempDoublePtr|0;var d=t.ABORT|0;var f=t.STACKTOP|0;var p=t.STACK_MAX|0;var m=t.cttz_i8|0;var g=e.NaN,b=e.Infinity;var k=0,y=0;var w=0;var C=e.Math.floor;var v=e.Math.abs;var A=e.Math.sqrt;var I=e.Math.pow;var S=e.Math.cos;var M=e.Math.sin;var T=e.Math.tan;var P=e.Math.acos;var E=e.Math.asin;var x=e.Math.atan;var R=e.Math.atan2;var B=e.Math.exp;var O=e.Math.log;var F=e.Math.ceil;var L=e.Math.imul;var D=e.Math.min;var N=e.Math.max;var H=e.Math.clz32;var U=t.abort;var j=t.assert;var V=t.enlargeMemory;var W=t.getTotalMemory;var z=t.abortOnCannotGrowMemory;var Q=t.invoke_ii;var Y=t.invoke_iiii;var $=t._emscripten_asm_const_ii;var q=t.___syscall6;var K=t.___setErrNo;var G=t.___syscall146;var J=t._emscripten_memcpy_big;var Z=t.___syscall140;var X=t._exit;var ee=t.__exit;var te=t._emscripten_asm_const_iii;function se(e){e=e|0;var t=0;t=f;f=f+e|0;f=f+15&-16;return t|0}function ie(){return f|0}function re(e){e=e|0;f=e}function ae(e,t){e=e|0;t=t|0;f=e;p=t}function ne(e,t){}function oe(e){e=e|0;w=e}function he(){return w|0}function ce(e){e=e|0;a[1162]=e;return}function ue(){return 380}function _e(e){e=e|0;var t=0,s=0,i=0,r=0,n=0;a[1163]=0;if(!e){r=0;return r|0}else{t=0;s=0}while(1){n=ge()|0;s=(n|0)==0?s:n;i=(a[1163]|0)!=0;t=t+1|0;if(i|(n|0)==0^1)break;if(t>>>0>=e>>>0){t=0;r=5;break}}if((r|0)==5)return t|0;n=i?10:s;return n|0}function le(){a[1163]=1;return}function de(e){e=e|0;i[5300]=e;return}function fe(e){e=e|0;var t=0,s=0;s=f;f=f+16|0;t=a[4668+((e&15)<<2)>>2]|0;if((e&15|0)!=15){f=s;return t|0}if(t&1|0){e=a[2]|0;a[s>>2]=t;Ne(e,520,s)|0}t=t&-2;f=s;return t|0}function pe(e,t){e=e|0;t=t|0;a[4668+((e&15)<<2)>>2]=(e&15|0)==15?t&-2:t;return}function me(){a[1164]=4;a[1165]=0;a[1166]=0;a[1183]=0;a[1184]=0;return 0}function ge(){var e=0,t=0,s=0,r=0,n=0,o=0,h=0,c=0,u=0,_=0;_=f;f=f+4848|0;t=a[1182]|0;if(t&1|0){u=a[2]|0;a[_>>2]=t;Ne(u,520,_)|0}e=a[1162]|0;if(!e){e=$(0,(t&-2)+-2|0)|0;if(e|0){u=e;f=_;return u|0}}else if(((t&-2)+-2|0)==(e|0)){u=20;f=_;return u|0}if((t&-2)>>>0>4026531839&(a[1183]|0)!=0){a[1183]=0;u=a[1180]|0;a[1167]=$(1,u|0)|0;a[1168]=$(1,u+4|0)|0;a[1169]=$(1,u+8|0)|0;a[1170]=$(1,u+12|0)|0;a[1179]=$(1,u+16|0)|0;a[1181]=$(1,u+20|0)|0;s=$(1,u+24|0)|0;a[1184]=$(1,u+28|0)|0;a[1180]=u+32}else s=t&-2;e=a[1164]|0;do{if(e&1){t=a[1166]|0;if(!t){a[1166]=a[1165];a[1164]=e|65536;e=e|65536;break}else{a[1166]=t+-1;break}}}while(0);if((e&3|0)==3)if((e&65536|0)!=0&(a[1183]|0)==0){r=a[1180]|0;t=a[1184]|0;e:do{if((r+-4&-268435456|0)==-536870912)switch((r+536813548|0)>>>2|r+536813548<<30|0){case 0:{a[1164]=t&65543;if((e&1|0)!=0|(t&1|0)==0)break e;a[1166]=a[1165];break e}case 1:{a[1165]=t&16777215;break e}case 2:{a[1166]=t&16777215;break e}case 3:break e;default:break e}else te(2,r+-4|0,t|0)|0}while(0);e:do{if((r+-8&-268435456|0)==-536870912)switch((r+536813544|0)>>>2|r+536813544<<30|0){case 0:{u=a[1164]|0;a[1164]=s&65543;if((s&1|0)==0|(u&1|0)!=0)break e;a[1166]=a[1165];break e}case 1:{a[1165]=s&16777215;break e}case 2:{a[1166]=s&16777215;break e}case 3:break e;default:break e}else te(2,r+-8|0,s|0)|0}while(0);e=a[1181]|0;e:do{if((r+-12&-268435456|0)==-536870912)switch((r+536813540|0)>>>2|r+536813540<<30|0){case 0:{u=a[1164]|0;a[1164]=e&65543;if((e&1|0)==0|(u&1|0)!=0)break e;a[1166]=a[1165];break e}case 1:{a[1165]=e&16777215;break e}case 2:{a[1166]=e&16777215;break e}case 3:break e;default:break e}else te(2,r+-12|0,e|0)|0}while(0);e=a[1179]|0;e:do{if((r+-16&-268435456|0)==-536870912)switch((r+536813536|0)>>>2|r+536813536<<30|0){case 0:{u=a[1164]|0;a[1164]=e&65543;if((e&1|0)==0|(u&1|0)!=0)break e;a[1166]=a[1165];break e}case 1:{a[1165]=e&16777215;break e}case 2:{a[1166]=e&16777215;break e}case 3:break e;default:break e}else te(2,r+-16|0,e|0)|0}while(0);e=a[1170]|0;e:do{if((r+-20&-268435456|0)==-536870912)switch((r+536813532|0)>>>2|r+536813532<<30|0){case 0:{u=a[1164]|0;a[1164]=e&65543;if((e&1|0)==0|(u&1|0)!=0)break e;a[1166]=a[1165];break e}case 1:{a[1165]=e&16777215;break e}case 2:{a[1166]=e&16777215;break e}case 3:break e;default:break e}else te(2,r+-20|0,e|0)|0}while(0);e=a[1169]|0;e:do{if((r+-24&-268435456|0)==-536870912)switch((r+536813528|0)>>>2|r+536813528<<30|0){case 0:{u=a[1164]|0;a[1164]=e&65543;if((e&1|0)==0|(u&1|0)!=0)break e;a[1166]=a[1165];break e}case 1:{a[1165]=e&16777215;break e}case 2:{a[1166]=e&16777215;break e}case 3:break e;default:break e}else te(2,r+-24|0,e|0)|0}while(0);e=a[1168]|0;e:do{if((r+-28&-268435456|0)==-536870912)switch((r+536813524|0)>>>2|r+536813524<<30|0){case 0:{u=a[1164]|0;a[1164]=e&65543;if((e&1|0)==0|(u&1|0)!=0)break e;a[1166]=a[1165];break e}case 1:{a[1165]=e&16777215;break e}case 2:{a[1166]=e&16777215;break e}case 3:break e;default:break e}else te(2,r+-28|0,e|0)|0}while(0);e=a[1167]|0;e:do{if((r+-32&-268435456|0)==-536870912)switch((r+536813520|0)>>>2|r+536813520<<30|0){case 0:{u=a[1164]|0;a[1164]=e&65543;if((e&1|0)==0|(u&1|0)!=0)break e;a[1166]=a[1165];break e}case 1:{a[1165]=e&16777215;break e}case 2:{a[1166]=e&16777215;break e}case 3:break e;default:break e}else te(2,r+-32|0,e|0)|0}while(0);a[1180]=r+-32;s=($(1,60)|0)+2|0;a[1181]=-7;a[1183]=1}n=s+-2|0;u=$(3,n|0)|0;o=s+2|0;a[1182]=o&-2;if(i[5300]|0){r=a[2]|0;a[_+8>>2]=n;a[_+8+4>>2]=u;Ne(r,591,_+8|0)|0}if((u&65472|0)==16704){if(i[5300]|0){c=a[2]|0;a[_+16>>2]=u&7;a[_+16+4>>2]=u>>>3&7;Ne(c,611,_+16|0)|0}t=a[4668+((u&7)<<2)>>2]|0;s=a[4668+((u>>>3&7)<<2)>>2]|0;c=a[1184]|0;a[4668+((u&7)<<2)>>2]=s+t+(c>>>29&1);e=(s+t+(c>>>29&1)|0)<0?c|-2147483648:c&2147483647;e=(s+t+(c>>>29&1)|0)==0?e|1073741824:e&-1073741825;a[1184]=e;if(!(e&536870912)){u=((s>>>31)+(t>>>31)+(((s&2147483647)+(t&2147483647)|0)>>>31)&2|0)==0?e&-536870913:e|536870912;a[1184]=(((s&2147483647)+(t&2147483647)|0)>>>31|0)==(((s>>>31)+(t>>>31)+(((s&2147483647)+(t&2147483647)|0)>>>31)|0)>>>1&1|0)?u&-268435457:u|268435456;u=0;f=_;return u|0}else{u=(((s>>>31)+(t>>>31)+(((s&2147483647)+(t&2147483647)+1|0)>>>31)|0)&2|0)==0?e&-536870913:e|536870912;a[1184]=(((s&2147483647)+(t&2147483647)+1|0)>>>31|0)==(((s>>>31)+(t>>>31)+(((s&2147483647)+(t&2147483647)+1|0)>>>31)|0)>>>1&1|0)?u&-268435457:u|268435456;u=0;f=_;return u|0}}if((u&65024|0)==7168)if(u>>>6&7|0){if(i[5300]|0){c=a[2]|0;a[_+24>>2]=u&7;a[_+24+4>>2]=u>>>3&7;a[_+24+8>>2]=u>>>6&7;Ne(c,624,_+24|0)|0}h=a[4668+((u>>>3&7)<<2)>>2]|0;a[4668+((u&7)<<2)>>2]=h+(u>>>6&7);c=a[1184]|0;c=(h+(u>>>6&7)|0)<0?c|-2147483648:c&2147483647;c=(h+(u>>>6&7)|0)==0?c|1073741824:c&-1073741825;c=((((h&2147483647)+(u>>>6&7)|0)>>>31)+(h>>>31)&2|0)==0?c&-536870913:c|536870912;a[1184]=(((h&2147483647)+(u>>>6&7)|0)>>>31|0)==(((((h&2147483647)+(u>>>6&7)|0)>>>31)+(h>>>31)|0)>>>1|0)?c&-268435457:c|268435456;u=0;f=_;return u|0}if((u&63488|0)==12288){if(i[5300]|0){c=a[2]|0;a[_+40>>2]=u>>>8&7;a[_+40+4>>2]=u&255;Ne(c,644,_+40|0)|0}h=a[4668+((u>>>8&7)<<2)>>2]|0;a[4668+((u>>>8&7)<<2)>>2]=h+(u&255);c=a[1184]|0;c=(h+(u&255)|0)<0?c|-2147483648:c&2147483647;c=(h+(u&255)|0)==0?c|1073741824:c&-1073741825;c=((((h&2147483647)+(u&255)|0)>>>31)+(h>>>31)&2|0)==0?c&-536870913:c|536870912;a[1184]=(((h&2147483647)+(u&255)|0)>>>31|0)==(((((h&2147483647)+(u&255)|0)>>>31)+(h>>>31)|0)>>>1|0)?c&-268435457:c|268435456;u=0;f=_;return u|0}if((u&65024|0)==6144){if(i[5300]|0){c=a[2]|0;a[_+48>>2]=u&7;a[_+48+4>>2]=u>>>3&7;a[_+48+8>>2]=u>>>6&7;Ne(c,662,_+48|0)|0}c=a[4668+((u>>>3&7)<<2)>>2]|0;h=a[4668+((u>>>6&7)<<2)>>2]|0;a[4668+((u&7)<<2)>>2]=h+c;u=a[1184]|0;u=(h+c|0)<0?u|-2147483648:u&2147483647;u=(h+c|0)==0?u|1073741824:u&-1073741825;u=((h>>>31)+(c>>>31)+(((h&2147483647)+(c&2147483647)|0)>>>31)&2|0)==0?u&-536870913:u|536870912;a[1184]=(((h&2147483647)+(c&2147483647)|0)>>>31|0)==(((h>>>31)+(c>>>31)+(((h&2147483647)+(c&2147483647)|0)>>>31)|0)>>>1&1|0)?u&-268435457:u|268435456;u=0;f=_;return u|0}if((u&65280|0)==17408){if(i[5300]|0){c=a[2]|0;a[_+64>>2]=u>>>4&8|u&7;a[_+64+4>>2]=u>>>3&15;Ne(c,680,_+64|0)|0}e=a[4668+((u>>>4&8|u&7)<<2)>>2]|0;if((u>>>4&8|u&7|0)==15){if(e&1|0){c=a[2]|0;a[_+72>>2]=e;Ne(c,520,_+72|0)|0}e=e&-2}t=a[4668+((u>>>3&15)<<2)>>2]|0;if((u>>>3&15|0)==15){if(t&1|0){c=a[2]|0;a[_+80>>2]=t;Ne(c,520,_+80|0)|0}t=t&-2}e=t+e|0;do{if((u>>>4&8|u&7|0)==15)if(!(e&1)){c=a[2]|0;a[_+88>>2]=o;a[_+88+4>>2]=e;Ne(c,693,_+88|0)|0;X(1)}else{h=e+2&-2;break}else h=e}while(0);a[4668+((u>>>4&8|u&7)<<2)>>2]=(u>>>4&8|u&7|0)==15?h&-2:h;u=0;f=_;return u|0}e=1;t=(u&63488)<<16>>16;if(e)switch(t|0){case-24576:{if(i[5300]|0){c=a[2]|0;a[_+96>>2]=u>>>8&7;a[_+96+4>>2]=u<<2&1020;Ne(c,743,_+96|0)|0}e=a[1182]|0;if(e&1|0){c=a[2]|0;a[_+104>>2]=e;Ne(c,520,_+104|0)|0}a[4668+((u>>>8&7)<<2)>>2]=(e&-4)+(u<<2&1020);u=0;f=_;return u|0}case-22528:{if(i[5300]|0){c=a[2]|0;a[_+112>>2]=u>>>8&7;a[_+112+4>>2]=u<<2&1020;Ne(c,763,_+112|0)|0}a[4668+((u>>>8&7)<<2)>>2]=(a[1180]|0)+(u<<2&1020);u=0;f=_;return u|0}default:e=1}if(e)switch(t|0){default:{if((u&65408|0)==45056){if(i[5300]|0){c=a[2]|0;a[_+120>>2]=u<<2&508;Ne(c,783,_+120|0)|0}a[1180]=(a[1180]|0)+(u<<2&508);u=0;f=_;return u|0}if((u&65472|0)==16384){if(i[5300]|0){c=a[2]|0;a[_+128>>2]=u&7;a[_+128+4>>2]=u>>>3&7;Ne(c,799,_+128|0)|0}c=a[4668+((u>>>3&7)<<2)>>2]&a[4668+((u&7)<<2)>>2];a[4668+((u&7)<<2)>>2]=c;u=a[1184]|0;u=(c|0)<0?u|-2147483648:u&2147483647;a[1184]=(c|0)==0?u|1073741824:u&-1073741825;u=0;f=_;return u|0}if((u&63488|0)==4096){if(i[5300]|0){c=a[2]|0;a[_+136>>2]=u&7;a[_+136+4>>2]=u>>>3&7;a[_+136+8>>2]=u>>>6&31;Ne(c,813,_+136|0)|0}e=a[4668+((u>>>3&7)<<2)>>2]|0;do{if(!(u>>>6&31)){s=a[1184]|0;if((e|0)<0){a[1184]=s|536870912;t=-1;e=s|536870912;break}else{a[1184]=s&-536870913;t=0;e=s&-536870913;break}}else{c=a[1184]|0;c=e&1<<(u>>>6&31)+-1|0?c|536870912:c&-536870913;a[1184]=c;t=((e|0)<0?-1<<32-(u>>>6&31):0)|e>>>(u>>>6&31);e=c}}while(0);a[4668+((u&7)<<2)>>2]=t;u=(t|0)<0?e|-2147483648:e&2147483647;a[1184]=(t|0)==0?u|1073741824:u&-1073741825;u=0;f=_;return u|0}if((u&65472|0)==16640){if(i[5300]|0){c=a[2]|0;a[_+152>>2]=u&7;a[_+152+4>>2]=u>>>3&7;Ne(c,833,_+152|0)|0}t=a[4668+((u&7)<<2)>>2]|0;e=a[4668+((u>>>3&7)<<2)>>2]&255;do{if(!e)e=a[1184]|0;else{if(e>>>0<32){c=a[1184]|0;c=1<<e+-1&t|0?c|536870912:c&-536870913;a[1184]=c;t=((t|0)<0?-1<<32-e:0)|t>>>e;e=c;break}e=a[1184]|0;if((t|0)<0){a[1184]=e|536870912;t=-1;e=e|536870912;break}else{a[1184]=e&-536870913;t=0;e=e&-536870913;break}}}while(0);a[4668+((u&7)<<2)>>2]=t;u=(t|0)<0?e|-2147483648:e&2147483647;a[1184]=(t|0)==0?u|1073741824:u&-1073741825;u=0;f=_;return u|0}e:do{if((u&61440|0)==53248){t=(((u&128|0)==0?u&255:u|-256)<<1)+o|0;do{switch(u>>>8&15){case 0:{if(i[5300]|0){u=a[2]|0;a[_+160>>2]=t+-1;Ne(u,847,_+160|0)|0}if(!(a[1184]&1073741824)){u=0;f=_;return u|0}a[1182]=t+2&-2;u=0;f=_;return u|0}case 1:{if(i[5300]|0){u=a[2]|0;a[_+168>>2]=t+-1;Ne(u,859,_+168|0)|0}if(a[1184]&1073741824|0){u=0;f=_;return u|0}a[1182]=t+2&-2;u=0;f=_;return u|0}case 2:{if(i[5300]|0){u=a[2]|0;a[_+176>>2]=t+-1;Ne(u,871,_+176|0)|0}if(!(a[1184]&536870912)){u=0;f=_;return u|0}a[1182]=t+2&-2;u=0;f=_;return u|0}case 3:{if(i[5300]|0){u=a[2]|0;a[_+184>>2]=t+-1;Ne(u,883,_+184|0)|0}if(a[1184]&536870912|0){u=0;f=_;return u|0}a[1182]=t+2&-2;u=0;f=_;return u|0}case 4:{if(i[5300]|0){u=a[2]|0;a[_+192>>2]=t+-1;Ne(u,895,_+192|0)|0}if((a[1184]|0)>=0){u=0;f=_;return u|0}a[1182]=t+2&-2;u=0;f=_;return u|0}case 5:{if(i[5300]|0){u=a[2]|0;a[_+200>>2]=t+-1;Ne(u,907,_+200|0)|0}if((a[1184]|0)<0){u=0;f=_;return u|0}a[1182]=t+2&-2;u=0;f=_;return u|0}case 6:{if(i[5300]|0){u=a[2]|0;a[_+208>>2]=t+-1;Ne(u,919,_+208|0)|0}if(!(a[1184]&268435456)){u=0;f=_;return u|0}a[1182]=t+2&-2;u=0;f=_;return u|0}case 7:{if(i[5300]|0){u=a[2]|0;a[_+216>>2]=t+-1;Ne(u,931,_+216|0)|0}if(a[1184]&268435456|0){u=0;f=_;return u|0}a[1182]=t+2&-2;u=0;f=_;return u|0}case 8:{if(i[5300]|0){u=a[2]|0;a[_+224>>2]=t+-1;Ne(u,943,_+224|0)|0}if((a[1184]&1610612736|0)!=536870912){u=0;f=_;return u|0}a[1182]=t+2&-2;u=0;f=_;return u|0}case 9:{if(i[5300]|0){u=a[2]|0;a[_+232>>2]=t+-1;Ne(u,955,_+232|0)|0}if((a[1184]&1610612736|0)==536870912){u=0;f=_;return u|0}a[1182]=t+2&-2;u=0;f=_;return u|0}case 10:{if(i[5300]|0){u=a[2]|0;a[_+240>>2]=t+-1;Ne(u,967,_+240|0)|0}e=a[1184]&-1879048192;t:do{if((e|0)<0){switch(e|0){case-1879048192:break t;default:c=0}f=_;return c|0}else{switch(e|0){case 0:break t;default:c=0}f=_;return c|0}}while(0);a[1182]=t+2&-2;u=0;f=_;return u|0}case 11:{if(i[5300]|0){u=a[2]|0;a[_+248>>2]=t+-1;Ne(u,979,_+248|0)|0}u=a[1184]|0;if(!((u&268435456|0?(u|0)<0?0:(u&268435456)>>>28:(u|0)<0?1:(u&268435456)>>>28)|0)){u=0;f=_;return u|0}a[1182]=t+2&-2;u=0;f=_;return u|0}case 12:{if(i[5300]|0){u=a[2]|0;a[_+256>>2]=t+-1;Ne(u,991,_+256|0)|0}u=a[1184]|0;if(u&1073741824|0?1:(((u&-1879048192|0)==0?(u&-1879048192|0)==-1879048192?2:1:(u&-1879048192|0)==-1879048192&1)|0)==0){u=0;f=_;return u|0}a[1182]=t+2&-2;u=0;f=_;return u|0}case 13:{if(i[5300]|0){u=a[2]|0;a[_+264>>2]=t+-1;Ne(u,1003,_+264|0)|0}u=a[1184]|0;if(((u&268435456|0?(u|0)<0?0:(u&268435456)>>>28:(u|0)<0?1:(u&268435456)>>>28)|0)==(0-(u>>>30&1)|0)){u=0;f=_;return u|0}a[1182]=t+2&-2;u=0;f=_;return u|0}default:break e}}while(0)}}while(0);if((u&63488|0)==57344){e=(((u&1024|0)==0?u&2047:u|-2048)<<1)+o|0;if(i[5300]|0){u=a[2]|0;a[_+272>>2]=e+-1;Ne(u,1015,_+272|0)|0}a[1182]=e+2&-2;u=0;f=_;return u|0}if((u&65472|0)==17280){if(i[5300]|0){c=a[2]|0;a[_+280>>2]=u&7;a[_+280+4>>2]=u>>>3&7;Ne(c,1025,_+280|0)|0}c=a[4668+((u&7)<<2)>>2]&~a[4668+((u>>>3&7)<<2)>>2];a[4668+((u&7)<<2)>>2]=c;u=a[1184]|0;u=(c|0)<0?u|-2147483648:u&2147483647;a[1184]=(c|0)==0?u|1073741824:u&-1073741825;u=0;f=_;return u|0}if((u&65280|0)==48640){c=a[2]|0;a[_+288>>2]=u&255;Ne(c,1039,_+288|0)|0;u=1;f=_;return u|0}e:do{if((u&57344|0)==57344){if((u&6144)<4096){switch(u&6144){case 2048:break;default:break e}e=(a[1181]|0)+(u<<1&4094)&-4|2;if(i[5300]|0){u=a[2]|0;a[_+304>>2]=e+-3;Ne(u,1052,_+304|0)|0}a[1181]=s|1;a[1182]=e;u=0;f=_;return u|0}switch(u&6144){case 4096:{if(i[5300]|0)at(10,a[2]|0)|0;a[1181]=(((u&1024|0)==0?u&2047:u|1046528)<<12)+o;u=0;f=_;return u|0}case 6144:{e=(a[1181]|0)+(u<<1&4094)|0;if(i[5300]|0){u=a[2]|0;a[_+296>>2]=e+-1;Ne(u,1052,_+296|0)|0}a[1181]=s|1;a[1182]=e+2&-2;u=0;f=_;return u|0}default:break e}}}while(0);e=(i[5300]|0)!=0;t=1;r=(u&65415)<<16>>16;if(t)switch(r|0){case 18304:{if(e){c=a[2]|0;a[_+312>>2]=u>>>3&15;Ne(c,1063,_+312|0)|0}e=a[4668+((u>>>3&15)<<2)>>2]|0;if((u>>>3&15|0)==15){if(e&1|0){c=a[2]|0;a[_+320>>2]=e;Ne(c,520,_+320|0)|0}e=e&-2}e=e+2|0;if(!(e&1)){c=a[2]|0;a[_+328>>2]=o;a[_+328+4>>2]=u;Ne(c,1072,_+328|0)|0;u=2;f=_;return u|0}else{a[1181]=s|1;a[1182]=e&-2;u=0;f=_;return u|0}}case 18176:{if(e){c=a[2]|0;a[_+336>>2]=u>>>3&15;Ne(c,1108,_+336|0)|0}e=a[4668+((u>>>3&15)<<2)>>2]|0;if((u>>>3&15|0)==15){if(e&1|0){u=a[2]|0;a[_+344>>2]=e;Ne(u,520,_+344|0)|0}e=e&-2}e=e+2|0;if(e&1|0){a[1182]=e&-2;u=0;f=_;return u|0}e=te(4,n|0,e|0)|0;if(e|0){u=e;f=_;return u|0}a[1182]=(a[1181]|0)+2&-2;u=0;f=_;return u|0}default:t=1}if(t)switch(r|0){default:{if((u&65472|0)==17088){if(e){c=a[2]|0;a[_+352>>2]=u&7;a[_+352+4>>2]=u>>>3&7;Ne(c,1154,_+352|0)|0}c=a[4668+((u&7)<<2)>>2]|0;h=a[4668+((u>>>3&7)<<2)>>2]|0;u=a[1184]|0;u=(h+c|0)<0?u|-2147483648:u&2147483647;u=(h+c|0)==0?u|1073741824:u&-1073741825;u=((h>>>31)+(c>>>31)+(((h&2147483647)+(c&2147483647)|0)>>>31)&2|0)==0?u&-536870913:u|536870912;a[1184]=(((h&2147483647)+(c&2147483647)|0)>>>31|0)==(((h>>>31)+(c>>>31)+(((h&2147483647)+(c&2147483647)|0)>>>31)|0)>>>1&1|0)?u&-268435457:u|268435456;u=0;f=_;return u|0}if((u&63488|0)==10240){if(e){c=a[2]|0;a[_+360>>2]=u>>>8&7;a[_+360+4>>2]=u&255;Ne(c,1168,_+360|0)|0}h=a[4668+((u>>>8&7)<<2)>>2]|0;c=a[1184]|0;c=(h-(u&255)|0)<0?c|-2147483648:c&2147483647;c=(h-(u&255)|0)==0?c|1073741824:c&-1073741825;c=(((h>>>31)+1+((-2147483648-(u&255)+(h&2147483647)|0)>>>31)|0)&2|0)==0?c&-536870913:c|536870912;a[1184]=((-2147483648-(u&255)+(h&2147483647)|0)>>>31|0)==(((h>>>31)+1+((-2147483648-(u&255)+(h&2147483647)|0)>>>31)|0)>>>1&1|0)?c&-268435457:c|268435456;u=0;f=_;return u|0}if((u&65472|0)==17024){if(e){c=a[2]|0;a[_+368>>2]=u&7;a[_+368+4>>2]=u>>>3&7;Ne(c,1185,_+368|0)|0}h=a[4668+((u&7)<<2)>>2]|0;c=a[4668+((u>>>3&7)<<2)>>2]|0;u=a[1184]|0;u=(h-c|0)<0?u|-2147483648:u&2147483647;u=(h-c|0)==0?u|1073741824:u&-1073741825;u=(((~c>>>31)+(h>>>31)+(((h&2147483647)+1+(~c&2147483647)|0)>>>31)|0)&2|0)==0?u&-536870913:u|536870912;a[1184]=(((h&2147483647)+1+(~c&2147483647)|0)>>>31|0)==(((~c>>>31)+(h>>>31)+(((h&2147483647)+1+(~c&2147483647)|0)>>>31)|0)>>>1&1|0)?u&-268435457:u|268435456;u=0;f=_;return u|0}if((u&65280|0)==17664){if(e){c=a[2]|0;a[_+376>>2]=u>>>4&8|u&7;a[_+376+4>>2]=u>>>3&15;Ne(c,1185,_+376|0)|0}e=a[4668+((u>>>4&8|u&7)<<2)>>2]|0;if((u>>>4&8|u&7|0)==15){if(e&1|0){c=a[2]|0;a[_+384>>2]=e;Ne(c,520,_+384|0)|0}t=e&-2}else t=e;e=a[4668+((u>>>3&15)<<2)>>2]|0;if((u>>>3&15|0)==15){if(e&1|0){u=a[2]|0;a[_+392>>2]=e;Ne(u,520,_+392|0)|0}e=e&-2}c=t-e|0;u=a[1184]|0;u=(c|0)<0?u|-2147483648:u&2147483647;u=(c|0)==0?u|1073741824:u&-1073741825;c=~e;h=((t&2147483647)+1+(c&2147483647)|0)>>>31;c=(c>>>31)+(t>>>31)+h|0;u=(c&2|0)==0?u&-536870913:u|536870912;a[1184]=(h|0)==(c>>>1&1|0)?u&-268435457:u|268435456;u=0;f=_;return u|0}if((u&65512|0)==46688&e)Ee(1199,9,1,a[2]|0)|0;e=1;t=(u&65472)<<16>>16;if(e)switch(t|0){case 17920:{if(i[5300]|0){c=a[2]|0;a[_+400>>2]=u&7;a[_+400+4>>2]=u>>>3&7;Ne(c,1209,_+400|0)|0}a[4668+((u&7)<<2)>>2]=a[4668+((u>>>3&7)<<2)>>2];u=0;f=_;return u|0}case 16448:{if(i[5300]|0){c=a[2]|0;a[_+408>>2]=u&7;a[_+408+4>>2]=u>>>3&7;Ne(c,1222,_+408|0)|0}c=a[4668+((u>>>3&7)<<2)>>2]^a[4668+((u&7)<<2)>>2];a[4668+((u&7)<<2)>>2]=c;u=a[1184]|0;u=(c|0)<0?u|-2147483648:u&2147483647;a[1184]=(c|0)==0?u|1073741824:u&-1073741825;u=0;f=_;return u|0}default:e=1}if(e)switch(t|0){default:{e:do{if((u&63488)<<16>>16<26624){switch((u&63488)<<16>>16){case-14336:break;default:break e}if(!(i[5300]|0))t=u&1;else{t=a[2]|0;a[_+416>>2]=u>>>8&7;Ne(t,1236,_+416|0)|0;if(!(u&1))e=0;else{a[_+424>>2]=0;Ne(t,1249,_+424|0)|0;e=1}if(u&2){if(e|0)at(44,t)|0;a[_+1176>>2]=1;Ne(t,1249,_+1176|0)|0;e=e+1|0}if(u&4){if(e|0)at(44,t)|0;a[_+1184>>2]=2;Ne(t,1249,_+1184|0)|0;e=e+1|0}if(u&8){if(e|0)at(44,t)|0;a[_+1192>>2]=3;Ne(t,1249,_+1192|0)|0;e=e+1|0}if(u&16){if(e|0)at(44,t)|0;a[_+1200>>2]=4;Ne(t,1249,_+1200|0)|0;e=e+1|0}if(u&32){if(e|0)at(44,t)|0;a[_+1208>>2]=5;Ne(t,1249,_+1208|0)|0;e=e+1|0}if(u&64){if(e|0)at(44,t)|0;a[_+1216>>2]=6;Ne(t,1249,_+1216|0)|0;e=e+1|0}if(u&128|0){if(e|0)at(44,t)|0;a[_+1224>>2]=7;Ne(t,1249,_+1224|0)|0}Ee(1253,2,1,t)|0;t=u&1}e=a[4668+((u>>>8&7)<<2)>>2]|0;if(t){a[1167]=$(1,e|0)|0;e=e+4|0}if(u&2){a[1168]=$(1,e|0)|0;e=e+4|0}if(u&4){a[1169]=$(1,e|0)|0;e=e+4|0}if(u&8){a[1170]=$(1,e|0)|0;e=e+4|0}if(u&16){a[1171]=$(1,e|0)|0;e=e+4|0}if(u&32){a[1172]=$(1,e|0)|0;e=e+4|0}if(u&64){a[1173]=$(1,e|0)|0;e=e+4|0}if(u&128){a[1174]=$(1,e|0)|0;e=e+4|0}if(1<<(u>>>8&7)&u|0){u=0;f=_;return u|0}a[4668+((u>>>8&7)<<2)>>2]=e;u=0;f=_;return u|0}else{switch((u&63488)<<16>>16){case 26624:break;default:break e}if(i[5300]|0){c=a[2]|0;a[_+432>>2]=u&7;a[_+432+4>>2]=u>>>3&7;a[_+432+8>>2]=u>>>4&124;Ne(c,1256,_+432|0)|0}a[4668+((u&7)<<2)>>2]=$(1,(a[4668+((u>>>3&7)<<2)>>2]|0)+(u>>>4&124)|0)|0;u=0;f=_;return u|0}}while(0);if((u&65024|0)==22528){if(i[5300]|0){c=a[2]|0;a[_+448>>2]=u&7;a[_+448+4>>2]=u>>>3&7;a[_+448+8>>2]=u>>>6&7;Ne(c,1277,_+448|0)|0}a[4668+((u&7)<<2)>>2]=$(1,(a[4668+((u>>>6&7)<<2)>>2]|0)+(a[4668+((u>>>3&7)<<2)>>2]|0)|0)|0;u=0;f=_;return u|0}e:do{if((u&63488)<<16>>16<18432){switch((u&63488)<<16>>16){case-26624:break;default:break e}if(i[5300]|0){c=a[2]|0;a[_+488>>2]=u>>>8&7;a[_+488+4>>2]=u<<2&1020;Ne(c,1325,_+488|0)|0}a[4668+((u>>>8&7)<<2)>>2]=$(1,(a[1180]|0)+(u<<2&1020)|0)|0;u=0;f=_;return u|0}else{if((u&63488)<<16>>16>=30720){switch((u&63488)<<16>>16){case 30720:break;default:break e}if(i[5300]|0){c=a[2]|0;a[_+496>>2]=u&7;a[_+496+4>>2]=u>>>3&7;a[_+496+8>>2]=u>>>6&31;Ne(c,1345,_+496|0)|0}h=a[4668+((u>>>3&7)<<2)>>2]|0;c=$(3,h+(u>>>6&31)&-2|0)|0;a[4668+((u&7)<<2)>>2]=((h+(u>>>6)&1|0)==0?c:c>>>8)&255;u=0;f=_;return u|0}switch((u&63488)<<16>>16){case 18432:break;default:break e}if(i[5300]|0){c=a[2]|0;a[_+464>>2]=u>>>8&7;a[_+464+4>>2]=u<<2&1020;Ne(c,1296,_+464|0)|0}e=a[1182]|0;if(e&1|0){c=a[2]|0;a[_+472>>2]=e;Ne(c,520,_+472|0)|0}if(i[5300]|0){c=a[2]|0;a[_+480>>2]=(e&-4)+(u<<2&1020);Ne(c,1316,_+480|0)|0}a[4668+((u>>>8&7)<<2)>>2]=$(1,(e&-4)+(u<<2&1020)|0)|0;u=0;f=_;return u|0}}while(0);a[_+1368>>2]=c;a[_+3472>>2]=n;a[_+3496>>2]=u;a[_+3504>>2]=o;a[_+4792>>2]=0;a[_+4796>>2]=0;vt(_);y=a[_+4792>>2]|0;k=a[_+4796>>2]|0;a[_+4792>>2]=0;a[_+4796>>2]=0;if((y|0)==6)return k|0}}}}}}return 0}function be(e){e=e|0;var t=0,s=0,i=0,r=0,n=0,o=0,h=0,c=0,u=0,_=0,l=0,d=0,p=0;p=f;f=f+16|0;do{if(e>>>0<245){l=e>>>0<11?16:e+11&-8;u=a[1185]|0;if(u>>>(l>>>3)&3|0){e=4780+((u>>>(l>>>3)&1^1)+(l>>>3)<<1<<2)|0;t=a[e+8>>2]|0;s=a[t+8>>2]|0;if((e|0)==(s|0))a[1185]=u&~(1<<(u>>>(l>>>3)&1^1)+(l>>>3));else{a[s+12>>2]=e;a[e+8>>2]=s}d=(u>>>(l>>>3)&1^1)+(l>>>3)<<3;a[t+4>>2]=d|3;a[t+d+4>>2]=a[t+d+4>>2]|1;d=t+8|0;f=p;return d|0}_=a[1187]|0;if(l>>>0>_>>>0){if(u>>>(l>>>3)|0){e=u>>>(l>>>3)<<(l>>>3)&(2<<(l>>>3)|0-(2<<(l>>>3)));r=((e&0-e)+-1|0)>>>(((e&0-e)+-1|0)>>>12&16);i=r>>>(r>>>5&8)>>>(r>>>(r>>>5&8)>>>2&4);i=(r>>>5&8|((e&0-e)+-1|0)>>>12&16|r>>>(r>>>5&8)>>>2&4|i>>>1&2|i>>>(i>>>1&2)>>>1&1)+(i>>>(i>>>1&2)>>>(i>>>(i>>>1&2)>>>1&1))|0;r=a[4780+(i<<1<<2)+8>>2]|0;e=a[r+8>>2]|0;if((4780+(i<<1<<2)|0)==(e|0)){a[1185]=u&~(1<<i);e=u&~(1<<i)}else{a[e+12>>2]=4780+(i<<1<<2);a[4780+(i<<1<<2)+8>>2]=e;e=u}a[r+4>>2]=l|3;a[r+l+4>>2]=(i<<3)-l|1;a[r+l+((i<<3)-l)>>2]=(i<<3)-l;if(_|0){s=a[1190]|0;if(!(e&1<<(_>>>3))){a[1185]=e|1<<(_>>>3);e=4780+(_>>>3<<1<<2)|0;t=4780+(_>>>3<<1<<2)+8|0}else{e=a[4780+(_>>>3<<1<<2)+8>>2]|0;t=4780+(_>>>3<<1<<2)+8|0}a[t>>2]=s;a[e+12>>2]=s;a[s+8>>2]=e;a[s+12>>2]=4780+(_>>>3<<1<<2)}a[1187]=(i<<3)-l;a[1190]=r+l;d=r+8|0;f=p;return d|0}c=a[1186]|0;if(c){t=((c&0-c)+-1|0)>>>(((c&0-c)+-1|0)>>>12&16);e=t>>>(t>>>5&8)>>>(t>>>(t>>>5&8)>>>2&4);e=a[5044+((t>>>5&8|((c&0-c)+-1|0)>>>12&16|t>>>(t>>>5&8)>>>2&4|e>>>1&2|e>>>(e>>>1&2)>>>1&1)+(e>>>(e>>>1&2)>>>(e>>>(e>>>1&2)>>>1&1))<<2)>>2]|0;t=(a[e+4>>2]&-8)-l|0;s=a[e+16+(((a[e+16>>2]|0)==0&1)<<2)>>2]|0;if(!s){h=e;n=t}else{do{o=(a[s+4>>2]&-8)-l|0;h=o>>>0<t>>>0;t=h?o:t;e=h?s:e;s=a[s+16+(((a[s+16>>2]|0)==0&1)<<2)>>2]|0}while((s|0)!=0);h=e;n=t}o=h+l|0;if(h>>>0<o>>>0){r=a[h+24>>2]|0;e=a[h+12>>2]|0;do{if((e|0)==(h|0)){t=h+20|0;e=a[t>>2]|0;if(!e){t=h+16|0;e=a[t>>2]|0;if(!e){t=0;break}}while(1){s=e+20|0;i=a[s>>2]|0;if(i|0){e=i;t=s;continue}s=e+16|0;i=a[s>>2]|0;if(!i)break;else{e=i;t=s}}a[t>>2]=0;t=e}else{t=a[h+8>>2]|0;a[t+12>>2]=e;a[e+8>>2]=t;t=e}}while(0);do{if(r|0){e=a[h+28>>2]|0;if((h|0)==(a[5044+(e<<2)>>2]|0)){a[5044+(e<<2)>>2]=t;if(!t){a[1186]=c&~(1<<e);break}}else{a[r+16+(((a[r+16>>2]|0)!=(h|0)&1)<<2)>>2]=t;if(!t)break}a[t+24>>2]=r;e=a[h+16>>2]|0;if(e|0){a[t+16>>2]=e;a[e+24>>2]=t}e=a[h+20>>2]|0;if(e|0){a[t+20>>2]=e;a[e+24>>2]=t}}}while(0);if(n>>>0<16){d=n+l|0;a[h+4>>2]=d|3;d=h+d+4|0;a[d>>2]=a[d>>2]|1}else{a[h+4>>2]=l|3;a[o+4>>2]=n|1;a[o+n>>2]=n;if(_|0){s=a[1190]|0;if(!(u&1<<(_>>>3))){a[1185]=u|1<<(_>>>3);e=4780+(_>>>3<<1<<2)|0;t=4780+(_>>>3<<1<<2)+8|0}else{e=a[4780+(_>>>3<<1<<2)+8>>2]|0;t=4780+(_>>>3<<1<<2)+8|0}a[t>>2]=s;a[e+12>>2]=s;a[s+8>>2]=e;a[s+12>>2]=4780+(_>>>3<<1<<2)}a[1187]=n;a[1190]=o}d=h+8|0;f=p;return d|0}}}}else if(e>>>0>4294967231)l=-1;else{l=e+11&-8;c=a[1186]|0;if(c){if(!((e+11|0)>>>8))o=0;else if(l>>>0>16777215)o=31;else{o=(e+11|0)>>>8<<((((e+11|0)>>>8)+1048320|0)>>>16&8);o=14-((o+520192|0)>>>16&4|(((e+11|0)>>>8)+1048320|0)>>>16&8|((o<<((o+520192|0)>>>16&4))+245760|0)>>>16&2)+(o<<((o+520192|0)>>>16&4)<<(((o<<((o+520192|0)>>>16&4))+245760|0)>>>16&2)>>>15)|0;o=l>>>(o+7|0)&1|o<<1}t=a[5044+(o<<2)>>2]|0;e:do{if(!t){t=0;e=0;s=0-l|0;d=57}else{e=0;s=0-l|0;n=l<<((o|0)==31?0:25-(o>>>1)|0);r=0;while(1){i=(a[t+4>>2]&-8)-l|0;if(i>>>0<s>>>0)if(!i){e=t;s=0;i=t;d=61;break e}else{e=t;s=i}i=a[t+20>>2]|0;t=a[t+16+(n>>>31<<2)>>2]|0;r=(i|0)==0|(i|0)==(t|0)?r:i;i=(t|0)==0;if(i){t=r;d=57;break}else n=n<<((i^1)&1)}}}while(0);if((d|0)==57){if((t|0)==0&(e|0)==0){e=2<<o;if(!(c&(e|0-e)))break;u=(c&(e|0-e)&0-(c&(e|0-e)))+-1|0;_=u>>>(u>>>12&16)>>>(u>>>(u>>>12&16)>>>5&8);t=_>>>(_>>>2&4)>>>(_>>>(_>>>2&4)>>>1&2);e=0;t=a[5044+((u>>>(u>>>12&16)>>>5&8|u>>>12&16|_>>>2&4|_>>>(_>>>2&4)>>>1&2|t>>>1&1)+(t>>>(t>>>1&1))<<2)>>2]|0}if(!t){h=e;n=s}else{i=t;d=61}}if((d|0)==61)while(1){d=0;t=(a[i+4>>2]&-8)-l|0;_=t>>>0<s>>>0;t=_?t:s;e=_?i:e;i=a[i+16+(((a[i+16>>2]|0)==0&1)<<2)>>2]|0;if(!i){h=e;n=t;break}else{s=t;d=61}}if(h)if(n>>>0<((a[1187]|0)-l|0)>>>0){o=h+l|0;if(h>>>0>=o>>>0){d=0;f=p;return d|0}r=a[h+24>>2]|0;e=a[h+12>>2]|0;do{if((e|0)==(h|0)){t=h+20|0;e=a[t>>2]|0;if(!e){t=h+16|0;e=a[t>>2]|0;if(!e){e=0;break}}while(1){s=e+20|0;i=a[s>>2]|0;if(i|0){e=i;t=s;continue}s=e+16|0;i=a[s>>2]|0;if(!i)break;else{e=i;t=s}}a[t>>2]=0}else{d=a[h+8>>2]|0;a[d+12>>2]=e;a[e+8>>2]=d}}while(0);do{if(!r)i=c;else{t=a[h+28>>2]|0;if((h|0)==(a[5044+(t<<2)>>2]|0)){a[5044+(t<<2)>>2]=e;if(!e){a[1186]=c&~(1<<t);i=c&~(1<<t);break}}else{a[r+16+(((a[r+16>>2]|0)!=(h|0)&1)<<2)>>2]=e;if(!e){i=c;break}}a[e+24>>2]=r;t=a[h+16>>2]|0;if(t|0){a[e+16>>2]=t;a[t+24>>2]=e}t=a[h+20>>2]|0;if(!t)i=c;else{a[e+20>>2]=t;a[t+24>>2]=e;i=c}}}while(0);do{if(n>>>0<16){d=n+l|0;a[h+4>>2]=d|3;d=h+d+4|0;a[d>>2]=a[d>>2]|1}else{a[h+4>>2]=l|3;a[o+4>>2]=n|1;a[o+n>>2]=n;s=n>>>3;if(n>>>0<256){e=a[1185]|0;if(!(e&1<<s)){a[1185]=e|1<<s;e=4780+(s<<1<<2)|0;t=4780+(s<<1<<2)+8|0}else{e=a[4780+(s<<1<<2)+8>>2]|0;t=4780+(s<<1<<2)+8|0}a[t>>2]=o;a[e+12>>2]=o;a[o+8>>2]=e;a[o+12>>2]=4780+(s<<1<<2);break}e=n>>>8;if(!e)e=0;else if(n>>>0>16777215)e=31;else{d=e<<((e+1048320|0)>>>16&8)<<(((e<<((e+1048320|0)>>>16&8))+520192|0)>>>16&4);e=14-(((e<<((e+1048320|0)>>>16&8))+520192|0)>>>16&4|(e+1048320|0)>>>16&8|(d+245760|0)>>>16&2)+(d<<((d+245760|0)>>>16&2)>>>15)|0;e=n>>>(e+7|0)&1|e<<1}s=5044+(e<<2)|0;a[o+28>>2]=e;a[o+16+4>>2]=0;a[o+16>>2]=0;t=1<<e;if(!(i&t)){a[1186]=i|t;a[s>>2]=o;a[o+24>>2]=s;a[o+12>>2]=o;a[o+8>>2]=o;break}t=n<<((e|0)==31?0:25-(e>>>1)|0);s=a[s>>2]|0;while(1){if((a[s+4>>2]&-8|0)==(n|0)){d=97;break}i=s+16+(t>>>31<<2)|0;e=a[i>>2]|0;if(!e){d=96;break}else{t=t<<1;s=e}}if((d|0)==96){a[i>>2]=o;a[o+24>>2]=s;a[o+12>>2]=o;a[o+8>>2]=o;break}else if((d|0)==97){l=s+8|0;d=a[l>>2]|0;a[d+12>>2]=o;a[l>>2]=o;a[o+8>>2]=d;a[o+12>>2]=s;a[o+24>>2]=0;break}}}while(0);d=h+8|0;f=p;return d|0}}}}while(0);s=a[1187]|0;if(s>>>0>=l>>>0){e=s-l|0;t=a[1190]|0;if(e>>>0>15){d=t+l|0;a[1190]=d;a[1187]=e;a[d+4>>2]=e|1;a[d+e>>2]=e;a[t+4>>2]=l|3}else{a[1187]=0;a[1190]=0;a[t+4>>2]=s|3;a[t+s+4>>2]=a[t+s+4>>2]|1}d=t+8|0;f=p;return d|0}n=a[1188]|0;if(n>>>0>l>>>0){u=n-l|0;a[1188]=u;d=a[1191]|0;_=d+l|0;a[1191]=_;a[_+4>>2]=u|1;a[d+4>>2]=l|3;d=d+8|0;f=p;return d|0}if(!(a[1303]|0)){a[1305]=4096;a[1304]=4096;a[1306]=-1;a[1307]=-1;a[1308]=0;a[1296]=0;a[p>>2]=p&-16^1431655768;a[1303]=p&-16^1431655768;e=4096}else e=a[1305]|0;o=l+48|0;h=l+47|0;u=e+h|0;c=0-e|0;if((u&c)>>>0<=l>>>0){d=0;f=p;return d|0}e=a[1295]|0;if(e|0){_=a[1293]|0;if((_+(u&c)|0)>>>0<=_>>>0?1:(_+(u&c)|0)>>>0>e>>>0){d=0;f=p;return d|0}}e:do{if(!(a[1296]&4)){s=a[1191]|0;t:do{if(!s)d=118;else{e=5188;while(1){t=a[e>>2]|0;if(t>>>0<=s>>>0){r=e+4|0;if((t+(a[r>>2]|0)|0)>>>0>s>>>0)break}e=a[e+8>>2]|0;if(!e){d=118;break t}}if((u-n&c)>>>0<2147483647){i=mt(u-n&c|0)|0;if((i|0)==((a[e>>2]|0)+(a[r>>2]|0)|0))if((i|0)==(-1|0))e=u-n&c;else{n=u-n&c;d=135;break e}else{s=u-n&c;d=126}}else e=0}}while(0);do{if((d|0)==118){r=mt(0)|0;if((r|0)==(-1|0))e=0;else{s=a[1304]|0;s=((s+-1&r|0)==0?0:(s+-1+r&0-s)-r|0)+(u&c)|0;e=a[1293]|0;if(s>>>0>l>>>0&s>>>0<2147483647){t=a[1295]|0;if(t|0)if((s+e|0)>>>0<=e>>>0|(s+e|0)>>>0>t>>>0){e=0;break}i=mt(s|0)|0;if((i|0)==(r|0)){n=s;i=r;d=135;break e}else d=126}else e=0}}}while(0);do{if((d|0)==126){t=0-s|0;if(!(o>>>0>s>>>0&(s>>>0<2147483647&(i|0)!=(-1|0))))if((i|0)==(-1|0)){e=0;break}else{n=s;d=135;break e}e=a[1305]|0;e=h-s+e&0-e;if(e>>>0>=2147483647){n=s;d=135;break e}if((mt(e|0)|0)==(-1|0)){mt(t|0)|0;e=0;break}else{n=e+s|0;d=135;break e}}}while(0);a[1296]=a[1296]|4;d=133}else{e=0;d=133}}while(0);if((d|0)==133)if((u&c)>>>0<2147483647){i=mt(u&c|0)|0;t=mt(0)|0;s=(t-i|0)>>>0>(l+40|0)>>>0;if(!((i|0)==(-1|0)|s^1|i>>>0<t>>>0&((i|0)!=(-1|0)&(t|0)!=(-1|0))^1)){n=s?t-i|0:e;d=135}}if((d|0)==135){e=(a[1293]|0)+n|0;a[1293]=e;if(e>>>0>(a[1294]|0)>>>0)a[1294]=e;o=a[1191]|0;do{if(!o){d=a[1189]|0;if((d|0)==0|i>>>0<d>>>0)a[1189]=i;a[1297]=i;a[1298]=n;a[1300]=0;a[1194]=a[1303];a[1193]=-1;e=0;do{d=4780+(e<<1<<2)|0;a[d+12>>2]=d;a[d+8>>2]=d;e=e+1|0}while((e|0)!=32);d=i+8|0;d=(d&7|0)==0?0:0-d&7;_=i+d|0;d=n+-40-d|0;a[1191]=_;a[1188]=d;a[_+4>>2]=d|1;a[_+d+4>>2]=40;a[1192]=a[1307]}else{e=5188;do{t=a[e>>2]|0;s=e+4|0;r=a[s>>2]|0;if((i|0)==(t+r|0)){d=145;break}e=a[e+8>>2]|0}while((e|0)!=0);if((d|0)==145)if(!(a[e+12>>2]&8))if(o>>>0<i>>>0&o>>>0>=t>>>0){a[s>>2]=r+n;_=(o+8&7|0)==0?0:0-(o+8)&7;d=(a[1188]|0)+(n-_)|0;a[1191]=o+_;a[1188]=d;a[o+_+4>>2]=d|1;a[o+_+d+4>>2]=40;a[1192]=a[1307];break}if(i>>>0<(a[1189]|0)>>>0)a[1189]=i;t=i+n|0;e=5188;do{if((a[e>>2]|0)==(t|0)){d=153;break}e=a[e+8>>2]|0}while((e|0)!=0);if((d|0)==153)if(!(a[e+12>>2]&8)){a[e>>2]=i;u=e+4|0;a[u>>2]=(a[u>>2]|0)+n;u=i+8|0;u=i+((u&7|0)==0?0:0-u&7)|0;e=t+((t+8&7|0)==0?0:0-(t+8)&7)|0;c=u+l|0;h=e-u-l|0;a[u+4>>2]=l|3;do{if((e|0)==(o|0)){d=(a[1188]|0)+h|0;a[1188]=d;a[1191]=c;a[c+4>>2]=d|1}else{if((e|0)==(a[1190]|0)){d=(a[1187]|0)+h|0;a[1187]=d;a[1190]=c;a[c+4>>2]=d|1;a[c+d>>2]=d;break}o=a[e+4>>2]|0;if((o&3|0)==1){e:do{if(o>>>0<256){t=a[e+8>>2]|0;s=a[e+12>>2]|0;if((s|0)==(t|0)){a[1185]=a[1185]&~(1<<(o>>>3));break}else{a[t+12>>2]=s;a[s+8>>2]=t;break}}else{n=a[e+24>>2]|0;t=a[e+12>>2]|0;do{if((t|0)==(e|0)){t=a[e+16+4>>2]|0;if(!t){t=a[e+16>>2]|0;if(!t){t=0;break}else r=e+16|0}else r=e+16+4|0;while(1){s=t+20|0;i=a[s>>2]|0;if(i|0){t=i;r=s;continue}s=t+16|0;i=a[s>>2]|0;if(!i)break;else{t=i;r=s}}a[r>>2]=0}else{d=a[e+8>>2]|0;a[d+12>>2]=t;a[t+8>>2]=d}}while(0);if(!n)break;s=a[e+28>>2]|0;do{if((e|0)==(a[5044+(s<<2)>>2]|0)){a[5044+(s<<2)>>2]=t;if(t|0)break;a[1186]=a[1186]&~(1<<s);break e}else{a[n+16+(((a[n+16>>2]|0)!=(e|0)&1)<<2)>>2]=t;if(!t)break e}}while(0);a[t+24>>2]=n;s=a[e+16>>2]|0;if(s|0){a[t+16>>2]=s;a[s+24>>2]=t}s=a[e+16+4>>2]|0;if(!s)break;a[t+20>>2]=s;a[s+24>>2]=t}}while(0);e=e+(o&-8)|0;r=(o&-8)+h|0}else r=h;s=e+4|0;a[s>>2]=a[s>>2]&-2;a[c+4>>2]=r|1;a[c+r>>2]=r;s=r>>>3;if(r>>>0<256){e=a[1185]|0;if(!(e&1<<s)){a[1185]=e|1<<s;e=4780+(s<<1<<2)|0;t=4780+(s<<1<<2)+8|0}else{e=a[4780+(s<<1<<2)+8>>2]|0;t=4780+(s<<1<<2)+8|0}a[t>>2]=c;a[e+12>>2]=c;a[c+8>>2]=e;a[c+12>>2]=4780+(s<<1<<2);break}e=r>>>8;do{if(!e)e=0;else{if(r>>>0>16777215){e=31;break}d=e<<((e+1048320|0)>>>16&8)<<(((e<<((e+1048320|0)>>>16&8))+520192|0)>>>16&4);e=14-(((e<<((e+1048320|0)>>>16&8))+520192|0)>>>16&4|(e+1048320|0)>>>16&8|(d+245760|0)>>>16&2)+(d<<((d+245760|0)>>>16&2)>>>15)|0;e=r>>>(e+7|0)&1|e<<1}}while(0);i=5044+(e<<2)|0;a[c+28>>2]=e;a[c+16+4>>2]=0;a[c+16>>2]=0;t=a[1186]|0;s=1<<e;if(!(t&s)){a[1186]=t|s;a[i>>2]=c;a[c+24>>2]=i;a[c+12>>2]=c;a[c+8>>2]=c;break}t=r<<((e|0)==31?0:25-(e>>>1)|0);s=a[i>>2]|0;while(1){if((a[s+4>>2]&-8|0)==(r|0)){d=194;break}i=s+16+(t>>>31<<2)|0;e=a[i>>2]|0;if(!e){d=193;break}else{t=t<<1;s=e}}if((d|0)==193){a[i>>2]=c;a[c+24>>2]=s;a[c+12>>2]=c;a[c+8>>2]=c;break}else if((d|0)==194){l=s+8|0;d=a[l>>2]|0;a[d+12>>2]=c;a[l>>2]=c;a[c+8>>2]=d;a[c+12>>2]=s;a[c+24>>2]=0;break}}}while(0);d=u+8|0;f=p;return d|0}t=5188;while(1){e=a[t>>2]|0;if(e>>>0<=o>>>0){s=e+(a[t+4>>2]|0)|0;if(s>>>0>o>>>0)break}t=a[t+8>>2]|0}r=s+-47+((s+-47+8&7|0)==0?0:0-(s+-47+8)&7)|0;r=r>>>0<(o+16|0)>>>0?o:r;e=i+8|0;e=(e&7|0)==0?0:0-e&7;d=i+e|0;e=n+-40-e|0;a[1191]=d;a[1188]=e;a[d+4>>2]=e|1;a[d+e+4>>2]=40;a[1192]=a[1307];a[r+4>>2]=27;a[r+8>>2]=a[1297];a[r+8+4>>2]=a[1298];a[r+8+8>>2]=a[1299];a[r+8+12>>2]=a[1300];a[1297]=i;a[1298]=n;a[1300]=0;a[1299]=r+8;e=r+24|0;do{d=e;e=e+4|0;a[e>>2]=7}while((d+8|0)>>>0<s>>>0);if((r|0)!=(o|0)){a[r+4>>2]=a[r+4>>2]&-2;a[o+4>>2]=r-o|1;a[r>>2]=r-o;if((r-o|0)>>>0<256){s=4780+((r-o|0)>>>3<<1<<2)|0;e=a[1185]|0;if(!(e&1<<((r-o|0)>>>3))){a[1185]=e|1<<((r-o|0)>>>3);e=s;t=s+8|0}else{e=a[s+8>>2]|0;t=s+8|0}a[t>>2]=o;a[e+12>>2]=o;a[o+8>>2]=e;a[o+12>>2]=s;break}if(!((r-o|0)>>>8))e=0;else if((r-o|0)>>>0>16777215)e=31;else{e=(r-o|0)>>>8<<((((r-o|0)>>>8)+1048320|0)>>>16&8);e=14-((e+520192|0)>>>16&4|(((r-o|0)>>>8)+1048320|0)>>>16&8|((e<<((e+520192|0)>>>16&4))+245760|0)>>>16&2)+(e<<((e+520192|0)>>>16&4)<<(((e<<((e+520192|0)>>>16&4))+245760|0)>>>16&2)>>>15)|0;e=(r-o|0)>>>(e+7|0)&1|e<<1}i=5044+(e<<2)|0;a[o+28>>2]=e;a[o+20>>2]=0;a[o+16>>2]=0;t=a[1186]|0;s=1<<e;if(!(t&s)){a[1186]=t|s;a[i>>2]=o;a[o+24>>2]=i;a[o+12>>2]=o;a[o+8>>2]=o;break}t=r-o<<((e|0)==31?0:25-(e>>>1)|0);s=a[i>>2]|0;while(1){if((a[s+4>>2]&-8|0)==(r-o|0)){d=216;break}i=s+16+(t>>>31<<2)|0;e=a[i>>2]|0;if(!e){d=215;break}else{t=t<<1;s=e}}if((d|0)==215){a[i>>2]=o;a[o+24>>2]=s;a[o+12>>2]=o;a[o+8>>2]=o;break}else if((d|0)==216){_=s+8|0;d=a[_>>2]|0;a[d+12>>2]=o;a[_>>2]=o;a[o+8>>2]=d;a[o+12>>2]=s;a[o+24>>2]=0;break}}}}while(0);e=a[1188]|0;if(e>>>0>l>>>0){u=e-l|0;a[1188]=u;d=a[1191]|0;_=d+l|0;a[1191]=_;a[_+4>>2]=u|1;a[d+4>>2]=l|3;d=d+8|0;f=p;return d|0}}a[(Ie()|0)>>2]=12;d=0;f=p;return d|0}function ke(e){e=e|0;var t=0,s=0,i=0,r=0,n=0,o=0,h=0,c=0;if(!e)return;t=a[1189]|0;s=a[e+-4>>2]|0;c=e+-8+(s&-8)|0;do{if(!(s&1)){i=a[e+-8>>2]|0;if(!(s&3))return;o=e+-8+(0-i)|0;n=i+(s&-8)|0;if(o>>>0<t>>>0)return;if((o|0)==(a[1190]|0)){e=a[c+4>>2]|0;if((e&3|0)!=3){h=o;t=n;break}a[1187]=n;a[c+4>>2]=e&-2;a[o+4>>2]=n|1;a[o+n>>2]=n;return}if(i>>>0<256){e=a[o+8>>2]|0;t=a[o+12>>2]|0;if((t|0)==(e|0)){a[1185]=a[1185]&~(1<<(i>>>3));h=o;t=n;break}else{a[e+12>>2]=t;a[t+8>>2]=e;h=o;t=n;break}}r=a[o+24>>2]|0;e=a[o+12>>2]|0;do{if((e|0)==(o|0)){e=a[o+16+4>>2]|0;if(!e){e=a[o+16>>2]|0;if(!e){e=0;break}else i=o+16|0}else i=o+16+4|0;while(1){t=e+20|0;s=a[t>>2]|0;if(s|0){e=s;i=t;continue}t=e+16|0;s=a[t>>2]|0;if(!s)break;else{e=s;i=t}}a[i>>2]=0}else{h=a[o+8>>2]|0;a[h+12>>2]=e;a[e+8>>2]=h}}while(0);if(!r){h=o;t=n}else{t=a[o+28>>2]|0;if((o|0)==(a[5044+(t<<2)>>2]|0)){a[5044+(t<<2)>>2]=e;if(!e){a[1186]=a[1186]&~(1<<t);h=o;t=n;break}}else{a[r+16+(((a[r+16>>2]|0)!=(o|0)&1)<<2)>>2]=e;if(!e){h=o;t=n;break}}a[e+24>>2]=r;t=a[o+16>>2]|0;if(t|0){a[e+16>>2]=t;a[t+24>>2]=e}t=a[o+16+4>>2]|0;if(!t){h=o;t=n}else{a[e+20>>2]=t;a[t+24>>2]=e;h=o;t=n}}}else{h=e+-8|0;t=s&-8;o=e+-8|0}}while(0);if(o>>>0>=c>>>0)return;s=a[c+4>>2]|0;if(!(s&1))return;if(!(s&2)){e=a[1190]|0;if((c|0)==(a[1191]|0)){c=(a[1188]|0)+t|0;a[1188]=c;a[1191]=h;a[h+4>>2]=c|1;if((h|0)!=(e|0))return;a[1190]=0;a[1187]=0;return}if((c|0)==(e|0)){c=(a[1187]|0)+t|0;a[1187]=c;a[1190]=o;a[h+4>>2]=c|1;a[o+c>>2]=c;return}r=(s&-8)+t|0;do{if(s>>>0<256){t=a[c+8>>2]|0;e=a[c+12>>2]|0;if((e|0)==(t|0)){a[1185]=a[1185]&~(1<<(s>>>3));break}else{a[t+12>>2]=e;a[e+8>>2]=t;break}}else{n=a[c+24>>2]|0;e=a[c+12>>2]|0;do{if((e|0)==(c|0)){e=a[c+16+4>>2]|0;if(!e){e=a[c+16>>2]|0;if(!e){t=0;break}else i=c+16|0}else i=c+16+4|0;while(1){t=e+20|0;s=a[t>>2]|0;if(s|0){e=s;i=t;continue}t=e+16|0;s=a[t>>2]|0;if(!s)break;else{e=s;i=t}}a[i>>2]=0;t=e}else{t=a[c+8>>2]|0;a[t+12>>2]=e;a[e+8>>2]=t;t=e}}while(0);if(n|0){e=a[c+28>>2]|0;if((c|0)==(a[5044+(e<<2)>>2]|0)){a[5044+(e<<2)>>2]=t;if(!t){a[1186]=a[1186]&~(1<<e);break}}else{a[n+16+(((a[n+16>>2]|0)!=(c|0)&1)<<2)>>2]=t;if(!t)break}a[t+24>>2]=n;e=a[c+16>>2]|0;if(e|0){a[t+16>>2]=e;a[e+24>>2]=t}e=a[c+16+4>>2]|0;if(e|0){a[t+20>>2]=e;a[e+24>>2]=t}}}}while(0);a[h+4>>2]=r|1;a[o+r>>2]=r;if((h|0)==(a[1190]|0)){a[1187]=r;return}}else{a[c+4>>2]=s&-2;a[h+4>>2]=t|1;a[o+t>>2]=t;r=t}s=r>>>3;if(r>>>0<256){e=a[1185]|0;if(!(e&1<<s)){a[1185]=e|1<<s;e=4780+(s<<1<<2)|0;t=4780+(s<<1<<2)+8|0}else{e=a[4780+(s<<1<<2)+8>>2]|0;t=4780+(s<<1<<2)+8|0}a[t>>2]=h;a[e+12>>2]=h;a[h+8>>2]=e;a[h+12>>2]=4780+(s<<1<<2);return}e=r>>>8;if(!e)e=0;else if(r>>>0>16777215)e=31;else{c=e<<((e+1048320|0)>>>16&8)<<(((e<<((e+1048320|0)>>>16&8))+520192|0)>>>16&4);e=14-(((e<<((e+1048320|0)>>>16&8))+520192|0)>>>16&4|(e+1048320|0)>>>16&8|(c+245760|0)>>>16&2)+(c<<((c+245760|0)>>>16&2)>>>15)|0;e=r>>>(e+7|0)&1|e<<1}i=5044+(e<<2)|0;a[h+28>>2]=e;a[h+20>>2]=0;a[h+16>>2]=0;t=a[1186]|0;s=1<<e;do{if(!(t&s)){a[1186]=t|s;a[i>>2]=h;a[h+24>>2]=i;a[h+12>>2]=h;a[h+8>>2]=h}else{t=r<<((e|0)==31?0:25-(e>>>1)|0);s=a[i>>2]|0;while(1){if((a[s+4>>2]&-8|0)==(r|0)){e=73;break}i=s+16+(t>>>31<<2)|0;e=a[i>>2]|0;if(!e){e=72;break}else{t=t<<1;s=e}}if((e|0)==72){a[i>>2]=h;a[h+24>>2]=s;a[h+12>>2]=h;a[h+8>>2]=h;break}else if((e|0)==73){o=s+8|0;c=a[o>>2]|0;a[c+12>>2]=h;a[o>>2]=h;a[h+8>>2]=c;a[h+12>>2]=s;a[h+24>>2]=0;break}}}while(0);c=(a[1193]|0)+-1|0;a[1193]=c;if(!c)e=5196;else return;while(1){e=a[e>>2]|0;if(!e)break;else e=e+8|0}a[1193]=-1;return}function ye(){return 5236}function we(e){e=e|0;var t=0;t=f;f=f+16|0;a[t>>2]=Te(a[e+60>>2]|0)|0;e=Ae(q(6,t|0)|0)|0;f=t;return e|0}function Ce(e,t,s){e=e|0;t=t|0;s=s|0;var i=0,r=0,n=0,o=0,h=0,c=0,u=0;h=f;f=f+48|0;i=a[e+28>>2]|0;a[h+32>>2]=i;i=(a[e+20>>2]|0)-i|0;a[h+32+4>>2]=i;a[h+32+8>>2]=t;a[h+32+12>>2]=s;a[h>>2]=a[e+60>>2];a[h+4>>2]=h+32;a[h+8>>2]=2;r=Ae(G(146,h|0)|0)|0;e:do{if((i+s|0)==(r|0))o=3;else{t=2;n=i+s|0;i=h+32|0;while(1){if((r|0)<0)break;n=n-r|0;c=a[i+4>>2]|0;u=r>>>0>c>>>0;i=u?i+8|0:i;t=(u<<31>>31)+t|0;c=r-(u?c:0)|0;a[i>>2]=(a[i>>2]|0)+c;a[i+4>>2]=(a[i+4>>2]|0)-c;a[h+16>>2]=a[e+60>>2];a[h+16+4>>2]=i;a[h+16+8>>2]=t;r=Ae(G(146,h+16|0)|0)|0;if((n|0)==(r|0)){o=3;break e}}a[e+16>>2]=0;a[e+28>>2]=0;a[e+20>>2]=0;a[e>>2]=a[e>>2]|32;if((t|0)==2)s=0;else s=s-(a[i+4>>2]|0)|0}}while(0);if((o|0)==3){u=a[e+44>>2]|0;a[e+16>>2]=u+(a[e+48>>2]|0);a[e+28>>2]=u;a[e+20>>2]=u}f=h;return s|0}function ve(e,t,s){e=e|0;t=t|0;s=s|0;var i=0;i=f;f=f+32|0;a[i>>2]=a[e+60>>2];a[i+4>>2]=0;a[i+8>>2]=t;a[i+12>>2]=i+20;a[i+16>>2]=s;if((Ae(Z(140,i|0)|0)|0)<0){a[i+20>>2]=-1;e=-1}else e=a[i+20>>2]|0;f=i;return e|0}function Ae(e){e=e|0;if(e>>>0>4294963200){a[(Ie()|0)>>2]=0-e;e=-1}return e|0}function Ie(){return(Se()|0)+64|0}function Se(){return Me()|0}function Me(){return 136}function Te(e){e=e|0;return e|0}function Pe(e,t){e=e|0;t=t|0;var s=0,r=0;s=i[e>>0]|0;r=i[t>>0]|0;if(s<<24>>24==0?1:s<<24>>24!=r<<24>>24)e=r;else{do{e=e+1|0;t=t+1|0;s=i[e>>0]|0;r=i[t>>0]|0}while(!(s<<24>>24==0?1:s<<24>>24!=r<<24>>24));e=r}return(s&255)-(e&255)|0}function Ee(e,t,s,i){e=e|0;t=t|0;s=s|0;i=i|0;var r=0;r=L(s,t)|0;s=(t|0)==0?0:s;if((a[i+76>>2]|0)>-1){e=Be(e,r,i)|0}else e=Be(e,r,i)|0;if((e|0)!=(r|0))s=(e>>>0)/(t>>>0)|0;return s|0}function xe(e,t){e=e|0;t=t|0;var s=0,r=0,o=0,h=0;h=f;f=f+16|0;i[h>>0]=t;s=a[e+16>>2]|0;if(!s)if(!(Re(e)|0)){r=a[e+16>>2]|0;o=4}else s=-1;else{r=s;o=4}do{if((o|0)==4){s=a[e+20>>2]|0;if(s>>>0<r>>>0)if((t&255|0)!=(i[e+75>>0]|0)){a[e+20>>2]=s+1;i[s>>0]=t;s=t&255;break}if((It[a[e+36>>2]&3](e,h,1)|0)==1)s=n[h>>0]|0;else s=-1}}while(0);f=h;return s|0}function Re(e){e=e|0;var t=0;t=i[e+74>>0]|0;i[e+74>>0]=t+255|t;t=a[e>>2]|0;if(!(t&8)){a[e+8>>2]=0;a[e+4>>2]=0;t=a[e+44>>2]|0;a[e+28>>2]=t;a[e+20>>2]=t;a[e+16>>2]=t+(a[e+48>>2]|0);e=0}else{a[e>>2]=t|32;e=-1}return e|0}function Be(e,t,s){e=e|0;t=t|0;s=s|0;var r=0,n=0,o=0,h=0;r=a[s+16>>2]|0;if(!r)if(!(Re(s)|0)){n=a[s+16>>2]|0;o=5}else r=0;else{n=r;o=5}e:do{if((o|0)==5){r=a[s+20>>2]|0;if((n-r|0)>>>0<t>>>0){r=It[a[s+36>>2]&3](s,e,t)|0;break}t:do{if((i[s+75>>0]|0)>-1){o=t;while(1){if(!o){h=0;n=e;break t}n=o+-1|0;if((i[e+n>>0]|0)==10)break;else o=n}r=It[a[s+36>>2]&3](s,e,o)|0;if(r>>>0<o>>>0)break e;h=o;n=e+o|0;t=t-o|0;r=a[s+20>>2]|0}else{h=0;n=e}}while(0);lt(r|0,n|0,t|0)|0;a[s+20>>2]=(a[s+20>>2]|0)+t;r=h+t|0}}while(0);return r|0}function Oe(e,t){e=e|0;t=t|0;if(!t)t=0;else t=Fe(a[t>>2]|0,a[t+4>>2]|0,e)|0;return(t|0?t:e)|0}function Fe(e,t,s){e=e|0;t=t|0;s=s|0;var r=0,n=0,o=0,h=0,c=0,u=0,_=0,l=0,d=0;d=(a[e>>2]|0)+1794895138|0;r=Le(a[e+8>>2]|0,d)|0;u=Le(a[e+12>>2]|0,d)|0;l=Le(a[e+16>>2]|0,d)|0;e:do{if(r>>>0<t>>>2>>>0)if(u>>>0<(t-(r<<2)|0)>>>0&l>>>0<(t-(r<<2)|0)>>>0)if(!((l|u)&3)){c=0;while(1){h=r>>>1;_=c+h|0;n=Le(a[e+((_<<1)+(u>>>2)<<2)>>2]|0,d)|0;o=Le(a[e+((_<<1)+(u>>>2)+1<<2)>>2]|0,d)|0;if(!(o>>>0<t>>>0&n>>>0<(t-o|0)>>>0)){r=0;break e}if(i[e+(o+n)>>0]|0){r=0;break e}n=Pe(s,e+o|0)|0;if(!n)break;if((r|0)==1){r=0;break e}else{c=(n|0)<0?c:_;r=(n|0)<0?h:r-h|0}}n=Le(a[e+((_<<1)+(l>>>2)<<2)>>2]|0,d)|0;r=Le(a[e+((_<<1)+(l>>>2)+1<<2)>>2]|0,d)|0;if(r>>>0<t>>>0&n>>>0<(t-r|0)>>>0)r=(i[e+(r+n)>>0]|0)==0?e+r|0:0;else r=0}else r=0;else r=0;else r=0}while(0);return r|0}function Le(e,t){e=e|0;t=t|0;var s=0;s=bt(e|0)|0;return((t|0)==0?e:s)|0}function De(e,t,s){e=e|0;t=t|0;s=s|0;var r=0,n=0,o=0;e:do{if((s|0)!=0&(e&3|0)!=0){r=e;e=s;while(1){if((i[r>>0]|0)==(t&255)<<24>>24){n=6;break e}r=r+1|0;s=e+-1|0;if((s|0)!=0&(r&3|0)!=0)e=s;else{e=s;s=(s|0)!=0;n=5;break}}}else{r=e;e=s;s=(s|0)!=0;n=5}}while(0);if((n|0)==5)if(s)n=6;else e=0;e:do{if((n|0)==6)if((i[r>>0]|0)!=(t&255)<<24>>24){s=L(t&255,16843009)|0;t:do{if(e>>>0>3)while(1){o=a[r>>2]^s;if((o&-2139062144^-2139062144)&o+-16843009|0)break;r=r+4|0;e=e+-4|0;if(e>>>0<=3){n=11;break t}}else n=11}while(0);if((n|0)==11)if(!e){e=0;break}while(1){if((i[r>>0]|0)==(t&255)<<24>>24)break e;r=r+1|0;e=e+-1|0;if(!e){e=0;break}}}}while(0);return(e|0?r:0)|0}function Ne(e,t,s){e=e|0;t=t|0;s=s|0;var i=0;i=f;f=f+16|0;a[i>>2]=s;s=He(e,t,i)|0;f=i;return s|0}function He(e,t,s){e=e|0;t=t|0;s=s|0;var r=0,n=0,o=0;o=f;f=f+224|0;r=o+80|0;n=r+40|0;do{a[r>>2]=0;r=r+4|0}while((r|0)<(n|0));a[o+120>>2]=a[s>>2];if((Ue(0,t,o+120|0,o,o+80|0)|0)<0)s=-1;else{n=a[e>>2]|0;if((i[e+74>>0]|0)<1)a[e>>2]=n&-33;if(!(a[e+48>>2]|0)){r=a[e+44>>2]|0;a[e+44>>2]=o+136;a[e+28>>2]=o+136;a[e+20>>2]=o+136;a[e+48>>2]=80;a[e+16>>2]=o+136+80;s=Ue(e,t,o+120|0,o,o+80|0)|0;if(r){It[a[e+36>>2]&3](e,0,0)|0;s=(a[e+20>>2]|0)==0?-1:s;a[e+44>>2]=r;a[e+48>>2]=0;a[e+16>>2]=0;a[e+28>>2]=0;a[e+20>>2]=0}}else s=Ue(e,t,o+120|0,o,o+80|0)|0;r=a[e>>2]|0;a[e>>2]=r|n&32;s=(r&32|0)==0?s:-1}f=o;return s|0}function Ue(e,t,s,n,o){e=e|0;t=t|0;s=s|0;n=n|0;o=o|0;var h=0,c=0,_=0,l=0,d=0,p=0,m=0,g=0,b=0,k=0,y=0,C=0,v=0,A=0,I=0;A=f;f=f+64|0;a[A+16>>2]=t;v=A+24+40|0;c=0;h=0;p=0;e:while(1){do{if((h|0)>-1)if((c|0)>(2147483647-h|0)){a[(Ie()|0)>>2]=75;h=-1;break}else{h=c+h|0;break}}while(0);c=i[t>>0]|0;if(!(c<<24>>24)){C=87;break}else _=t;t:while(1){switch(c<<24>>24){case 37:{c=_;C=9;break t}case 0:{c=_;break t}}y=_+1|0;a[A+16>>2]=y;c=i[y>>0]|0;_=y}t:do{if((C|0)==9)while(1){C=0;if((i[_+1>>0]|0)!=37)break t;c=c+1|0;_=_+2|0;a[A+16>>2]=_;if((i[_>>0]|0)==37)C=9;else break}}while(0);c=c-t|0;if(e|0)je(e,t,c);if(c|0){t=_;continue}l=_+1|0;c=(i[l>>0]|0)+-48|0;if(c>>>0<10){y=(i[_+2>>0]|0)==36;b=y?c:-1;p=y?1:p;l=y?_+3|0:l}else b=-1;a[A+16>>2]=l;c=i[l>>0]|0;t:do{if(((c<<24>>24)+-32|0)>>>0<32){_=0;m=c;d=(c<<24>>24)+-32|0;while(1){c=1<<d;if(!(c&75913)){c=m;break t}_=c|_;l=l+1|0;a[A+16>>2]=l;c=i[l>>0]|0;d=(c<<24>>24)+-32|0;if(d>>>0>=32)break;else m=c}}else _=0}while(0);if(c<<24>>24==42){d=l+1|0;c=(i[d>>0]|0)+-48|0;if(c>>>0<10)if((i[l+2>>0]|0)==36){a[o+(c<<2)>>2]=10;c=a[n+((i[d>>0]|0)+-48<<3)>>2]|0;p=1;l=l+3|0}else C=23;else C=23;if((C|0)==23){C=0;if(p|0){h=-1;break}if(e|0){p=(a[s>>2]|0)+(4-1)&~(4-1);c=a[p>>2]|0;a[s>>2]=p+4;p=0;l=d}else{c=0;p=0;l=d}}a[A+16>>2]=l;k=(c|0)<0;c=k?0-c|0:c;k=k?_|8192:_}else{c=Ve(A+16|0)|0;if((c|0)<0){h=-1;break}k=_;l=a[A+16>>2]|0}do{if((i[l>>0]|0)==46){if((i[l+1>>0]|0)!=42){a[A+16>>2]=l+1;_=Ve(A+16|0)|0;l=a[A+16>>2]|0;break}d=l+2|0;_=(i[d>>0]|0)+-48|0;if(_>>>0<10)if((i[l+3>>0]|0)==36){a[o+(_<<2)>>2]=10;_=a[n+((i[d>>0]|0)+-48<<3)>>2]|0;l=l+4|0;a[A+16>>2]=l;break}if(p|0){h=-1;break e}if(e|0){y=(a[s>>2]|0)+(4-1)&~(4-1);_=a[y>>2]|0;a[s>>2]=y+4}else _=0;a[A+16>>2]=d;l=d}else _=-1}while(0);g=0;while(1){if(((i[l>>0]|0)+-65|0)>>>0>57){h=-1;break e}y=l+1|0;a[A+16>>2]=y;d=i[(i[l>>0]|0)+-65+(2221+(g*58|0))>>0]|0;if(((d&255)+-1|0)>>>0<8){g=d&255;l=y}else break}if(!(d<<24>>24)){h=-1;break}m=(b|0)>-1;do{if(d<<24>>24==19)if(m){h=-1;break e}else C=49;else{if(m){a[o+(b<<2)>>2]=d&255;b=n+(b<<3)|0;C=a[b+4>>2]|0;a[A>>2]=a[b>>2];a[A+4>>2]=C;C=49;break}if(!e){h=0;break e}We(A,d&255,s)}}while(0);if((C|0)==49){C=0;if(!e){c=0;t=y;continue}}l=i[l>>0]|0;l=(g|0)!=0&(l&15|0)==3?l&-33:l;b=k&-65537;k=(k&8192|0)==0?k:b;t:do{switch(l|0){case 110:switch((g&255)<<24>>24){case 0:{a[a[A>>2]>>2]=h;c=0;t=y;continue e}case 1:{a[a[A>>2]>>2]=h;c=0;t=y;continue e}case 2:{c=a[A>>2]|0;a[c>>2]=h;a[c+4>>2]=((h|0)<0)<<31>>31;c=0;t=y;continue e}case 3:{r[a[A>>2]>>1]=h;c=0;t=y;continue e}case 4:{i[a[A>>2]>>0]=h;c=0;t=y;continue e}case 6:{a[a[A>>2]>>2]=h;c=0;t=y;continue e}case 7:{c=a[A>>2]|0;a[c>>2]=h;a[c+4>>2]=((h|0)<0)<<31>>31;c=0;t=y;continue e}default:{c=0;t=y;continue e}}case 112:{l=120;_=_>>>0>8?_:8;t=k|8;C=61;break}case 88:case 120:{t=k;C=61;break}case 111:{t=a[A>>2]|0;l=a[A+4>>2]|0;b=Qe(t,l,v)|0;g=b;d=0;m=2685;_=(k&8|0)==0|(_|0)>(v-b|0)?_:v-b+1|0;b=k;C=67;break}case 105:case 100:{t=a[A>>2]|0;l=a[A+4>>2]|0;if((l|0)<0){t=ot(0,0,t|0,l|0)|0;l=w;a[A>>2]=t;a[A+4>>2]=l;d=1;m=2685;C=66;break t}else{d=(k&2049|0)!=0&1;m=(k&2048|0)==0?(k&1|0)==0?2685:2687:2686;C=66;break t}}case 117:{d=0;m=2685;t=a[A>>2]|0;l=a[A+4>>2]|0;C=66;break}case 99:{i[A+24+39>>0]=a[A>>2];t=A+24+39|0;d=0;m=2685;g=v;l=1;_=b;break}case 109:{l=$e(a[(Ie()|0)>>2]|0)|0;C=71;break}case 115:{l=a[A>>2]|0;l=l|0?l:2695;C=71;break}case 67:{a[A+8>>2]=a[A>>2];a[A+8+4>>2]=0;a[A>>2]=A+8;g=-1;l=A+8|0;C=75;break}case 83:{t=a[A>>2]|0;if(!_){qe(e,32,c,0,k);t=0;C=84}else{g=_;l=t;C=75}break}case 65:case 71:case 70:case 69:case 97:case 103:case 102:case 101:{c=Ge(e,+u[A>>3],c,_,k,l)|0;t=y;continue e}default:{d=0;m=2685;g=v;l=_;_=k}}}while(0);t:do{if((C|0)==61){I=a[A>>2]|0;k=a[A+4>>2]|0;g=ze(I,k,v,l&32)|0;m=(t&8|0)==0|(I|0)==0&(k|0)==0;d=m?0:2;m=m?2685:2685+(l>>4)|0;b=t;t=I;l=k;C=67}else if((C|0)==66){g=Ye(t,l,v)|0;b=k;C=67}else if((C|0)==71){C=0;I=De(l,0,_)|0;t=l;d=0;m=2685;g=(I|0)==0?l+_|0:I;l=(I|0)==0?_:I-l|0;_=b}else if((C|0)==75){C=0;m=l;t=0;_=0;while(1){d=a[m>>2]|0;if(!d)break;_=Ke(A+20|0,d)|0;if((_|0)<0|_>>>0>(g-t|0)>>>0)break;t=_+t|0;if(g>>>0>t>>>0)m=m+4|0;else break}if((_|0)<0){h=-1;break e}qe(e,32,c,t,k);if(!t){t=0;C=84}else{d=0;while(1){_=a[l>>2]|0;if(!_){C=84;break t}_=Ke(A+20|0,_)|0;d=_+d|0;if((d|0)>(t|0)){C=84;break t}je(e,A+20|0,_);if(d>>>0>=t>>>0){C=84;break}else l=l+4|0}}}}while(0);if((C|0)==67){C=0;l=(t|0)!=0|(l|0)!=0;I=(_|0)!=0|l;l=((l^1)&1)+(v-g)|0;t=I?g:v;g=v;l=I?(_|0)>(l|0)?_:l:_;_=(_|0)>-1?b&-65537:b}else if((C|0)==84){C=0;qe(e,32,c,t,k^8192);c=(c|0)>(t|0)?c:t;t=y;continue}k=g-t|0;b=(l|0)<(k|0)?k:l;I=b+d|0;c=(c|0)<(I|0)?I:c;qe(e,32,c,I,_);je(e,m,d);qe(e,48,c,I,_^65536);qe(e,48,b,k,0);je(e,t,k);qe(e,32,c,I,_^8192);t=y}e:do{if((C|0)==87)if(!e)if(!p)h=0;else{h=1;while(1){t=a[o+(h<<2)>>2]|0;if(!t)break;We(n+(h<<3)|0,t,s);h=h+1|0;if((h|0)>=10){h=1;break e}}while(1){if(a[o+(h<<2)>>2]|0){h=-1;break e}h=h+1|0;if((h|0)>=10){h=1;break}}}}while(0);f=A;return h|0}function je(e,t,s){e=e|0;t=t|0;s=s|0;if(!(a[e>>2]&32))Be(t,s,e)|0;return}function Ve(e){e=e|0;var t=0,s=0,r=0;s=a[e>>2]|0;r=(i[s>>0]|0)+-48|0;if(r>>>0<10){t=0;do{t=r+(t*10|0)|0;s=s+1|0;a[e>>2]=s;r=(i[s>>0]|0)+-48|0}while(r>>>0<10)}else t=0;return t|0}function We(e,t,s){e=e|0;t=t|0;s=s|0;var i=0,r=0,n=0.0;e:do{if(t>>>0<=20)do{switch(t|0){case 9:{i=(a[s>>2]|0)+(4-1)&~(4-1);t=a[i>>2]|0;a[s>>2]=i+4;a[e>>2]=t;break e}case 10:{t=(a[s>>2]|0)+(4-1)&~(4-1);i=a[t>>2]|0;a[s>>2]=t+4;a[e>>2]=i;a[e+4>>2]=((i|0)<0)<<31>>31;break e}case 11:{t=(a[s>>2]|0)+(4-1)&~(4-1);i=a[t>>2]|0;a[s>>2]=t+4;a[e>>2]=i;a[e+4>>2]=0;break e}case 12:{r=(a[s>>2]|0)+(8-1)&~(8-1);t=a[r>>2]|0;i=a[r+4>>2]|0;a[s>>2]=r+8;a[e>>2]=t;a[e+4>>2]=i;break e}case 13:{i=(a[s>>2]|0)+(4-1)&~(4-1);r=a[i>>2]|0;a[s>>2]=i+4;a[e>>2]=(r&65535)<<16>>16;a[e+4>>2]=(((r&65535)<<16>>16|0)<0)<<31>>31;break e}case 14:{i=(a[s>>2]|0)+(4-1)&~(4-1);r=a[i>>2]|0;a[s>>2]=i+4;a[e>>2]=r&65535;a[e+4>>2]=0;break e}case 15:{i=(a[s>>2]|0)+(4-1)&~(4-1);r=a[i>>2]|0;a[s>>2]=i+4;a[e>>2]=(r&255)<<24>>24;a[e+4>>2]=(((r&255)<<24>>24|0)<0)<<31>>31;break e}case 16:{i=(a[s>>2]|0)+(4-1)&~(4-1);r=a[i>>2]|0;a[s>>2]=i+4;a[e>>2]=r&255;a[e+4>>2]=0;break e}case 17:{r=(a[s>>2]|0)+(8-1)&~(8-1);n=+u[r>>3];a[s>>2]=r+8;u[e>>3]=n;break e}case 18:{r=(a[s>>2]|0)+(8-1)&~(8-1);n=+u[r>>3];a[s>>2]=r+8;u[e>>3]=n;break e}default:break e}}while(0)}while(0);return}function ze(e,t,s,r){e=e|0;t=t|0;s=s|0;r=r|0;if(!((e|0)==0&(t|0)==0))do{s=s+-1|0;i[s>>0]=n[2737+(e&15)>>0]|0|r;e=ut(e|0,t|0,4)|0;t=w}while(!((e|0)==0&(t|0)==0));return s|0}function Qe(e,t,s){e=e|0;t=t|0;s=s|0;if(!((e|0)==0&(t|0)==0))do{s=s+-1|0;i[s>>0]=e&7|48;e=ut(e|0,t|0,3)|0;t=w}while(!((e|0)==0&(t|0)==0));return s|0}function Ye(e,t,s){e=e|0;t=t|0;s=s|0;var r=0;if(t>>>0>0|(t|0)==0&e>>>0>4294967295){while(1){r=gt(e|0,t|0,10,0)|0;s=s+-1|0;i[s>>0]=r&255|48;r=e;e=pt(e|0,t|0,10,0)|0;if(!(t>>>0>9|(t|0)==9&r>>>0>4294967295))break;else t=w}t=e}else t=e;if(t)while(1){s=s+-1|0;i[s>>0]=(t>>>0)%10|0|48;if(t>>>0<10)break;else t=(t>>>0)/10|0}return s|0}function $e(e){e=e|0;return it(e,a[(st()|0)+188>>2]|0)|0}function qe(e,t,s,i,r){e=e|0;t=t|0;s=s|0;i=i|0;r=r|0;var a=0;a=f;f=f+256|0;if((s|0)>(i|0)&(r&73728|0)==0){ct(a|0,t|0,((s-i|0)>>>0<256?s-i|0:256)|0)|0;if((s-i|0)>>>0>255){t=s-i|0;do{je(e,a,256);t=t+-256|0}while(t>>>0>255);t=s-i&255}else t=s-i|0;je(e,a,t)}f=a;return}function Ke(e,t){e=e|0;t=t|0;if(!e)e=0;else e=et(e,t)|0;return e|0}function Ge(e,t,s,r,o,h){e=e|0;t=+t;s=s|0;r=r|0;o=o|0;h=h|0;var c=0,u=0,_=0,l=0,d=0,p=0.0,m=0,g=0,b=0,k=0,y=0,C=0,v=0,A=0,I=0,S=0,M=0,T=0;T=f;f=f+560|0;M=T+524|0;a[T>>2]=0;S=T+512+12|0;Je(t)|0;if((w|0)<0){t=-t;A=1;v=2702}else{A=(o&2049|0)!=0&1;v=(o&2048|0)==0?(o&1|0)==0?2703:2708:2705}Je(t)|0;I=w&2146435072;do{if(I>>>0<2146435072|(I|0)==2146435072&0<0){p=+Ze(t,T)*2.0;if(p!=0.0)a[T>>2]=(a[T>>2]|0)+-1;if((h|32|0)==97){d=(h&32|0)==0?v:v+9|0;l=A|2;do{if(r>>>0>11|(12-r|0)==0)t=p;else{t=8.0;c=12-r|0;do{c=c+-1|0;t=t*16.0}while((c|0)!=0);if((i[d>>0]|0)==45){t=-(t+(-p-t));break}else{t=p+t-t;break}}}while(0);u=a[T>>2]|0;c=(u|0)<0?0-u|0:u;c=Ye(c,((c|0)<0)<<31>>31,S)|0;if((c|0)==(S|0)){i[T+512+11>>0]=48;c=T+512+11|0}i[c+-1>>0]=(u>>31&2)+43;_=c+-2|0;i[_>>0]=h+15;c=T+524|0;do{I=~~t;u=c+1|0;i[c>>0]=n[2737+I>>0]|h&32;t=(t-+(I|0))*16.0;if((u-M|0)==1)if((o&8|0)==0&((r|0)<1&t==0.0))c=u;else{i[u>>0]=46;c=c+2|0}else c=u}while(t!=0.0);M=c-M|0;c=(r|0)!=0&(M+-2|0)<(r|0)?r+2|0:M;qe(e,32,s,S-_+l+c|0,o);je(e,d,l);qe(e,48,s,S-_+l+c|0,o^65536);je(e,T+524|0,M);qe(e,48,c-M|0,0,0);je(e,_,S-_|0);qe(e,32,s,S-_+l+c|0,o^8192);c=S-_+l+c|0;break}u=(r|0)<0?6:r;if(p!=0.0){l=(a[T>>2]|0)+-28|0;a[T>>2]=l;t=p*268435456.0}else{t=p;l=a[T>>2]|0}I=(l|0)<0?T+8|0:T+8+288|0;c=I;do{C=~~t>>>0;a[c>>2]=C;c=c+4|0;t=(t-+(C>>>0))*1.0e9}while(t!=0.0);if((l|0)>0){_=I;do{r=(l|0)<29?l:29;l=c+-4|0;if(l>>>0>=_>>>0){d=0;do{y=_t(a[l>>2]|0,0,r|0)|0;y=ht(y|0,w|0,d|0,0)|0;C=w;k=gt(y|0,C|0,1e9,0)|0;a[l>>2]=k;d=pt(y|0,C|0,1e9,0)|0;l=l+-4|0}while(l>>>0>=_>>>0);if(d){_=_+-4|0;a[_>>2]=d}}while(1){if(c>>>0<=_>>>0)break;l=c+-4|0;if(!(a[l>>2]|0))c=l;else break}l=(a[T>>2]|0)-r|0;a[T>>2]=l}while((l|0)>0)}else _=I;if((l|0)<0)do{r=0-l|0;r=(r|0)<9?r:9;if(_>>>0<c>>>0){d=0;l=_;do{C=a[l>>2]|0;a[l>>2]=(C>>>r)+d;d=L(C&(1<<r)+-1,1e9>>>r)|0;l=l+4|0}while(l>>>0<c>>>0);_=(a[_>>2]|0)==0?_+4|0:_;if(d){a[c>>2]=d;c=c+4|0}}else _=(a[_>>2]|0)==0?_+4|0:_;l=(h|32|0)==102?I:_;c=(c-l>>2|0)>(((u+25|0)/9|0)+1|0)?l+(((u+25|0)/9|0)+1<<2)|0:c;l=(a[T>>2]|0)+r|0;a[T>>2]=l}while((l|0)<0);if(_>>>0<c>>>0){l=(I-_>>2)*9|0;r=a[_>>2]|0;if(r>>>0<10)b=l;else{d=10;do{d=d*10|0;l=l+1|0}while(r>>>0>=d>>>0);b=l}}else b=0;d=u-((h|32|0)!=102?b:0)+(((u|0)!=0&(h|32|0)==103)<<31>>31)|0;if((d|0)<(((c-I>>2)*9|0)+-9|0)){l=I+4+(((d+9216|0)/9|0)+-1024<<2)|0;if((((d+9216|0)%9|0)+1|0)<9){r=((d+9216|0)%9|0)+1|0;d=10;do{d=d*10|0;r=r+1|0}while((r|0)!=9)}else d=10;m=a[l>>2]|0;g=(m>>>0)%(d>>>0)|0;r=(l+4|0)==(c|0);if(r&(g|0)==0)d=b;else{p=(((m>>>0)/(d>>>0)|0)&1|0)==0?9007199254740992.0:9007199254740994.0;C=(d|0)/2|0;t=g>>>0<C>>>0?.5:r&(g|0)==(C|0)?1.0:1.5;if(A){C=(i[v>>0]|0)==45;t=C?-t:t;p=C?-p:p}a[l>>2]=m-g;if(p+t!=p){C=m-g+d|0;a[l>>2]=C;if(C>>>0>999999999)while(1){d=l+-4|0;a[l>>2]=0;if(d>>>0<_>>>0){_=_+-4|0;a[_>>2]=0}C=(a[d>>2]|0)+1|0;a[d>>2]=C;if(C>>>0>999999999)l=d;else{l=d;break}}d=(I-_>>2)*9|0;m=a[_>>2]|0;if(m>>>0>=10){r=10;do{r=r*10|0;d=d+1|0}while(m>>>0>=r>>>0)}}else d=b}y=l+4|0;c=c>>>0>y>>>0?y:c;y=_}else{d=b;y=_}C=c;while(1){if(C>>>0<=y>>>0){k=0;break}c=C+-4|0;if(!(a[c>>2]|0))C=c;else{k=1;break}}m=0-d|0;do{if((h|32|0)==103){if((d|0)>-5?((((u|0)!=0^1)&1)+u|0)>(d|0):0){r=h+-1|0;u=(((u|0)!=0^1)&1)+u+-1-d|0}else{r=h+-2|0;u=(((u|0)!=0^1)&1)+u+-1|0}if(!(o&8)){if(k){l=a[C+-4>>2]|0;if(!l)c=9;else if(!((l>>>0)%10|0)){c=0;_=10;do{_=_*10|0;c=c+1|0}while(!((l>>>0)%(_>>>0)|0|0))}else c=0}else c=9;_=((C-I>>2)*9|0)+-9|0;if((r|32|0)==102){l=_-c|0;l=(l|0)>0?l:0;u=(u|0)<(l|0)?u:l;l=0;break}else{l=_+d-c|0;l=(l|0)>0?l:0;u=(u|0)<(l|0)?u:l;l=0;break}}else l=o&8}else{r=h;l=o&8}}while(0);b=u|l;_=(r|32|0)==102;if(_){g=0;c=(d|0)>0?d:0}else{c=(d|0)<0?m:d;c=Ye(c,((c|0)<0)<<31>>31,S)|0;if((S-c|0)<2)do{c=c+-1|0;i[c>>0]=48}while((S-c|0)<2);i[c+-1>>0]=(d>>31&2)+43;c=c+-2|0;i[c>>0]=r;g=c;c=S-c|0}c=A+1+u+((b|0)!=0&1)+c|0;qe(e,32,s,c,o);je(e,v,A);qe(e,48,s,c,o^65536);if(_){d=y>>>0>I>>>0?I:y;l=d;do{_=Ye(a[l>>2]|0,0,T+524+9|0)|0;if((l|0)==(d|0)){if((_|0)==(T+524+9|0)){i[T+524+8>>0]=48;_=T+524+8|0}}else if(_>>>0>(T+524|0)>>>0){ct(T+524|0,48,_-M|0)|0;do{_=_+-1|0}while(_>>>0>(T+524|0)>>>0)}je(e,_,T+524+9-_|0);l=l+4|0}while(l>>>0<=I>>>0);if(b|0)je(e,2753,1);if(l>>>0<C>>>0&(u|0)>0)while(1){_=Ye(a[l>>2]|0,0,T+524+9|0)|0;if(_>>>0>(T+524|0)>>>0){ct(T+524|0,48,_-M|0)|0;do{_=_+-1|0}while(_>>>0>(T+524|0)>>>0)}je(e,_,(u|0)<9?u:9);l=l+4|0;_=u+-9|0;if(!(l>>>0<C>>>0&(u|0)>9)){u=_;break}else u=_}qe(e,48,u+9|0,9,0)}else{m=k?C:y+4|0;if((u|0)>-1){r=(l|0)==0;d=y;do{_=Ye(a[d>>2]|0,0,T+524+9|0)|0;if((_|0)==(T+524+9|0)){i[T+524+8>>0]=48;_=T+524+8|0}do{if((d|0)==(y|0)){l=_+1|0;je(e,_,1);if(r&(u|0)<1){_=l;break}je(e,2753,1);_=l}else{if(_>>>0<=(T+524|0)>>>0)break;ct(T+524|0,48,_+(0-M)|0)|0;do{_=_+-1|0}while(_>>>0>(T+524|0)>>>0)}}while(0);I=T+524+9-_|0;je(e,_,(u|0)>(I|0)?I:u);u=u-I|0;d=d+4|0}while(d>>>0<m>>>0&(u|0)>-1)}qe(e,48,u+18|0,18,0);je(e,g,S-g|0)}qe(e,32,s,c,o^8192)}else{c=A+3|0;qe(e,32,s,c,o&-65537);je(e,v,A);je(e,t!=t|0.0!=0.0?h&32|0?2729:2733:h&32|0?2721:2725,3);qe(e,32,s,c,o^8192)}}while(0);f=T;return((c|0)<(s|0)?s:c)|0}function Je(e){e=+e;var t=0;u[l>>3]=e;t=a[l>>2]|0;w=a[l+4>>2]|0;return t|0}function Ze(e,t){e=+e;t=t|0;return+ +Xe(e,t)}function Xe(e,t){e=+e;t=t|0;var s=0,i=0,r=0;u[l>>3]=e;s=a[l>>2]|0;i=a[l+4>>2]|0;r=ut(s|0,i|0,52)|0;switch(r&2047){case 0:{if(e!=0.0){e=+Xe(e*18446744073709551616.0,t);s=(a[t>>2]|0)+-64|0}else s=0;a[t>>2]=s;break}case 2047:break;default:{a[t>>2]=(r&2047)+-1022;a[l>>2]=s;a[l+4>>2]=i&-2146435073|1071644672;e=+u[l>>3]}}return+e}function et(e,t,s){e=e|0;t=t|0;do{if(!e)e=1;else{if(t>>>0<128){i[e>>0]=t;e=1;break}if(!(a[a[(tt()|0)+188>>2]>>2]|0))if((t&-128|0)==57216){i[e>>0]=t;e=1;break}else{a[(Ie()|0)>>2]=84;e=-1;break}if(t>>>0<2048){i[e>>0]=t>>>6|192;i[e+1>>0]=t&63|128;e=2;break}if(t>>>0<55296|(t&-8192|0)==57344){i[e>>0]=t>>>12|224;i[e+1>>0]=t>>>6&63|128;i[e+2>>0]=t&63|128;e=3;break}if((t+-65536|0)>>>0<1048576){i[e>>0]=t>>>18|240;i[e+1>>0]=t>>>12&63|128;i[e+2>>0]=t>>>6&63|128;i[e+3>>0]=t&63|128;e=4;break}else{a[(Ie()|0)>>2]=84;e=-1;break}}}while(0);return e|0}function tt(){return Me()|0}function st(){return Me()|0}function it(e,t){e=e|0;t=t|0;var s=0,r=0;r=0;while(1){if((n[2755+r>>0]|0)==(e|0)){e=2;break}s=r+1|0;if((s|0)==87){s=2843;r=87;e=5;break}else r=s}if((e|0)==2)if(!r)s=2843;else{s=2843;e=5}if((e|0)==5)while(1){do{e=s;s=s+1|0}while((i[e>>0]|0)!=0);r=r+-1|0;if(!r)break;else e=5}return rt(s,a[t+20>>2]|0)|0}function rt(e,t){e=e|0;t=t|0;return Oe(e,t)|0}function at(e,t){e=e|0;t=t|0;var s=0,r=0;if((a[t+76>>2]|0)<0)r=3;else r=3;do{if((r|0)==3){if((e&255|0)!=(i[t+75>>0]|0)){s=a[t+20>>2]|0;if(s>>>0<(a[t+16>>2]|0)>>>0){a[t+20>>2]=s+1;i[s>>0]=e;s=e&255;break}}s=xe(t,e)|0}}while(0);return s|0}function nt(){}function ot(e,t,s,i){e=e|0;t=t|0;s=s|0;i=i|0;i=t-i-(s>>>0>e>>>0|0)>>>0;return(w=i,e-s>>>0|0)|0}function ht(e,t,s,i){e=e|0;t=t|0;s=s|0;i=i|0;return(w=t+i+(e+s>>>0>>>0<e>>>0|0)>>>0,e+s>>>0|0)|0}function ct(e,t,s){e=e|0;t=t|0;s=s|0;var r=0,n=0;r=e+s|0;t=t&255;if((s|0)>=67){while(e&3){i[e>>0]=t;e=e+1|0}n=t|t<<8|t<<16|t<<24;while((e|0)<=((r&-4)-64|0)){a[e>>2]=n;a[e+4>>2]=n;a[e+8>>2]=n;a[e+12>>2]=n;a[e+16>>2]=n;a[e+20>>2]=n;a[e+24>>2]=n;a[e+28>>2]=n;a[e+32>>2]=n;a[e+36>>2]=n;a[e+40>>2]=n;a[e+44>>2]=n;a[e+48>>2]=n;a[e+52>>2]=n;a[e+56>>2]=n;a[e+60>>2]=n;e=e+64|0}while((e|0)<(r&-4|0)){a[e>>2]=n;e=e+4|0}}while((e|0)<(r|0)){i[e>>0]=t;e=e+1|0}return r-s|0}function ut(e,t,s){e=e|0;t=t|0;s=s|0;if((s|0)<32){w=t>>>s;return e>>>s|(t&(1<<s)-1)<<32-s}w=0;return t>>>s-32|0}function _t(e,t,s){e=e|0;t=t|0;s=s|0;if((s|0)<32){w=t<<s|(e&(1<<s)-1<<32-s)>>>32-s;return e<<s}w=e<<s-32;return 0}function lt(e,t,s){e=e|0;t=t|0;s=s|0;var r=0,n=0,o=0;if((s|0)>=8192)return J(e|0,t|0,s|0)|0;o=e|0;n=e+s|0;if((e&3)==(t&3)){while(e&3){if(!s)return o|0;i[e>>0]=i[t>>0]|0;e=e+1|0;t=t+1|0;s=s-1|0}s=n&-4|0;r=s-64|0;while((e|0)<=(r|0)){a[e>>2]=a[t>>2];a[e+4>>2]=a[t+4>>2];a[e+8>>2]=a[t+8>>2];a[e+12>>2]=a[t+12>>2];a[e+16>>2]=a[t+16>>2];a[e+20>>2]=a[t+20>>2];a[e+24>>2]=a[t+24>>2];a[e+28>>2]=a[t+28>>2];a[e+32>>2]=a[t+32>>2];a[e+36>>2]=a[t+36>>2];a[e+40>>2]=a[t+40>>2];a[e+44>>2]=a[t+44>>2];a[e+48>>2]=a[t+48>>2];a[e+52>>2]=a[t+52>>2];a[e+56>>2]=a[t+56>>2];a[e+60>>2]=a[t+60>>2];e=e+64|0;t=t+64|0}while((e|0)<(s|0)){a[e>>2]=a[t>>2];e=e+4|0;t=t+4|0}}else{s=n-4|0;while((e|0)<(s|0)){i[e>>0]=i[t>>0]|0;i[e+1>>0]=i[t+1>>0]|0;i[e+2>>0]=i[t+2>>0]|0;i[e+3>>0]=i[t+3>>0]|0;e=e+4|0;t=t+4|0}}while((e|0)<(n|0)){i[e>>0]=i[t>>0]|0;e=e+1|0;t=t+1|0}return o|0}function dt(e){e=e|0;var t=0;t=i[m+(e&255)>>0]|0;if((t|0)<8)return t|0;t=i[m+(e>>8&255)>>0]|0;if((t|0)<8)return t+8|0;t=i[m+(e>>16&255)>>0]|0;if((t|0)<8)return t+16|0;return(i[m+(e>>>24)>>0]|0)+24|0}function ft(e,t,s,i,r){e=e|0;t=t|0;s=s|0;i=i|0;r=r|0;var n=0,o=0,h=0,c=0,u=0,_=0,l=0,d=0,f=0,p=0;if(!t)if(!i){if(r|0){a[r>>2]=(e>>>0)%(s>>>0);a[r+4>>2]=0}i=0;r=(e>>>0)/(s>>>0)>>>0;return(w=i,r)|0}else{if(!r){i=0;r=0;return(w=i,r)|0}a[r>>2]=e|0;a[r+4>>2]=t&0;i=0;r=0;return(w=i,r)|0}do{if(!s){if(!i){if(r|0){a[r>>2]=(t>>>0)%(s>>>0);a[r+4>>2]=0}i=0;r=(t>>>0)/(s>>>0)>>>0;return(w=i,r)|0}if(!e){if(r|0){a[r>>2]=0;a[r+4>>2]=(t>>>0)%(i>>>0)}s=0;r=(t>>>0)/(i>>>0)>>>0;return(w=s,r)|0}if(!(i-1&i)){if(r|0){a[r>>2]=e|0;a[r+4>>2]=i-1&t|t&0}s=0;r=t>>>((dt(i|0)|0)>>>0);return(w=s,r)|0}o=(H(i|0)|0)-(H(t|0)|0)|0;if(o>>>0<=30){d=o+1|0;h=t<<31-o|e>>>((o+1|0)>>>0);l=t>>>((o+1|0)>>>0);n=0;o=e<<31-o;break}if(!r){i=0;r=0;return(w=i,r)|0}a[r>>2]=e|0;a[r+4>>2]=t|t&0;i=0;r=0;return(w=i,r)|0}else{if(i|0){o=(H(i|0)|0)-(H(t|0)|0)|0;if(o>>>0<=31){d=o+1|0;h=e>>>((o+1|0)>>>0)&o-31>>31|t<<31-o;l=t>>>((o+1|0)>>>0)&o-31>>31;n=0;o=e<<31-o;break}if(!r){i=0;r=0;return(w=i,r)|0}a[r>>2]=e|0;a[r+4>>2]=t|t&0;i=0;r=0;return(w=i,r)|0}if(s-1&s|0){o=(H(s|0)|0)+33-(H(t|0)|0)|0;d=o;h=32-o-1>>31&t>>>((o-32|0)>>>0)|(t<<32-o|e>>>(o>>>0))&o-32>>31;l=o-32>>31&t>>>(o>>>0);n=e<<64-o&32-o>>31;o=(t<<64-o|e>>>((o-32|0)>>>0))&32-o>>31|e<<32-o&o-33>>31;break}if(r|0){a[r>>2]=s-1&e;a[r+4>>2]=0}if((s|0)==1){i=t|t&0;r=e|0|0;return(w=i,r)|0}else{r=dt(s|0)|0;i=t>>>(r>>>0)|0;r=t<<32-r|e>>>(r>>>0)|0;return(w=i,r)|0}}}while(0);if(!d){c=o;t=l;e=0;o=0}else{u=ht(s|0|0,i|i&0|0,-1,-1)|0;_=w;c=o;t=l;e=d;o=0;do{p=c;c=n>>>31|c<<1;n=o|n<<1;p=h<<1|p>>>31|0;f=h>>>31|t<<1|0;ot(u|0,_|0,p|0,f|0)|0;d=w;l=d>>31|((d|0)<0?-1:0)<<1;o=l&1;h=ot(p|0,f|0,l&(s|0)|0,(((d|0)<0?-1:0)>>31|((d|0)<0?-1:0)<<1)&(i|i&0)|0)|0;t=w;e=e-1|0}while((e|0)!=0);e=0}if(r|0){a[r>>2]=h;a[r+4>>2]=t}f=(n|0)>>>31|c<<1|(0<<1|n>>>31)&0|e;p=(n<<1|0>>>31)&-2|o;return(w=f,p)|0}function pt(e,t,s,i){e=e|0;t=t|0;s=s|0;i=i|0;return ft(e,t,s,i,0)|0}function mt(e){e=e|0;var t=0,s=0;s=e+15&-16|0;t=a[_>>2]|0;e=t+s|0;if((s|0)>0&(e|0)<(t|0)|(e|0)<0){z()|0;K(12);return-1}a[_>>2]=e;if((e|0)>(W()|0))if(!(V()|0)){a[_>>2]=t;K(12);return-1}return t|0}function gt(e,t,s,i){e=e|0;t=t|0;s=s|0;i=i|0;var r=0;r=f;f=f+16|0;ft(e,t,s,i,r|0)|0;f=r;return(w=a[r+4>>2]|0,a[r>>2]|0)|0}function bt(e){e=e|0;return(e&255)<<24|(e>>8&255)<<16|(e>>16&255)<<8|e>>>24|0}function kt(e,t){e=e|0;t=t|0;return At[e&1](t|0)|0}function yt(e,t,s,i){e=e|0;t=t|0;s=s|0;i=i|0;return It[e&3](t|0,s|0,i|0)|0}function wt(e){U(0);return 0}function Ct(e,t,s){U(1);return 0}function vt(e){e=e|0;var t=0,s=0,r=0,n=0,o=0,h=0,c=0,u=0,_=0,l=0,d=0,p=0;r=a[e+1368>>2]|0;n=a[e+3472>>2]|0;p=a[e+3496>>2]|0;d=a[e+3504>>2]|0;e:{if((p&65024|0)==23552){if(i[5300]|0){d=a[2]|0;a[e+512>>2]=p&7;a[e+512+4>>2]=p>>>3&7;a[e+512+8>>2]=p>>>6&7;Ne(d,1367,e+512|0)|0}d=(a[4668+((p>>>6&7)<<2)>>2]|0)+(a[4668+((p>>>3&7)<<2)>>2]|0)|0;r=$(3,d&-2|0)|0;a[4668+((p&7)<<2)>>2]=((d&1|0)==0?r:r>>>8)&255;r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}if((p&63488|0)==34816){if(i[5300]|0){d=a[2]|0;a[e+528>>2]=p&7;a[e+528+4>>2]=p>>>3&7;a[e+528+8>>2]=p>>>5&62;Ne(d,1387,e+528|0)|0}a[4668+((p&7)<<2)>>2]=($(3,(a[4668+((p>>>3&7)<<2)>>2]|0)+(p>>>5&62)|0)|0)&65535;r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}t=1;s=(p&65024)<<16>>16;if(t)switch(s|0){case 23040:{if(i[5300]|0){d=a[2]|0;a[e+544>>2]=p&7;a[e+544+4>>2]=p>>>3&7;a[e+544+8>>2]=p>>>6&7;Ne(d,1409,e+544|0)|0}a[4668+((p&7)<<2)>>2]=($(3,(a[4668+((p>>>6&7)<<2)>>2]|0)+(a[4668+((p>>>3&7)<<2)>>2]|0)|0)|0)&65535;r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}case 22016:{if(i[5300]|0){d=a[2]|0;a[e+560>>2]=p&7;a[e+560+4>>2]=p>>>3&7;a[e+560+8>>2]=p>>>6&7;Ne(d,1429,e+560|0)|0}d=(a[4668+((p>>>6&7)<<2)>>2]|0)+(a[4668+((p>>>3&7)<<2)>>2]|0)|0;r=$(3,d&-2|0)|0;r=(d&1|0)==0?r:r>>>8;a[4668+((p&7)<<2)>>2]=(r&128|0)==0?r&255:r|-256;r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}case 24064:{if(i[5300]|0){d=a[2]|0;a[e+576>>2]=p&7;a[e+576+4>>2]=p>>>3&7;a[e+576+8>>2]=p>>>6&7;Ne(d,1450,e+576|0)|0}r=$(3,(a[4668+((p>>>6&7)<<2)>>2]|0)+(a[4668+((p>>>3&7)<<2)>>2]|0)|0)|0;a[4668+((p&7)<<2)>>2]=(r&32768|0)==0?r&65535:r|-65536;r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}default:t=1}if(t)switch(s|0){default:{if(!(p&63488)){if(i[5300]|0){d=a[2]|0;a[e+592>>2]=p&7;a[e+592+4>>2]=p>>>3&7;a[e+592+8>>2]=p>>>6&31;Ne(d,1471,e+592|0)|0}t=a[4668+((p>>>3&7)<<2)>>2]|0;if(!(p>>>6&31))s=a[1184]|0;else{s=a[1184]|0;s=t&1<<32-(p>>>6&31)|0?s|536870912:s&-536870913;a[1184]=s;t=t<<(p>>>6&31)}a[4668+((p&7)<<2)>>2]=t;r=(t|0)<0?s|-2147483648:s&2147483647;a[1184]=(t|0)==0?r|1073741824:r&-1073741825;r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}if((p&65472|0)==16512){if(i[5300]|0){d=a[2]|0;a[e+608>>2]=p&7;a[e+608+4>>2]=p>>>3&7;Ne(d,1491,e+608|0)|0}t=a[4668+((p&7)<<2)>>2]|0;s=a[4668+((p>>>3&7)<<2)>>2]&255;do{if(!s)s=a[1184]|0;else{if(s>>>0<32){d=a[1184]|0;d=1<<32-s&t|0?d|536870912:d&-536870913;a[1184]=d;t=t<<s;s=d;break}if((s|0)==32){s=a[1184]|0;s=t&1|0?s|536870912:s&-536870913;a[1184]=s;t=0;break}else{s=a[1184]&-536870913;a[1184]=s;t=0;break}}}while(0);a[4668+((p&7)<<2)>>2]=t;r=(t|0)<0?s|-2147483648:s&2147483647;a[1184]=(t|0)==0?r|1073741824:r&-1073741825;r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}if((p&63488|0)==2048){if(i[5300]|0){d=a[2]|0;a[e+616>>2]=p&7;a[e+616+4>>2]=p>>>3&7;a[e+616+8>>2]=p>>>6&31;Ne(d,1505,e+616|0)|0}t=a[4668+((p>>>3&7)<<2)>>2]|0;if(!(p>>>6&31)){s=a[1184]|0;s=(t|0)<0?s|536870912:s&-536870913;a[1184]=s;t=0}else{s=a[1184]|0;s=t&1<<(p>>>6&31)+-1|0?s|536870912:s&-536870913;a[1184]=s;t=t>>>(p>>>6&31)}a[4668+((p&7)<<2)>>2]=t;r=(t|0)<0?s|-2147483648:s&2147483647;a[1184]=(t|0)==0?r|1073741824:r&-1073741825;r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}if((p&65472|0)==16576){if(i[5300]|0){d=a[2]|0;a[e+632>>2]=p&7;a[e+632+4>>2]=p>>>3&7;Ne(d,1525,e+632|0)|0}t=a[4668+((p&7)<<2)>>2]|0;s=a[4668+((p>>>3&7)<<2)>>2]&255;do{if(!s)s=a[1184]|0;else{if(s>>>0<32){d=a[1184]|0;d=1<<s+-1&t|0?d|536870912:d&-536870913;a[1184]=d;t=t>>>s;s=d;break}if((s|0)==32){s=a[1184]|0;s=(t|0)<0?s|536870912:s&-536870913;a[1184]=s;t=0;break}else{s=a[1184]&-536870913;a[1184]=s;t=0;break}}}while(0);a[4668+((p&7)<<2)>>2]=t;r=(t|0)<0?s|-2147483648:s&2147483647;a[1184]=(t|0)==0?r|1073741824:r&-1073741825;r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}if((p&63488|0)==8192){if(i[5300]|0){d=a[2]|0;a[e+640>>2]=p>>>8&7;a[e+640+4>>2]=p&255;Ne(d,1539,e+640|0)|0}a[4668+((p>>>8&7)<<2)>>2]=p&255;r=a[1184]&1073741823;a[1184]=(p&255|0)==0?r|1073741824:r;r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}if((p&65472|0)==7168){if(i[5300]|0){d=a[2]|0;a[e+648>>2]=p&7;a[e+648+4>>2]=p>>>3&7;Ne(d,1557,e+648|0)|0}d=a[4668+((p>>>3&7)<<2)>>2]|0;a[4668+((p&7)<<2)>>2]=d;r=a[1184]|0;r=(d|0)<0?r|-2147483648:r&2147483647;a[1184]=((d|0)==0?r|1073741824:r&-1879048193)&-805306369;r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}if((p&65280|0)==17920){if(i[5300]|0){d=a[2]|0;a[e+656>>2]=p>>>4&8|p&7;a[e+656+4>>2]=p>>>3&15;Ne(d,1571,e+656|0)|0}t=a[4668+((p>>>3&15)<<2)>>2]|0;if((p>>>3&15|0)==15){if(t&1|0){d=a[2]|0;a[e+664>>2]=t;Ne(d,520,e+664|0)|0}t=t&-2}a[4668+((p>>>4&8|p&7)<<2)>>2]=(p>>>4&8|p&7|0)==15?((p>>>4&8|p&7|0)==15?t+2|0:t)&-2:t;r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}t=1;s=((p&65472)+-16960|0)>>>6&67108863|0;if(t)switch(s|0){case 4:{if(i[5300]|0){d=a[2]|0;a[e+672>>2]=p&7;a[e+672+4>>2]=p>>>3&7;Ne(d,1584,e+672|0)|0}d=L(a[4668+((p>>>3&7)<<2)>>2]|0,a[4668+((p&7)<<2)>>2]|0)|0;a[4668+((p&7)<<2)>>2]=d;r=a[1184]|0;r=(d|0)<0?r|-2147483648:r&2147483647;a[1184]=(d|0)==0?r|1073741824:r&-1073741825;r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}case 6:{if(i[5300]|0){d=a[2]|0;a[e+680>>2]=p&7;a[e+680+4>>2]=p>>>3&7;Ne(d,1598,e+680|0)|0}d=a[4668+((p>>>3&7)<<2)>>2]|0;a[4668+((p&7)<<2)>>2]=~d;r=a[1184]|0;r=(d|0)>-1?r|-2147483648:r&2147483647;a[1184]=(d|0)==-1?r|1073741824:r&-1073741825;r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}case 0:{if(i[5300]|0){d=a[2]|0;a[e+688>>2]=p&7;a[e+688+4>>2]=p>>>3&7;Ne(d,1612,e+688|0)|0}d=a[4668+((p>>>3&7)<<2)>>2]|0;a[4668+((p&7)<<2)>>2]=0-d;r=a[1184]|0;r=(0-d|0)<0?r|-2147483648:r&2147483647;r=(d|0)==0?r|1073741824:r&-1073741825;r=(((((~d&2147483647)+1|0)>>>31)+(~d>>>31)|0)&2|0)==0?r&-536870913:r|536870912;a[1184]=(((~d&2147483647)+1|0)>>>31|0)==(((((~d&2147483647)+1|0)>>>31)+(~d>>>31)|0)>>>1|0)?r&-268435457:r|268435456;r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}case 3:{if(i[5300]|0){d=a[2]|0;a[e+696>>2]=p&7;a[e+696+4>>2]=p>>>3&7;Ne(d,1626,e+696|0)|0}d=a[4668+((p>>>3&7)<<2)>>2]|a[4668+((p&7)<<2)>>2];a[4668+((p&7)<<2)>>2]=d;r=a[1184]|0;r=(d|0)<0?r|-2147483648:r&2147483647;a[1184]=(d|0)==0?r|1073741824:r&-1073741825;r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}default:t=1}if(t)switch(s|0){default:{t=1;s=(p&65024)<<16>>16;if(t)switch(s|0){case-17408:{if(!(i[5300]|0))s=p&1;else{s=a[2]|0;Ee(1640,5,1,s)|0;if(!(p&1))t=0;else{a[e+704>>2]=0;Ne(s,1249,e+704|0)|0;t=1}if(p&2){if(t|0)at(44,s)|0;a[e+1064>>2]=1;Ne(s,1249,e+1064|0)|0;t=t+1|0}if(p&4){if(t|0)at(44,s)|0;a[e+1072>>2]=2;Ne(s,1249,e+1072|0)|0;t=t+1|0}if(p&8){if(t|0)at(44,s)|0;a[e+1080>>2]=3;Ne(s,1249,e+1080|0)|0;t=t+1|0}if(p&16){if(t|0)at(44,s)|0;a[e+1088>>2]=4;Ne(s,1249,e+1088|0)|0;t=t+1|0}if(p&32){if(t|0)at(44,s)|0;a[e+1096>>2]=5;Ne(s,1249,e+1096|0)|0;t=t+1|0}if(p&64){if(t|0)at(44,s)|0;a[e+1104>>2]=6;Ne(s,1249,e+1104|0)|0;t=t+1|0}if(p&128){if(t|0)at(44,s)|0;a[e+1112>>2]=7;Ne(s,1249,e+1112|0)|0;t=t+1|0}if(p&256|0){if(t|0)at(44,s)|0;Ee(1646,2,1,s)|0}Ee(1253,2,1,s)|0;s=p&1}t=a[1180]|0;if(s){a[1167]=$(1,t|0)|0;t=t+4|0}if(p&2){a[1168]=$(1,t|0)|0;t=t+4|0}if(p&4){a[1169]=$(1,t|0)|0;t=t+4|0}if(p&8){a[1170]=$(1,t|0)|0;t=t+4|0}if(p&16){a[1171]=$(1,t|0)|0;t=t+4|0}if(p&32){a[1172]=$(1,t|0)|0;t=t+4|0}if(p&64){a[1173]=$(1,t|0)|0;t=t+4|0}if(p&128){a[1174]=$(1,t|0)|0;t=t+4|0}if(p&256){s=$(1,t|0)|0;if(!(s&1)){p=a[2]|0;a[e+712>>2]=d;a[e+712+4>>2]=s;Ne(p,1649,e+712|0)|0;s=s&-2}a[1182]=s+2&-2;t=t+4|0}a[1180]=t;r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}case-19456:{l=a[2]|0;if(!(i[5300]|0)){t=p&2;s=p&4;r=p&8;n=p&16;o=p&32;h=p&64;c=p&128;_=p&256;u=p&1}else{Ee(1703,6,1,l)|0;if(!(p&1))t=0;else{a[e+720>>2]=0;Ne(l,1249,e+720|0)|0;t=1}if(p&2){if(t|0)at(44,l)|0;a[e+1120>>2]=1;Ne(l,1249,e+1120|0)|0;t=t+1|0}if(p&4){if(t|0)at(44,l)|0;a[e+1128>>2]=2;Ne(l,1249,e+1128|0)|0;t=t+1|0}if(p&8){if(t|0)at(44,l)|0;a[e+1136>>2]=3;Ne(l,1249,e+1136|0)|0;t=t+1|0}if(p&16){if(t|0)at(44,l)|0;a[e+1144>>2]=4;Ne(l,1249,e+1144|0)|0;t=t+1|0}if(p&32){if(t|0)at(44,l)|0;a[e+1152>>2]=5;Ne(l,1249,e+1152|0)|0;t=t+1|0}if(p&64){if(t|0)at(44,l)|0;a[e+1160>>2]=6;Ne(l,1249,e+1160|0)|0;t=t+1|0}if(p&128){if(t|0)at(44,l)|0;a[e+1168>>2]=7;Ne(l,1249,e+1168|0)|0;t=t+1|0}if(p&256|0){if(t|0)at(44,l)|0;Ee(1710,2,1,l)|0}Ee(1253,2,1,l)|0;t=p&2;s=p&4;r=p&8;n=p&16;o=p&32;h=p&64;c=p&128;_=p&256;u=p&1}o=(a[1180]|0)-((c>>>7)+((h>>>6)+((o>>>5)+((n>>>4)+((r>>>3)+((s>>>2)+((t>>>1)+u))))))+(_>>>8)<<2)|0;t=o;r=0;n=1;while(1){if(!(n&p))s=t;else{s=a[4668+(r<<2)>>2]|0;t:do{if((t&-268435456|0)==-536870912){u=t+536813552|0;switch(u>>>2|u<<30|0){case 0:{u=a[1164]|0;a[1164]=s&65543;if((s&1|0)==0|(u&1|0)!=0)break t;a[1166]=a[1165];break t}case 1:{a[1165]=s&16777215;break t}case 2:{a[1166]=s&16777215;break t}case 3:break t;default:break t}}else te(2,t|0,s|0)|0}while(0);s=t+4|0}r=r+1|0;if((r|0)==8)break;else{t=s;n=n<<1&254}}do{if(_|0){t=a[1181]|0;t:do{if((s&-268435456|0)==-536870912){p=s+536813552|0;switch(p>>>2|p<<30|0){case 0:{p=a[1164]|0;a[1164]=t&65543;if((t&1|0)==0|(p&1|0)!=0)break t;a[1166]=a[1165];break t}case 1:{a[1165]=t&16777215;break t}case 2:{a[1166]=t&16777215;break t}case 3:break t;default:break t}}else te(2,s|0,t|0)|0}while(0);if(t&1|0)break;a[e+728>>2]=d;a[e+728+4>>2]=t;Ne(l,1713,e+728|0)|0}}while(0);a[1180]=o;r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}default:t=1}if(t)switch(s|0){default:{t:do{if((p&65472)<<16>>16<-17728)switch((p&65472)<<16>>16){case-17920:{if(i[5300]|0){d=a[2]|0;a[e+736>>2]=p&7;a[e+736+4>>2]=p>>>3&7;Ne(d,1768,e+736|0)|0}a[4668+((p&7)<<2)>>2]=bt(a[4668+((p>>>3&7)<<2)>>2]|0)|0;r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}case-17856:{if(i[5300]|0){d=a[2]|0;a[e+744>>2]=p&7;a[e+744+4>>2]=p>>>3&7;Ne(d,1781,e+744|0)|0}r=a[4668+((p>>>3&7)<<2)>>2]|0;a[4668+((p&7)<<2)>>2]=r<<8&65280|r>>>8&255|r>>>16<<24|r>>>24<<16;r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}default:break t}else{if((p&65472)<<16>>16<16768){switch((p&65472)<<16>>16){case-17728:break;default:break t}if(i[5300]|0){d=a[2]|0;a[e+752>>2]=p&7;a[e+752+4>>2]=p>>>3&7;Ne(d,1796,e+752|0)|0}r=a[4668+((p>>>3&7)<<2)>>2]|0;a[4668+((p&7)<<2)>>2]=(r<<8&32768|0)==0?r<<8&65280|r>>>8&255:r<<8&65280|r>>>8&255|-65536;r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}switch((p&65472)<<16>>16){case 16832:break;case 16768:{if(i[5300]|0){d=a[2]|0;a[e+768>>2]=p&7;a[e+768+4>>2]=p>>>3&7;Ne(d,1825,e+768|0)|0}s=a[4668+((p&7)<<2)>>2]|0;r=a[4668+((p>>>3&7)<<2)>>2]|0;d=a[1184]|0;a[4668+((p&7)<<2)>>2]=s-r+-1+(d>>>29&1);t=(s-r+-1+(d>>>29&1)|0)<0?d|-2147483648:d&2147483647;t=(s-r+-1+(d>>>29&1)|0)==0?t|1073741824:t&-1073741825;a[1184]=t;if(!(t&536870912)){p=(((~r>>>31)+(s>>>31)+(((~r&2147483647)+(s&2147483647)|0)>>>31)|0)&2|0)==0?t&-536870913:t|536870912;a[1184]=(((~r&2147483647)+(s&2147483647)|0)>>>31|0)==(((~r>>>31)+(s>>>31)+(((~r&2147483647)+(s&2147483647)|0)>>>31)|0)>>>1&1|0)?p&-268435457:p|268435456;r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}else{p=(((~r>>>31)+(s>>>31)+(((~r&2147483647)+(s&2147483647)+1|0)>>>31)|0)&2|0)==0?t&-536870913:t|536870912;a[1184]=(((~r&2147483647)+(s&2147483647)+1|0)>>>31|0)==(((~r>>>31)+(s>>>31)+(((~r&2147483647)+(s&2147483647)+1|0)>>>31)|0)>>>1&1|0)?p&-268435457:p|268435456;r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}}default:break t}if(i[5300]|0){d=a[2]|0;a[e+760>>2]=p&7;a[e+760+4>>2]=p>>>3&7;Ne(d,1811,e+760|0)|0}t=a[4668+((p&7)<<2)>>2]|0;s=a[4668+((p>>>3&7)<<2)>>2]|0;do{if(!(s&255))s=a[1184]|0;else if(!(s&31)){s=a[1184]|0;s=(t|0)<0?s|536870912:s&-536870913;a[1184]=s;break}else{d=a[1184]|0;d=1<<(s&31)+-1&t|0?d|536870912:d&-536870913;a[1184]=d;t=t<<32-(s&31)|t>>>(s&31);s=d;break}}while(0);a[4668+((p&7)<<2)>>2]=t;r=(t|0)<0?s|-2147483648:s&2147483647;a[1184]=(t|0)==0?r|1073741824:r&-1073741825;r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}}while(0);if((p&65527|0)==46672){Ee(1838,23,1,a[2]|0)|0;r=1;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}t:do{if((p&63488)<<16>>16<24576){switch((p&63488)<<16>>16){case-16384:break;default:break t}if(i[5300]|0){s=a[2]|0;a[e+776>>2]=p>>>8&7;Ne(s,1862,e+776|0)|0;if(!(p&1))t=0;else{a[e+784>>2]=0;Ne(s,1249,e+784|0)|0;t=1}if(p&2){if(t|0)at(44,s)|0;a[e+1008>>2]=1;Ne(s,1249,e+1008|0)|0;t=t+1|0}if(p&4){if(t|0)at(44,s)|0;a[e+1016>>2]=2;Ne(s,1249,e+1016|0)|0;t=t+1|0}if(p&8){if(t|0)at(44,s)|0;a[e+1024>>2]=3;Ne(s,1249,e+1024|0)|0;t=t+1|0}if(p&16){if(t|0)at(44,s)|0;a[e+1032>>2]=4;Ne(s,1249,e+1032|0)|0;t=t+1|0}if(p&32){if(t|0)at(44,s)|0;a[e+1040>>2]=5;Ne(s,1249,e+1040|0)|0;t=t+1|0}if(p&64){if(t|0)at(44,s)|0;a[e+1048>>2]=6;Ne(s,1249,e+1048|0)|0;t=t+1|0}if(p&128|0){if(t|0)at(44,s)|0;a[e+1056>>2]=7;Ne(s,1249,e+1056|0)|0}Ee(1253,2,1,s)|0}r=1;n=0;t=a[4668+((p>>>8&7)<<2)>>2]|0;while(1){if(r&p){s=a[4668+(n<<2)>>2]|0;s:do{if((t&-268435456|0)==-536870912){d=t+536813552|0;switch(d>>>2|d<<30|0){case 0:{d=a[1164]|0;a[1164]=s&65543;if((s&1|0)==0|(d&1|0)!=0)break s;a[1166]=a[1165];break s}case 1:{a[1165]=s&16777215;break s}case 2:{a[1166]=s&16777215;break s}case 3:break s;default:break s}}else te(2,t|0,s|0)|0}while(0);t=t+4|0}n=n+1|0;if((n|0)==8)break;else r=r<<1&254}a[4668+((p>>>8&7)<<2)>>2]=t;r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}else{switch((p&63488)<<16>>16){case 24576:break;default:break t}if(i[5300]|0){d=a[2]|0;a[e+792>>2]=p&7;a[e+792+4>>2]=p>>>3&7;a[e+792+8>>2]=p>>>4&124;Ne(d,1875,e+792|0)|0}s=(a[4668+((p>>>3&7)<<2)>>2]|0)+(p>>>4&124)|0;t=a[4668+((p&7)<<2)>>2]|0;if((s&-268435456|0)!=-536870912){te(2,s|0,t|0)|0;r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}switch((s+536813552|0)>>>2|s+536813552<<30|0){case 0:{p=a[1164]|0;a[1164]=t&65543;if((t&1|0)==0|(p&1|0)!=0){r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}a[1166]=a[1165];r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}case 1:{a[1165]=t&16777215;r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}case 2:{a[1166]=t&16777215;r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}case 3:{r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}default:{r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}}}}while(0);if((p&65024|0)==20480){if(i[5300]|0){d=a[2]|0;a[e+808>>2]=p&7;a[e+808+4>>2]=p>>>3&7;a[e+808+8>>2]=p>>>6&7;Ne(d,1896,e+808|0)|0}s=(a[4668+((p>>>6&7)<<2)>>2]|0)+(a[4668+((p>>>3&7)<<2)>>2]|0)|0;t=a[4668+((p&7)<<2)>>2]|0;if((s&-268435456|0)!=-536870912){te(2,s|0,t|0)|0;r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}switch((s+536813552|0)>>>2|s+536813552<<30|0){case 0:{p=a[1164]|0;a[1164]=t&65543;if((t&1|0)==0|(p&1|0)!=0){r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}a[1166]=a[1165];r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}case 1:{a[1165]=t&16777215;r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}case 2:{a[1166]=t&16777215;r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}case 3:{r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}default:{r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}}}t:do{if((p&63488)<<16>>16<28672){switch((p&63488)<<16>>16){case-28672:break;default:break t}if(i[5300]|0){d=a[2]|0;a[e+824>>2]=p>>>8&7;a[e+824+4>>2]=p<<2&1020;Ne(d,1915,e+824|0)|0}s=(a[1180]|0)+(p<<2&1020)|0;t=a[4668+((p>>>8&7)<<2)>>2]|0;if((s&-268435456|0)!=-536870912){te(2,s|0,t|0)|0;r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}switch((s+536813552|0)>>>2|s+536813552<<30|0){case 0:{p=a[1164]|0;a[1164]=t&65543;if((t&1|0)==0|(p&1|0)!=0){r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}a[1166]=a[1165];r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}case 1:{a[1165]=t&16777215;r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}case 2:{a[1166]=t&16777215;r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}case 3:{r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}default:{r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}}}else{switch((p&63488)<<16>>16){case 28672:break;default:break t}if(i[5300]|0){d=a[2]|0;a[e+832>>2]=p&7;a[e+832+4>>2]=p>>>3&7;a[e+832+8>>2]=p>>>6&31;Ne(d,1935,e+832|0)|0}r=a[4668+((p>>>3&7)<<2)>>2]|0;t=a[4668+((p&7)<<2)>>2]|0;s=$(3,r+(p>>>6&31)&-2|0)|0;if(!(r+(p>>>6)&1))t=s&65280|t&255;else t=s&255|t<<8;te(5,r+(p>>>6&31)&-2|0,t&65535|0)|0;r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}}while(0);if((p&65024|0)==21504){if(i[5300]|0){d=a[2]|0;a[e+848>>2]=p&7;a[e+848+4>>2]=p>>>3&7;a[e+848+8>>2]=p>>>6&7;Ne(d,1957,e+848|0)|0}r=(a[4668+((p>>>6&7)<<2)>>2]|0)+(a[4668+((p>>>3&7)<<2)>>2]|0)|0;t=a[4668+((p&7)<<2)>>2]|0;s=$(3,r&-2|0)|0;if(!(r&1))t=s&65280|t&255;else t=s&255|t<<8;te(5,r&-2|0,t&65535|0)|0;r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}if((p&63488|0)==32768){if(i[5300]|0){d=a[2]|0;a[e+864>>2]=p&7;a[e+864+4>>2]=p>>>3&7;a[e+864+8>>2]=p>>>5&62;Ne(d,1977,e+864|0)|0}te(5,(a[4668+((p>>>3&7)<<2)>>2]|0)+(p>>>5&62)|0,a[4668+((p&7)<<2)>>2]&65535|0)|0;r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}t:do{if((p&65024)<<16>>16<20992){switch((p&65024)<<16>>16){case 7680:break;default:break t}if(i[5300]|0){d=a[2]|0;a[e+896>>2]=p&7;a[e+896+4>>2]=p>>>3&7;a[e+896+8>>2]=p>>>6&7;Ne(d,2019,e+896|0)|0}d=a[4668+((p>>>3&7)<<2)>>2]|0;a[4668+((p&7)<<2)>>2]=d-(p>>>6&7);r=a[1184]|0;r=(d-(p>>>6&7)|0)<0?r|-2147483648:r&2147483647;r=(d-(p>>>6&7)|0)==0?r|1073741824:r&-1073741825;r=(((d>>>31)+1+((((p>>>6|2147483640)^7)+1+(d&2147483647)|0)>>>31)|0)&2|0)==0?r&-536870913:r|536870912;a[1184]=((((p>>>6|2147483640)^7)+1+(d&2147483647)|0)>>>31|0)==(((d>>>31)+1+((((p>>>6|2147483640)^7)+1+(d&2147483647)|0)>>>31)|0)>>>1&1|0)?r&-268435457:r|268435456;r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}else{switch((p&65024)<<16>>16){case 20992:break;default:break t}if(i[5300]|0){d=a[2]|0;a[e+880>>2]=p&7;a[e+880+4>>2]=p>>>3&7;a[e+880+8>>2]=p>>>6&7;Ne(d,1999,e+880|0)|0}te(5,(a[4668+((p>>>6&7)<<2)>>2]|0)+(a[4668+((p>>>3&7)<<2)>>2]|0)|0,a[4668+((p&7)<<2)>>2]&65535|0)|0;r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}}while(0);if((p&63488|0)==14336){if(i[5300]|0){d=a[2]|0;a[e+912>>2]=p>>>8&7;a[e+912+4>>2]=p&255;Ne(d,2039,e+912|0)|0}d=a[4668+((p>>>8&7)<<2)>>2]|0;a[4668+((p>>>8&7)<<2)>>2]=d-(p&255);r=a[1184]|0;r=(d-(p&255)|0)<0?r|-2147483648:r&2147483647;r=(d-(p&255)|0)==0?r|1073741824:r&-1073741825;r=(((d>>>31)+1+((-2147483648-(p&255)+(d&2147483647)|0)>>>31)|0)&2|0)==0?r&-536870913:r|536870912;a[1184]=((-2147483648-(p&255)+(d&2147483647)|0)>>>31|0)==(((d>>>31)+1+((-2147483648-(p&255)+(d&2147483647)|0)>>>31)|0)>>>1&1|0)?r&-268435457:r|268435456;r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}if((p&65024|0)==6656){if(i[5300]|0){d=a[2]|0;a[e+920>>2]=p&7;a[e+920+4>>2]=p>>>3&7;a[e+920+8>>2]=p>>>6&7;Ne(d,2057,e+920|0)|0}l=a[4668+((p>>>3&7)<<2)>>2]|0;d=a[4668+((p>>>6&7)<<2)>>2]|0;a[4668+((p&7)<<2)>>2]=l-d;r=a[1184]|0;r=(l-d|0)<0?r|-2147483648:r&2147483647;r=(l-d|0)==0?r|1073741824:r&-1073741825;r=(((~d>>>31)+(l>>>31)+(((l&2147483647)+1+(~d&2147483647)|0)>>>31)|0)&2|0)==0?r&-536870913:r|536870912;a[1184]=(((l&2147483647)+1+(~d&2147483647)|0)>>>31|0)==(((~d>>>31)+(l>>>31)+(((l&2147483647)+1+(~d&2147483647)|0)>>>31)|0)>>>1&1|0)?r&-268435457:r|268435456;r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}if((p&65408|0)==45184){if(i[5300]|0){d=a[2]|0;a[e+936>>2]=p<<2&508;Ne(d,2075,e+936|0)|0}a[1180]=(a[1180]|0)-(p<<2&508);r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}if((p&65280|0)==57088){if(i[5300]|0){d=a[2]|0;a[e+944>>2]=p&255;Ne(d,2091,e+944|0)|0}if((p&255|0)==204){a[1167]=a[1184];r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}else{r=a[2]|0;a[e+952>>2]=p&255;Ne(r,2103,e+952|0)|0;r=1;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}}t:do{if((p&65472)<<16>>16<-19840)switch((p&65472)<<16>>16){case-19904:{if(i[5300]|0){d=a[2]|0;a[e+960>>2]=p&7;a[e+960+4>>2]=p>>>3&7;Ne(d,2117,e+960|0)|0}r=a[4668+((p>>>3&7)<<2)>>2]|0;a[4668+((p&7)<<2)>>2]=(r&128|0)==0?r&255:r|-256;r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}case-19968:{if(i[5300]|0){d=a[2]|0;a[e+968>>2]=p&7;a[e+968+4>>2]=p>>>3&7;Ne(d,2131,e+968|0)|0}r=a[4668+((p>>>3&7)<<2)>>2]|0;a[4668+((p&7)<<2)>>2]=(r&32768|0)==0?r&65535:r|-65536;r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}default:break t}else{if((p&65472)<<16>>16<-19776){switch((p&65472)<<16>>16){case-19840:break;default:break t}if(i[5300]|0){d=a[2]|0;a[e+992>>2]=p&7;a[e+992+4>>2]=p>>>3&7;Ne(d,2172,e+992|0)|0}a[4668+((p&7)<<2)>>2]=a[4668+((p>>>3&7)<<2)>>2]&65535;r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}if((p&65472)<<16>>16<16896){switch((p&65472)<<16>>16){case-19776:break;default:break t}if(i[5300]|0){d=a[2]|0;a[e+984>>2]=p&7;a[e+984+4>>2]=p>>>3&7;Ne(d,2158,e+984|0)|0}a[4668+((p&7)<<2)>>2]=a[4668+((p>>>3&7)<<2)>>2]&255;r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}else{switch((p&65472)<<16>>16){case 16896:break;default:break t}if(i[5300]|0){d=a[2]|0;a[e+976>>2]=p&7;a[e+976+4>>2]=p>>>3&7;Ne(d,2145,e+976|0)|0}p=a[4668+((p>>>3&7)<<2)>>2]&a[4668+((p&7)<<2)>>2];r=a[1184]|0;r=(p|0)<0?r|-2147483648:r&2147483647;a[1184]=(p|0)==0?r|1073741824:r&-1073741825;r=0;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}}}while(0);r=a[2]|0;a[e+1e3>>2]=n;a[e+1e3+4>>2]=p;Ne(r,2186,e+1e3|0)|0;r=1;f=e;a[e+4792>>2]=6;a[e+4796>>2]=r|0;break e}}}}}}}a[e+1368>>2]=r}var At=[wt,we];var It=[Ct,Ce,ve,Ct];return{_llvm_bswap_i32:bt,_enable_debug:de,stackSave:ie,_i64Subtract:ot,___udivdi3:pt,setThrew:ne,_bitshift64Lshr:ut,_read_register:fe,_bitshift64Shl:_t,_memset:ct,_sbrk:mt,_memcpy:lt,stackAlloc:se,___uremdi3:gt,_run:_e,_abort_run:le,setTempRet0:oe,_i64Add:ht,dynCall_iiii:yt,dynCall_ii:kt,_ping:ue,_emscripten_get_global_libc:ye,_free:ke,___errno_location:Ie,_set_stop_address:ce,runPostSets:nt,getTempRet0:he,_write_register:pe,stackRestore:re,_malloc:be,establishStackSpace:ae,_reset:me}}(Module.asmGlobalArg,Module.asmLibraryArg,buffer),_enable_debug=Module._enable_debug=asm._enable_debug,stackSave=Module.stackSave=asm.stackSave,_i64Subtract=Module._i64Subtract=asm._i64Subtract,___udivdi3=Module.___udivdi3=asm.___udivdi3,getTempRet0=Module.getTempRet0=asm.getTempRet0,_bitshift64Lshr=Module._bitshift64Lshr=asm._bitshift64Lshr,_read_register=Module._read_register=asm._read_register,_bitshift64Shl=Module._bitshift64Shl=asm._bitshift64Shl,_memset=Module._memset=asm._memset,_sbrk=Module._sbrk=asm._sbrk,_memcpy=Module._memcpy=asm._memcpy,___errno_location=Module.___errno_location=asm.___errno_location,___uremdi3=Module.___uremdi3=asm.___uremdi3,stackAlloc=Module.stackAlloc=asm.stackAlloc,_run=Module._run=asm._run,_abort_run=Module._abort_run=asm._abort_run,setTempRet0=Module.setTempRet0=asm.setTempRet0,_i64Add=Module._i64Add=asm._i64Add,_ping=Module._ping=asm._ping,_emscripten_get_global_libc=Module._emscripten_get_global_libc=asm._emscripten_get_global_libc,_set_stop_address=Module._set_stop_address=asm._set_stop_address,_llvm_bswap_i32=Module._llvm_bswap_i32=asm._llvm_bswap_i32,_free=Module._free=asm._free,runPostSets=Module.runPostSets=asm.runPostSets,setThrew=Module.setThrew=asm.setThrew,establishStackSpace=Module.establishStackSpace=asm.establishStackSpace,_write_register=Module._write_register=asm._write_register,stackRestore=Module.stackRestore=asm.stackRestore,_malloc=Module._malloc=asm._malloc,_reset=Module._reset=asm._reset,dynCall_ii=Module.dynCall_ii=asm.dynCall_ii,dynCall_iiii=Module.dynCall_iiii=asm.dynCall_iiii,initialStackTop;function ExitStatus(e){this.name="ExitStatus",this.message="Program terminated with exit("+e+")",this.status=e}function run(e){function t(){Module.calledRun||(Module.calledRun=!0,ABORT||(ensureInitRuntime(),preMain(),Module.onRuntimeInitialized&&Module.onRuntimeInitialized(),Module._main&&shouldRunNow&&Module.callMain(e),postRun()))}e=e||Module.arguments,runDependencies>0||(preRun(),runDependencies>0||Module.calledRun||(Module.setStatus?(Module.setStatus("Running..."),setTimeout((function(){setTimeout((function(){Module.setStatus("")}),1),t()}),1)):t()))}function exit(e,t){t&&Module.noExitRuntime||(Module.noExitRuntime||(ABORT=!0,STACKTOP=initialStackTop,exitRuntime(),Module.onExit&&Module.onExit(e)),ENVIRONMENT_IS_NODE&&process.exit(e),Module.quit(e,new ExitStatus(e)))}Runtime.stackAlloc=Module.stackAlloc,Runtime.stackSave=Module.stackSave,Runtime.stackRestore=Module.stackRestore,Runtime.establishStackSpace=Module.establishStackSpace,Runtime.setTempRet0=Module.setTempRet0,Runtime.getTempRet0=Module.getTempRet0,Module.asm=asm,Module.then=function(e){if(Module.calledRun)e(Module);else{var t=Module.onRuntimeInitialized;Module.onRuntimeInitialized=function(){t&&t(),e(Module)}}return Module},ExitStatus.prototype=new Error,ExitStatus.prototype.constructor=ExitStatus,dependenciesFulfilled=function e(){Module.calledRun||run(),Module.calledRun||(dependenciesFulfilled=e)},Module.callMain=Module.callMain=function(e){e=e||[],ensureInitRuntime();var t=e.length+1;function s(){for(var e=0;e<3;e++)i.push(0)}var i=[allocate(intArrayFromString(Module.thisProgram),"i8",ALLOC_NORMAL)];s();for(var r=0;r<t-1;r+=1)i.push(allocate(intArrayFromString(e[r]),"i8",ALLOC_NORMAL)),s();i.push(0),i=allocate(i,"i32",ALLOC_NORMAL);try{exit(Module._main(t,i,0),!0)}catch(e){if(e instanceof ExitStatus)return;if("SimulateInfiniteLoop"==e)return void(Module.noExitRuntime=!0);var a=e;e&&"object"==typeof e&&e.stack&&(a=[e,e.stack]),Module.printErr("exception thrown: "+a),Module.quit(1,e)}},Module.run=Module.run=run,Module.exit=Module.exit=exit;var abortDecorators=[];function abort(e){Module.onAbort&&Module.onAbort(e),void 0!==e?(Module.print(e),Module.printErr(e),e=JSON.stringify(e)):e="",ABORT=!0;var t="abort("+e+") at "+stackTrace()+"\nIf this abort() is unexpected, build with -s ASSERTIONS=1 which can give more information.";throw abortDecorators&&abortDecorators.forEach((function(s){t=s(t,e)})),t}if(Module.abort=Module.abort=abort,Module.preInit)for("function"==typeof Module.preInit&&(Module.preInit=[Module.preInit]);Module.preInit.length>0;)Module.preInit.pop()();var shouldRunNow=!1;return Module.noInitialRun&&(shouldRunNow=!1),Module.noExitRuntime=!0,run(),Module};module.exports&&(module.exports=Module),module.exports=Module})),Thumbulator_1=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){void 0===t&&(t={}),this._module=null,this._options=null,this._options=tslib_es6.__assign({stopAddress:0},t),this._module=thumbulator(this._getApi(e,this._options)),this.enableDebug(!1)}return e.prototype.init=function(){return tslib_es6.__awaiter(this,void 0,void 0,(function(){return tslib_es6.__generator(this,(function(e){return this._module._set_stop_address(this._options.stopAddress),[2]}))}))},e.prototype.ping=function(){return this._module.ccall("ping","string",[],[])},e.prototype.run=function(e){return this._module._run(e)},e.prototype.abort=function(){this._module._abort_run()},e.prototype.enableDebug=function(e){this._module._enable_debug(e?1:0)},e.prototype.reset=function(){this._module._reset()},e.prototype.readRegister=function(e){if(e<0||e>15)throw new Error("illegal thumb register "+e);return this._module._read_register(e)},e.prototype.writeRegister=function(e,t){if(e<0||e>15)throw new Error("illegal thumb register "+e);this._module._write_register(e,t)},e.prototype._getApi=function(e,t){var s=t.printer||function(e){return console.log("thumbulator: "+e)};return{print:s,printErr:s,trapOnInstructionFetch:t.trapOnInstructionFetch||function(){return 0},trapOnBx32:t.trapOnBx32||function(){return 3},busRead16:e.read16,busRead32:e.read32||function(t){return 65535&e.read16(t)|e.read16(t+2)<<16},busWrite16:e.write16,busWrite32:e.write32||function(t,s){return e.write16(t,65535&s),e.write16(t+2,s>>>16)}}},e}();t.default=s})),Thumbulator=unwrapExports(Thumbulator_1);function encodeWithPrefix(e,t,s=!0,i=""){if(!s&&e<0)return encodeWithPrefix(e>>>16,t&&t>8?t-4:4,!1,i)+encodeWithPrefix(65535&e,4);let r=Math.abs(e).toString(16).toUpperCase();if(void 0!==t)for(;r.length<t;)r="0"+r;return(e<0?"-":"")+i+r}function encode(e,t,s=!0){return encodeWithPrefix(e,t,s,"$")}function hostIsLittleEndian(){const e=new Uint8Array([1,2,3,4]);return 67305985===new Uint32Array(e.buffer)[0]}class Soc{constructor(e=(()=>3)){this.trap=new lib_1,this._thumbulatorBus={read16:e=>{if(1&e)return this._triggerTrap(`unaligned 16 bit ARM read from ${encode(e,8,!1)}`),0;const t=268435455&e;switch(e>>>28){case 0:if(t<32768)return this.getRom16(t);break;case 4:if(t<8192)return this.getRam16(t);break;case 14:switch(t){case 2080768:return this._armMamcr}}this._triggerTrap(`invalid 16 bit ARM read from ${encode(e,8,!1)}`)},read32:e=>{if(3&e)return this._triggerTrap(`unaligned 32 bit ARM read from ${encode(e,8,!1)}`),0;const t=268435455&e;switch(e>>>28){case 0:if(t<32768)return this.getRom32(t);break;case 4:if(t<8192)return this.getRam32(t);break;case 14:switch(t){case 32772:case 32776:return 0}}this._triggerTrap(`invalid 32 bit ARM read from ${encode(e,8,!1)}`)},write16:(e,t)=>{if(1&e)return void this._triggerTrap(`unaligned 16 bit ARM write: ${encode(t,4)} -> ${encode(e,8,!1)}`);const s=268435455&e;switch(e>>>28){case 4:if(s<8192)return void this.setRam16(s,65535&t);break;case 14:switch(s){case 2080768:return void(this._armMamcr=t)}}this._triggerTrap(`invalid 16 bit ARM write: ${encode(t,4)} -> ${encode(e,8,!1)}`)},write32:(e,t)=>{if(3&e)return void this._triggerTrap(`unaligned 32 bit ARM write: ${encode(t,8,!1)} -> ${encode(e,8,!1)}`);const s=268435455&e;switch(e>>>28){case 4:if(s<8192)return void this.setRam32(s,t);case 14:switch(s){case 32772:case 32776:return}}this._triggerTrap(`invalid 32 bit ARM write: ${encode(t,8,!1)} -> ${encode(e,8,!1)}`)}},this._romBuffer=new ArrayBuffer(32768),this._ramBuffer=new ArrayBuffer(8192),this._armMamcr=0,this._thumbulator=null,hostIsLittleEndian()?(this.getRom16=e=>this._rom16[e>>>1],this.getRom32=e=>this._rom32[e>>>2],this.getRam16=e=>this._ram16[e>>>1],this.getRam32=e=>this._ram32[e>>>2],this.setRam16=(e,t)=>this._ram16[e>>>1]=t,this.setRam32=(e,t)=>this._ram32[e>>>2]=t):(this.getRom16=e=>this._rom8[e]|this._rom8[e+1]<<8,this.getRom32=e=>this._rom8[e]|this._rom8[e+1]<<8|this._rom8[e+2]<<16|this._rom8[e+3]<<24,this.getRam16=e=>this._ram8[e]|this._ram8[e+1]<<8,this.getRam32=e=>this._ram8[e]|this._ram8[e+1]<<8|this._ram8[e+2]<<16|this._ram8[e+3]<<24,this.setRam16=(e,t)=>{this._ram8[e]=255&t,this._ram8[e+1]=t>>>8&255},this.setRam32=(e,t)=>{this._ram8[e]=255&t,this._ram8[e+1]=t>>>8&255,this._ram8[e+2]=t>>>16&255,this._ram8[e+3]=t>>>24&255}),this._rom8=new Uint8Array(this._romBuffer),this._rom16=new Uint16Array(this._romBuffer),this._rom32=new Uint32Array(this._romBuffer),this._ram8=new Uint8Array(this._ramBuffer),this._ram16=new Uint16Array(this._ramBuffer),this._ram32=new Uint32Array(this._ramBuffer),this._thumbulator=new Thumbulator(this._thumbulatorBus,{stopAddress:32772,trapOnBx32:e}),this.reset()}init(){return this._thumbulator.init()}reset(){}getRom(){return this._rom8}getRam(){return this._ram8}run(e){this._thumbulator.reset(),this._thumbulator.enableDebug(!1);for(let e=0;e<=12;e++)this._thumbulator.writeRegister(e,0);this._thumbulator.writeRegister(13,1073749940),this._thumbulator.writeRegister(14,32773),this._thumbulator.writeRegister(15,e),this._armMamcr=0;const t=this._thumbulator.run(5e5);20!==t&&10!==t&&this._triggerTrap(`ARM execution trapped: ${t}`)}getThumbulator(){return this._thumbulator}_triggerTrap(e){this._thumbulator.abort(),this.trap.dispatch(e)}}class CartridgeDPCPlus extends AbstractCartridge{constructor(e){if(super(),this._banks=new Array(6),this._fetchers=new Array(8),this._fractionalFetchers=new Array(8),this._musicFetchers=new Array(3),this._parameters=new Uint8Array(8),this._parameterIndex=0,this._rng=0,this._clockAccumulator=0,this._lastCpuTime=0,this._fastFetch=!1,this._ldaPending=!1,this._cpuTimeProvider=null,this._soc=new Soc,e.length<28672||e.length>32768)throw new Error(`not a DPC+ image: invalid lenght ${e.length}`);this._rom=this._soc.getRom();for(let e=0;e<6;e++)this._banks[e]=new Uint8Array(this._rom.buffer,3072+4096*e,4096);this._ram=this._soc.getRam(),this._imageRam=new Uint8Array(this._ram.buffer,3072,4096);const t=32768-e.length;for(let s=0;s<e.length;s++)this._rom[t+s]=e[s];for(let e=0;e<8;e++)this._fetchers[e]=new Fetcher$1,this._fractionalFetchers[e]=new FractionalFetcher;for(let e=0;e<3;e++)this._musicFetchers[e]=new MusicFetcher;this._soc.trap.addHandler(e=>this.triggerTrap(2,e)),this.reset()}static matchesBuffer(e){return 2===searchForSignatures(e,["DPC+".split("").map(e=>e.charCodeAt(0))])[0]}init(){return this._soc.init()}reset(){this._soc.reset(),this._currentBank=this._banks[5];for(let e=0;e<768;e++)this._soc.setRam32(e<<2,this._soc.getRom32(e<<2));for(let e=6912;e<8192;e++)this._soc.setRam32(768+e-6912<<2,this._soc.getRom32(e<<2));this._currentBank=this._banks[5];for(let e=0;e<8;e++)this._parameters[e]=0;for(let e=0;e<8;e++)this._fetchers[e].reset(),this._fractionalFetchers[e].reset();for(let e=0;e<3;e++)this._musicFetchers[e].reset();this._parameterIndex=0,this._fastFetch=this._ldaPending=!1,this._rng=725831748,this._lastCpuTime=0,this._clockAccumulator=0}getType(){return CartridgeInfo.CartridgeType.bankswitch_dpc_plus}setBus(e){return this._bus=e,this}setCpuTimeProvider(e){return this._cpuTimeProvider=e,this}read(e){return this._access(e,this._bus.getLastDataBusValue())}peek(e){return this._currentBank[4095&e]}write(e,t){this._access(e,t)}triggerTrap(e,t){super.triggerTrap(e,t)}_access(e,t){e&=4095;const s=this._currentBank[e];if(this._fastFetch&&this._ldaPending&&e>127&&e<4086&&s<40&&(e=s),this._ldaPending=!1,e<40){const t=7&e,s=this._fetchers[t],i=this._fractionalFetchers[t];let r=0;switch(e>>>3&7){case 0:switch(t){case 0:return this._advanceRng(),255&this._rng;case 1:return this._rewindRng(),255&this._rng;case 2:return this._rng>>>8&255;case 3:return this._rng>>>16&255;case 4:return this._rng>>>24&255;case 5:{this._clockMusicFetchers();let e=0;for(let t=0;t<3;t++)e+=this._imageRam[(this._musicFetchers[t].waveform<<5)+this._musicFetchers[t].waveformSample()];return 255&e}}return 0;case 1:return r=this._imageRam[s.pointer],s.increment(),r;case 2:return r=this._imageRam[s.pointer]&s.mask(),s.increment(),r;case 3:return r=this._imageRam[i.pointer>>>8],i.increment(),r;case 4:return t<4?s.mask():0;default:return 0}}else if(e<128){const s=7&e,i=this._fetchers[s],r=this._fractionalFetchers[s];switch(e-40>>>3&15){case 0:r.setPointerLo(t);break;case 1:r.setPointerHi(t);break;case 2:r.setFraction(t);break;case 3:i.top=t;break;case 4:i.bottom=t;break;case 5:i.setPointerLo(t);break;case 6:switch(s){case 0:this._fastFetch=0===t;break;case 1:this._parameterIndex<8&&(this._parameters[this._parameterIndex++]=t);break;case 2:this._dispatchFunction(t);break;case 5:case 6:case 7:this._musicFetchers[s-5].waveform=127&t}break;case 7:i.decrement(),this._imageRam[i.pointer]=t;break;case 8:i.setPointerHi(t);break;case 9:switch(s){case 0:this._rng=725831748;break;case 1:this._rng=4294967040&this._rng|t;break;case 2:this._rng=4294902015&this._rng|t<<8;break;case 3:this._rng=4278255615&this._rng|t<<16;break;case 4:this._rng=16777215&this._rng|t<<24;break;case 5:case 6:case 7:this._musicFetchers[s-5].frequency=this._soc.getRam32(7168+(t<<2))}break;case 10:this._imageRam[i.pointer]=t,i.increment()}}else e>4085&&e<4092&&(this._currentBank=this._banks[e-4086]);return this._fastFetch&&e>127&&e<4086&&(this._ldaPending=169===s),s}_clockMusicFetchers(){const e=this._cpuTimeProvider();this._clockAccumulator+=2e4*(e-this._lastCpuTime),this._lastCpuTime=e;const t=Math.floor(this._clockAccumulator);if(this._clockAccumulator-=t,0!==t)for(let e=0;e<3;e++)this._musicFetchers[e].increment(t)}_dispatchFunction(e){const t=this._parameters[0]+(this._parameters[1]<<8);switch(e){case 0:this._parameterIndex=0;break;case 1:for(let e=0;e<this._parameters[3];e++)this._ram[3072+(this._fetchers[7&this._parameters[2]].pointer+e&4095)]=this._rom[3072+(t+e)%29696];this._parameterIndex=0;break;case 2:for(let e=0;e<this._parameters[3];e++)this._ram[3072+(this._fetchers[7&this._parameters[2]].pointer+e&4095)]=this._parameters[0];this._parameterIndex=0;break;case 254:case 255:this._soc.run(3083)}}_advanceRng(){this._rng=(1024&this._rng?279816990:0)^(this._rng>>>11|this._rng<<21)}_rewindRng(){this._rng=this._rng&1<<31?(279816990^this._rng)<<11|(279816990^this._rng)>>>21:this._rng<<11|this._rng>>>21}}class Fetcher$1{constructor(){this.pointer=0,this.top=0,this.bottom=0}contructor(){this.reset()}reset(){this.pointer=this.top=this.bottom=0}setPointerHi(e){this.pointer=255&this.pointer|(15&e)<<8}setPointerLo(e){this.pointer=3840&this.pointer|255&e}increment(){this.pointer=this.pointer+1&4095}decrement(){this.pointer=this.pointer+4095&4095}mask(){return(this.top-(255&this.pointer)&255)>(this.top-this.bottom&255)?255:0}}class FractionalFetcher{constructor(){this.pointer=0,this.fraction=0}contructor(){this.reset()}reset(){this.pointer=this.fraction=0}setPointerHi(e){this.pointer=65535&this.pointer|(15&e)<<16}setPointerLo(e){this.pointer=983295&this.pointer|(255&e)<<8}setFraction(e){this.fraction=e,this.pointer&=1048320}increment(){this.pointer=this.pointer+this.fraction&1048575}}class MusicFetcher{constructor(){this.frequency=-1,this.counter=-1,this.waveform=0,this.reset()}reset(){this.frequency=0,this.waveform=0,this.counter=0}increment(e){this.counter=this.counter+e*this.frequency|0}waveformSample(){return this.counter>>>27}}class CartridgeCDF extends AbstractCartridge{constructor(e){super(),this._handleBxCDF0=e=>{const t=this._soc.getThumbulator(),s=t.readRegister(2),i=t.readRegister(3);switch(e){case 1762:return this._musicStreams[s%3].frequency=i,0;case 1766:return this._musicStreams[s%3].counter=0,0;case 1770:return t.writeRegister(2,this._musicStreams[s%3].counter),0;case 1774:return this._musicStreams[s%3].waveformSize=i,0}return 3},this._handleBxCDF1=e=>{const t=this._soc.getThumbulator(),s=t.readRegister(2),i=t.readRegister(3);switch(e){case 1874:return this._musicStreams[s%3].frequency=i,0;case 1878:return this._musicStreams[s%3].counter=0,0;case 1882:return t.writeRegister(2,this._musicStreams[s%3].counter),0;case 1886:return this._musicStreams[s%3].waveformSize=i,0}return 3},this._banks=new Array(7),this._currentBank=null,this._rom=null,this._ram=null,this._displayRam=null,this._musicStreams=new Array(3),this._clockAccumulator=0,this._lastCpuTime=0,this._soc=null,this._fastFetch=!1,this._digitalAudio=!1,this._fastJumpCountdown=0,this._fastFetchPending=!1,this._jmpOperandAddress=0,this._ldaOperandAddress=0,this._datastreamBase=0,this._datastreamIncrementBase=0,this._waveformBase=0,this._jumpstream=0,this._jumpstreamMask=0,this._amplitudeStream=0,this._bus=null,this._cpuTimeProvider=null;const t=CartridgeCDF.getVersion(e);switch(t){case 0:this._jumpstreamMask=255,this._amplitudeStream=34,this._datastreamBase=1760,this._datastreamIncrementBase=1896,this._waveformBase=2032;break;case 1:this._jumpstreamMask=255,this._amplitudeStream=34,this._datastreamBase=160,this._datastreamIncrementBase=296,this._waveformBase=432;break;case 2:this._jumpstreamMask=254,this._amplitudeStream=35,this._datastreamBase=152,this._datastreamIncrementBase=292,this._waveformBase=432;break;default:throw new Error("not a CDF image: missing signature")}if(32768!==e.length)throw new Error(`not a CDF image: invalid lenght ${e.length}`);this._soc=new Soc(0===t?this._handleBxCDF0:this._handleBxCDF1),this._soc.trap.addHandler(e=>this.triggerTrap(2,e)),this._rom=this._soc.getRom();for(let t=0;t<32768;t++)this._rom[t]=e[t];for(let e=0;e<7;e++)this._banks[e]=new Uint8Array(this._rom.buffer,4096*(e+1),4096);this._ram=this._soc.getRam(),this._displayRam=new Uint8Array(this._soc.getRam().buffer,2048,4096);for(let e=0;e<3;e++)this._musicStreams[e]=new MusicStream;this.reset()}static getVersion(e){const t="CDF".split("").map(e=>e.charCodeAt(0)),s=searchForSignature(e,[...t,-1,...t,-1,...t]);if(s<0)return 3;switch(e[s+3]){case 0:return 0;case 1:return 1;case"J".charCodeAt(0):return 2;default:return 3}}static matchesBuffer(e){return 3!==CartridgeCDF.getVersion(e)}init(){return this._soc.init()}reset(){for(let e=0;e<512;e++)this._soc.setRam32(e<<2,this._soc.getRom32(e<<2));this._fastFetch=!1,this._digitalAudio=!1,this._fastJumpCountdown=0,this._fastFetchPending=!1,this._jmpOperandAddress=0,this._ldaOperandAddress=0,this._currentBank=this._banks[6];for(let e=0;e<3;e++)this._musicStreams[e].reset();this._lastCpuTime=0,this._clockAccumulator=0}getType(){return CartridgeInfo.CartridgeType.bankswitch_cdf}setBus(e){return this._bus=e,this}setCpuTimeProvider(e){return this._cpuTimeProvider=e,this}read(e){return this._access(e,this._bus.getLastDataBusValue())}peek(e){return this._currentBank[4095&e]}write(e,t){this._access(e,t)}_access(e,t){e&=4095;const s=this._currentBank[e];if(this._fastJumpCountdown-- >0&&e===this._jmpOperandAddress)return this._jmpOperandAddress++,this._datastreamReadWithIncrement(this._jumpstream,256);if(this._fastFetch&&76===s&&0==(this._currentBank[e+1&4095]&this._jumpstreamMask)&&0===this._currentBank[e+2&4095])return this._fastJumpCountdown=2,this._jmpOperandAddress=e+1&4095,this._jumpstream=33+this._currentBank[e+1&4095],s;if(this._fastJumpCountdown=0,this._fastFetch&&this._fastFetchPending&&this._ldaOperandAddress===e&&s<=this._amplitudeStream){if(this._fastFetchPending=!1,s===this._amplitudeStream){if(this._clockMusicStreams(),this._digitalAudio){const e=this._musicStreams[0].counter,t=this._soc.getRam32(this._waveformBase)+(e>>>21);let s=0;return t<32768&&(s=this._rom[t]),t>1073741824&&t<1073750016&&(s=this._ram[t-1073741824]),0==(1048576&e)&&(s>>>=4),15&s}{let e=0;for(let t=0;t<3;t++)e+=this._displayRam[this._getWaveform(t)+(this._musicStreams[t].counter>>>this._musicStreams[t].waveformSize)&4095];return e}}return this._datastreamRead(s)}if(this._fastFetchPending=!1,e>=4080){switch(e){case 4080:this._datastreamWriteWithIncrement(32,t,256);break;case 4081:{let e=this._getDatastreamPointer(32);e<<=8,e&=4026531840,e|=t<<20,this._setDatastreamPointer(32,e);break}case 4082:this._fastFetch=0==(15&t),this._digitalAudio=0==(240&t);break;case 4083:switch(t){case 254:case 255:this._soc.run(2059)}}e>4084&&e<4092&&(this._currentBank=this._banks[e-4085])}return this._fastFetch&&169===s&&(this._fastFetchPending=!0,this._ldaOperandAddress=e+1&4095),s}_clockMusicStreams(){const e=this._cpuTimeProvider();this._clockAccumulator+=2e4*(e-this._lastCpuTime),this._lastCpuTime=e;const t=Math.floor(this._clockAccumulator);if(this._clockAccumulator-=t,0!==t)for(let e=0;e<3;e++)this._musicStreams[e].increment(t)}_getDatastreamPointer(e){return this._soc.getRam32(this._datastreamBase+4*e)}_setDatastreamPointer(e,t){this._soc.setRam32(this._datastreamBase+4*e,t)}_getDatastreamIncrement(e){return this._soc.getRam32(this._datastreamIncrementBase+4*e)}_datastreamRead(e){const t=this._getDatastreamPointer(e),s=this._displayRam[t>>>20];return this._setDatastreamPointer(e,t+(this._getDatastreamIncrement(e)<<12)|0),s}_datastreamReadWithIncrement(e,t){const s=this._getDatastreamPointer(e),i=this._displayRam[s>>>20];return this._setDatastreamPointer(e,s+(t<<12)|0),i}_datastreamWriteWithIncrement(e,t,s){const i=this._getDatastreamPointer(e);this._displayRam[i>>>20]=t,this._setDatastreamPointer(e,i+(s<<12)|0)}_getWaveform(e){return this._soc.getRam32(this._waveformBase+4*e)-1073741824-2048&4095}}class MusicStream{constructor(){this.counter=0,this.frequency=0,this.waveformSize=27}reset(){this.counter=this.frequency=0,this.waveformSize=27}increment(e){this.counter=this.counter+e*this.frequency|0}}class Cartridge8040 extends AbstractCartridge{constructor(e){if(super(),this._bank=null,this._bank0=new Uint8Array(4096),this._bank1=new Uint8Array(4096),this._bus=null,8192!==e.length)throw new Error(`buffer is not an 8k cartridge image: wrong length ${e.length}`);for(let t=0;t<4096;t++)this._bank0[t]=e[t],this._bank1[t]=e[4096+t];this.reset()}static matchesBuffer(e){const t=searchForSignatures(e,[[173,0,8],[173,64,8],[44,0,8],[12,0,8,76],[12,255,15,76]]);for(const e of t)if(e>=2)return!0;return!1}reset(){this._bank=this._bank0}read(e){return this.peek(e)}peek(e){return e&=4095,this._bank[e]}getType(){return CartridgeInfo.CartridgeType.bankswitch_8k_econobanking}setBus(e){return this._bus=e,this._bus.event.read.addHandler(this._onBusAccess,this),this._bus.event.write.addHandler(this._onBusAccess,this),this}_onBusAccess(e,t){switch(6208&t._bus.getLastAddresBusValue()){case 2048:t._bank=t._bank0;break;case 2112:t._bank=t._bank1}}}class CartridgePP extends AbstractCartridge{constructor(e){if(super(),this._banks=new Array(8),this._segments=new Array(4),this._ram=new Uint8Array(64),this._bankSwitchPending=!1,this._pendingBank=0,this._accessCounter=0,this._previousAddressBusValue=0,8192!==e.length&&8195!==e.length)throw new Error(`buffer is not a PP cartridge image; wrong length ${e.length} bytes`);for(let t=0;t<8;t++){this._banks[t]=new Uint8Array(1024);for(let s=0;s<1024;s++)this._banks[t][s]=e[1024*t+s]}this.reset()}getType(){return CartridgeInfo.CartridgeType.bankswitch_8k_pp}reset(){this._switchLayout(0),this._bankSwitchPending=!1}randomize(e){for(let t=0;t<64;t++)this._ram[t]=e.int(255)}setBus(e){return this._bus=e,e.event.read.addHandler(CartridgePP._onBusAccess,this),e.event.write.addHandler(CartridgePP._onBusAccess,this),this}read(e){return e&=4095,this._access(e,this._bus.getLastDataBusValue()),e<64?this._ram[e]:e<128?this._bus.getLastDataBusValue():this._segments[e>>>10][1023&e]}write(e,t){this._access(4095&e,t)}peek(e){return(e&=4095)<64?this._ram[e]:e<128?this._bus.getLastDataBusValue():this._segments[e>>>10][1023&e]}static _onBusAccess(e,t){let s=t._bus.getLastAddresBusValue();t._bankSwitchPending&&s!==t._previousAddressBusValue&&0==--t._accessCounter&&(t._switchLayout(t._pendingBank),t._bankSwitchPending=!1),4096&s||(s&=255,s>=48&&s<=63&&(t._pendingBank=15&s,t._accessCounter=3,t._bankSwitchPending=!0))}_access(e,t){e>=64&&e<128&&(this._ram[e-64]=t)}_switchLayout(e){switch(e){case 0:case 8:return this._configureSegments(0,0,1,2);case 1:case 9:return this._configureSegments(0,1,3,2);case 2:case 10:return this._configureSegments(4,5,6,7);case 3:case 11:return this._configureSegments(7,4,3,2);case 4:case 12:return this._configureSegments(0,0,6,7);case 5:case 13:return this._configureSegments(0,1,7,6);case 6:case 14:return this._configureSegments(3,2,4,5);case 7:case 15:return this._configureSegments(6,0,5,1);default:throw new Error("illegal layout index")}}_configureSegments(e,t,s,i){this._segments[0]=this._banks[e],this._segments[1]=this._banks[t],this._segments[2]=this._banks[s],this._segments[3]=this._banks[i]}}class CartridgeDetector{detectCartridgeType(e){if(e.length%8448==0)return CartridgeInfo.CartridgeType.bankswitch_supercharger;if(e.length<2048)return CartridgeInfo.CartridgeType.vanilla_2k;if(e.length>=10240&&e.length<=10496)return CartridgeInfo.CartridgeType.bankswitch_8k_DPC;switch(e.length){case 2048:return this._detect2k(e);case 4096:return CartridgeInfo.CartridgeType.vanilla_4k;case 8192:return this._detect8k(e);case 8195:return CartridgeInfo.CartridgeType.bankswitch_8k_pp;case 12288:return CartridgeInfo.CartridgeType.bankswitch_12k_FA;case 16384:return this._detect16k(e);case 28672:return CartridgeInfo.CartridgeType.bankswitch_FA2;case 29696:return this._detect29k(e);case 32768:return this._detect32k(e);case 65536:return this._detect64k(e);default:return CartridgeInfo.CartridgeType.unknown}}_detect2k(e){return CartridgeCV.matchesBuffer(e)?CartridgeInfo.CartridgeType.bankswitch_2k_cv:CartridgeInfo.CartridgeType.vanilla_2k}_detect8k(e){const t=CartridgeF8.matchesBuffer(e);return CartridgeE0.matchesBuffer(e)?CartridgeInfo.CartridgeType.bankswitch_8k_E0:Cartridge3F.matchesBuffer(e)?CartridgeInfo.CartridgeType.bankswitch_8k_3F:CartridgeUA.matchesBuffer(e)?CartridgeInfo.CartridgeType.bankswitch_8k_UA:!t&&CartridgeFE.matchesBuffer(e)?CartridgeInfo.CartridgeType.bankswitch_8k_FE:Cartridge8040.matchesBuffer(e)?CartridgeInfo.CartridgeType.bankswitch_8k_econobanking:CartridgeInfo.CartridgeType.bankswitch_8k_F8}_detect16k(e){return CartrdigeE7.matchesBuffer(e)?CartridgeInfo.CartridgeType.bankswitch_16k_E7:CartridgeInfo.CartridgeType.bankswitch_16k_F6}_detect29k(e){return CartridgeFA2.matchesBuffer(e)?CartridgeInfo.CartridgeType.bankswitch_FA2:CartridgeInfo.CartridgeType.bankswitch_dpc_plus}_detect32k(e){return Cartridge3E.matchesBuffer(e)?CartridgeInfo.CartridgeType.bankswitch_3E:CartridgeDPCPlus.matchesBuffer(e)?CartridgeInfo.CartridgeType.bankswitch_dpc_plus:CartridgeCDF.matchesBuffer(e)?CartridgeInfo.CartridgeType.bankswitch_cdf:CartridgeInfo.CartridgeType.bankswitch_32k_F4}_detect64k(e){return CartridgeEF.matchesBuffer(e)?CartridgeInfo.CartridgeType.bankswitch_64k_EF:CartridgeInfo.CartridgeType.bankswitch_64k_F0}}class CartridgeFactory{createCartridge(e,t){return __awaiter(this,void 0,void 0,(function*(){const s=this._createCartridge(e,t);return yield s.init(),s}))}_createCartridge(e,t){if(void 0===t){t=(new CartridgeDetector).detectCartridgeType(e)}switch(t){case CartridgeInfo.CartridgeType.vanilla_2k:return new Cartridge2k(e);case CartridgeInfo.CartridgeType.vanilla_4k:return new Cartridge4k(e);case CartridgeInfo.CartridgeType.bankswitch_2k_cv:return new CartridgeCV(e);case CartridgeInfo.CartridgeType.bankswitch_8k_F8:return new CartridgeF8(e);case CartridgeInfo.CartridgeType.bankswitch_8k_E0:return new CartridgeE0(e);case CartridgeInfo.CartridgeType.bankswitch_8k_3F:return new Cartridge3F(e);case CartridgeInfo.CartridgeType.bankswitch_8k_FE:return new CartridgeFE(e);case CartridgeInfo.CartridgeType.bankswitch_8k_UA:return new CartridgeUA(e);case CartridgeInfo.CartridgeType.bankswitch_8k_DPC:return new CartridgeDPC(e);case CartridgeInfo.CartridgeType.bankswitch_8k_econobanking:return new Cartridge8040(e);case CartridgeInfo.CartridgeType.bankswitch_8k_pp:return new CartridgePP(e);case CartridgeInfo.CartridgeType.bankswitch_12k_FA:return new CartridgeFA(e);case CartridgeInfo.CartridgeType.bankswitch_16k_F6:return new CartridgeF6(e);case CartridgeInfo.CartridgeType.bankswitch_16k_E7:return new CartrdigeE7(e);case CartridgeInfo.CartridgeType.bankswitch_FA2:return new CartridgeFA2(e);case CartridgeInfo.CartridgeType.bankswitch_32k_F4:return new CartridgeF4(e);case CartridgeInfo.CartridgeType.bankswitch_64k_F0:return new CartridgeF0(e);case CartridgeInfo.CartridgeType.bankswitch_64k_EF:return new CartridgeEF(e);case CartridgeInfo.CartridgeType.bankswitch_3E:return new Cartridge3E(e);case CartridgeInfo.CartridgeType.bankswitch_supercharger:return new CartridgeSupercharger(e);case CartridgeInfo.CartridgeType.bankswitch_dpc_plus:return new CartridgeDPCPlus(e);case CartridgeInfo.CartridgeType.bankswitch_cdf:return new CartridgeCDF(e);default:throw new Error("invalid or unsupported cartridge image")}}}class PeriodicScheduler{constructor(e){this._period=e}setPeriod(e){return this._period=e,this}getPeriod(){return this._period}start(e,t){let s=!1;const i=()=>{s||(e(t),setTimeout(i,this._period))};return setTimeout(i,this._period),{stop:()=>s=!0}}}var setImmediate=createCommonjsModule((function(e,t){e.exports=function(){var e=function(){return this||(0,eval)("this")}(),t=!(e.navigator&&/Trident|Edge/.test(e.navigator.userAgent)),s=1,i=!1,r={};function a(e){var t=Array.prototype.slice.call(arguments,1),s=t.length;return s?1===s?function(){return e.call(void 0,t[0])}:2===s?function(){return e.call(void 0,t[0],t[1])}:3===s?function(){return e.call(void 0,t[0],t[1],t[2])}:function(){return e.apply(void 0,t)}:function(){return e.call(void 0)}}function n(e){return r[s]=a.apply(void 0,e),s++}function o(e){delete r[e]}function h(t){if(i)e.setTimeout(a(h,t),0);else{var s=r[t];if(s){i=!0;try{s()}finally{o(t),i=!1}}}}function c(){var t=function(){var t=n(arguments);return e.setTimeout(a(h,t),0),t};return t.usePolifill="setTimeout",t}var u=Object.freeze({init:c,canUse:function(){return"setTimeout"in e}}),_=Object.freeze({init:function(){var t=function(){var t=n(arguments);return e.process.nextTick(a(h,t)),t};return t.usePolifill="nextTick",t},canUse:function(){return"[object process]"===Object.prototype.toString.call(e.process)}}),l=Object.freeze({init:function(){var t="setImmediate$"+Math.random()+"$",s=function(s){s.source===e&&"string"==typeof s.data&&0===s.data.indexOf(t)&&h(Number(s.data.slice(t.length)))};e.addEventListener?e.addEventListener("message",s,!1):e.attachEvent("onmessage",s);var i=function(){var s=n(arguments);return e.postMessage(t+s,"*"),s};return i.usePolifill="postMessage",i},canUse:function(){if(e.importScripts||!e.postMessage)return!1;if(e.navigator&&/Chrome/.test(e.navigator.userAgent))return!1;var t=!0,s=e.onmessage;return e.onmessage=function(){t=!1},e.postMessage("","*"),e.onmessage=s,t}}),d=Object.freeze({init:function(){var t=new e.MessageChannel;t.port1.onmessage=function(e){h(Number(e.data))};var s=function(){var e=n(arguments);return t.port2.postMessage(e),e};return s.usePolifill="messageChannel",s},canUse:function(){return Boolean(e.MessageChannel)}}),f=Object.freeze({init:function(){var t=e.document.documentElement,s=function(){var s=n(arguments),i=e.document.createElement("script");return i.onreadystatechange=function(){h(s),i.onreadystatechange=null,t.removeChild(i),i=null},t.appendChild(i),s};return s.usePolifill="readyStateChange",s},canUse:function(){return e.document&&"onreadystatechange"in e.document.createElement("script")}}),p=[_,l,d,f],m=t?e.setImmediate||e.msSetImmediate||function(e,t){for(var s=0;s<e.length;s++){var i=e[s];if(i.canUse())return i.init()}return t.init()}(p,u):c(),g=t&&(e.clearImmediate||e.msClearImmediate)||o;return{setImmediate:m,clearImmediate:g,polifill:function(){e.setImmediate!==m&&(e.setImmediate=m,e.msSetImmediate=m,e.clearImmediate=g,e.msClearImmediate=g)}}}()})),setImmediate_1=setImmediate.setImmediate;let index=0;function setImmediate$1(e){0===index?setTimeout(e,0):setImmediate_1(e),index=(index+1)%10}class ImmediateScheduler{start(e,t){let s=!1;return setImmediate$1((function i(){s||(e(t),setImmediate$1(i))})),{stop:()=>s=!0}}}const getTimestamp=self.performance&&self.performance.now?()=>self.performance.now():()=>Date.now(),THRESHOLD=1;class ConstantTimesliceScheduler{start(e,t,s){const i=s||50;let r=!0;return setImmediate$1((function s(){if(!r)return;const a=getTimestamp();let n=0,o=0;for(;getTimestamp()-a<i;){do{o=getTimestamp()-a-n}while(o<THRESHOLD);n+=e(t,o)}o=getTimestamp()-a-n,o>0&&(n+=e(t,o)),r&&setImmediate$1(s)})),{stop:()=>r=!1}}}const CORRECTION_THESHOLD=3,MAX_ACCUMULATED_DELTA=100;class ConstantCyclesScheduler{start(e,t){let s=!1,i=-1,r=0,a=0;return setImmediate$1((function n(){if(s)return;const o=getTimestamp();let h=(e(t)||0)-getTimestamp()+o;i>=0&&(a+=i-o+r),a>MAX_ACCUMULATED_DELTA?a=MAX_ACCUMULATED_DELTA:a<-MAX_ACCUMULATED_DELTA&&(a=-MAX_ACCUMULATED_DELTA),Math.abs(a)>CORRECTION_THESHOLD&&(h+=a,a=0),h<0&&(h=0,a=h),h>0?setTimeout(n,Math.round(h)):setImmediate$1(n),i=h,r=getTimestamp()})),{stop:()=>s=!0}}}const SAFETY_FACTOR=3;class ConstantTimesliceScheduler$1{start(e,t,s){const i=s||100;let r=getTimestamp(),a=0,n=!0;return setImmediate$1((function s(){if(!n)return;const o=getTimestamp();let h=o-r-a;h>SAFETY_FACTOR*i&&(h=SAFETY_FACTOR*i,r=o-h,a=0),a+=e(t,h);const c=i-getTimestamp()+o;c>0?setTimeout(s,c):setImmediate$1(s)})),{stop:()=>n=!1}}}class Factory$1{createPeriodicScheduler(e){return new PeriodicScheduler(e)}createImmediateScheduler(){return new ImmediateScheduler}createLimitingScheduler(e=1){switch(e){case 0:return new ConstantTimesliceScheduler;case 1:return new ConstantCyclesScheduler;case 2:return new ConstantTimesliceScheduler$1;default:throw new Error("invalud limiting scheduling strategy")}}getLimitingSchedulingStrategies(){return[0,1,2]}describeLimitingSchedulingStrategy(e){switch(e){case 0:return"Busy wait, constant timeslice length";case 1:return"Constant cycle count";case 2:return"Constant timeslice length";default:throw new Error("invalid limiting scheduling strategy")}}}class ClockProbe{constructor(e){this._scheduler=e,this.frequencyUpdate=new lib_1,this._counter=0,this._frequency=0}attach(e){return this._clock&&this.detach(),this._clock=e,e.addHandler(this._clockHandler,this),this}start(){return this._measurementTask?this:(this._timestamp=Date.now(),this._counter=0,this._measurementTask=this._scheduler.start(this._updateMeasurement,this),this)}detach(){return this._clock?(this._clock.removeHandler(this._clockHandler,this),this._clock=void 0,this):this}stop(){return this._measurementTask?(this._measurementTask.stop(),this._measurementTask=void 0,this):this}getFrequency(){return this._frequency}_updateMeasurement(e){const t=Date.now();e._frequency=e._counter/(t-e._timestamp)*1e3,e._counter=0,e._timestamp=t,e.frequencyUpdate.dispatch(e._frequency)}_clockHandler(e,t){t._counter+=e}}var Mutex_1=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(){this._queue=[],this._pending=!1}return e.prototype.isLocked=function(){return this._pending},e.prototype.acquire=function(){var e=this,t=new Promise((function(t){return e._queue.push(t)}));return this._pending||this._dispatchNext(),t},e.prototype.runExclusive=function(e){return this.acquire().then((function(t){var s;try{s=e()}catch(e){throw t(),e}return Promise.resolve(s).then((function(e){return t(),e}),(function(e){throw t(),e}))}))},e.prototype._dispatchNext=function(){this._queue.length>0?(this._pending=!0,this._queue.shift()(this._dispatchNext.bind(this))):this._pending=!1},e}();t.default=s}));unwrapExports(Mutex_1);var lib$2=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Mutex=Mutex_1.default}));unwrapExports(lib$2);var lib_1$2=lib$2.Mutex;const CLOCK_UPDATE_INTERVAL=2e3;class EmulationService{constructor(){this.stateChanged=new lib_1,this.emulationError=new lib_1,this._enforceRateLimit=!0,this._state=EmulationServiceInterface.State.stopped,this._lastError=null,this._scheduler=null,this._clockProbe=new ClockProbe(new PeriodicScheduler(CLOCK_UPDATE_INTERVAL)),this._mutex=new lib_1$2,this._schedulerFactory=new Factory$1,this._limitingStrategy=1,this.frequencyUpdate=this._clockProbe.frequencyUpdate,this._updateScheduler()}init(){return Promise.resolve()}start(e,t,s,i){const r=new CartridgeFactory;return this._mutex.runExclusive(()=>__awaiter(this,void 0,void 0,(function*(){try{if(this._stop(),this._limitingStrategy=t.pcmAudio?2:1,this._updateScheduler(),this._state===EmulationServiceInterface.State.error)return this._state;const a=yield r.createCartridge(e,s),n=new Board(t,a);this._board=n,this._board.trap.addHandler(EmulationService._trapHandler,this),this._context=new EmulationContext(n,i),this._clockProbe.attach(this._board.clock),this._setState(EmulationServiceInterface.State.paused)}catch(e){this._setError(e)}return this._state})))}stop(){return this._mutex.runExclusive(()=>this._stop())}pause(){return this._mutex.runExclusive(()=>{try{this._state===EmulationServiceInterface.State.running&&(this._board.getTimer().stop(),this._board.suspend(),this._setState(EmulationServiceInterface.State.paused),this._clockProbe.stop())}catch(e){this._setError(e)}return this._state})}resume(){return this._mutex.runExclusive(()=>{if(this._state===EmulationServiceInterface.State.paused)try{this._tryToResume()}catch(e){this._setError(e)}return this._state})}reset(){return this._mutex.runExclusive(()=>{try{switch(this._state){case EmulationServiceInterface.State.running:case EmulationServiceInterface.State.paused:this._board.reset();break;case EmulationServiceInterface.State.error:this._board.reset(),this._tryToResume()}}catch(e){this._setError(e)}return this._state})}getState(){return this._state}getEmulationContext(){switch(this._state){case EmulationServiceInterface.State.running:case EmulationServiceInterface.State.paused:return this._context;default:return null}}getLastError(){return this._lastError}getFrequency(){return this._clockProbe.getFrequency()}getRateLimit(){return this._enforceRateLimit}setRateLimit(e){return this._enforceRateLimit===e?Promise.resolve(void 0):this._mutex.runExclusive(()=>{this._state===EmulationServiceInterface.State.running&&this._board.getTimer().stop(),this._enforceRateLimit=e,this._updateScheduler(),this._state===EmulationServiceInterface.State.running&&this._board.getTimer().start(this._scheduler)})}static _trapHandler(e,t){t._setError(new Error(`TRAP: ${e.message}`)),t.emulationError.dispatch(t._lastError)}_stop(){try{this._state===EmulationServiceInterface.State.running&&(this._board.getTimer().stop(),this._board.suspend(),this._board.trap.removeHandler(EmulationService._trapHandler,this),this._clockProbe.stop().detach()),this._board=null,this._context=null,this._setState(EmulationServiceInterface.State.stopped)}catch(e){this._setError(e)}return this._state}_tryToResume(){this._state!==EmulationServiceInterface.State.running&&(this._board.getTimer().start(this._scheduler),this._board.resume(),this._setState(EmulationServiceInterface.State.running),this._clockProbe.start())}_setError(e){this._lastError=e,this._setState(EmulationServiceInterface.State.error)}_setState(e){return e!==this._state&&(this._state=e,this.stateChanged.dispatch(e)),this._state}_updateScheduler(){this._scheduler=this._enforceRateLimit?this._schedulerFactory.createLimitingScheduler(this._limitingStrategy):this._schedulerFactory.createImmediateScheduler()}}class DriverManager{constructor(){this._drivers=new Map,this._driversBound=!1}bind(e){return this._driversBound?this:(this._emulationService=e,this._shouldBindDrivers()&&this._bindDrivers(),this._emulationService.stateChanged.addHandler(DriverManager._onEmuStateChange,this),this)}unbind(){return this._emulationService?(this._unbindDrivers(),this._emulationService.stateChanged.removeHandler(DriverManager._onEmuStateChange,this),this._emulationService=null,this):this}addDriver(e,t){return this._drivers.set(e,new DriverManager.DriverContext(e,t)),this._driversBound&&t(this._emulationService.getEmulationContext(),e),this}removeDriver(e){return this._drivers.get(e)?(e.unbind(),this._drivers.delete(e),this):this}static _onEmuStateChange(e,t){t._shouldBindDrivers(e)?t._bindDrivers():t._unbindDrivers()}_shouldBindDrivers(e=(this._emulationService?this._emulationService.getState():void 0)){return this._emulationService&&(e===EmulationServiceInterface.State.running||e===EmulationServiceInterface.State.paused)}_bindDrivers(){this._driversBound||(this._drivers.forEach(e=>e.binder(this._emulationService.getEmulationContext(),e.driver)),this._driversBound=!0)}_unbindDrivers(){this._driversBound&&(this._drivers.forEach(e=>e.driver.unbind()),this._driversBound=!1)}}!function(e){e.DriverContext=class{constructor(e,t){this.driver=e,this.binder=t}}}(DriverManager||(DriverManager={}));const messageIds={configure:"pipeline/configure",flush:"pipeline/flush",process:"pipeline/process",emit:"pipeline/emit",release:"pipeline/release"};Object.freeze(messageIds);class PipelineClient{constructor(e){this._rpc=e,this.emit=new lib_1,this._nextId=0,this._surfaces=new Map,this._rpc.registerSignalHandler(messageIds.emit,this._onMessageEmit.bind(this)).registerSignalHandler(messageIds.release,this._onMessageRelease.bind(this))}static spawn(e="video-pipeline.js"){const t=new Worker(e),s=new lib_1$1((e,s)=>t.postMessage(e,s));return t.onmessage=e=>s.dispatch(e.data),new PipelineClient(s)}configure(e,t,s){return this._rpc.rpc(messageIds.configure,{width:e,height:t,config:s})}flush(){return this._rpc.rpc(messageIds.flush)}processSurface(e){const t=this._nextId++,s=e.get(),i=s.getUnderlyingBuffer();this._surfaces.set(t,e),this._rpc.signal(messageIds.process,{id:t,width:s.getWidth(),height:s.getHeight(),buffer:i},[i])}_onMessageEmit(e){if(!this._surfaces.has(e.id))throw new Error(`no surface with id ${e.id}`);const t=this._surfaces.get(e.id),s=t.get();this._surfaces.delete(e.id),s.replaceUnderlyingBuffer(s.getWidth(),s.getHeight(),e.buffer),this.emit.dispatch(t)}_onMessageRelease(e){if(!this._surfaces.has(e.id))throw new Error(`no surface with id ${e.id}`);const t=this._surfaces.get(e.id),s=t.get();this._surfaces.delete(e.id),s.replaceUnderlyingBuffer(s.getWidth(),s.getHeight(),e.buffer),t.release()}}const RPC_TYPE={emulationPause:"emulation/pause",emulationReset:"emulation/reset",emulationResume:"emulation/resume",emulationSetRateLimit:"emulation/setRateLimit",emulationStart:"emulation/start",emulationStop:"emulation/stop",emulationFetchLastError:"emulation/fetchLastError",getVideoParameters:"video/getParameters",getWaveformAudioParameters:e=>`audio/waveform/getParameters/${e}`,getPCMAudioParameters:e=>`audio/pcm/getParameters/${e}`,setup:"/setup"};Object.freeze(RPC_TYPE);const SIGNAL_TYPE={emulationError:"emulation/error",emulationFrequencyUpdate:"emulation/frequencyUpdate",videoNewFrame:"video/newFrame",videoReturnSurface:"video/returnSurface",controlStateUpdate:"control/stateUpdate",waveformAudioVolumeChange:"audio/waveform/volumeChange",waveformAudioBufferChange:"audio/waveform/bufferChange",pcmAudioNewFrame:e=>`audio/pcm/newFrame/${e}`,pcmAudioTogglePause:e=>`audio/pcm/togglePause/${e}`,pcmAudioReturnFrame:e=>`audio/pcm/returnFrame/${e}`,audioStop:"audio/stop"};Object.freeze(SIGNAL_TYPE);class VideoDriver{constructor(e){this._rpc=e,this._active=!1,this._video=null,this._videoPipelineClient=null,this._mutex=new lib_1$2,this._videoProcessingConfig=null,this._bypassProcessingPipeline=!0,this._surfacePool=null,this._managedSurfacesById=null,this._ids=null,this._width=0,this._height=0,this._nextId=0}init(e){if(this._rpc.registerSignalHandler(SIGNAL_TYPE.videoReturnSurface,this._onReturnSurfaceFromHost.bind(this)).registerRpcHandler(RPC_TYPE.getVideoParameters,this._onGetVideoParameters.bind(this)),e){const t=new lib_1$1((t,s)=>e.postMessage(t,s));e.onmessage=e=>t.dispatch(e.data),this._videoPipelineClient=new PipelineClient(t),this._videoPipelineClient.emit.addHandler(VideoDriver._onEmitFromPipeline,this)}}setVideoProcessingConfig(e){this._videoProcessingConfig=e}bind(e){this._mutex.runExclusive(()=>this._bind(e))}unbind(){this._mutex.runExclusive(()=>this._unbind())}static _onEmitFromPipeline(e,t){if(!t._active)return void console.warn("surface emmited from pipeline to inactive driver");if(!t._ids.has(e))return void console.warn("surface not registered");const s=e.get().getUnderlyingBuffer(),i=t._ids.get(e);t._rpc.signal(SIGNAL_TYPE.videoNewFrame,{id:i,width:t._width,height:t._height,buffer:s},[s])}static _onNewFrame(e,t){t._active?t._managedSurfaces.has(e)?t._bypassProcessingPipeline||!t._videoPipelineClient?VideoDriver._onEmitFromPipeline(t._managedSurfaces.get(e),t):t._videoPipelineClient.processSurface(t._managedSurfaces.get(e)):console.warn("surface not registered"):console.warn("new frame passed to inactive driver")}_bind(e){return __awaiter(this,void 0,void 0,(function*(){this._active||(this._width=e.getWidth(),this._height=e.getHeight(),this._video=e,this._surfacePool=new Pool(()=>ArrayBufferSurface.createFromArrayBuffer(this._width,this._height,new ArrayBuffer(4*this._width*this._height))),this._managedSurfacesById=new Map,this._managedSurfaces=new WeakMap,this._ids=new WeakMap,this._videoPipelineClient&&(yield this._videoPipelineClient.configure(this._width,this._height,this._videoProcessingConfig)),this._video.setSurfaceFactory(()=>{const e=this._surfacePool.get(),t=e.get();if(!this._ids.has(e)){const s=this._nextId++;this._ids.set(e,s),this._managedSurfacesById.set(s,e),this._managedSurfaces.set(t,e),t.fill(4278190080)}return e.get()}),this._video.newFrame.addHandler(VideoDriver._onNewFrame,this),this._bypassProcessingPipeline=!this._videoProcessingConfig||0===this._videoProcessingConfig.length,this._active=!0)}))}_unbind(){return __awaiter(this,void 0,void 0,(function*(){this._active&&(this._active=!1,this._video.setSurfaceFactory(null),this._video.newFrame.removeHandler(VideoDriver._onNewFrame,this),this._videoPipelineClient&&(yield this._videoPipelineClient.flush()),this._video=null,this._surfacePool=null,this._managedSurfacesById=null,this._ids=null)}))}_onReturnSurfaceFromHost(e){if(!this._active)return void console.warn("surface returned from host to inactive driver");const t=this._managedSurfacesById.get(e.id);t?(t.get().replaceUnderlyingBuffer(this._width,this._height,e.buffer),t.release()):console.warn(`invalid member ID ${e.id}`)}_onGetVideoParameters(){return{width:this._width,height:this._height}}}class ControlDriver{constructor(e){this._rpc=e,this._active=!1,this._emulationContext=null}init(){this._rpc.registerSignalHandler(SIGNAL_TYPE.controlStateUpdate,this._onControlStateUpdate.bind(this))}bind(e){this._active||(this._active=!0,this._emulationContext=e)}unbind(){this._active&&(this._active=!1,this._emulationContext=null)}_onControlStateUpdate(e){if(this._active){for(let t=0;t<2;t++)this._applyJoystickState(e.joystickState[t],this._emulationContext.getJoystick(t));for(let t=0;t<4;t++)this._applyPaddleState(e.paddleState[t],this._emulationContext.getPaddle(t));this._applyControlPanelState(e.controlPanelState,this._emulationContext.getControlPanel())}}_applyJoystickState(e,t){t.getUp().toggle(e.up),t.getDown().toggle(e.down),t.getLeft().toggle(e.left),t.getRight().toggle(e.right),t.getFire().toggle(e.fire)}_applyPaddleState(e,t){t.setValue(e.value),t.getFire().toggle(e.fire)}_applyControlPanelState(e,t){t.getDifficultySwitchP0().toggle(e.difficulty0),t.getDifficultySwitchP1().toggle(e.difficulty1),t.getResetButton().toggle(e.reset),t.getColorSwitch().toggle(e.color),t.getSelectSwitch().toggle(e.select)}}class WaveformAudioDriver{constructor(e,t){this._index=e,this._rpc=t,this._audio=null,this._rpc.registerRpcHandler(RPC_TYPE.getWaveformAudioParameters(this._index),this._onGetWaveformAudioParameters.bind(this))}bind(e){this._audio||(this._audio=e,this._audio.bufferChanged.addHandler(WaveformAudioDriver._onBufferChanged,this),this._audio.volumeChanged.addHandler(WaveformAudioDriver._onVolumeChanged,this),this._audio.stop.addHandler(WaveformAudioDriver._onStop,this))}unbind(){this._audio&&(this._audio.bufferChanged.removeHandler(WaveformAudioDriver._onBufferChanged,this),this._audio.volumeChanged.removeHandler(WaveformAudioDriver._onVolumeChanged,this),this._audio.stop.removeHandler(WaveformAudioDriver._onStop,this),this._audio=null)}static _onBufferChanged(e,t){t._rpc.signal(SIGNAL_TYPE.waveformAudioBufferChange,{index:t._index,key:e})}static _onVolumeChanged(e,t){t._rpc.signal(SIGNAL_TYPE.waveformAudioVolumeChange,{index:t._index,value:e})}static _onStop(e,t){t._rpc.signal(SIGNAL_TYPE.audioStop,t._index)}_onGetWaveformAudioParameters(){return{volume:this._audio.getVolume()}}}class PCMAudioDriver{constructor(e,t){this._rpc=t,this._enabled=!1,this._sampleRate=0,this._frameSize=0,this._pendingFrames=new Map,this._nextId=0,this._paused=!1,this._signalNewFrame="",this._signalTogglePause="",this._rpc.registerRpcHandler(RPC_TYPE.getPCMAudioParameters(e),this._onGetPCMAudioParameters.bind(this)).registerSignalHandler(SIGNAL_TYPE.pcmAudioReturnFrame(e),this._onReturnFrame.bind(this)),this._signalNewFrame=SIGNAL_TYPE.pcmAudioNewFrame(e),this._signalTogglePause=SIGNAL_TYPE.pcmAudioTogglePause(e)}bind(e){this._enabled&&this.unbind(),this._endpoint=e,this._endpoint.newFrame.addHandler(PCMAudioDriver._onNewFrame,this),this._endpoint.togglePause.addHandler(PCMAudioDriver._onTogglePause,this),this._sampleRate=this._endpoint.getSampleRate(),this._frameSize=this._endpoint.getFrameSize(),this._enabled=!0}unbind(){this._enabled&&(this._endpoint.newFrame.removeHandler(PCMAudioDriver._onNewFrame,this),this._endpoint.togglePause.removeHandler(PCMAudioDriver._onTogglePause,this),this._endpoint=null,this._pendingFrames.clear(),this._sampleRate=this._frameSize=0,this._enabled=!1)}static _onNewFrame(e,t){if(!t._enabled)return void e.dispose();const s=t._nextId++,i=e.get();t._pendingFrames.set(s,e),t._rpc.signal(t._signalNewFrame,{id:s,buffer:i.buffer},[i.buffer])}static _onTogglePause(e,t){t._paused=e,t._rpc.signal(t._signalTogglePause,{paused:e})}_onGetPCMAudioParameters(){return{sampleRate:this._sampleRate,frameSize:this._frameSize,paused:this._paused}}_onReturnFrame(e){if(!this._enabled||!this._pendingFrames.has(e.id))return;const t=this._pendingFrames.get(e.id);this._pendingFrames.delete(e.id),t.adopt(new Float32Array(e.buffer)),t.release()}}class EmulationBackend{constructor(e){this._rpc=e,this._videoDriver=null,this._service=new EmulationService}startup(){this._rpc.registerRpcHandler(RPC_TYPE.setup,this._onSetup.bind(this)).registerRpcHandler(RPC_TYPE.emulationFetchLastError,this._onFetchLastError.bind(this)).registerRpcHandler(RPC_TYPE.emulationPause,this._onEmulationPause.bind(this)).registerRpcHandler(RPC_TYPE.emulationReset,this._onEmulationReset.bind(this)).registerRpcHandler(RPC_TYPE.emulationResume,this._onEmulationResume.bind(this)).registerRpcHandler(RPC_TYPE.emulationSetRateLimit,this._onEmulationSetRateLimit.bind(this)).registerRpcHandler(RPC_TYPE.emulationStart,this._onEmulationStart.bind(this)).registerRpcHandler(RPC_TYPE.emulationStop,this._onEmulationStop.bind(this)),this._service.frequencyUpdate.addHandler(EmulationBackend._onFrequencyUpdate,this),this._service.emulationError.addHandler(EmulationBackend._onEmulationError,this);const e=new DriverManager,t=new VideoDriver(this._rpc),s=new ControlDriver(this._rpc),i=[0,1].map(e=>new WaveformAudioDriver(e,this._rpc)),r=new PCMAudioDriver(0,this._rpc);this._videoDriver=t,s.init(),e.addDriver(t,(e,t)=>t.bind(e.getRawVideo())).addDriver(s,(e,t)=>t.bind(e)).addDriver(r,(e,t)=>t.bind(e.getPCMChannel())).bind(this._service);for(let t=0;t<2;t++)e.addDriver(i[t],(e,s)=>s.bind(e.getWaveformChannels()[t]))}static _onFrequencyUpdate(e,t){t._rpc.signal(SIGNAL_TYPE.emulationFrequencyUpdate,e)}static _onEmulationError(e,t){t._rpc.signal(SIGNAL_TYPE.emulationError,e?e.message:null)}_onSetup(e){this._videoDriver.init(e.videoProcessorPort)}_onFetchLastError(){const e=this._service.getLastError();return e?e.message:null}_onEmulationPause(){return this._service.pause()}_onEmulationReset(){return this._service.reset()}_onEmulationResume(){return this._service.resume()}_onEmulationStart(e){return this._videoDriver.setVideoProcessingConfig(e.videoProcessing),this._service.start(e.buffer,e.config,e.cartridgeType)}_onEmulationStop(){return this._service.stop()}_onEmulationSetRateLimit(e){return this._service.setRateLimit(e)}}const emulationBackend=new EmulationBackend(getRpc());emulationBackend.startup()}();
//# sourceMappingURL=stellerator.min.js.map

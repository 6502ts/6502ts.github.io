!function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){"use strict";function d(a){return f[a]||(f[a]=e(a)),f[a]}function e(a){for(var b="return function dispatcher"+a+"(payload) {\n",c=[],d=[],e=0;e<a;e++)c.push("cb"+e),d.push("ctx"+e),b+="    cb"+e+"(payload, ctx"+e+");\n";return b+="};",new(Function.bind.apply(Function,[void 0].concat(c.concat(d),[b])))}var f=[];f[0]=function(){return function(){}},f[1]=function(a,b){return"undefined"==typeof b?a:function(c){a(c,b)}};var g=function(){function a(){this.hasHandlers=!1,this._handlers=[],this._contexts=[],this._createDispatcher()}return a.prototype.addHandler=function(a,b){return this.isHandlerAttached(a,b)||(this._handlers.push(a),this._contexts.push(b),this._createDispatcher(),this._updateHasHandlers()),this},a.prototype.removeHandler=function(a,b){var c=this._getHandlerIndex(a,b);return"undefined"!=typeof c&&(this._handlers.splice(c,1),this._contexts.splice(c,1),this._createDispatcher(),this._updateHasHandlers()),this},a.prototype.isHandlerAttached=function(a,b){return"undefined"!=typeof this._getHandlerIndex(a,b)},a.prototype._updateHasHandlers=function(){this.hasHandlers=!!this._handlers.length},a.prototype._getHandlerIndex=function(a,b){var c,d=this._handlers.length;for(c=0;c<d&&(this._handlers[c]!==a||this._contexts[c]!==b);c++);return c<d?c:void 0},a.prototype._createDispatcher=function(){this.dispatch=d(this._handlers.length).apply(this,this._handlers.concat(this._contexts))},a}();Object.defineProperty(c,"__esModule",{value:!0}),c.default=g},{}],2:[function(a,b,c){"use strict";var d=a("./Event");c.Event=d.default},{"./Event":1}],3:[function(a,b,c){"use strict";var d,e=a("microevent.ts"),f="resolve_transaction",g="reject_transaction",h="error",d=function(){function a(a,b){void 0===b&&(b=0),this._dispatch=a,this._rpcTimeout=b,this.error=new e.Event,this._rpcHandlers={},this._signalHandlers={},this._pendingTransactions={},this._nextTransactionId=0}return a.prototype.dispatch=function(b){var c=b;switch(c.type){case a.MessageType.signal:return this._handleSignal(c);case a.MessageType.rpc:return this._handeRpc(c);case a.MessageType.internal:return this._handleInternal(c);default:this._raiseError("invalid message type "+c.type)}},a.prototype.rpc=function(b,c,d){var e=this,f=this._nextTransactionId++;return this._dispatch({type:a.MessageType.rpc,transactionId:f,id:b,payload:c},d?d:void 0),new Promise(function(a,b){var c=e._pendingTransactions[f]={id:f,resolve:a,reject:b};e._rpcTimeout>0&&(e._pendingTransactions[f].timeoutHandle=setTimeout(function(){return e._transactionTimeout(c)},e._rpcTimeout))})},a.prototype.signal=function(b,c,d){return this._dispatch({type:a.MessageType.signal,id:b,payload:c},d?d:void 0),this},a.prototype.registerRpcHandler=function(a,b){if(this._rpcHandlers[a])throw new Error("rpc handler for "+a+" already registered");return this._rpcHandlers[a]=b,this},a.prototype.registerSignalHandler=function(a,b){return this._signalHandlers[a]||(this._signalHandlers[a]=[]),this._signalHandlers[a].push(b),this},a.prototype.deregisterRpcHandler=function(a,b){return this._rpcHandlers[a]&&delete this._rpcHandlers[a],this},a.prototype.deregisterSignalHandler=function(a,b){return this._signalHandlers[a]&&(this._signalHandlers[a]=this._signalHandlers[a].filter(function(a){return b!==a})),this},a.prototype._raiseError=function(b){this.error.dispatch(new Error(b)),this._dispatch({type:a.MessageType.internal,id:h,payload:b})},a.prototype._handleSignal=function(a){return this._signalHandlers[a.id]?void this._signalHandlers[a.id].forEach(function(b){return b(a.payload)}):this._raiseError("invalid signal "+a.id)},a.prototype._handeRpc=function(b){var c=this;return this._rpcHandlers[b.id]?void Promise.resolve(this._rpcHandlers[b.id](b.payload)).then(function(d){return c._dispatch({type:a.MessageType.internal,id:f,transactionId:b.transactionId,payload:d})},function(d){return c._dispatch({type:a.MessageType.internal,id:g,transactionId:b.transactionId,payload:d})}):this._raiseError("invalid rpc "+b.id)},a.prototype._handleInternal=function(a){switch(a.id){case f:if(!this._pendingTransactions[a.transactionId])return this._raiseError("no pending transaction with id "+a.transactionId);this._pendingTransactions[a.transactionId].resolve(a.payload),this._clearTransaction(this._pendingTransactions[a.transactionId]);break;case g:if(!this._pendingTransactions[a.transactionId])return this._raiseError("no pending transaction with id "+a.transactionId);this._pendingTransactions[a.transactionId].reject(a.payload),this._clearTransaction(this._pendingTransactions[a.transactionId]);break;case h:this.error.dispatch(new Error("remote error: "+a.payload));break;default:this._raiseError("unhandled internal message "+a.id)}},a.prototype._transactionTimeout=function(a){a.reject("transaction timed out"),this._raiseError("transaction "+a.id+" timed out"),delete this._pendingTransactions[a.id]},a.prototype._clearTransaction=function(a){"undefined"!=typeof a.timeoutHandle&&clearTimeout(a.timeoutHandle),delete this._pendingTransactions[a.id]},a}();!function(a){!function(a){a[a.signal=0]="signal",a[a.rpc=1]="rpc",a[a.internal=2]="internal"}(a.MessageType||(a.MessageType={}));a.MessageType}(d||(d={})),Object.defineProperty(c,"__esModule",{value:!0}),c.default=d},{"microevent.ts":2}],4:[function(a,b,c){"use strict";var d=a("./RpcProvider");c.RpcProvider=d.default},{"./RpcProvider":3}],5:[function(a,b,c){"use strict";var d=a("microevent.ts"),e=a("./PoolMember"),f=function(){function a(a){this._factory=a,this.event={release:new d.Event,dispose:new d.Event},this._pool=[],this._poolSize=0}return a.prototype.get=function(){var a,b=this;if(0===this._poolSize){var c=this._factory();a=c&&new e.default(c,function(a){return b._releaseMember(a)},function(a){return b._disposeMember(a)})}else a=this._pool[--this._poolSize],a._isAvailable=!1;return a},a.prototype._releaseMember=function(a){if(a._isAvailable)throw new Error("Trying to release an already released pool member");if(a._isDisposed)throw new Error("Trying to release an already disposed pool member");var b=this._poolSize++;this._pool[b]=a,a._isAvailable=!0,a._poolPosition=b,this.event.release.dispatch(a.get())},a.prototype._disposeMember=function(a){if(a._isDisposed)throw new Error("Trying to dispose of an already disposed pool member");a._isAvailable&&(this._poolSize>1&&(this._pool[a._poolPosition]=this._pool[this._poolSize-1]),this._poolSize--),a._isDisposed=!0,this.event.dispose.dispatch(a.get())},a}();Object.defineProperty(c,"__esModule",{value:!0}),c.default=f},{"./PoolMember":6,"microevent.ts":2}],6:[function(a,b,c){"use strict";var d=function(){function a(a,b,c){this._value=a,this._releaseCB=b,this._disposeCB=c,this._isAvailable=!1,this._isDisposed=!1}return a.prototype.adopt=function(a){this._value=a},a.prototype.get=function(){return this._value},a.prototype.release=function(){this._releaseCB(this)},a.prototype.dispose=function(){this._disposeCB(this)},a}();Object.defineProperty(c,"__esModule",{value:!0}),c.default=d},{}],7:[function(a,b,c){"use strict";var d=a("microevent.ts"),e=function(){function a(){this.emit=new d.Event,this._framesOnHold=new Array(2),this._nFramesOnHold=0,this._width=0,this._height=0}return a.prototype.init=function(a,b){this.flush(),this._width=a,this._height=b},a.prototype.flush=function(){for(var a=0;a<this._nFramesOnHold;a++)this._framesOnHold[a].release(),this._framesOnHold[a]=null;this._nFramesOnHold=0},a.prototype.processSurface=function(a){var b=a.get();if(b.getHeight()!==this._height||b.getWidth()!==this._width)throw new Error("surface dimensions do not match");this._framesOnHold[this._nFramesOnHold++]=a,2===this._nFramesOnHold&&this._process()},a.prototype._process=function(){for(var a=this._framesOnHold[0].get().getBuffer(),b=this._framesOnHold[1].get().getBuffer(),c=0;c<this._width*this._height;c++)a[c]=4278190080|(16711680&a[c])+(16711680&b[c])>>>1&16711680|(65280&a[c])+(65280&b[c])>>>1&65280|(255&a[c])+(255&b[c])>>>1&255;this.emit.dispatch(this._framesOnHold[0]),this._framesOnHold[1].release(),this._nFramesOnHold=0},a}();Object.defineProperty(c,"__esModule",{value:!0}),c.default=e},{"microevent.ts":2}],8:[function(a,b,c){"use strict";var d=a("microevent.ts"),e=function(){function a(){this.emit=new d.Event}return a.prototype.init=function(){},a.prototype.flush=function(){},a.prototype.processSurface=function(a){this.emit.dispatch(a)},a}();Object.defineProperty(c,"__esModule",{value:!0}),c.default=e},{"microevent.ts":2}],9:[function(a,b,c){"use strict";var d=(a("./config"),a("./PassthroughProcessor")),e=a("./FrameMergeProcessor"),f=function(){function a(){}return a.prototype.create=function(a){switch(a.type){case 0:return new d.default;case 1:return new e.default;default:throw new Error("cannot happen: invalid processor type")}},a}();Object.defineProperty(c,"__esModule",{value:!0}),c.default=f},{"./FrameMergeProcessor":7,"./PassthroughProcessor":8,"./config":11}],10:[function(a,b,c){"use strict";var d=a("./ProcessorFactory"),e=function(){function a(a){var b=this;a&&0!==a.length||(a=[{type:0}]);var c=new d.default;this._processors=a.map(function(a){return c.create(a)});for(var e=function(a){f._processors[a-1].emit.addHandler(function(c){return b._processors[a].processSurface(c)})},f=this,g=1;g<this._processors.length;g++)e(g);this.emit=this._processors[this._processors.length-1].emit}return a.prototype.init=function(a,b){this._processors.forEach(function(c){return c.init(a,b)})},a.prototype.flush=function(){this._processors.forEach(function(a){return a.flush()})},a.prototype.processSurface=function(a){this._processors[0].processSurface(a)},a}();Object.defineProperty(c,"__esModule",{value:!0}),c.default=e},{"./ProcessorFactory":9}],11:[function(a,b,c){"use strict";var d;!function(a){a[a.passthrough=0]="passthrough",a[a.merge=1]="merge"}(d=c.Type||(c.Type={}))},{}],12:[function(a,b,c){"use strict";var d=a("../../surface/ArrayBufferSurface"),e=a("../../../tools/pool/Pool"),f=a("./messages"),g=a("../ProcessorPipeline"),h=function(){function a(b){this._rpc=b,this._pipeline=null,this._surfacePool=new e.default(function(){return new d.default}),this._bufferIds=new WeakMap,this._rpc.registerRpcHandler(f.messageIds.configure,this._onConfigure.bind(this)).registerRpcHandler(f.messageIds.flush,this._onFlush.bind(this)).registerSignalHandler(f.messageIds.process,this._onProcess.bind(this)),this._surfacePool.event.release.addHandler(a._onReleaseSurface,this)}return a.prototype._onConfigure=function(b){this._pipeline&&(this._pipeline.flush(),this._pipeline.emit.removeHandler(a._onEmitSurface,this)),this._pipeline=new g.default(b.config),this._pipeline.init(b.width,b.height),this._pipeline.emit.addHandler(a._onEmitSurface,this)},a.prototype._onFlush=function(a){this._pipeline&&this._pipeline.flush()},a.prototype._onProcess=function(a){if(this._pipeline){this._bufferIds.set(a.buffer,a.id);var b=this._surfacePool.get();b.get().replaceUnderlyingBuffer(a.width,a.height,a.buffer),this._pipeline.processSurface(b)}},a._onReleaseSurface=function(a,b){var c=a.getUnderlyingBuffer();if(c){if(!b._bufferIds.has(c))throw new Error("double release");var d=b._bufferIds.get(c);b._bufferIds.delete(c),b._rpc.signal(f.messageIds.release,{id:d,buffer:c},[c])}},a._onEmitSurface=function(a,b){var c=a.get().getUnderlyingBuffer();if(!b._bufferIds.has(c))throw new Error("double release");var d=b._bufferIds.get(c);b._bufferIds.delete(c),b._rpc.signal(f.messageIds.emit,{id:d,buffer:c},[c]),a.get().resetUnderlyingBuffer(),a.release()},a}();Object.defineProperty(c,"__esModule",{value:!0}),c.default=h},{"../../../tools/pool/Pool":5,"../../surface/ArrayBufferSurface":14,"../ProcessorPipeline":10,"./messages":13}],13:[function(a,b,c){"use strict";c.messageIds={configure:"pipeline/configure",flush:"pipeline/flush",process:"pipeline/process",emit:"pipeline/emit",release:"pipeline/release"},Object.freeze(c.messageIds)},{}],14:[function(a,b,c){"use strict";var d=(a("./RGBASurfaceInterface"),function(){function a(){this._height=0,this._width=0,this._buffer=null}return a.prototype.replaceUnderlyingBuffer=function(a,b,c){if(a*b*4!==c.byteLength)throw new Error("surface size mismatch");return this._width=a,this._height=b,this._underlyingBuffer=c,this._buffer=new Uint32Array(this._underlyingBuffer),this},a.prototype.getUnderlyingBuffer=function(){return this._underlyingBuffer},a.prototype.resetUnderlyingBuffer=function(){return this._width=this._height=0,this._underlyingBuffer=this._buffer=null,this},a.prototype.getWidth=function(){return this._width},a.prototype.getHeight=function(){return this._height},a.prototype.getBuffer=function(){return this._buffer},a.prototype.getByteOrder=function(){return 0},a.prototype.fill=function(a){for(var b=0;b<this._buffer.length;b++)this._buffer[b]=a;return this},a.createFromArrayBuffer=function(b,c,d){return(new a).replaceUnderlyingBuffer(b,c,d)},a}());Object.defineProperty(c,"__esModule",{value:!0}),c.default=d},{"./RGBASurfaceInterface":15}],15:[function(a,b,c){"use strict";var d;!function(a){var b;!function(a){a[a.rgba=0]="rgba"}(b=a.ByteOrder||(a.ByteOrder={}))}(d||(d={})),Object.defineProperty(c,"__esModule",{value:!0}),c.default=d},{}],16:[function(a,b,c){"use strict";var d=a("../rpc"),e=a("../../../src/video/processing/worker/PipelineHost");c.pipelineHost=new e.default(d.getRpc())},{"../../../src/video/processing/worker/PipelineHost":12,"../rpc":17}],17:[function(a,b,c){"use strict";function d(a,b){h?h.postMessage(a,b):postMessage(a,b),i&&(h=i,h.onmessage=function(a){return g.dispatch(a.data)}),i=null}function e(){return g}var f=a("worker-rpc"),g=null,h=null,i=null;g=new f.RpcProvider(d),g.error.addHandler(function(a){console.log(a?a.message:"unknown rpc error")}),onmessage=function(a){return h||g.dispatch(a.data)},g.registerRpcHandler("/use-port",function(a){return h||i?Promise.reject("RPC already switched to message port"):(i=a,Promise.resolve())}),c.getRpc=e},{"worker-rpc":4}]},{},[16]);
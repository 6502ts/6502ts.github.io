!function e(t,r,n){function i(o,a){if(!r[o]){if(!t[o]){var c="function"==typeof require&&require;if(!a&&c)return c(o,!0);if(s)return s(o,!0);var u=new Error("Cannot find module '"+o+"'");throw u.code="MODULE_NOT_FOUND",u}var p=r[o]={exports:{}};t[o][0].call(p.exports,function(e){var r=t[o][1][e];return i(r||e)},p,p.exports,e,t,r,n)}return r[o].exports}for(var s="function"==typeof require&&require,o=0;o<n.length;o++)i(n[o]);return i}({1:[function(e,t,r){"use strict";function n(e){return s[e]||(s[e]=i(e)),s[e]}function i(e){for(var t="return function dispatcher"+e+"(payload) {\n",r=[],n=[],i=0;i<e;i++)r.push("cb"+i),n.push("ctx"+i),t+="    cb"+i+"(payload, ctx"+i+");\n";return t+="};",new(Function.bind.apply(Function,[void 0].concat(r.concat(n),[t])))}var s=[];s[0]=function(){return function(){}},s[1]=function(e,t){return void 0===t?e:function(r){e(r,t)}};var o=function(){function e(){this.hasHandlers=!1,this._handlers=[],this._contexts=[],this._createDispatcher()}return e.prototype.addHandler=function(e,t){return this.isHandlerAttached(e,t)||(this._handlers.push(e),this._contexts.push(t),this._createDispatcher(),this._updateHasHandlers()),this},e.prototype.removeHandler=function(e,t){var r=this._getHandlerIndex(e,t);return void 0!==r&&(this._handlers.splice(r,1),this._contexts.splice(r,1),this._createDispatcher(),this._updateHasHandlers()),this},e.prototype.isHandlerAttached=function(e,t){return void 0!==this._getHandlerIndex(e,t)},e.prototype._updateHasHandlers=function(){this.hasHandlers=!!this._handlers.length},e.prototype._getHandlerIndex=function(e,t){var r,n=this._handlers.length;for(r=0;r<n&&(this._handlers[r]!==e||this._contexts[r]!==t);r++);return r<n?r:void 0},e.prototype._createDispatcher=function(){this.dispatch=n(this._handlers.length).apply(this,this._handlers.concat(this._contexts))},e}();Object.defineProperty(r,"__esModule",{value:!0}),r.default=o},{}],2:[function(e,t,r){"use strict";var n=e("./Event");r.Event=n.default},{"./Event":1}],3:[function(e,t,r){"use strict";var n,i=e("microevent.ts");!function(e){!function(e){e[e.signal=0]="signal",e[e.rpc=1]="rpc",e[e.internal=2]="internal"}(e.MessageType||(e.MessageType={}));e.MessageType}((n=function(){function e(e,t){void 0===t&&(t=0),this._dispatch=e,this._rpcTimeout=t,this.error=new i.Event,this._rpcHandlers={},this._signalHandlers={},this._pendingTransactions={},this._nextTransactionId=0}return e.prototype.dispatch=function(t){var r=t;switch(r.type){case e.MessageType.signal:return this._handleSignal(r);case e.MessageType.rpc:return this._handeRpc(r);case e.MessageType.internal:return this._handleInternal(r);default:this._raiseError("invalid message type "+r.type)}},e.prototype.rpc=function(t,r,n){var i=this,s=this._nextTransactionId++;return this._dispatch({type:e.MessageType.rpc,transactionId:s,id:t,payload:r},n||void 0),new Promise(function(e,t){var r=i._pendingTransactions[s]={id:s,resolve:e,reject:t};i._rpcTimeout>0&&(i._pendingTransactions[s].timeoutHandle=setTimeout(function(){return i._transactionTimeout(r)},i._rpcTimeout))})},e.prototype.signal=function(t,r,n){return this._dispatch({type:e.MessageType.signal,id:t,payload:r},n||void 0),this},e.prototype.registerRpcHandler=function(e,t){if(this._rpcHandlers[e])throw new Error("rpc handler for "+e+" already registered");return this._rpcHandlers[e]=t,this},e.prototype.registerSignalHandler=function(e,t){return this._signalHandlers[e]||(this._signalHandlers[e]=[]),this._signalHandlers[e].push(t),this},e.prototype.deregisterRpcHandler=function(e,t){return this._rpcHandlers[e]&&delete this._rpcHandlers[e],this},e.prototype.deregisterSignalHandler=function(e,t){return this._signalHandlers[e]&&(this._signalHandlers[e]=this._signalHandlers[e].filter(function(e){return t!==e})),this},e.prototype._raiseError=function(t){this.error.dispatch(new Error(t)),this._dispatch({type:e.MessageType.internal,id:"error",payload:t})},e.prototype._handleSignal=function(e){if(!this._signalHandlers[e.id])return this._raiseError("invalid signal "+e.id);this._signalHandlers[e.id].forEach(function(t){return t(e.payload)})},e.prototype._handeRpc=function(t){var r=this;if(!this._rpcHandlers[t.id])return this._raiseError("invalid rpc "+t.id);Promise.resolve(this._rpcHandlers[t.id](t.payload)).then(function(n){return r._dispatch({type:e.MessageType.internal,id:"resolve_transaction",transactionId:t.transactionId,payload:n})},function(n){return r._dispatch({type:e.MessageType.internal,id:"reject_transaction",transactionId:t.transactionId,payload:n})})},e.prototype._handleInternal=function(e){switch(e.id){case"resolve_transaction":if(!this._pendingTransactions[e.transactionId])return this._raiseError("no pending transaction with id "+e.transactionId);this._pendingTransactions[e.transactionId].resolve(e.payload),this._clearTransaction(this._pendingTransactions[e.transactionId]);break;case"reject_transaction":if(!this._pendingTransactions[e.transactionId])return this._raiseError("no pending transaction with id "+e.transactionId);this._pendingTransactions[e.transactionId].reject(e.payload),this._clearTransaction(this._pendingTransactions[e.transactionId]);break;case"error":this.error.dispatch(new Error("remote error: "+e.payload));break;default:this._raiseError("unhandled internal message "+e.id)}},e.prototype._transactionTimeout=function(e){e.reject("transaction timed out"),this._raiseError("transaction "+e.id+" timed out"),delete this._pendingTransactions[e.id]},e.prototype._clearTransaction=function(e){void 0!==e.timeoutHandle&&clearTimeout(e.timeoutHandle),delete this._pendingTransactions[e.id]},e}())||(n={})),Object.defineProperty(r,"__esModule",{value:!0}),r.default=n},{"microevent.ts":2}],4:[function(e,t,r){"use strict";var n=e("./RpcProvider");r.RpcProvider=n.default},{"./RpcProvider":3}],5:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n=e("microevent.ts"),i=e("./PoolMember"),s=function(){function e(e){this._factory=e,this.event={release:new n.Event,dispose:new n.Event},this._pool=[],this._poolSize=0}return e.prototype.get=function(){var e,t=this;if(0===this._poolSize){var r=this._factory();e=new i.default(r,function(e){return t._releaseMember(e)},function(e){return t._disposeMember(e)})}else(e=this._pool[--this._poolSize])._isAvailable=!1;return e},e.prototype._releaseMember=function(e){if(e._isAvailable)throw new Error("Trying to release an already released pool member");if(e._isDisposed)throw new Error("Trying to release an already disposed pool member");var t=this._poolSize++;this._pool[t]=e,e._isAvailable=!0,e._poolPosition=t,this.event.release.dispatch(e.get())},e.prototype._disposeMember=function(e){if(e._isDisposed)throw new Error("Trying to dispose of an already disposed pool member");e._isAvailable&&(this._poolSize>1&&(this._pool[e._poolPosition]=this._pool[this._poolSize-1]),this._poolSize--),e._isDisposed=!0,this.event.dispose.dispatch(e.get())},e}();r.default=s},{"./PoolMember":6,"microevent.ts":2}],6:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t,r){this._value=e,this._releaseCB=t,this._disposeCB=r,this._isAvailable=!1,this._isDisposed=!1}return e.prototype.adopt=function(e){this._value=e},e.prototype.get=function(){return this._value},e.prototype.release=function(){this._releaseCB(this)},e.prototype.dispose=function(){this._disposeCB(this)},e}();r.default=n},{}],7:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n=e("microevent.ts"),i=function(){function e(){this.emit=new n.Event,this._framesOnHold=new Array(2),this._nFramesOnHold=0,this._width=0,this._height=0}return e.prototype.init=function(e,t){this.flush(),this._width=e,this._height=t},e.prototype.flush=function(){for(var e=0;e<this._nFramesOnHold;e++)this._framesOnHold[e].release(),this._framesOnHold[e]=null;this._nFramesOnHold=0},e.prototype.processSurface=function(e){var t=e.get();if(t.getHeight()!==this._height||t.getWidth()!==this._width)throw new Error("surface dimensions do not match");this._framesOnHold[this._nFramesOnHold++]=e,2===this._nFramesOnHold&&this._process()},e.prototype._process=function(){for(var e=this._framesOnHold[0].get().getBuffer(),t=this._framesOnHold[1].get().getBuffer(),r=0;r<this._width*this._height;r++)e[r]=4278190080|(16711680&e[r])+(16711680&t[r])>>>1&16711680|(65280&e[r])+(65280&t[r])>>>1&65280|(255&e[r])+(255&t[r])>>>1&255;this.emit.dispatch(this._framesOnHold[0]),this._framesOnHold[1].release(),this._nFramesOnHold=0},e}();r.default=i},{"microevent.ts":2}],8:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n=e("microevent.ts"),i=function(){function e(){this.emit=new n.Event}return e.prototype.init=function(){},e.prototype.flush=function(){},e.prototype.processSurface=function(e){this.emit.dispatch(e)},e}();r.default=i},{"microevent.ts":2}],9:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});e("./config");var n=e("./PassthroughProcessor"),i=e("./FrameMergeProcessor"),s=function(){function e(){}return e.prototype.create=function(e){switch(e.type){case 0:return new n.default;case 1:return new i.default;default:throw new Error("cannot happen: invalid processor type")}},e}();r.default=s},{"./FrameMergeProcessor":7,"./PassthroughProcessor":8,"./config":11}],10:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n=e("./ProcessorFactory"),i=function(){function e(e){var t=this;e&&0!==e.length||(e=[{type:0}]);var r=new n.default;this._processors=e.map(function(e){return r.create(e)});for(var i=this,s=1;s<this._processors.length;s++)!function(e){i._processors[e-1].emit.addHandler(function(r){return t._processors[e].processSurface(r)})}(s);this.emit=this._processors[this._processors.length-1].emit}return e.prototype.init=function(e,t){this._processors.forEach(function(r){return r.init(e,t)})},e.prototype.flush=function(){this._processors.forEach(function(e){return e.flush()})},e.prototype.processSurface=function(e){this._processors[0].processSurface(e)},e}();r.default=i},{"./ProcessorFactory":9}],11:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});!function(e){e[e.passthrough=0]="passthrough",e[e.merge=1]="merge"}(r.Type||(r.Type={}))},{}],12:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n=e("../../surface/ArrayBufferSurface"),i=e("../../../tools/pool/Pool"),s=e("./messages"),o=e("../ProcessorPipeline"),a=function(){function e(t){this._rpc=t,this._pipeline=null,this._surfacePool=new i.default(function(){return new n.default}),this._bufferIds=new WeakMap,this._rpc.registerRpcHandler(s.messageIds.configure,this._onConfigure.bind(this)).registerRpcHandler(s.messageIds.flush,this._onFlush.bind(this)).registerSignalHandler(s.messageIds.process,this._onProcess.bind(this)),this._surfacePool.event.release.addHandler(e._onReleaseSurface,this)}return e._onReleaseSurface=function(e,t){var r=e.getUnderlyingBuffer();if(r){if(!t._bufferIds.has(r))throw new Error("double release");var n=t._bufferIds.get(r);t._bufferIds.delete(r),t._rpc.signal(s.messageIds.release,{id:n,buffer:r},[r])}},e._onEmitSurface=function(e,t){var r=e.get().getUnderlyingBuffer();if(!t._bufferIds.has(r))throw new Error("double release");var n=t._bufferIds.get(r);t._bufferIds.delete(r),t._rpc.signal(s.messageIds.emit,{id:n,buffer:r},[r]),e.get().resetUnderlyingBuffer(),e.release()},e.prototype._onConfigure=function(t){this._pipeline&&(this._pipeline.flush(),this._pipeline.emit.removeHandler(e._onEmitSurface,this)),this._pipeline=new o.default(t.config),this._pipeline.init(t.width,t.height),this._pipeline.emit.addHandler(e._onEmitSurface,this)},e.prototype._onFlush=function(e){this._pipeline&&this._pipeline.flush()},e.prototype._onProcess=function(e){if(this._pipeline){this._bufferIds.set(e.buffer,e.id);var t=this._surfacePool.get();t.get().replaceUnderlyingBuffer(e.width,e.height,e.buffer),this._pipeline.processSurface(t)}},e}();r.default=a},{"../../../tools/pool/Pool":5,"../../surface/ArrayBufferSurface":14,"../ProcessorPipeline":10,"./messages":13}],13:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.messageIds={configure:"pipeline/configure",flush:"pipeline/flush",process:"pipeline/process",emit:"pipeline/emit",release:"pipeline/release"},Object.freeze(r.messageIds)},{}],14:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(){this._height=0,this._width=0,this._buffer=null}return e.createFromArrayBuffer=function(t,r,n){return(new e).replaceUnderlyingBuffer(t,r,n)},e.prototype.replaceUnderlyingBuffer=function(e,t,r){if(e*t*4!==r.byteLength)throw new Error("surface size mismatch");return this._width=e,this._height=t,this._underlyingBuffer=r,this._buffer=new Uint32Array(this._underlyingBuffer),this},e.prototype.getUnderlyingBuffer=function(){return this._underlyingBuffer},e.prototype.resetUnderlyingBuffer=function(){return this._width=this._height=0,this._underlyingBuffer=this._buffer=null,this},e.prototype.getWidth=function(){return this._width},e.prototype.getHeight=function(){return this._height},e.prototype.getBuffer=function(){return this._buffer},e.prototype.getByteOrder=function(){return 0},e.prototype.fill=function(e){for(var t=0;t<this._buffer.length;t++)this._buffer[t]=e;return this},e}();r.default=n},{}],15:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n=e("../rpc"),i=e("../../../src/video/processing/worker/PipelineHost");r.pipelineHost=new i.default(n.getRpc())},{"../../../src/video/processing/worker/PipelineHost":12,"../rpc":16}],16:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n=e("worker-rpc"),i=null,s=null,o=null;(i=new n.RpcProvider(function(e,t){s?s.postMessage(e,t):postMessage(e,t),o&&((s=o).onmessage=function(e){return i.dispatch(e.data)}),o=null})).error.addHandler(function(e){console.log(e?e.message:"unknown rpc error")}),onmessage=function(e){return s||i.dispatch(e.data)},i.registerRpcHandler("/use-port",function(e){return s||o?Promise.reject("RPC already switched to message port"):(o=e,Promise.resolve())}),r.getRpc=function(){return i}},{"worker-rpc":4}]},{},[15]);
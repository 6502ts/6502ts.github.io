!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).$6502=t()}}(function(){return function t(e,n,i){function r(s,a){if(!n[s]){if(!e[s]){var u="function"==typeof require&&require;if(!a&&u)return u(s,!0);if(o)return o(s,!0);var c=new Error("Cannot find module '"+s+"'");throw c.code="MODULE_NOT_FOUND",c}var h=n[s]={exports:{}};e[s][0].call(h.exports,function(t){var n=e[s][1][t];return r(n||t)},h,h.exports,t,e,n,i)}return n[s].exports}for(var o="function"==typeof require&&require,s=0;s<i.length;s++)r(i[s]);return r}({1:[function(t,e,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function t(){this._queue=[],this._pending=!1}return t.prototype.isLocked=function(){return this._pending},t.prototype.acquire=function(){var t=this,e=new Promise(function(e){return t._queue.push(e)});return this._pending||this._dispatchNext(),e},t.prototype.runExclusive=function(t){return this.acquire().then(function(e){var n;try{n=t()}catch(t){throw e(),t}return Promise.resolve(n).then(function(t){return e(),t},function(t){throw e(),t})})},t.prototype._dispatchNext=function(){this._queue.length>0?(this._pending=!0,this._queue.shift()(this._dispatchNext.bind(this))):this._pending=!1},t}();n.default=i},{}],2:[function(t,e,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=t("./Mutex");n.Mutex=i.default},{"./Mutex":1}],3:[function(t,e,n){"use strict";var i=[];i[0]=function(){return function(){}},i[1]=function(t,e){return void 0===e?t:function(n){t(n,e)}};var r=function(){function t(){this.hasHandlers=!1,this._handlers=[],this._contexts=[],this._createDispatcher()}return t.prototype.addHandler=function(t,e){return this.isHandlerAttached(t,e)||(this._handlers.push(t),this._contexts.push(e),this._createDispatcher(),this._updateHasHandlers()),this},t.prototype.removeHandler=function(t,e){var n=this._getHandlerIndex(t,e);return void 0!==n&&(this._handlers.splice(n,1),this._contexts.splice(n,1),this._createDispatcher(),this._updateHasHandlers()),this},t.prototype.isHandlerAttached=function(t,e){return void 0!==this._getHandlerIndex(t,e)},t.prototype._updateHasHandlers=function(){this.hasHandlers=!!this._handlers.length},t.prototype._getHandlerIndex=function(t,e){var n,i=this._handlers.length;for(n=0;n<i&&(this._handlers[n]!==t||this._contexts[n]!==e);n++);return n<i?n:void 0},t.prototype._createDispatcher=function(){this.dispatch=function(t){return i[t]||(i[t]=function(t){for(var e="return function dispatcher"+t+"(payload) {\n",n=[],i=[],r=0;r<t;r++)n.push("cb"+r),i.push("ctx"+r),e+="    cb"+r+"(payload, ctx"+r+");\n";return e+="};",new(Function.bind.apply(Function,[void 0].concat(n.concat(i),[e])))}(t)),i[t]}(this._handlers.length).apply(this,this._handlers.concat(this._contexts))},t}();Object.defineProperty(n,"__esModule",{value:!0}),n.default=r},{}],4:[function(t,e,n){"use strict";var i=t("./Event");n.Event=i.default},{"./Event":3}],5:[function(t,e,n){!function(){"use strict";var t="undefined"!=typeof window&&void 0!==window.document?window.document:{},n=void 0!==e&&e.exports,i="undefined"!=typeof Element&&"ALLOW_KEYBOARD_INPUT"in Element,r=function(){for(var e,n=[["requestFullscreen","exitFullscreen","fullscreenElement","fullscreenEnabled","fullscreenchange","fullscreenerror"],["webkitRequestFullscreen","webkitExitFullscreen","webkitFullscreenElement","webkitFullscreenEnabled","webkitfullscreenchange","webkitfullscreenerror"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitCurrentFullScreenElement","webkitCancelFullScreen","webkitfullscreenchange","webkitfullscreenerror"],["mozRequestFullScreen","mozCancelFullScreen","mozFullScreenElement","mozFullScreenEnabled","mozfullscreenchange","mozfullscreenerror"],["msRequestFullscreen","msExitFullscreen","msFullscreenElement","msFullscreenEnabled","MSFullscreenChange","MSFullscreenError"]],i=0,r=n.length,o={};i<r;i++)if((e=n[i])&&e[1]in t){for(i=0;i<e.length;i++)o[n[0][i]]=e[i];return o}return!1}(),o={change:r.fullscreenchange,error:r.fullscreenerror},s={request:function(e){var n=r.requestFullscreen;e=e||t.documentElement,/5\.1[.\d]* Safari/.test(navigator.userAgent)?e[n]():e[n](i&&Element.ALLOW_KEYBOARD_INPUT)},exit:function(){t[r.exitFullscreen]()},toggle:function(t){this.isFullscreen?this.exit():this.request(t)},onchange:function(t){this.on("change",t)},onerror:function(t){this.on("error",t)},on:function(e,n){var i=o[e];i&&t.addEventListener(i,n,!1)},off:function(e,n){var i=o[e];i&&t.removeEventListener(i,n,!1)},raw:r};r?(Object.defineProperties(s,{isFullscreen:{get:function(){return Boolean(t[r.fullscreenElement])}},element:{enumerable:!0,get:function(){return t[r.fullscreenElement]}},enabled:{enumerable:!0,get:function(){return Boolean(t[r.fullscreenEnabled])}}}),n?e.exports=s:window.screenfull=s):n?e.exports=!1:window.screenfull=!1}()},{}],6:[function(t,e,n){(function(t){var n,i,r,o,s,a,u,c,h,l,_,d,p,f,g,m,v;!function(n){function i(t,e){return"function"==typeof Object.create?Object.defineProperty(t,"__esModule",{value:!0}):t.__esModule=!0,function(n,i){return t[n]=e?e(n,i):i}}var r="object"==typeof t?t:"object"==typeof self?self:"object"==typeof this?this:{};n("object"==typeof e&&"object"==typeof e.exports?i(r,i(e.exports)):i(r))}(function(t){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};n=function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)},i=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++){e=arguments[n];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])}return t},r=function(t,e){var n={};for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&e.indexOf(i)<0&&(n[i]=t[i]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols)for(var r=0,i=Object.getOwnPropertySymbols(t);r<i.length;r++)e.indexOf(i[r])<0&&(n[i[r]]=t[i[r]]);return n},o=function(t,e,n,i){var r,o=arguments.length,s=o<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,n,i);else for(var a=t.length-1;a>=0;a--)(r=t[a])&&(s=(o<3?r(s):o>3?r(e,n,s):r(e,n))||s);return o>3&&s&&Object.defineProperty(e,n,s),s},s=function(t,e){return function(n,i){e(n,i,t)}},a=function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},u=function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(function(t){try{s(i.next(t))}catch(t){o(t)}},function(t){try{s(i.throw(t))}catch(t){o(t)}})}s((i=i.apply(t,e||[])).next())})},c=function(t,e){function n(n){return function(s){return function(n){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,r&&(o=r[2&n[0]?"return":n[0]?"throw":"next"])&&!(o=o.call(r,n[1])).done)return o;switch(r=0,o&&(n=[0,o.value]),n[0]){case 0:case 1:o=n;break;case 4:return a.label++,{value:n[1],done:!1};case 5:a.label++,r=n[1],n=[0];continue;case 7:n=a.ops.pop(),a.trys.pop();continue;default:if(o=a.trys,!(o=o.length>0&&o[o.length-1])&&(6===n[0]||2===n[0])){a=0;continue}if(3===n[0]&&(!o||n[1]>o[0]&&n[1]<o[3])){a.label=n[1];break}if(6===n[0]&&a.label<o[1]){a.label=o[1],o=n;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(n);break}o[2]&&a.ops.pop(),a.trys.pop();continue}n=e.call(t,a)}catch(t){n=[6,t],r=0}finally{i=o=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}([n,s])}}var i,r,o,s,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s},h=function(t,e){for(var n in t)e.hasOwnProperty(n)||(e[n]=t[n])},l=function(t){var e="function"==typeof Symbol&&t[Symbol.iterator],n=0;return e?e.call(t):{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}}},_=function(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var i,r,o=n.call(t),s=[];try{for(;(void 0===e||e-- >0)&&!(i=o.next()).done;)s.push(i.value)}catch(t){r={error:t}}finally{try{i&&!i.done&&(n=o.return)&&n.call(o)}finally{if(r)throw r.error}}return s},d=function(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(_(arguments[e]));return t},p=function(t){return this instanceof p?(this.v=t,this):new p(t)},f=function(t,e,n){function i(t){a[t]&&(s[t]=function(e){return new Promise(function(n,i){u.push([t,e,n,i])>1||r(t,e)})})}function r(t,e){try{!function(t){t.value instanceof p?Promise.resolve(t.value.v).then(function(t){r("next",t)},function(t){r("throw",t)}):o(u[0][2],t)}(a[t](e))}catch(t){o(u[0][3],t)}}function o(t,e){t(e),u.shift(),u.length&&r(u[0][0],u[0][1])}if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var s,a=n.apply(t,e||[]),u=[];return s={},i("next"),i("throw"),i("return"),s[Symbol.asyncIterator]=function(){return this},s},g=function(t){function e(e,r){t[e]&&(n[e]=function(n){return(i=!i)?{value:p(t[e](n)),done:"return"===e}:r?r(n):n})}var n,i;return n={},e("next"),e("throw",function(t){throw t}),e("return"),n[Symbol.iterator]=function(){return this},n},m=function(t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e=t[Symbol.asyncIterator];return e?e.call(t):"function"==typeof l?l(t):t[Symbol.iterator]()},v=function(t,e){return Object.defineProperty?Object.defineProperty(t,"raw",{value:e}):t.raw=e,t},t("__extends",n),t("__assign",i),t("__rest",r),t("__decorate",o),t("__param",s),t("__metadata",a),t("__awaiter",u),t("__generator",c),t("__exportStar",h),t("__values",l),t("__read",_),t("__spread",d),t("__await",p),t("__asyncGenerator",f),t("__asyncDelegator",g),t("__asyncValues",m),t("__makeTemplateObject",v)})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],7:[function(t,e,n){"use strict";var i,r=t("microevent.ts");!function(t){!function(t){t[t.signal=0]="signal",t[t.rpc=1]="rpc",t[t.internal=2]="internal"}(t.MessageType||(t.MessageType={}));t.MessageType}((i=function(){function t(t,e){void 0===e&&(e=0),this._dispatch=t,this._rpcTimeout=e,this.error=new r.Event,this._rpcHandlers={},this._signalHandlers={},this._pendingTransactions={},this._nextTransactionId=0}return t.prototype.dispatch=function(e){var n=e;switch(n.type){case t.MessageType.signal:return this._handleSignal(n);case t.MessageType.rpc:return this._handeRpc(n);case t.MessageType.internal:return this._handleInternal(n);default:this._raiseError("invalid message type "+n.type)}},t.prototype.rpc=function(e,n,i){var r=this,o=this._nextTransactionId++;return this._dispatch({type:t.MessageType.rpc,transactionId:o,id:e,payload:n},i||void 0),new Promise(function(t,e){var n=r._pendingTransactions[o]={id:o,resolve:t,reject:e};r._rpcTimeout>0&&(r._pendingTransactions[o].timeoutHandle=setTimeout(function(){return r._transactionTimeout(n)},r._rpcTimeout))})},t.prototype.signal=function(e,n,i){return this._dispatch({type:t.MessageType.signal,id:e,payload:n},i||void 0),this},t.prototype.registerRpcHandler=function(t,e){if(this._rpcHandlers[t])throw new Error("rpc handler for "+t+" already registered");return this._rpcHandlers[t]=e,this},t.prototype.registerSignalHandler=function(t,e){return this._signalHandlers[t]||(this._signalHandlers[t]=[]),this._signalHandlers[t].push(e),this},t.prototype.deregisterRpcHandler=function(t,e){return this._rpcHandlers[t]&&delete this._rpcHandlers[t],this},t.prototype.deregisterSignalHandler=function(t,e){return this._signalHandlers[t]&&(this._signalHandlers[t]=this._signalHandlers[t].filter(function(t){return e!==t})),this},t.prototype._raiseError=function(e){this.error.dispatch(new Error(e)),this._dispatch({type:t.MessageType.internal,id:"error",payload:e})},t.prototype._handleSignal=function(t){if(!this._signalHandlers[t.id])return this._raiseError("invalid signal "+t.id);this._signalHandlers[t.id].forEach(function(e){return e(t.payload)})},t.prototype._handeRpc=function(e){var n=this;if(!this._rpcHandlers[e.id])return this._raiseError("invalid rpc "+e.id);Promise.resolve(this._rpcHandlers[e.id](e.payload)).then(function(i){return n._dispatch({type:t.MessageType.internal,id:"resolve_transaction",transactionId:e.transactionId,payload:i})},function(i){return n._dispatch({type:t.MessageType.internal,id:"reject_transaction",transactionId:e.transactionId,payload:i})})},t.prototype._handleInternal=function(t){switch(t.id){case"resolve_transaction":if(!this._pendingTransactions[t.transactionId])return this._raiseError("no pending transaction with id "+t.transactionId);this._pendingTransactions[t.transactionId].resolve(t.payload),this._clearTransaction(this._pendingTransactions[t.transactionId]);break;case"reject_transaction":if(!this._pendingTransactions[t.transactionId])return this._raiseError("no pending transaction with id "+t.transactionId);this._pendingTransactions[t.transactionId].reject(t.payload),this._clearTransaction(this._pendingTransactions[t.transactionId]);break;case"error":this.error.dispatch(new Error("remote error: "+t.payload));break;default:this._raiseError("unhandled internal message "+t.id)}},t.prototype._transactionTimeout=function(t){t.reject("transaction timed out"),this._raiseError("transaction "+t.id+" timed out"),delete this._pendingTransactions[t.id]},t.prototype._clearTransaction=function(t){void 0!==t.timeoutHandle&&clearTimeout(t.timeoutHandle),delete this._pendingTransactions[t.id]},t}())||(i={})),Object.defineProperty(n,"__esModule",{value:!0}),n.default=i},{"microevent.ts":4}],8:[function(t,e,n){"use strict";var i=t("./RpcProvider");n.RpcProvider=i.default},{"./RpcProvider":7}],9:[function(t,e,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=t("./Switch"),r=function(){function t(){this._left=new i.default,this._right=new i.default,this._up=new i.default,this._down=new i.default,this._fire=new i.default}return t.prototype.getLeft=function(){return this._left},t.prototype.getRight=function(){return this._right},t.prototype.getUp=function(){return this._up},t.prototype.getDown=function(){return this._down},t.prototype.getFire=function(){return this._fire},t}();n.default=r},{"./Switch":11}],10:[function(t,e,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=t("microevent.ts"),r=t("./Switch"),o=function(){function t(){this.valueChanged=new i.Event,this._fireSwitch=new r.default,this._value=.5}return t.prototype.setValue=function(t){this._value=t,this.valueChanged.dispatch(t)},t.prototype.getValue=function(){return this._value},t.prototype.getFire=function(){return this._fireSwitch},t}();n.default=o},{"./Switch":11,"microevent.ts":4}],11:[function(t,e,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=t("microevent.ts"),r=function(){function t(t){void 0===t&&(t=!1),this._state=t,this.stateChanged=new i.Event,this.beforeRead=new i.Event}return t.prototype.read=function(){return this.beforeRead.dispatch(this),this._state},t.prototype.peek=function(){return this._state},t.prototype.toggle=function(t){this._state!==t&&(this._state=t,this.stateChanged.dispatch(t))},t}();n.default=r},{"microevent.ts":4}],12:[function(t,e,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i,r=t("tslib");!function(t){t.create=function(t){return void 0===t&&(t={}),r.__assign({tvMode:0,enableAudio:!0,randomSeed:-1,emulatePaddles:!0,frameStart:-1,pcmAudio:!1},t)},t.getClockHz=function(t){switch(t.tvMode){case 0:return 3584160;case 1:case 2:return 3556800}}}(i||(i={})),n.default=i},{tslib:6}],13:[function(t,e,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=t("../io/Switch"),r=function(){function t(){this._selectSwitch=new i.default,this._resetButton=new i.default,this._colorSwitch=new i.default,this._difficutlyP0=new i.default,this._difficutlyP1=new i.default}return t.prototype.getSelectSwitch=function(){return this._selectSwitch},t.prototype.getResetButton=function(){return this._resetButton},t.prototype.getColorSwitch=function(){return this._colorSwitch},t.prototype.getDifficultySwitchP0=function(){return this._difficutlyP0},t.prototype.getDifficultySwitchP1=function(){return this._difficutlyP1},t}();n.default=r},{"../io/Switch":11}],14:[function(t,e,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i;!function(t){var e;!function(t){t.vanilla_2k="vanilla_2k",t.vanilla_4k="vanilla_4k",t.bankswitch_8k_F8="bankswitch_8k_F8",t.bankswitch_8k_E0="bankswitch_8k_E0",t.bankswitch_8k_3F="bankswitch_8k_3F",t.bankswitch_8k_FE="bankswitch_8k_FE",t.bankswitch_8k_UA="bankswitch_8k_UA",t.bankswitch_8k_DPC="bankswitch_8k_DPC",t.bankswitch_8k_econobanking="bankswitch_8k_econobanking",t.bankswitch_12k_FA="bankswitch_12k_FA",t.bankswitch_16k_F6="bankswitch_16k_F6",t.bankswitch_16k_E7="bankswitch_16k_E7",t.bankswitch_FA2="bankswitch_FA2",t.bankswitch_32k_F4="bankswitch_32k_F4",t.bankswitch_64k_F0="bankswitch_64k_F0",t.bankswitch_64k_EF="bankswitch_64k_EF",t.bankswitch_3E="bankswitch_3E",t.bankswitch_supercharger="bankswitch_supercharger",t.bankswitch_dpc_plus="bankswitch_dpc_plus",t.bankswitch_cdf="bankswitch_cdf",t.unknown="unknown"}(e=t.CartridgeType||(t.CartridgeType={})),t.getAllTypes=function(){return[e.vanilla_2k,e.vanilla_4k,e.bankswitch_8k_F8,e.bankswitch_8k_E0,e.bankswitch_8k_3F,e.bankswitch_8k_FE,e.bankswitch_8k_UA,e.bankswitch_8k_econobanking,e.bankswitch_12k_FA,e.bankswitch_8k_DPC,e.bankswitch_16k_F6,e.bankswitch_16k_E7,e.bankswitch_FA2,e.bankswitch_32k_F4,e.bankswitch_3E,e.bankswitch_64k_F0,e.bankswitch_64k_EF,e.bankswitch_supercharger,e.bankswitch_dpc_plus,e.bankswitch_cdf,e.unknown]},t.describeCartridgeType=function(t){switch(t){case e.vanilla_2k:return"plain 2k";case e.vanilla_4k:return"plain 4k";case e.bankswitch_8k_F8:return"bankswitched 8k, F8 (Atari) scheme";case e.bankswitch_8k_E0:return"bankswitched 8k, E0 (Parker Bros.) scheme";case e.bankswitch_8k_3F:return"bankswitched 8k, 3F (Tigervision) scheme";case e.bankswitch_8k_FE:return"bankswitched 8k, FE (Activision) scheme";case e.bankswitch_8k_UA:return"bankswitched 8k, UA (Pleiades) scheme";case e.bankswitch_12k_FA:return"bankswitched 12k, FA (CBS) scheme";case e.bankswitch_8k_DPC:return"bankswitched 8k + DPC";case e.bankswitch_8k_econobanking:return"bankswitched 8k, econobanking scheme";case e.bankswitch_16k_F6:return"bankswitched 16k, F6 (Atari) scheme";case e.bankswitch_16k_E7:return"bankswitched 16k, E7 (M-Network) scheme";case e.bankswitch_FA2:return"bankswitched 28k/29k, FA2 (modified CBS) scheme";case e.bankswitch_32k_F4:return"bankswitched 32k, F4 (Atari) scheme";case e.bankswitch_3E:return"bankswitched 3E (Tigervision + RAM) scheme";case e.bankswitch_64k_F0:return"bankswitched 64k, F0 (Megaboy) scheme";case e.bankswitch_64k_EF:return"bankswitched 64k, EFSC (Homestar Runner) scheme";case e.bankswitch_supercharger:return"bankswitched supercharger";case e.bankswitch_dpc_plus:return"bankswitched DPC+";case e.bankswitch_cdf:return"bankswitched CDF";case e.unknown:return"unknown"}}}(i||(i={})),n.default=i},{}],15:[function(t,e,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=t("../Config"),r=t("../../../tools/AudioOutputBuffer"),o=t("../../../tools/base64"),s=o.decode("AQEPAQEBAQEBAQEBAwMDAQ=="),a=new Int8Array([1]),u=new Int8Array([1,1]),c=new Int8Array([16,15]),h=o.decode("AQICAQEBBAM="),l=o.decode("AQIBAQICBQQCAQMBAQEBBA=="),_=o.decode("AQQBAwIEAQIDAgEBAQEBAQIEAgEEAQECAgEDAgEDAQEBBAEBAQECAQECBgECAgECAQIBAQIBBgIBAgIBAQEBAgICAgcCAwICAQEBAwIBAQIBAQcBAQMBAQIDAwEBAQICAQECAgQDBQEDAQEFAgEBAQIBAgEDAQIFAQECAQEBBQEBAQEBAQEBBgEBAQIBAQEBBAIBAQMBAwYDAgMBAQIBAgQBAQEDAQEBAQMBAgEEAgIDBAEBBAECAQICAgEBBAMBBAQJBQQBBQMBAQMCAgIBBQECAQEBAgMBAgEBAwQCBQICAQIDAQEBAQECAQMDAwIBAgEBAQEBAwMBAgIDAQMBCA=="),d=o.decode("BQYEBQoFAwcECgYDBgQJBg=="),p=[a,h,h,o.decode("AgMCAQQBBgoCBAIBAQQFCQMDBAEBAQgFBQUEAQEBCAQCCAMDAQEHBAIHBQEDAQcEAQQIAgEDBAcBAwcDAgEGBgICBAUDAgYGAQMDAgUDBwMEAwICAgUJAwEFAwECAgsFAQUDAQECDAUBAgUCAQEMBgECBQECAQoGAwICBAECBgo="),u,u,c,l,_,l,c,a,u,u,c,d],f=function(){function t(t){this._config=t}return t.prototype.setConfig=function(t){this._config=t},t.prototype.getKey=function(t,e){return p[t]===u&&s[t]*(e+1)==1?0:t<<5|e},t.prototype.getBuffer=function(t){for(var e=t>>>5&15,n=31&t,o=p[e],a=0,u=0;u<o.length;u++)a+=o[u];a=a*s[e]*(n+1);for(var c=new Float32Array(a),h=i.default.getClockHz(this._config)/114,l=0,_=0,d=0,f=!0,u=0;u<a;u++)++l===s[e]*(n+1)&&(l=0,++_===o[d]&&(d++,_=0,o.length===d&&(d=0)),f=!(1&d)),c[u]=f?1:-1;return new r.default(c,h)},t}();n.default=f},{"../../../tools/AudioOutputBuffer":16,"../../../tools/base64":18,"../Config":12}],16:[function(t,e,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function t(t,e){this._content=t,this._sampleRate=e}return t.prototype.getLength=function(){return this._content.length},t.prototype.getContent=function(){return this._content},t.prototype.getSampleRate=function(){return this._sampleRate},t.prototype.replaceUnderlyingBuffer=function(t){this._content=t},t}();n.default=i},{}],17:[function(t,e,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function t(t){this._capacity=t,this._size=0,this._index=0,this._buffer=new Array(this._capacity);for(var e=0;e<this._capacity;e++)this._buffer[e]=null}return t.prototype.size=function(){return this._size},t.prototype.pop=function(){if(0!==this._size){var t=this._buffer[this._index];return this._buffer[this._index]=null,this._index=(this._index+1)%this._capacity,this._size--,t}},t.prototype.push=function(t){return this._size===this._capacity&&this.pop(),this._buffer[(this._index+this._size++)%this._capacity]=t,this},t.prototype.forEach=function(t){for(var e=0;e<this._size;e++)t(this._buffer[(this._index+e)%this._capacity]);return this},t.prototype.clear=function(){for(var t=0;t<this._capacity;t++)this._buffer[t]=null;return this._size=0,this._index=0,this},t}();n.default=i},{}],18:[function(t,e,n){"use strict";function i(t,e){var n=r[t.charCodeAt(e)];if(n>63)throw new Error('invalid base64 character "'+t[e]+'" at index '+e);return n}Object.defineProperty(n,"__esModule",{value:!0});var r=new Uint8Array(256);!function(t){var e;for(e=0;e<256;e++)r[e]=255;for(e=0;e<64;e++)r["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charCodeAt(e)]=e;r["=".charCodeAt(0)]=0}(n.__init||(n.__init={})),n.decode=function(t){if(t.length%4!=0)throw new Error("invalid base64 data --- char count mismatch");for(var e=t.length/4,n=3*e-function(t){for(var e=0,n=t.length-1;n>=0&&"="===t[n--];)e++;return e}(t),r=new Uint8Array(n),o=0,s=0;s<e;s++)for(var a=function(t,e){return(i(t,e)<<18)+(i(t,e+1)<<12)+(i(t,e+2)<<6)+i(t,e+3)}(t,4*s),u=0;u<3&&o<n;u++)r[o++]=a>>>8*(2-u)&255;return r}},{}],19:[function(t,e,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=t("microevent.ts"),r=t("./PoolMember"),o=function(){function t(t){this._factory=t,this.event={release:new i.Event,dispose:new i.Event},this._pool=[],this._poolSize=0}return t.prototype.get=function(){var t,e=this;if(0===this._poolSize){var n=this._factory();t=new r.default(n,function(t){return e._releaseMember(t)},function(t){return e._disposeMember(t)})}else(t=this._pool[--this._poolSize])._isAvailable=!1;return t},t.prototype._releaseMember=function(t){if(t._isAvailable)throw new Error("Trying to release an already released pool member");if(t._isDisposed)throw new Error("Trying to release an already disposed pool member");var e=this._poolSize++;this._pool[e]=t,t._isAvailable=!0,t._poolPosition=e,this.event.release.dispatch(t.get())},t.prototype._disposeMember=function(t){if(t._isDisposed)throw new Error("Trying to dispose of an already disposed pool member");t._isAvailable&&(this._poolSize>1&&(this._pool[t._poolPosition]=this._pool[this._poolSize-1]),this._poolSize--),t._isDisposed=!0,this.event.dispose.dispatch(t.get())},t}();n.default=o},{"./PoolMember":20,"microevent.ts":4}],20:[function(t,e,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function t(t,e,n){this._value=t,this._releaseCB=e,this._disposeCB=n,this._isAvailable=!1,this._isDisposed=!1}return t.prototype.adopt=function(t){this._value=t},t.prototype.get=function(){return this._value},t.prototype.release=function(){this._releaseCB(this)},t.prototype.dispose=function(){this._disposeCB(this)},t}();n.default=i},{}],21:[function(t,e,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=t("screenfull"),r=function(){function t(t){this._videoDriver=t,this._resizeListener=this._adjustSizeForFullscreen.bind(this),this._changeListener=this._onChange.bind(this),this._engaged=!1}return t.prototype.engage=function(){this._engaged||(this._engaged=!0,i.on("change",this._changeListener),i.request(this._videoDriver.getCanvas()))},t.prototype.disengage=function(){this._engaged&&i.exit()},t.prototype.toggle=function(){this._engaged?this.disengage():this.engage()},t.prototype.isEngaged=function(){return this._engaged},t.prototype._onChange=function(){i.isFullscreen?(window.addEventListener("resize",this._resizeListener),this._adjustSizeForFullscreen()):(this._resetSize(),window.removeEventListener("resize",this._resizeListener),i.off("change",this._changeListener),this._engaged=!1)},t.prototype._resetSize=function(){var t=this,e=this._videoDriver.getCanvas();e.style.width="",e.style.height="",setTimeout(function(){return t._videoDriver.resize()},0)},t.prototype._adjustSizeForFullscreen=function(){var t=this._videoDriver.getCanvas();this._videoDriver.resize(window.innerWidth,window.innerHeight),t.style.width=window.innerWidth+"px",t.style.height=window.innerHeight+"px"},t}();n.default=r},{screenfull:5}],22:[function(t,e,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=t("tslib"),r=t("microevent.ts"),o=(a={},a.up=[12],a.down=[13],a.left=[14],a.right=[15],a.fire=[0,1,2,3,10,11],a.select=[8],a.start=[9],a),s=function(){function t(){var t=this;this._onGamepadConnect=function(){return t._probeGamepads()},this._onGamepadDisconnect=function(){return t._probeGamepads()},this.gamepadCountChanged=new r.Event,this._bound=!1,this._gamepadCount=0,this._lastPoll=0,this._joysticks=null,this._start=null,this._select=null,this._joysticksShadow=null,this._startShadow=null,this._selectShadow=null}return t.prototype.init=function(){if(!navigator.getGamepads)throw new Error("gamepad API not available");this._probeGamepads(),window.addEventListener("gamepadconnected",this._onGamepadConnect),window.addEventListener("gamepaddisconnected",this._onGamepadDisconnect)},t.prototype.deinit=function(){this.unbind(),window.removeEventListener("gamepadconnected",this._onGamepadConnect),window.removeEventListener("gamepaddisconnected",this._onGamepadDisconnect)},t.prototype.bind=function(e){var n=this,i=e.joysticks,r=void 0===i?null:i,o=e.start,s=void 0===o?null:o,a=e.select,c=void 0===a?null:a;this._bound||(this._joysticks=r||[],this._start=s,this._select=c,this._bound=!0,this._joysticksShadow=this._joysticks.map(function(t){return function(){return t={},t.left=new u,t.right=new u,t.up=new u,t.down=new u,t.fire=new u,t;var t}()}),this._startShadow=this._start?new u:null,this._selectShadow=this._select?new u:null,this._controlledSwitches().forEach(function(e){return e.beforeRead.addHandler(t._onBeforeSwitchRead,n)}),this._initShadows())},t.prototype.unbind=function(){var e=this;this._bound&&(this._controlledSwitches().forEach(function(n){return n.beforeRead.removeHandler(t._onBeforeSwitchRead,e)}),this._joysticks=this._start=this._select=null,this._bound=!1)},t.prototype.getGamepadCount=function(){return this._gamepadCount},t._onBeforeSwitchRead=function(t,e){var n=Date.now();if(!(0===e._gamepadCount||n-e._lastPoll<50)){e._lastPoll=n;for(var i=0,r=0,s=!1,a=!1,u=navigator.getGamepads(),c=0;c<u.length;c++){var h=u[c];h&&(i++,e._updateJoystickState(h,r++),s=s||e._readState(o.start,h),a=a||e._readState(o.select,h))}i>0&&(e._start&&e._startShadow.toggle(s),e._select&&e._selectShadow.toggle(a)),e._syncShadows()}},t.prototype._controlledSwitches=function(){var t=[];try{for(var e=i.__values(this._joysticks),n=e.next();!n.done;n=e.next()){var r=n.value;t.push(r.getLeft(),r.getRight(),r.getUp(),r.getDown(),r.getFire())}}catch(t){o={error:t}}finally{try{n&&!n.done&&(s=e.return)&&s.call(e)}finally{if(o)throw o.error}}return this._select&&t.push(this._select),this._start&&t.push(this._start),t;var o,s},t.prototype._readState=function(t,e){for(var n=!1,i=0;i<t.length;i++){var r=e.buttons[t[i]];n=n||("object"==typeof r?r.pressed:r>=.5)}return n},t.prototype._updateJoystickState=function(t,e){if(this._joysticks&&!(e>=this._joysticks.length)){var n=this._joysticksShadow[e];n.left.toggle(this._readState(o.left,t)),n.right.toggle(this._readState(o.right,t)),n.up.toggle(this._readState(o.up,t)),n.down.toggle(this._readState(o.down,t)),n.fire.toggle(this._readState(o.fire,t)),(t.axes[0]<-.5||t.axes[2]<-.5)&&n.left.toggle(!0),(t.axes[0]>.5||t.axes[2]>.5)&&n.right.toggle(!0),(t.axes[1]<-.5||t.axes[3]<-.5)&&n.up.toggle(!0),(t.axes[1]>.5||t.axes[3]>.5)&&n.down.toggle(!0)}},t.prototype._initShadows=function(){if(this._joysticks)for(var t=0;t<this._joysticks.length;t++){var e=this._joysticks[t],n=this._joysticksShadow[t];n.left.setState(e.getLeft().peek()),n.right.setState(e.getRight().peek()),n.up.setState(e.getUp().peek()),n.down.setState(e.getDown().peek()),n.fire.setState(e.getFire().peek())}this._start&&this._startShadow.setState(this._start.peek()),this._select&&this._selectShadow.setState(this._select.peek())},t.prototype._syncShadows=function(){if(this._joysticks)for(var t=0;t<this._joysticks.length;t++){var e=this._joysticks[t],n=this._joysticksShadow[t];n.left.sync(e.getLeft()),n.right.sync(e.getRight()),n.up.sync(e.getUp()),n.down.sync(e.getDown()),n.fire.sync(e.getFire())}this._start&&this._startShadow.sync(this._start),this._select&&this._selectShadow.sync(this._select)},t.prototype._probeGamepads=function(){for(var t=0,e=navigator.getGamepads(),n=0;n<e.length;n++)e[n]&&t++;t!==this._gamepadCount&&(this._gamepadCount=t,this.gamepadCountChanged.dispatch(this._gamepadCount))},t}();n.default=s;var a,u=function(){function t(){this._state=!1,this._dirty=!1}return t.prototype.toggle=function(t){t!==this._state&&(this._state=t,this._dirty=!0)},t.prototype.setState=function(t){this._state=t,this._dirty=!1},t.prototype.sync=function(t){this._dirty&&(t.toggle(this._state),this._dirty=!1)},t}()},{"microevent.ts":4,tslib:6}],23:[function(t,e,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function t(){this._x=-1,this._listener=this._onDocumentMouseMove.bind(this)}return t.prototype.bind=function(t){this._paddle||(this._paddle=t,this._x=-1,document.addEventListener("mousemove",this._listener))},t.prototype.unbind=function(){this._paddle&&(document.removeEventListener("mousemove",this._listener),this._paddle=null)},t.prototype._onDocumentMouseMove=function(t){if(this._x>=0){var e=t.screenX-this._x,n=this._paddle.getValue();(n+=-e/window.innerWidth/.9)<0&&(n=0),n>1&&(n=1),this._paddle.setValue(n)}this._x=t.screenX},t}();n.default=i},{}],24:[function(t,e,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=t("tslib"),r=["imageSmoothingEnabled","mozImageSmoothingEnabled","webkitImageSmoothingEnabled","msImageSmoothingEnabled"],o=100,s=function(){function t(t,e){void 0===e&&(e=4/3),this._canvas=t,this._aspect=e,this._syncRendering=!0,this._animationFrameHandle=0,this._pendingFrame=null,this._video=null,this._interpolate=!0,this._context=this._canvas.getContext("2d"),this._renderCanvas=document.createElement("canvas"),this._renderCanvas.width=this._renderCanvas.height=o,this._renderContext=this._renderCanvas.getContext("2d")}return t.prototype.resize=function(t,e){return void 0!==t&&void 0!==e||(t=this._canvas.clientWidth,e=this._canvas.clientHeight),this._canvas.width=t,this._canvas.height=e,this._clearCanvas(),this._recalculateBlittingMetrics(),this._applyInterpolationSettings(),this._video&&this._blitToCanvas(),this},t.prototype.init=function(){return this.enableInterpolation(!0),this._clearRenderCanvas(),this.resize(),this},t.prototype.close=function(){return this},t.prototype.enableSyncRendering=function(t){return t===this._syncRendering?this:(this._cancelPendingFrame(),this._syncRendering=t,this)},t.prototype.syncRenderingEnabled=function(){return this._syncRendering},t.prototype.bind=function(e){return this._video?this:(this._video=e,this._videoWidth=this._renderCanvas.width=this._video.getWidth(),this._videoHeight=this._renderCanvas.height=this._video.getHeight(),this.resize(),this._clearRenderCanvas(),this._video.newFrame.addHandler(t._frameHandler,this),this)},t.prototype.unbind=function(){return this._video?(this._video.newFrame.removeHandler(t._frameHandler,this),this._video=null,this._cancelPendingFrame(),this._clearCanvas(),this):this},t.prototype.enableInterpolation=function(t){return this._interpolate===t?this:(this._interpolate=t,this._applyInterpolationSettings(),this)},t.prototype.interpolationEnabled=function(){return this._interpolate},t.prototype.getCanvas=function(){return this._canvas},t._frameHandler=function(t,e){e._pendingFrame&&e._pendingFrame.release(),e._pendingFrame=t,e._syncRendering?e._animationFrameHandle||e._scheduleDraw():e._draw()},t.prototype._clearCanvas=function(){this._context.fillStyle="solid black",this._context.fillRect(0,0,this._canvas.width,this._canvas.height)},t.prototype._clearRenderCanvas=function(){this._renderContext.fillStyle="solid black",this._renderContext.fillRect(0,0,this._renderCanvas.width,this._renderCanvas.height)},t.prototype._draw=function(){this._blitToRenderCanvas(),this._blitToCanvas(),this._pendingFrame.release(),this._pendingFrame=null},t.prototype._blitToRenderCanvas=function(){this._renderContext.putImageData(this._pendingFrame.get(),0,0)},t.prototype._blitToCanvas=function(){this._context.drawImage(this._renderCanvas,0,0,this._videoWidth,this._videoHeight,this._renderX,this._renderY,this._renderWidth,this._renderHeight)},t.prototype._scheduleDraw=function(){var t=this;this._animationFrameHandle||(this._animationFrameHandle=requestAnimationFrame(function(){t._draw(),t._animationFrameHandle=0}))},t.prototype._cancelPendingFrame=function(){this._animationFrameHandle&&(cancelAnimationFrame(this._animationFrameHandle),this._animationFrameHandle=0),this._pendingFrame&&(this._pendingFrame.release(),this._pendingFrame=null)},t.prototype._recalculateBlittingMetrics=function(){var t=this._canvas.width,e=this._canvas.height;this._aspect*e<=t?(this._renderHeight=e,this._renderWidth=this._aspect*e,this._renderY=0,this._renderX=Math.floor((t-this._renderWidth)/2)):(this._renderHeight=t/this._aspect,this._renderWidth=t,this._renderY=Math.floor((e-this._renderHeight)/2),this._renderX=0)},t.prototype._applyInterpolationSettings=function(){try{for(var t=i.__values(r),e=t.next();!e.done;e=t.next()){var n=e.value;this._context[n]=this._interpolate}}catch(t){o={error:t}}finally{try{e&&!e.done&&(s=t.return)&&s.call(t)}finally{if(o)throw o.error}}var o,s},t}();n.default=s},{tslib:6}],25:[function(t,e,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=t("tslib"),r=t("async-mutex"),o=t("./audio/WaveformChannel"),s=t("./audio/PCMChannel"),a=function(){function t(t,e,n){void 0===t&&(t=0),void 0===e&&(e=0),this._context=null,this._merger=null,this._waveformChannels=null,this._pcmChannels=null,this._channels=null,this._cache=new Map,this._mutex=new r.Mutex,this._isBound=!1,this._waveformChannels=new Array(t),this._pcmChannels=new Array(e);for(a=0;a<t;a++)this._waveformChannels[a]=new o.default(this._cache);for(var a=0;a<e;a++)this._pcmChannels[a]=new s.default(n);this._channels=i.__spread(this._waveformChannels,this._pcmChannels)}return t.prototype.init=function(){var t=this,e=window.AudioContext||window.webkitAudioContext;if(!e)throw new Error("web audio is not supported by runtime");this._context=new e;try{this._context.destination.channelCount=1}catch(t){console.warn("audio driver: failed to set channel count")}this._merger=this._context.createChannelMerger(this._channels.length),this._merger.connect(this._context.destination),this._channels.forEach(function(e){return e.init(t._context,t._merger)})},t.prototype.bind=function(t,e){if(void 0===t&&(t=[]),void 0===e&&(e=[]),!this._isBound){if(t.length!==this._waveformChannels.length)throw new Error("invalid number of waveform sources: expected "+this._waveformChannels.length+", got "+t.length);if(e.length!==this._pcmChannels.length)throw new Error("invalid number of waveform sources: expected "+this._pcmChannels.length+", got "+e.length);this._waveformChannels.forEach(function(e,n){return e.bind(t[n])}),this._pcmChannels.forEach(function(t,n){return t.bind(e[n])}),this._isBound=!0,this.resume()}},t.prototype.unbind=function(){this._isBound&&(this._channels.forEach(function(t){return t.unbind()}),this._isBound=!1,this.pause())},t.prototype.setMasterVolume=function(t,e){this._channels[t].setMasterVolume(e)},t.prototype.pause=function(){var t=this;return this._mutex.runExclusive(function(){return new Promise(function(e){t._context.suspend().then(e,e),setTimeout(e,200)})})},t.prototype.resume=function(){var t=this;return this._mutex.runExclusive(function(){return new Promise(function(e){t._context.resume().then(e,e),setTimeout(e,200)})})},t.prototype.close=function(){var t=this;this._mutex.runExclusive(function(){return t._context.close()})},t}();n.default=a},{"./audio/PCMChannel":27,"./audio/WaveformChannel":28,"async-mutex":2,tslib:6}],26:[function(t,e,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function t(){this._buffer=new Float32Array(2),this._fractionalIndex=0,this._needsData=!1,this._ratio=0,this.reset(1,1)}return t.prototype.reset=function(t,e){this._ratio=t/e,this._needsData=!1,this._fractionalIndex=0;for(var n=0;n<2;n++)this._buffer[n]=0},t.prototype.get=function(){var t=(1-this._fractionalIndex)*this._buffer[0]+this._fractionalIndex*this._buffer[1];return this._fractionalIndex+=this._ratio,this._fractionalIndex>1&&(this._fractionalIndex-=1,this._needsData=!0),t},t.prototype.push=function(t){this._buffer[0]=this._buffer[1],this._buffer[1]=t,this._needsData=!1},t.prototype.needsData=function(){return this._needsData},t}();n.default=i},{}],27:[function(t,e,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=t("../../../tools/RingBuffer"),r=t("./LinearResampler"),o=function(){function t(t){void 0===t&&(t=1024),this._hostFragmentSize=t,this._outputSampleRate=0,this._bufferSize=0,this._volume=1,this._gain=null,this._processor=null,this._bufferUnderrun=!1,this._fragmentRing=null,this._fragmentSize=0,this._inputSampleRate=0,this._fragmentIndex=0,this._currentFragment=null,this._lastFragment=null,this._resampler=new r.default}return t.prototype.init=function(t,e){var n=this;this._outputSampleRate=t.sampleRate,this._gain=t.createGain(),this._gain.gain.value=this._volume,this._gain.connect(e),this._processor=t.createScriptProcessor(this._hostFragmentSize,1,1),this._bufferSize=this._processor.bufferSize,this._processor.connect(this._gain),this._processor.onaudioprocess=function(t){return n._processAudio(t)},t.createBuffer(1,1,t.sampleRate).getChannelData(0).set([0])},t.prototype.bind=function(e){this.unbind(),this._audio=e,this._fragmentSize=e.getFrameSize(),this._inputSampleRate=e.getSampleRate(),this._fragmentIndex=0,this._lastFragment=null,this._bufferUnderrun=!0,this._fragmentRing=new i.default(Math.ceil(4*this._bufferSize/this._outputSampleRate/this._fragmentSize*this._inputSampleRate)),this._audio.newFrame.addHandler(t._onNewFragment,this),this._resampler.reset(this._inputSampleRate,this._outputSampleRate)},t.prototype.unbind=function(){this._audio&&(this._audio.newFrame.removeHandler(t._onNewFragment,this),this._lastFragment&&(this._lastFragment.release(),this._lastFragment=null),this._currentFragment&&(this._currentFragment.release(),this._currentFragment=null),this._fragmentRing&&(this._fragmentRing.forEach(function(t){return t.release()}),this._fragmentRing.clear(),this._fragmentRing=null))},t.prototype.setMasterVolume=function(t){this._volume=t},t._onNewFragment=function(t,e){e._fragmentRing.push(t),e._currentFragment||(e._currentFragment=e._fragmentRing.pop(),e._fragmentIndex=0)},t.prototype._processAudio=function(t){var e=this;if(this._audio){var n=t.outputBuffer.getChannelData(0),i=0,r=function(t){for(var r=e._lastFragment&&e._lastFragment.get();i<t;)e._resampler.needsData()&&(e._resampler.push(e._audio&&e._audio.isPaused()||!r?0:r[e._fragmentIndex++]*e._volume),e._fragmentIndex>=e._fragmentSize&&(e._fragmentIndex=0)),n[i++]=e._resampler.get()};this._currentFragment&&this._bufferUnderrun&&(r(this._bufferSize>>>1),this._bufferUnderrun=!1);for(var o=this._currentFragment&&this._currentFragment.get();i<this._bufferSize&&this._currentFragment;)this._resampler.needsData()&&(this._resampler.push(o[this._fragmentIndex++]*this._volume),this._fragmentIndex>=this._fragmentSize&&(this._fragmentIndex=0,this._lastFragment&&this._lastFragment.release(),this._lastFragment=this._currentFragment,this._currentFragment=this._fragmentRing.pop(),o=this._currentFragment&&this._currentFragment.get())),n[i++]=this._resampler.get();i<this._bufferSize&&(this._bufferUnderrun=!0),r(this._bufferSize)}},t}();n.default=o},{"../../../tools/RingBuffer":17,"./LinearResampler":26}],28:[function(t,e,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function t(t){this._cache=t,this._context=null,this._source=null,this._gain=null,this._audio=null,this._volume=0,this._masterVolume=1}return t.prototype.init=function(t,e){this._context=t,this._gain=this._context.createGain(),this._gain.connect(e)},t.prototype.bind=function(e){this._audio||(this._audio=e,this._volume=this._audio.getVolume(),this._updateGain(),this._audio.volumeChanged.addHandler(t._onVolumeChanged,this),this._audio.bufferChanged.addHandler(t._onBufferChanged,this),this._audio.stop.addHandler(t._onStop,this))},t.prototype.unbind=function(){this._audio&&(this._audio.volumeChanged.removeHandler(t._onVolumeChanged,this),this._audio.bufferChanged.removeHandler(t._onBufferChanged,this),this._audio.stop.removeHandler(t._onStop,this),this._source&&(this._source.stop(),this._source=null),this._audio=null)},t.prototype.setMasterVolume=function(t){this._masterVolume=t,this._updateGain()},t._onVolumeChanged=function(t,e){e._volume=t,e._updateGain()},t._onBufferChanged=function(t,e){if(!e._cache.has(t)){var n=e._audio.getBuffer(t),i=e._context.createBuffer(1,n.getLength(),n.getSampleRate());i.getChannelData(0).set(n.getContent()),e._cache.set(t,i)}var r=e._cache.get(t),o=e._context.createBufferSource();e._source&&e._source.stop(),o.loop=!0,o.buffer=r,o.connect(e._gain),o.start(),e._source=o},t._onStop=function(t,e){e._source&&(e._source.stop(),e._source=null)},t.prototype._updateGain=function(){this._gain.gain.value=this._volume*this._masterVolume},t}();n.default=i},{}],29:[function(t,e,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function t(t,e){void 0===e&&(e={}),this._canvas=t,this._gl=null,this._program=null,this._vertexBuffer=null,this._textureCoordinateBuffer=null,this._currentFrameIndex=0,this._frameCount=0,this._gamma=1,this._aspect=4/3,this._povEmulation=!0,this._animationFrameHandle=0,this._syncRendering=!0,this._video=null,this._interpolation=!0,void 0!==e.aspect&&(this._aspect=e.aspect),void 0!==e.gamma&&(this._gamma=e.gamma),void 0!==e.povEmulation&&(this._povEmulation=e.povEmulation),this._gl=this._canvas.getContext("webgl",{alpha:!1}),this._createTextureArrays()}return t.prototype.init=function(){return this._gl.clearColor(0,0,0,1),this._createProgram(),this._createBuffers(),this.resize(),this._allocateTextures(),this._configureTextures(),this._setupAttribs(),this.enableInterpolation(!0),this},t.prototype.close=function(){var t=this;return this._program&&this._gl.deleteProgram(this._program),this._vertexShader&&this._gl.deleteShader(this._vertexShader),this._fragmentShader&&this._gl.deleteShader(this._fragmentShader),this._textures&&this._textures.forEach(function(e){return e&&t._gl.deleteTexture(e)}),this._imageData&&this._imageData.forEach(function(t){return t&&t.release()}),this._vertexBuffer&&this._gl.deleteBuffer(this._vertexBuffer),this._textureCoordinateBuffer&&this._gl.deleteBuffer(this._textureCoordinateBuffer),this},t.prototype.resize=function(t,e){return void 0!==t&&void 0!==e||(t=this._canvas.clientWidth,e=this._canvas.clientHeight),this._canvas.width=t,this._canvas.height=e,this._gl.viewport(0,0,t,e),this._recalculateVertexBuffer(),this._video&&this._draw(),this},t.prototype.getCanvas=function(){return this._canvas},t.prototype.bind=function(e){return this._video?this:(this.resize(),this._video=e,this._video.newFrame.addHandler(t._frameHandler,this),this)},t.prototype.unbind=function(){return this._cancelDraw(),this._video?(this._video.newFrame.removeHandler(t._frameHandler,this),this._video=null,this):this},t.prototype.enableInterpolation=function(t){return t===this._interpolation?this:(this._interpolation=t,this._configureTextures(),this)},t.prototype.interpolationEnabled=function(){return this._interpolation},t.prototype.enableSyncRendering=function(t){return t===this._syncRendering?this:(t||this._cancelDraw(),this._syncRendering=t,this)},t.prototype.syncRenderingEnabled=function(){return this._syncRendering},t.prototype.setGamma=function(t){return this._gamma=t,this},t.prototype.getGamma=function(){return this._gamma},t.prototype.enablePovEmulation=function(t){if(t===this._povEmulation)return this;this._povEmulation=t,this._reinit()},t.prototype.povEmulationEnabled=function(){return this._povEmulation},t._frameHandler=function(t,e){var n=e._imageData[e._currentFrameIndex];e._imageData[e._currentFrameIndex]=t,e._imageDataGeneration[e._currentFrameIndex]++,e._currentFrameIndex=(e._currentFrameIndex+1)%e._numberOfFramesToCompose,e._frameCount<e._numberOfFramesToCompose?e._frameCount++:(e._syncRendering?e._scheduleDraw():e._draw(),n.release())},t.prototype._createTextureArrays=function(){var t=this;this._numberOfFramesToCompose=this._povEmulation?3:1,this._textures&&this._textures.forEach(function(e){return e&&t._gl.deleteTexture(e)}),this._imageData&&this._imageData.forEach(function(t){return t&&t.release()}),this._textures=new Array(this._numberOfFramesToCompose),this._imageData=new Array(this._numberOfFramesToCompose),this._imageDataGeneration=new Array(this._numberOfFramesToCompose),this._textureGeneration=new Array(this._numberOfFramesToCompose);for(var e=0;e<this._numberOfFramesToCompose;e++)this._imageDataGeneration[e]=0,this._textureGeneration[e]=-1},t.prototype._reinit=function(){this._createTextureArrays(),this._createProgram(),this._allocateTextures(),this._configureTextures(),this._setupAttribs()},t.prototype._scheduleDraw=function(){var t=this;this._animationFrameHandle||(this._animationFrameHandle=requestAnimationFrame(function(){return t._draw(),t._animationFrameHandle=0}))},t.prototype._cancelDraw=function(){0!==this._animationFrameHandle&&(cancelAnimationFrame(this._animationFrameHandle),this._animationFrameHandle=0)},t.prototype._draw=function(){if(!(this._frameCount<this._numberOfFramesToCompose)){for(var t=this._gl,e=0;e<this._numberOfFramesToCompose;e++){var n=(this._currentFrameIndex-e-1+this._numberOfFramesToCompose)%this._numberOfFramesToCompose;this._textureGeneration[n]!==this._imageDataGeneration[n]&&(t.activeTexture(t["TEXTURE"+n]),t.bindTexture(t.TEXTURE_2D,this._textures[n]),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this._imageData[n].get()),this._textureGeneration[n]=this._imageDataGeneration[n])}for(e=0;e<this._numberOfFramesToCompose;e++)t.uniform1i(this._getUniformLocation("u_Sampler"+e),(this._currentFrameIndex+this._numberOfFramesToCompose-e-1)%this._numberOfFramesToCompose);t.uniform1f(this._getUniformLocation("u_Gamma"),this._gamma),t.clear(t.COLOR_BUFFER_BIT),t.drawArrays(t.TRIANGLE_STRIP,0,4)}},t.prototype._createProgram=function(){var t=this._gl,e=t.createShader(t.VERTEX_SHADER),n=t.createShader(t.FRAGMENT_SHADER),i=t.createProgram();if(t.shaderSource(e,"attribute vec2 a_VertexPosition;\nattribute vec2 a_TextureCoordinate;\n\nvarying vec2 v_TextureCoordinate;\n\nvoid main() {\n    v_TextureCoordinate = a_TextureCoordinate;\n    gl_Position = vec4(a_VertexPosition, 0, 1);\n}\n"),t.compileShader(e),!t.getShaderParameter(e,t.COMPILE_STATUS))throw new Error("failed to compile vertex shader: "+t.getShaderInfoLog(e));if(t.shaderSource(n,this._povEmulation?"precision mediump float;\n\nvarying vec2 v_TextureCoordinate;\n\nuniform sampler2D u_Sampler0, u_Sampler1, u_Sampler2;\nuniform float u_Gamma;\n\nvoid main() {\n    vec4 compositedTexel =\n        0.4 * texture2D(u_Sampler0, v_TextureCoordinate) +\n        0.4 * texture2D(u_Sampler1, v_TextureCoordinate) +\n        0.2 * texture2D(u_Sampler2, v_TextureCoordinate);\n\n    gl_FragColor = vec4(pow(compositedTexel.rgb, vec3(u_Gamma)), 1.);\n}\n":"precision mediump float;\n\nvarying vec2 v_TextureCoordinate;\n\nuniform sampler2D u_Sampler0;\nuniform float u_Gamma;\n\nvoid main() {\n    vec4 texel = texture2D(u_Sampler0, v_TextureCoordinate);\n\n    gl_FragColor = vec4(pow(texel.rgb, vec3(u_Gamma)), 1.);\n}\n"),t.compileShader(n),!t.getShaderParameter(e,t.COMPILE_STATUS))throw new Error("failed to compile fragment shader: "+t.getShaderInfoLog(n));if(t.attachShader(i,e),t.attachShader(i,n),t.linkProgram(i),!t.getProgramParameter(i,t.LINK_STATUS))throw new Error("failed to link program: "+t.getProgramInfoLog(i));t.useProgram(i),this._program&&t.deleteProgram(this._program),this._vertexShader&&t.deleteShader(this._vertexShader),this._fragmentShader&&t.deleteShader(this._fragmentShader),this._program=i,this._vertexShader=e,this._fragmentShader=n},t.prototype._allocateTextures=function(){for(var t=0;t<this._numberOfFramesToCompose;t++)this._allocateTexture(t)},t.prototype._configureTextures=function(){for(var t=0;t<this._numberOfFramesToCompose;t++)this._configureTexture(t)},t.prototype._allocateTexture=function(t){var e=this._gl,n=e.createTexture();e.activeTexture(e["TEXTURE"+t]),e.bindTexture(e.TEXTURE_2D,n),this._textures[t]=n},t.prototype._configureTexture=function(t){var e=this._gl;e.activeTexture(e["TEXTURE"+t]),e.bindTexture(e.TEXTURE_2D,this._textures[t]),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,this._interpolation?e.LINEAR:e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,this._interpolation?e.LINEAR:e.NEAREST),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,1)},t.prototype._createBuffers=function(){var t=this._gl,e=t.createBuffer(),n=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,n),t.bufferData(t.ARRAY_BUFFER,new Float32Array([1,1,0,1,1,0,0,0]),t.STATIC_DRAW),this._vertexBuffer=e,this._textureCoordinateBuffer=n},t.prototype._recalculateVertexBuffer=function(){var t,e,n,i,r=this._gl,o=this._canvas.width,s=this._canvas.height,a=o>0?2/o:1,u=s>0?2/s:1;this._aspect*s<=o?(e=2,t=this._aspect*s*a,i=1,n=Math.floor(-this._aspect*s)/2*a):(e=o/this._aspect*u,t=2,i=Math.floor(o/this._aspect)/2*u,n=-1);var c=[n+t,i,n,i,n+t,i-e,n,i-e];r.bindBuffer(r.ARRAY_BUFFER,this._vertexBuffer),r.bufferData(r.ARRAY_BUFFER,new Float32Array(c),r.STATIC_DRAW)},t.prototype._getAttribLocation=function(t){var e=this._gl.getAttribLocation(this._program,t);if(e<0)throw new Error("unable to locate attribute "+t);return e},t.prototype._getUniformLocation=function(t){var e=this._gl.getUniformLocation(this._program,t);if(e<0)throw new Error("unable to locate uniform "+t);return e},t.prototype._setupAttribs=function(){var t=this._gl;t.bindBuffer(t.ARRAY_BUFFER,this._vertexBuffer),t.enableVertexAttribArray(this._getAttribLocation("a_VertexPosition")),t.vertexAttribPointer(this._getAttribLocation("a_VertexPosition"),2,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this._textureCoordinateBuffer),t.enableVertexAttribArray(this._getAttribLocation("a_TextureCoordinate")),t.vertexAttribPointer(this._getAttribLocation("a_TextureCoordinate"),2,t.FLOAT,!1,0,0)},t}();n.default=i},{}],30:[function(t,e,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=t("tslib"),r=t("async-mutex"),o=t("../../stella/service/EmulationServiceInterface"),s=t("../../stella/service/worker/EmulationService"),a=t("../../stella/service/DriverManager"),u=t("../../driver/SimpleCanvasVideo"),c=t("../../driver/webgl/WebglVideo"),h=t("../../stella/driver/WebAudio"),l=t("../../stella/driver/KeyboardIO"),_=t("../../driver/MouseAsPaddle"),d=t("../../driver/Gamepad"),p=t("../../driver/FullscreenVideo"),f=t("../../../machine/stella/cartridge/CartridgeInfo"),g=t("../../../machine/stella/Config"),m=t("../../../tools/base64"),v=function(){function t(e,n,o){void 0===o&&(o={}),this._canvasElt=e,this._config=null,this._emulationService=null,this._videoDriver=null,this._webglVideo=null,this._fullscreenVideo=null,this._audioDriver=null,this._keyboardIO=null,this._paddle=null,this._gamepad=null,this._state=t.State.stopped,this._driverManager=new a.default,this._mutex=new r.Mutex,this._config=i.__assign({smoothScaling:!0,simulatePov:!0,gamma:1,audio:!0,volume:1,enableKeyboard:!0,keyboardTarget:document,fullscreenViaKeyboard:!0,paddleViaMouse:!0,pauseViaKeyboard:!0,enableGamepad:!0},o),this._emulationService=new s.default(n),this._createDrivers()}return t.prototype.setGamma=function(t){return this._webglVideo&&this._webglVideo.setGamma(t),this},t.prototype.getGamma=function(){return this._webglVideo?this._webglVideo.getGamma():1},t.prototype.enablePovSimulation=function(t){return this._webglVideo&&this._webglVideo.enablePovEmulation(t),this},t.prototype.povSimulationEnabled=function(){return!!this._webglVideo&&this._webglVideo.povEmulationEnabled()},t.prototype.enableSmoothScaling=function(t){return this._videoDriver.enableInterpolation(t),this},t.prototype.smoothScalingEnabled=function(){return this._videoDriver.interpolationEnabled()},t.prototype.toggleFullscreen=function(t){return void 0===t?this._fullscreenVideo.toggle():t?this._fullscreenVideo.engage():this._fullscreenVideo.disengage(),this},t.prototype.isFullscreen=function(){return this._fullscreenVideo.isEngaged()},t.prototype.setVolume=function(t){return this._audioDriver&&this._audioDriver.setMasterVolume(Math.max(Math.min(t,1),0)),this},t.prototype.audioEnabled=function(){return!!this._audioDriver},t.prototype.getVolume=function(){return this._audioDriver?this._audioDriver.getMasterVolume():0},t.prototype.getState=function(){return this._state},t.prototype.start=function(t,e,n){var r=this;return this._mutex.runExclusive(function(){return i.__awaiter(r,void 0,void 0,function(){var e,r,o;return i.__generator(this,function(i){switch(i.label){case 0:return"string"==typeof t&&(t=m.decode(t)),e=g.default.create(),void 0!==n.randomSeed&&n.randomSeed>0&&(e.randomSeed=n.randomSeed),void 0!==n.emulatePaddles&&(e.emulatePaddles=n.emulatePaddles),void 0!==n.frameStart&&(e.frameStart=n.frameStart),r=this,o=this._mapState,[4,this._emulationService.start(t,e,n.cartridgeType)];case 1:return[2,r._state=o.apply(this,[i.sent()])]}})})})},t.prototype.pause=function(){var t=this;return this._mutex.runExclusive(function(){return i.__awaiter(t,void 0,void 0,function(){var t,e;return i.__generator(this,function(n){switch(n.label){case 0:return t=this,e=this._mapState,[4,this._emulationService.pause()];case 1:return[2,t._state=e.apply(this,[n.sent()])]}})})})},t.prototype.resume=function(){var t=this;return this._mutex.runExclusive(function(){return i.__awaiter(t,void 0,void 0,function(){var t,e;return i.__generator(this,function(n){switch(n.label){case 0:return t=this,e=this._mapState,[4,this._emulationService.resume()];case 1:return[2,t._state=e.apply(this,[n.sent()])]}})})})},t.prototype.stop=function(){var t=this;return this._mutex.runExclusive(function(){return i.__awaiter(t,void 0,void 0,function(){var t,e;return i.__generator(this,function(n){switch(n.label){case 0:return t=this,e=this._mapState,[4,this._emulationService.stop()];case 1:return[2,t._state=e.apply(this,[n.sent()])]}})})})},t.prototype.lastError=function(){return this._emulationService.getLastError()},t.prototype._createDrivers=function(){var t=this;try{this._webglVideo=this._videoDriver=new c.default(this._canvasElt,{povEmulation:this._config.simulatePov,gamma:this._config.gamma}).init()}catch(t){this._webglVideo=null,this._videoDriver=new u.default(this._canvasElt).init()}if(this._videoDriver.enableInterpolation(this._config.smoothScaling),this._driverManager.addDriver(this._videoDriver,function(e){return t._videoDriver.bind(e.getVideo())}),this._fullscreenVideo=new p.default(this._videoDriver),this._config.audio)try{this._audioDriver=new h.default,this._audioDriver.setMasterVolume(this._config.volume),this._driverManager.addDriver(this._audioDriver,function(e){return t._audioDriver.bind(!0,[e.getPCMChannel()])})}catch(t){console.error("failed to initialize audio: "+(t&&t.message))}this._config.enableKeyboard&&(this._keyboardIO=new l.default(this._config.keyboardTarget),this._driverManager.addDriver(this._keyboardIO,function(e){return t._keyboardIO.bind(e.getJoystick(0),e.getJoystick(1),e.getControlPanel())}),this._config.fullscreenViaKeyboard&&this._keyboardIO.toggleFullscreen.addHandler(function(){return t._fullscreenVideo.toggle()}),this._config.pauseViaKeyboard&&this._keyboardIO.togglePause.addHandler(function(){switch(t._emulationService.getState()){case o.default.State.paused:t.resume();break;case o.default.State.running:t.pause()}})),this._config.enableGamepad&&(this._gamepad=new d.default,this._driverManager.addDriver(this._gamepad,function(e){return t._gamepad.bind({joysticks:[e.getJoystick(0),e.getJoystick(1)],start:e.getControlPanel().getResetButton(),select:e.getControlPanel().getSelectSwitch()})})),this._config.paddleViaMouse&&(this._paddle=new _.default,this._driverManager.addDriver(this._paddle,function(e){return t._paddle.bind(e.getPaddle(0))}))},t.prototype._mapState=function(e){switch(e){case o.default.State.stopped:return t.State.stopped;case o.default.State.running:return t.State.running;case o.default.State.paused:return t.State.paused;case o.default.State.error:return t.State.error;default:throw new Error("cannot happen")}},t}();!function(t){!function(t){t.ntsc="ntsc",t.pal="pal",t.secam="secam"}(t.TvMode||(t.TvMode={})),t.CartridgeType=f.default.CartridgeType,t.describeCartridgeType=f.default.CartridgeType,t.allCartridgeTypes=f.default.getAllTypes;!function(t){t.running="running",t.paused="paused",t.stopped="stopped",t.error="error"}(t.State||(t.State={}))}(v||(v={})),n.default=v},{"../../../machine/stella/Config":12,"../../../machine/stella/cartridge/CartridgeInfo":14,"../../../tools/base64":18,"../../driver/FullscreenVideo":21,"../../driver/Gamepad":22,"../../driver/MouseAsPaddle":23,"../../driver/SimpleCanvasVideo":24,"../../driver/webgl/WebglVideo":29,"../../stella/driver/KeyboardIO":32,"../../stella/driver/WebAudio":33,"../../stella/service/DriverManager":34,"../../stella/service/EmulationServiceInterface":35,"../../stella/service/worker/EmulationService":38,"async-mutex":2,tslib:6}],31:[function(t,e,n){"use strict";var i=t("./Stellerator");e.exports={Stellerator:i.default}},{"./Stellerator":30}],32:[function(t,e,n){"use strict";function i(t){return{type:0,swtch:t}}function r(t){return{type:1,trigger:t}}Object.defineProperty(n,"__esModule",{value:!0});var o=t("tslib"),s=t("microevent.ts"),a=function(){function t(e,n){void 0===n&&(n=t.defaultMappings),this._target=e,this.toggleFullscreen=new s.Event,this.hardReset=new s.Event,this.togglePause=new s.Event,this._keydownListener=null,this._keyupListener=null,this._joystick0=null,this._joystick1=null,this._controlPanel=null,this._dispatchTable={},this._compiledMappings=new Map,this._compileMappings(n)}return t.prototype.bind=function(t,e,n){var i=this;this._joystick0||(this._joystick0=t,this._joystick1=e,this._controlPanel=n,this._updateActionTable(),this._keydownListener=function(t){if(i._compiledMappings.has(t.keyCode)){var e=(t.shiftKey?4:0)|(t.ctrlKey?1:0)|(t.altKey?2:0);if(i._compiledMappings.get(t.keyCode).has(e)){var n=i._compiledMappings.get(t.keyCode).get(e);if(void 0!==n){t.preventDefault();var r=i._dispatchTable[n];switch(r.type){case 0:r.swtch.toggle(!0);break;case 1:r.trigger.dispatch(void 0)}}}}},this._keyupListener=function(t){if(i._compiledMappings.has(t.keyCode)){try{for(var e=o.__values(i._compiledMappings.get(t.keyCode).values()),n=e.next();!n.done;n=e.next()){var r=n.value;t.preventDefault();var s=i._dispatchTable[r];switch(s.type){case 0:s.swtch.toggle(!1)}}}catch(t){a={error:t}}finally{try{n&&!n.done&&(u=e.return)&&u.call(e)}finally{if(a)throw a.error}}var a,u}},this._target.addEventListener("keydown",this._keydownListener),this._target.addEventListener("keyup",this._keyupListener))},t.prototype.unbind=function(){this._joystick0&&(this._target.removeEventListener("keydown",this._keydownListener),this._target.removeEventListener("keyup",this._keyupListener),this._joystick0=this._joystick1=this._controlPanel=null,this._keydownListener=this._keyupListener=null)},t.prototype._updateActionTable=function(){this._dispatchTable[12]=r(this.toggleFullscreen),this._dispatchTable[13]=r(this.hardReset),this._dispatchTable[14]=r(this.togglePause),this._dispatchTable[0]=i(this._controlPanel.getSelectSwitch()),this._dispatchTable[1]=i(this._controlPanel.getResetButton()),this._dispatchTable[2]=i(this._joystick0.getLeft()),this._dispatchTable[3]=i(this._joystick0.getRight()),this._dispatchTable[4]=i(this._joystick0.getUp()),this._dispatchTable[5]=i(this._joystick0.getDown()),this._dispatchTable[10]=i(this._joystick0.getFire()),this._dispatchTable[6]=i(this._joystick1.getLeft()),this._dispatchTable[7]=i(this._joystick1.getRight()),this._dispatchTable[8]=i(this._joystick1.getUp()),this._dispatchTable[9]=i(this._joystick1.getDown()),this._dispatchTable[11]=i(this._joystick1.getFire())},t.prototype._compileMappings=function(t){var e=this;t.forEach(function(t){var n=t.action;(Array.isArray(t.spec)?t.spec:[t.spec]).forEach(function(t){return function(t,n,i){if(0!=(-8&i))throw new Error("invalid modifier set "+i);e._compiledMappings.has(n)||e._compiledMappings.set(n,new Map),e._compiledMappings.get(n).set(i,t)}(n,"object"==typeof t?t.keycode:t,"object"==typeof t?t.modifiers:0)})})},t}();!function(t){t.defaultMappings=[{action:0,spec:{keycode:32,modifiers:4}},{action:1,spec:{keycode:13,modifiers:4}},{action:2,spec:[65,37]},{action:3,spec:[68,39]},{action:4,spec:[87,38]},{action:5,spec:[83,40]},{action:10,spec:[32,86]},{action:6,spec:74},{action:7,spec:76},{action:8,spec:73},{action:9,spec:75},{action:11,spec:66},{action:12,spec:13},{action:13,spec:{keycode:82,modifiers:4}},{action:14,spec:80}]}(a||(a={})),n.default=a},{"microevent.ts":4,tslib:6}],33:[function(t,e,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=t("tslib"),r=t("../../driver/WebAudio"),o=function(){function t(t){this._fragmentSize=t,this._pcmAudio=!1,this._volume=1}return t.prototype.init=function(){},t.prototype.bind=function(t,e){if(!this._channels){this._channels=i.__spread(e),this._driver&&this._pcmAudio===t||(this._driver&&this._driver.close(),this._driver=t?new r.default(0,this._channels.length,this._fragmentSize):new r.default(this._channels.length,0,this._fragmentSize),this._driver.init()),t?this._driver.bind([],this._channels):this._driver.bind(this._channels,[]);for(var n=0;n<this._channels.length;n++)this._driver.setMasterVolume(n,this._volume);this._pcmAudio=t}},t.prototype.unbind=function(){this._channels&&(this._driver.unbind(),this._channels=null)},t.prototype.setMasterVolume=function(t){if(this._volume=t,this._channels)for(var e=0;e<this._channels.length;e++)this._driver.setMasterVolume(e,this._volume)},t.prototype.getMasterVolume=function(){return this._volume},t.prototype.pause=function(){return i.__awaiter(this,void 0,void 0,function(){return i.__generator(this,function(t){switch(t.label){case 0:return this._driver?[4,this._driver.pause()]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}})})},t.prototype.resume=function(){return i.__awaiter(this,void 0,void 0,function(){return i.__generator(this,function(t){switch(t.label){case 0:return this._driver?[4,this._driver.resume()]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}})})},t}();n.default=o},{"../../driver/WebAudio":25,tslib:6}],34:[function(t,e,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=t("./EmulationServiceInterface"),r=function(){function t(){this._drivers=new Map,this._driversBound=!1}return t.prototype.bind=function(e){return this._driversBound?this:(this._emulationService=e,this._shouldBindDrivers()&&this._bindDrivers(),this._emulationService.stateChanged.addHandler(t._onEmuStateChange,this),this)},t.prototype.unbind=function(){return this._emulationService?(this._unbindDrivers(),this._emulationService.stateChanged.removeHandler(t._onEmuStateChange,this),this._emulationService=null,this):this},t.prototype.addDriver=function(e,n){return this._drivers.set(e,new t.DriverContext(e,n)),this._driversBound&&n(this._emulationService.getEmulationContext(),e),this},t.prototype.removeDriver=function(t){return this._drivers.get(t)?(t.unbind(),this._drivers.delete(t),this):this},t._onEmuStateChange=function(t,e){e._shouldBindDrivers(t)?e._bindDrivers():e._unbindDrivers()},t.prototype._shouldBindDrivers=function(t){return void 0===t&&(t=this._emulationService?this._emulationService.getState():void 0),this._emulationService&&(t===i.default.State.running||t===i.default.State.paused)},t.prototype._bindDrivers=function(){var t=this;this._driversBound||(this._drivers.forEach(function(e){return e.binder(t._emulationService.getEmulationContext(),e.driver)}),this._driversBound=!0)},t.prototype._unbindDrivers=function(){this._driversBound&&(this._drivers.forEach(function(t){return t.driver.unbind()}),this._driversBound=!1)},t}();!function(t){var e=function(){return function(t,e){this.driver=t,this.binder=e}}();t.DriverContext=e}(r||(r={})),n.default=r},{"./EmulationServiceInterface":35}],35:[function(t,e,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i;!function(t){!function(t){t[t.stopped=0]="stopped",t[t.running=1]="running",t[t.paused=2]="paused",t[t.error=3]="error"}(t.State||(t.State={}))}(i||(i={})),n.default=i},{}],36:[function(t,e,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=t("../../../../machine/io/DigitalJoystick"),r=t("../../../../machine/stella/ControlPanel"),o=t("../../../../machine/io/Paddle"),s=t("./messages"),a=function(){function t(t){this._rpc=t,this._joysticks=new Array(2),this._paddles=new Array(4),this._controlPanel=new r.default;for(e=0;e<2;e++)this._joysticks[e]=new i.default;for(var e=0;e<4;e++)this._paddles[e]=new o.default}return t.prototype.sendUpdate=function(){this._rpc.signal(s.SIGNAL_TYPE.controlStateUpdate,{joystickState:this._joysticks.map(t._joystickState),paddleState:this._paddles.map(t._paddleState),controlPanelState:t._controlPanelState(this._controlPanel)})},t.prototype.getJoystick=function(t){if(t<0||t>1)throw new Error("invalid joystick index "+t);return this._joysticks[t]},t.prototype.getControlPanel=function(){return this._controlPanel},t.prototype.getPaddle=function(t){if(t<0||t>3)throw new Error("invalid paddle index "+t);return this._paddles[t]},t._joystickState=function(t){return{up:t.getUp().read(),down:t.getDown().read(),left:t.getLeft().read(),right:t.getRight().read(),fire:t.getFire().read()}},t._paddleState=function(t){return{value:t.getValue(),fire:t.getFire().read()}},t._controlPanelState=function(t){return{difficulty0:t.getDifficultySwitchP0().read(),difficulty1:t.getDifficultySwitchP1().read(),select:t.getSelectSwitch().read(),reset:t.getResetButton().read(),color:t.getColorSwitch().read()}},t}();n.default=a},{"../../../../machine/io/DigitalJoystick":9,"../../../../machine/io/Paddle":10,"../../../../machine/stella/ControlPanel":13,"./messages":42}],37:[function(t,e,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function t(t,e,n,i){if(this._videoProxy=t,this._controlProxy=e,this._waveformChannels=n,this._pcmChannel=i,this._config=null,2!==this._waveformChannels.length)throw new Error("invalid channel count "+this._waveformChannels.length)}return t.prototype.setConfig=function(t){this._config=t},t.prototype.getConfig=function(){return this._config},t.prototype.getVideo=function(){return this._videoProxy},t.prototype.getJoystick=function(t){return this._controlProxy.getJoystick(t)},t.prototype.getControlPanel=function(){return this._controlProxy.getControlPanel()},t.prototype.getPaddle=function(t){return this._controlProxy.getPaddle(t)},t.prototype.getWaveformChannels=function(){return this._waveformChannels},t.prototype.getPCMChannel=function(){return this._pcmChannel},t.prototype.getVideoProxy=function(){return this._videoProxy},t}();n.default=i},{}],38:[function(t,e,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=t("tslib"),r=t("microevent.ts"),o=t("worker-rpc"),s=t("../EmulationServiceInterface"),a=t("./EmulationContext"),u=t("./VideoProxy"),c=t("./ControlProxy"),h=t("./WaveformAudioProxy"),l=t("./PCMAudioProxy"),_=t("async-mutex"),d=t("./messages"),p=function(){function t(t,e){this._stellaWorkerUri=t,this._videoWorkerUri=e,this.stateChanged=new r.Event,this.frequencyUpdate=new r.Event,this._rateLimitEnforced=!0,this._mutex=new _.Mutex,this._worker=null,this._rpc=null,this._state=s.default.State.stopped,this._lastError=null,this._emulationContext=null,this._frequency=0,this._waveformChannels=new Array(2),this._pcmChannel=null,this._controlProxy=null,this._controlProxyUpdateHandle=null,this._proxyState=0,this._saveConfig=null}return t.prototype.init=function(){var t=this;this._worker=new Worker(this._stellaWorkerUri),this._rpc=new o.RpcProvider(function(e,n){return t._worker.postMessage(e,n)}),this._pcmChannel=new l.default(0,this._rpc).init();for(var e=0;e<2;e++)this._waveformChannels[e]=new h.default(e,this._rpc).init();var n=new u.default(this._rpc),i=new c.default(this._rpc);return n.init(),this._emulationContext=new a.default(n,i,this._waveformChannels,this._pcmChannel),this._worker.onmessage=function(e){return t._rpc.dispatch(e.data)},this._rpc.registerSignalHandler(d.SIGNAL_TYPE.emulationFrequencyUpdate,this._onFrequencyUpdate.bind(this)).registerSignalHandler(d.SIGNAL_TYPE.emulationError,this._onEmulationError.bind(this)),this._controlProxy=i,this._startVideoProcessingPipeline().then(function(){return t.setRateLimit(t._rateLimitEnforced)})},t.prototype.start=function(t,e,n,r){return i.__awaiter(this,void 0,void 0,function(){var o=this;return i.__generator(this,function(a){switch(a.label){case 0:return[4,this.stop()];case 1:return a.sent(),[2,this._mutex.runExclusive(function(){return i.__awaiter(o,void 0,void 0,function(){var o;return i.__generator(this,function(i){switch(i.label){case 0:return[4,this._rpc.rpc(d.RPC_TYPE.emulationStart,{buffer:t,config:e,cartridgeType:n,videoProcessing:r})];case 1:return(o=i.sent())!==s.default.State.paused?[3,3]:(this._saveConfig=e,this._emulationContext.setConfig(e),[4,this._startProxies(e)]);case 2:return i.sent(),[3,4];case 3:this._saveConfig=null,i.label=4;case 4:return[2,this._applyState(o)]}})})})]}})})},t.prototype.pause=function(){var t=this;return this._mutex.runExclusive(function(){return t._rpc.rpc(d.RPC_TYPE.emulationPause).then(function(e){return t._pauseProxies(),t._applyState(e)})})},t.prototype.stop=function(){var t=this;return this._mutex.runExclusive(function(){return t._rpc.rpc(d.RPC_TYPE.emulationStop).then(function(e){return t._stopProxies(),t._applyState(e)})})},t.prototype.reset=function(){var t=this;return this._mutex.runExclusive(function(){return i.__awaiter(t,void 0,void 0,function(){var t;return i.__generator(this,function(e){switch(e.label){case 0:return[4,this._rpc.rpc(d.RPC_TYPE.emulationReset)];case 1:return t=e.sent(),this._state!==s.default.State.error||t!==s.default.State.running&&t!==s.default.State.paused||!this._saveConfig?[3,3]:[4,this._startProxies(this._saveConfig)];case 2:e.sent(),e.label=3;case 3:return[2,this._applyState(t)]}})})})},t.prototype.resume=function(){var t=this;return this._mutex.runExclusive(function(){return t._rpc.rpc(d.RPC_TYPE.emulationResume).then(function(e){return t._resumeProxies(),t._applyState(e)})})},t.prototype.setRateLimit=function(t){return this._rateLimitEnforced=t,this._rpc.rpc(d.RPC_TYPE.emulationSetRateLimit,t)},t.prototype.getFrequency=function(){return this._frequency},t.prototype.getRateLimit=function(){return this._rateLimitEnforced},t.prototype.getState=function(){return this._state},t.prototype.getLastError=function(){return this._lastError},t.prototype.getEmulationContext=function(){switch(this._state){case s.default.State.running:case s.default.State.paused:return this._emulationContext;default:return null}},t.prototype._fetchLastError=function(){return this._rpc.rpc(d.RPC_TYPE.emulationFetchLastError).then(function(t){return t?new Error(t):null})},t.prototype._applyState=function(t){var e=this;return t===s.default.State.error?this._fetchLastError().then(function(n){return e._state=t,e._lastError=n,e._stopProxies(),e.stateChanged.dispatch(t),t}):(this._state=t,this.stateChanged.dispatch(t),t)},t.prototype._onFrequencyUpdate=function(t){this._frequency=t,this.frequencyUpdate.dispatch(this._frequency)},t.prototype._onEmulationError=function(t){this._lastError=new Error(t||""),this._stopProxies(),this._state=s.default.State.error,this.stateChanged.dispatch(this._state)},t.prototype._startProxies=function(t){return i.__awaiter(this,void 0,void 0,function(){var e;return i.__generator(this,function(n){switch(n.label){case 0:return[4,this._emulationContext.getVideoProxy().start()];case 1:n.sent(),e=0,n.label=2;case 2:return e<this._waveformChannels.length?[4,this._waveformChannels[e].start(t)]:[3,5];case 3:n.sent(),n.label=4;case 4:return e++,[3,2];case 5:return[4,this._pcmChannel.start()];case 6:return n.sent(),this._startControlUpdates(),this._proxyState=1,[2]}})})},t.prototype._stopProxies=function(){0!==this._proxyState&&(this._emulationContext.getVideoProxy().stop(),this._pcmChannel.stop(),this._stopControlUpdates(),this._proxyState=0)},t.prototype._pauseProxies=function(){1===this._proxyState&&(this._stopControlUpdates(),this._proxyState=2)},t.prototype._resumeProxies=function(){2===this._proxyState&&(this._startControlUpdates(),this._proxyState=1)},t.prototype._startControlUpdates=function(){var t=this;null===this._controlProxyUpdateHandle&&(this._controlProxyUpdateHandle=setInterval(function(){return t._controlProxy.sendUpdate()},25))},t.prototype._stopControlUpdates=function(){null!==this._controlProxyUpdateHandle&&(clearInterval(this._controlProxyUpdateHandle),this._controlProxyUpdateHandle=null)},t.prototype._startVideoProcessingPipeline=function(){return i.__awaiter(this,void 0,void 0,function(){var t,e,n;return i.__generator(this,function(i){switch(i.label){case 0:return t=null,this._videoWorkerUri?(t=new MessageChannel,e=new Worker(this._videoWorkerUri),n=new o.RpcProvider(function(t,n){return e.postMessage(t,n)}),e.onmessage=function(t){return n.dispatch(t.data)},[4,n.rpc("/use-port",t.port1,[t.port1])]):[3,2];case 1:i.sent(),i.label=2;case 2:return[4,this._rpc.rpc(d.RPC_TYPE.setup,{videoProcessorPort:t&&t.port2},t?[t.port2]:[])];case 3:return i.sent(),[2]}})})},t}();n.default=p},{"../EmulationServiceInterface":35,"./ControlProxy":36,"./EmulationContext":37,"./PCMAudioProxy":39,"./VideoProxy":40,"./WaveformAudioProxy":41,"./messages":42,"async-mutex":2,"microevent.ts":4,tslib:6,"worker-rpc":8}],39:[function(t,e,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=t("tslib"),r=t("microevent.ts"),o=t("../../../../tools/pool/Pool"),s=t("./messages"),a=function(){function t(e,n){this._index=e,this._rpc=n,this.newFrame=new r.Event,this.togglePause=new r.Event,this._sampleRate=0,this._frameSize=0,this._paused=!1,this._framePool=new o.default(function(){return null}),this._frameMap=new WeakMap,this._enabled=!1,this._signalReturnFrame="",this._framePool.event.release.addHandler(t._onReleaseFragment,this),this._signalReturnFrame=s.SIGNAL_TYPE.pcmAudioReturnFrame(this._index)}return t.prototype.init=function(){return this._rpc.registerSignalHandler(s.SIGNAL_TYPE.pcmAudioNewFrame(this._index),this._onNewFrame.bind(this)).registerSignalHandler(s.SIGNAL_TYPE.pcmAudioTogglePause(this._index),this._onTogglePause.bind(this)),this},t.prototype.start=function(){return i.__awaiter(this,void 0,void 0,function(){var t;return i.__generator(this,function(e){switch(e.label){case 0:return this._enabled?[2]:[4,this._rpc.rpc(s.RPC_TYPE.getPCMAudioParameters(this._index))];case 1:return t=e.sent(),this._sampleRate=t.sampleRate,this._frameSize=t.frameSize,this._paused=t.paused,this._enabled=!0,[2]}})})},t.prototype.stop=function(){this._enabled=!1},t.prototype.isPaused=function(){return this._paused},t.prototype.getSampleRate=function(){return this._sampleRate},t.prototype.getFrameSize=function(){return this._frameSize},t._onReleaseFragment=function(t,e){e._frameMap.has(t)&&e._rpc.signal(e._signalReturnFrame,{id:e._frameMap.get(t),buffer:t.buffer},[t.buffer])},t.prototype._onNewFrame=function(t){if(this._enabled){var e=this._framePool.get(),n=new Float32Array(t.buffer);e.adopt(n),this._frameMap.set(n,t.id),this.newFrame.dispatch(e)}},t.prototype._onTogglePause=function(t){t.paused!==this._paused&&(this._paused=t.paused,this.togglePause.dispatch(this._paused))},t}();n.default=a},{"../../../../tools/pool/Pool":19,"./messages":42,"microevent.ts":4,tslib:6}],40:[function(t,e,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=t("tslib"),r=t("microevent.ts"),o=t("./messages"),s=function(){function t(t){this._rpc=t,this.newFrame=new r.Event,this._active=!1,this._width=0,this._height=0,this._ids=null}return t.prototype.init=function(){this._rpc.registerSignalHandler(o.SIGNAL_TYPE.videoNewFrame,this._onNewFrame.bind(this))},t.prototype.start=function(){return i.__awaiter(this,void 0,void 0,function(){var t;return i.__generator(this,function(e){switch(e.label){case 0:return this._active&&this.stop(),[4,this._rpc.rpc(o.RPC_TYPE.getVideoParameters)];case 1:return t=e.sent(),this._active=!0,this._width=t.width,this._height=t.height,this._ids=new Set,[2]}})})},t.prototype.stop=function(){this._active=!1,this._ids=null},t.prototype.getWidth=function(){return this._width},t.prototype.getHeight=function(){return this._height},t.prototype._onNewFrame=function(t){var e=this;if(this._active)if(this._width===t.width&&this._height===t.height){this._ids.add(t.id);var n=new ImageData(new Uint8ClampedArray(t.buffer),t.width,t.height);this.newFrame.dispatch({get:function(){return n},release:function(){e._active&&e._ids.has(t.id)&&e._rpc.signal(o.SIGNAL_TYPE.videoReturnSurface,{id:t.id,buffer:t.buffer},[t.buffer])},dispose:function(){},adopt:function(){throw new Error("adopt is not implemented")}})}else console.warn("surface dimensions do not match; ignoring frame");else console.warn("video proxy deactivated: ignoring frame")},t}();n.default=s},{"./messages":42,"microevent.ts":4,tslib:6}],41:[function(t,e,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=t("tslib"),r=t("microevent.ts"),o=t("../../../../machine/stella/tia/ToneGenerator"),s=t("./messages"),a=function(){function t(t,e){this._index=t,this._rpc=e,this.bufferChanged=new r.Event,this.volumeChanged=new r.Event,this.stop=new r.Event,this._toneGenerator=new o.default,this._volume=0}return t.prototype.init=function(){return this._rpc.registerSignalHandler(s.SIGNAL_TYPE.waveformAudioBufferChange,this._onBufferChangeSignal.bind(this)).registerSignalHandler(s.SIGNAL_TYPE.waveformAudioVolumeChange,this._onVolumeChangeSignal.bind(this)).registerSignalHandler(s.SIGNAL_TYPE.audioStop,this._onStopSignal.bind(this)),this},t.prototype.start=function(t){return i.__awaiter(this,void 0,void 0,function(){var e;return i.__generator(this,function(n){switch(n.label){case 0:return[4,this._rpc.rpc(s.RPC_TYPE.getWaveformAudioParameters(this._index))];case 1:return e=n.sent(),this._toneGenerator.setConfig(t),this.setVolume(e.volume),[2]}})})},t.prototype.setVolume=function(t){return this._volume=t,this},t.prototype.getVolume=function(){return this._volume},t.prototype.getBuffer=function(t){return this._toneGenerator.getBuffer(t)},t.prototype._onVolumeChangeSignal=function(t){t.index===this._index&&(this._volume=t.value,this.volumeChanged.dispatch(this._volume))},t.prototype._onBufferChangeSignal=function(t){t.index===this._index&&this.bufferChanged.dispatch(t.key)},t.prototype._onStopSignal=function(t){t===this._index&&this.stop.dispatch(void 0)},t}();n.default=a},{"../../../../machine/stella/tia/ToneGenerator":15,"./messages":42,"microevent.ts":4,tslib:6}],42:[function(t,e,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.RPC_TYPE={emulationPause:"emulation/pause",emulationReset:"emulation/reset",emulationResume:"emulation/resume",emulationSetRateLimit:"emulation/setRateLimit",emulationStart:"emulation/start",emulationStop:"emulation/stop",emulationFetchLastError:"emulation/fetchLastError",getVideoParameters:"video/getParameters",getWaveformAudioParameters:function(t){return"audio/waveform/getParameters/"+t},getPCMAudioParameters:function(t){return"audio/pcm/getParameters/"+t},setup:"/setup"},Object.freeze(n.RPC_TYPE),n.SIGNAL_TYPE={emulationError:"emulation/error",emulationFrequencyUpdate:"emulation/frequencyUpdate",videoNewFrame:"video/newFrame",videoReturnSurface:"video/returnSurface",controlStateUpdate:"control/stateUpdate",waveformAudioVolumeChange:"audio/waveform/volumeChange",waveformAudioBufferChange:"audio/waveform/bufferChange",pcmAudioNewFrame:function(t){return"audio/pcm/newFrame/"+t},pcmAudioTogglePause:function(t){return"audio/pcm/togglePause/"+t},pcmAudioReturnFrame:function(t){return"audio/pcm/returnFrame/"+t},audioStop:"audio/stop"},Object.freeze(n.SIGNAL_TYPE)},{}]},{},[31])(31)});
!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).$6502=e()}}(function(){return function e(t,n,i){function r(s,a){if(!n[s]){if(!t[s]){var u="function"==typeof require&&require;if(!a&&u)return u(s,!0);if(o)return o(s,!0);var c=new Error("Cannot find module '"+s+"'");throw c.code="MODULE_NOT_FOUND",c}var h=n[s]={exports:{}};t[s][0].call(h.exports,function(e){var n=t[s][1][e];return r(n||e)},h,h.exports,e,t,n,i)}return n[s].exports}for(var o="function"==typeof require&&require,s=0;s<i.length;s++)r(i[s]);return r}({1:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(){this._queue=[],this._pending=!1}return e.prototype.isLocked=function(){return this._pending},e.prototype.acquire=function(){var e=this,t=new Promise(function(t){return e._queue.push(t)});return this._pending||this._dispatchNext(),t},e.prototype.runExclusive=function(e){return this.acquire().then(function(t){var n;try{n=e()}catch(e){throw t(),e}return Promise.resolve(n).then(function(e){return t(),e},function(e){throw t(),e})})},e.prototype._dispatchNext=function(){this._queue.length>0?(this._pending=!0,this._queue.shift()(this._dispatchNext.bind(this))):this._pending=!1},e}();n.default=i},{}],2:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=e("./Mutex");n.Mutex=i.default},{"./Mutex":1}],3:[function(e,t,n){"use strict";var i=[];i[0]=function(){return function(){}},i[1]=function(e,t){return void 0===t?e:function(n){e(n,t)}};var r=function(){function e(){this.hasHandlers=!1,this._handlers=[],this._contexts=[],this._createDispatcher()}return e.prototype.addHandler=function(e,t){return this.isHandlerAttached(e,t)||(this._handlers.push(e),this._contexts.push(t),this._createDispatcher(),this._updateHasHandlers()),this},e.prototype.removeHandler=function(e,t){var n=this._getHandlerIndex(e,t);return void 0!==n&&(this._handlers.splice(n,1),this._contexts.splice(n,1),this._createDispatcher(),this._updateHasHandlers()),this},e.prototype.isHandlerAttached=function(e,t){return void 0!==this._getHandlerIndex(e,t)},e.prototype._updateHasHandlers=function(){this.hasHandlers=!!this._handlers.length},e.prototype._getHandlerIndex=function(e,t){var n,i=this._handlers.length;for(n=0;n<i&&(this._handlers[n]!==e||this._contexts[n]!==t);n++);return n<i?n:void 0},e.prototype._createDispatcher=function(){this.dispatch=function(e){return i[e]||(i[e]=function(e){for(var t="return function dispatcher"+e+"(payload) {\n",n=[],i=[],r=0;r<e;r++)n.push("cb"+r),i.push("ctx"+r),t+="    cb"+r+"(payload, ctx"+r+");\n";return t+="};",new(Function.bind.apply(Function,[void 0].concat(n.concat(i),[t])))}(e)),i[e]}(this._handlers.length).apply(this,this._handlers.concat(this._contexts))},e}();Object.defineProperty(n,"__esModule",{value:!0}),n.default=r},{}],4:[function(e,t,n){"use strict";var i=e("./Event");n.Event=i.default},{"./Event":3}],5:[function(e,t,n){!function(){"use strict";var e="undefined"!=typeof window&&void 0!==window.document?window.document:{},n=void 0!==t&&t.exports,i="undefined"!=typeof Element&&"ALLOW_KEYBOARD_INPUT"in Element,r=function(){for(var t,n=[["requestFullscreen","exitFullscreen","fullscreenElement","fullscreenEnabled","fullscreenchange","fullscreenerror"],["webkitRequestFullscreen","webkitExitFullscreen","webkitFullscreenElement","webkitFullscreenEnabled","webkitfullscreenchange","webkitfullscreenerror"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitCurrentFullScreenElement","webkitCancelFullScreen","webkitfullscreenchange","webkitfullscreenerror"],["mozRequestFullScreen","mozCancelFullScreen","mozFullScreenElement","mozFullScreenEnabled","mozfullscreenchange","mozfullscreenerror"],["msRequestFullscreen","msExitFullscreen","msFullscreenElement","msFullscreenEnabled","MSFullscreenChange","MSFullscreenError"]],i=0,r=n.length,o={};i<r;i++)if((t=n[i])&&t[1]in e){for(i=0;i<t.length;i++)o[n[0][i]]=t[i];return o}return!1}(),o={change:r.fullscreenchange,error:r.fullscreenerror},s={request:function(t){var n=r.requestFullscreen;t=t||e.documentElement,/5\.1[.\d]* Safari/.test(navigator.userAgent)?t[n]():t[n](i&&Element.ALLOW_KEYBOARD_INPUT)},exit:function(){e[r.exitFullscreen]()},toggle:function(e){this.isFullscreen?this.exit():this.request(e)},onchange:function(e){this.on("change",e)},onerror:function(e){this.on("error",e)},on:function(t,n){var i=o[t];i&&e.addEventListener(i,n,!1)},off:function(t,n){var i=o[t];i&&e.removeEventListener(i,n,!1)},raw:r};r?(Object.defineProperties(s,{isFullscreen:{get:function(){return Boolean(e[r.fullscreenElement])}},element:{enumerable:!0,get:function(){return e[r.fullscreenElement]}},enabled:{enumerable:!0,get:function(){return Boolean(e[r.fullscreenEnabled])}}}),n?t.exports=s:window.screenfull=s):n?t.exports=!1:window.screenfull=!1}()},{}],6:[function(e,t,n){(function(e){var n,i,r,o,s,a,u,c,h,l,_,d,f,p,g,m,v;!function(n){function i(e,t){return"function"==typeof Object.create?Object.defineProperty(e,"__esModule",{value:!0}):e.__esModule=!0,function(n,i){return e[n]=t?t(n,i):i}}var r="object"==typeof e?e:"object"==typeof self?self:"object"==typeof this?this:{};n("object"==typeof t&&"object"==typeof t.exports?i(r,i(t.exports)):i(r))}(function(e){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};n=function(e,n){function i(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)},i=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++){t=arguments[n];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])}return e},r=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var r=0,i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&(n[i[r]]=e[i[r]]);return n},o=function(e,t,n,i){var r,o=arguments.length,s=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,i);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,n,s):r(t,n))||s);return o>3&&s&&Object.defineProperty(t,n,s),s},s=function(e,t){return function(n,i){t(n,i,e)}},a=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},u=function(e,t,n,i){return new(n||(n=Promise))(function(r,o){function s(e){e.done?r(e.value):new n(function(t){t(e.value)}).then(function(e){try{s(i.next(e))}catch(e){o(e)}},function(e){try{s(i.throw(e))}catch(e){o(e)}})}s((i=i.apply(e,t||[])).next())})},c=function(e,t){function n(n){return function(s){return function(n){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,r&&(o=r[2&n[0]?"return":n[0]?"throw":"next"])&&!(o=o.call(r,n[1])).done)return o;switch(r=0,o&&(n=[0,o.value]),n[0]){case 0:case 1:o=n;break;case 4:return a.label++,{value:n[1],done:!1};case 5:a.label++,r=n[1],n=[0];continue;case 7:n=a.ops.pop(),a.trys.pop();continue;default:if(o=a.trys,!(o=o.length>0&&o[o.length-1])&&(6===n[0]||2===n[0])){a=0;continue}if(3===n[0]&&(!o||n[1]>o[0]&&n[1]<o[3])){a.label=n[1];break}if(6===n[0]&&a.label<o[1]){a.label=o[1],o=n;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(n);break}o[2]&&a.ops.pop(),a.trys.pop();continue}n=t.call(e,a)}catch(e){n=[6,e],r=0}finally{i=o=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}([n,s])}}var i,r,o,s,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s},h=function(e,t){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])},l=function(e){var t="function"==typeof Symbol&&e[Symbol.iterator],n=0;return t?t.call(e):{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}}},_=function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var i,r,o=n.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(i=o.next()).done;)s.push(i.value)}catch(e){r={error:e}}finally{try{i&&!i.done&&(n=o.return)&&n.call(o)}finally{if(r)throw r.error}}return s},d=function(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(_(arguments[t]));return e},f=function(e){return this instanceof f?(this.v=e,this):new f(e)},p=function(e,t,n){function i(e){a[e]&&(s[e]=function(t){return new Promise(function(n,i){u.push([e,t,n,i])>1||r(e,t)})})}function r(e,t){try{!function(e){e.value instanceof f?Promise.resolve(e.value.v).then(function(e){r("next",e)},function(e){r("throw",e)}):o(u[0][2],e)}(a[e](t))}catch(e){o(u[0][3],e)}}function o(e,t){e(t),u.shift(),u.length&&r(u[0][0],u[0][1])}if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var s,a=n.apply(e,t||[]),u=[];return s={},i("next"),i("throw"),i("return"),s[Symbol.asyncIterator]=function(){return this},s},g=function(e){function t(t,r){e[t]&&(n[t]=function(n){return(i=!i)?{value:f(e[t](n)),done:"return"===t}:r?r(n):n})}var n,i;return n={},t("next"),t("throw",function(e){throw e}),t("return"),n[Symbol.iterator]=function(){return this},n},m=function(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t=e[Symbol.asyncIterator];return t?t.call(e):"function"==typeof l?l(e):e[Symbol.iterator]()},v=function(e,t){return Object.defineProperty?Object.defineProperty(e,"raw",{value:t}):e.raw=t,e},e("__extends",n),e("__assign",i),e("__rest",r),e("__decorate",o),e("__param",s),e("__metadata",a),e("__awaiter",u),e("__generator",c),e("__exportStar",h),e("__values",l),e("__read",_),e("__spread",d),e("__await",f),e("__asyncGenerator",p),e("__asyncDelegator",g),e("__asyncValues",m),e("__makeTemplateObject",v)})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],7:[function(e,t,n){"use strict";var i,r=e("microevent.ts");!function(e){!function(e){e[e.signal=0]="signal",e[e.rpc=1]="rpc",e[e.internal=2]="internal"}(e.MessageType||(e.MessageType={}));e.MessageType}((i=function(){function e(e,t){void 0===t&&(t=0),this._dispatch=e,this._rpcTimeout=t,this.error=new r.Event,this._rpcHandlers={},this._signalHandlers={},this._pendingTransactions={},this._nextTransactionId=0}return e.prototype.dispatch=function(t){var n=t;switch(n.type){case e.MessageType.signal:return this._handleSignal(n);case e.MessageType.rpc:return this._handeRpc(n);case e.MessageType.internal:return this._handleInternal(n);default:this._raiseError("invalid message type "+n.type)}},e.prototype.rpc=function(t,n,i){var r=this,o=this._nextTransactionId++;return this._dispatch({type:e.MessageType.rpc,transactionId:o,id:t,payload:n},i||void 0),new Promise(function(e,t){var n=r._pendingTransactions[o]={id:o,resolve:e,reject:t};r._rpcTimeout>0&&(r._pendingTransactions[o].timeoutHandle=setTimeout(function(){return r._transactionTimeout(n)},r._rpcTimeout))})},e.prototype.signal=function(t,n,i){return this._dispatch({type:e.MessageType.signal,id:t,payload:n},i||void 0),this},e.prototype.registerRpcHandler=function(e,t){if(this._rpcHandlers[e])throw new Error("rpc handler for "+e+" already registered");return this._rpcHandlers[e]=t,this},e.prototype.registerSignalHandler=function(e,t){return this._signalHandlers[e]||(this._signalHandlers[e]=[]),this._signalHandlers[e].push(t),this},e.prototype.deregisterRpcHandler=function(e,t){return this._rpcHandlers[e]&&delete this._rpcHandlers[e],this},e.prototype.deregisterSignalHandler=function(e,t){return this._signalHandlers[e]&&(this._signalHandlers[e]=this._signalHandlers[e].filter(function(e){return t!==e})),this},e.prototype._raiseError=function(t){this.error.dispatch(new Error(t)),this._dispatch({type:e.MessageType.internal,id:"error",payload:t})},e.prototype._handleSignal=function(e){if(!this._signalHandlers[e.id])return this._raiseError("invalid signal "+e.id);this._signalHandlers[e.id].forEach(function(t){return t(e.payload)})},e.prototype._handeRpc=function(t){var n=this;if(!this._rpcHandlers[t.id])return this._raiseError("invalid rpc "+t.id);Promise.resolve(this._rpcHandlers[t.id](t.payload)).then(function(i){return n._dispatch({type:e.MessageType.internal,id:"resolve_transaction",transactionId:t.transactionId,payload:i})},function(i){return n._dispatch({type:e.MessageType.internal,id:"reject_transaction",transactionId:t.transactionId,payload:i})})},e.prototype._handleInternal=function(e){switch(e.id){case"resolve_transaction":if(!this._pendingTransactions[e.transactionId])return this._raiseError("no pending transaction with id "+e.transactionId);this._pendingTransactions[e.transactionId].resolve(e.payload),this._clearTransaction(this._pendingTransactions[e.transactionId]);break;case"reject_transaction":if(!this._pendingTransactions[e.transactionId])return this._raiseError("no pending transaction with id "+e.transactionId);this._pendingTransactions[e.transactionId].reject(e.payload),this._clearTransaction(this._pendingTransactions[e.transactionId]);break;case"error":this.error.dispatch(new Error("remote error: "+e.payload));break;default:this._raiseError("unhandled internal message "+e.id)}},e.prototype._transactionTimeout=function(e){e.reject("transaction timed out"),this._raiseError("transaction "+e.id+" timed out"),delete this._pendingTransactions[e.id]},e.prototype._clearTransaction=function(e){void 0!==e.timeoutHandle&&clearTimeout(e.timeoutHandle),delete this._pendingTransactions[e.id]},e}())||(i={})),Object.defineProperty(n,"__esModule",{value:!0}),n.default=i},{"microevent.ts":4}],8:[function(e,t,n){"use strict";var i=e("./RpcProvider");n.RpcProvider=i.default},{"./RpcProvider":7}],9:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=e("./Switch"),r=function(){function e(){this._left=new i.default,this._right=new i.default,this._up=new i.default,this._down=new i.default,this._fire=new i.default}return e.prototype.getLeft=function(){return this._left},e.prototype.getRight=function(){return this._right},e.prototype.getUp=function(){return this._up},e.prototype.getDown=function(){return this._down},e.prototype.getFire=function(){return this._fire},e}();n.default=r},{"./Switch":11}],10:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=e("microevent.ts"),r=e("./Switch"),o=function(){function e(){this.valueChanged=new i.Event,this._fireSwitch=new r.default,this._value=.5}return e.prototype.setValue=function(e){this._value=e,this.valueChanged.dispatch(e)},e.prototype.getValue=function(){return this._value},e.prototype.getFire=function(){return this._fireSwitch},e}();n.default=o},{"./Switch":11,"microevent.ts":4}],11:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=e("microevent.ts"),r=function(){function e(e){void 0===e&&(e=!1),this._state=e,this.stateChanged=new i.Event,this.beforeRead=new i.Event}return e.prototype.read=function(){return this.beforeRead.dispatch(this),this._state},e.prototype.peek=function(){return this._state},e.prototype.toggle=function(e){this._state!==e&&(this._state=e,this.stateChanged.dispatch(e))},e}();n.default=r},{"microevent.ts":4}],12:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i,r=e("tslib");!function(e){e.create=function(e){return void 0===e&&(e={}),r.__assign({tvMode:0,enableAudio:!0,randomSeed:-1,emulatePaddles:!0,frameStart:-1,pcmAudio:!1},e)},e.getClockHz=function(e){switch(e.tvMode){case 0:return 3584160;case 1:case 2:return 3556800}}}(i||(i={})),n.default=i},{tslib:6}],13:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=e("../io/Switch"),r=function(){function e(){this._selectSwitch=new i.default,this._resetButton=new i.default,this._colorSwitch=new i.default,this._difficutlyP0=new i.default,this._difficutlyP1=new i.default}return e.prototype.getSelectSwitch=function(){return this._selectSwitch},e.prototype.getResetButton=function(){return this._resetButton},e.prototype.getColorSwitch=function(){return this._colorSwitch},e.prototype.getDifficultySwitchP0=function(){return this._difficutlyP0},e.prototype.getDifficultySwitchP1=function(){return this._difficutlyP1},e}();n.default=r},{"../io/Switch":11}],14:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i;!function(e){var t;!function(e){e.vanilla_2k="vanilla_2k",e.vanilla_4k="vanilla_4k",e.bankswitch_8k_F8="bankswitch_8k_F8",e.bankswitch_8k_E0="bankswitch_8k_E0",e.bankswitch_8k_3F="bankswitch_8k_3F",e.bankswitch_8k_FE="bankswitch_8k_FE",e.bankswitch_8k_UA="bankswitch_8k_UA",e.bankswitch_8k_DPC="bankswitch_8k_DPC",e.bankswitch_12k_FA="bankswitch_12k_FA",e.bankswitch_16k_F6="bankswitch_16k_F6",e.bankswitch_16k_E7="bankswitch_16k_E7",e.bankswitch_FA2="bankswitch_FA2",e.bankswitch_32k_F4="bankswitch_32k_F4",e.bankswitch_64k_F0="bankswitch_64k_F0",e.bankswitch_64k_EF="bankswitch_64k_EF",e.bankswitch_3E="bankswitch_3E",e.bankswitch_supercharger="bankswitch_supercharger",e.bankswitch_dpc_plus="bankswitch_dpc_plus",e.bankswitch_cdf="bankswitch_cdf",e.unknown="unknown"}(t=e.CartridgeType||(e.CartridgeType={})),e.getAllTypes=function(){return[t.vanilla_2k,t.vanilla_4k,t.bankswitch_8k_F8,t.bankswitch_8k_E0,t.bankswitch_8k_3F,t.bankswitch_8k_FE,t.bankswitch_8k_UA,t.bankswitch_12k_FA,t.bankswitch_8k_DPC,t.bankswitch_16k_F6,t.bankswitch_16k_E7,t.bankswitch_FA2,t.bankswitch_32k_F4,t.bankswitch_3E,t.bankswitch_64k_F0,t.bankswitch_64k_EF,t.bankswitch_supercharger,t.bankswitch_dpc_plus,t.bankswitch_cdf,t.unknown]},e.describeCartridgeType=function(e){switch(e){case t.vanilla_2k:return"plain 2k";case t.vanilla_4k:return"plain 4k";case t.bankswitch_8k_F8:return"bankswitched 8k, F8 (Atari) scheme";case t.bankswitch_8k_E0:return"bankswitched 8k, E0 (Parker Bros.) scheme";case t.bankswitch_8k_3F:return"bankswitched 8k, 3F (Tigervision) scheme";case t.bankswitch_8k_FE:return"bankswitched 8k, FE (Activision) scheme";case t.bankswitch_8k_UA:return"bankswitched 8k, UA (Pleiades) scheme";case t.bankswitch_12k_FA:return"bankswitched 12k, FA (CBS) scheme";case t.bankswitch_8k_DPC:return"bankswitched 8k + DPC";case t.bankswitch_16k_F6:return"bankswitched 16k, F6 (Atari) scheme";case t.bankswitch_16k_E7:return"bankswitched 16k, E7 (M-Network) scheme";case t.bankswitch_FA2:return"bankswitched 28k/29k, FA2 (modified CBS) scheme";case t.bankswitch_32k_F4:return"bankswitched 32k, F4 (Atari) scheme";case t.bankswitch_3E:return"bankswitched 3E (Tigervision + RAM) scheme";case t.bankswitch_64k_F0:return"bankswitched 64k, F0 (Megaboy) scheme";case t.bankswitch_64k_EF:return"bankswitched 64k, EFSC (Homestar Runner) scheme";case t.bankswitch_supercharger:return"bankswitched supercharger";case t.bankswitch_dpc_plus:return"bankswitched DPC+";case t.bankswitch_cdf:return"bankswitched CDF";case t.unknown:return"unknown"}}}(i||(i={})),n.default=i},{}],15:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=e("../Config"),r=e("../../../tools/AudioOutputBuffer"),o=e("../../../tools/base64"),s=o.decode("AQEPAQEBAQEBAQEBAwMDAQ=="),a=new Int8Array([1]),u=new Int8Array([1,1]),c=new Int8Array([16,15]),h=o.decode("AQICAQEBBAM="),l=o.decode("AQIBAQICBQQCAQMBAQEBBA=="),_=o.decode("AQQBAwIEAQIDAgEBAQEBAQIEAgEEAQECAgEDAgEDAQEBBAEBAQECAQECBgECAgECAQIBAQIBBgIBAgIBAQEBAgICAgcCAwICAQEBAwIBAQIBAQcBAQMBAQIDAwEBAQICAQECAgQDBQEDAQEFAgEBAQIBAgEDAQIFAQECAQEBBQEBAQEBAQEBBgEBAQIBAQEBBAIBAQMBAwYDAgMBAQIBAgQBAQEDAQEBAQMBAgEEAgIDBAEBBAECAQICAgEBBAMBBAQJBQQBBQMBAQMCAgIBBQECAQEBAgMBAgEBAwQCBQICAQIDAQEBAQECAQMDAwIBAgEBAQEBAwMBAgIDAQMBCA=="),d=o.decode("BQYEBQoFAwcECgYDBgQJBg=="),f=[a,h,h,o.decode("AgMCAQQBBgoCBAIBAQQFCQMDBAEBAQgFBQUEAQEBCAQCCAMDAQEHBAIHBQEDAQcEAQQIAgEDBAcBAwcDAgEGBgICBAUDAgYGAQMDAgUDBwMEAwICAgUJAwEFAwECAgsFAQUDAQECDAUBAgUCAQEMBgECBQECAQoGAwICBAECBgo="),u,u,c,l,_,l,c,a,u,u,c,d],p=function(){function e(e){this._config=e}return e.prototype.setConfig=function(e){this._config=e},e.prototype.getKey=function(e,t){return f[e]===u&&s[e]*(t+1)==1?0:e<<5|t},e.prototype.getBuffer=function(e){for(var t=e>>>5&15,n=31&e,o=f[t],a=0,u=0;u<o.length;u++)a+=o[u];a=a*s[t]*(n+1);for(var c=new Float32Array(a),h=i.default.getClockHz(this._config)/114,l=0,_=0,d=0,p=!0,u=0;u<a;u++)++l===s[t]*(n+1)&&(l=0,++_===o[d]&&(d++,_=0,o.length===d&&(d=0)),p=!(1&d)),c[u]=p?1:-1;return new r.default(c,h)},e}();n.default=p},{"../../../tools/AudioOutputBuffer":16,"../../../tools/base64":18,"../Config":12}],16:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(e,t){this._content=e,this._sampleRate=t}return e.prototype.getLength=function(){return this._content.length},e.prototype.getContent=function(){return this._content},e.prototype.getSampleRate=function(){return this._sampleRate},e.prototype.replaceUnderlyingBuffer=function(e){this._content=e},e}();n.default=i},{}],17:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(e){this._capacity=e,this._size=0,this._index=0,this._buffer=new Array(this._capacity);for(var t=0;t<this._capacity;t++)this._buffer[t]=null}return e.prototype.size=function(){return this._size},e.prototype.pop=function(){if(0!==this._size){var e=this._buffer[this._index];return this._buffer[this._index]=null,this._index=(this._index+1)%this._capacity,this._size--,e}},e.prototype.push=function(e){return this._size===this._capacity&&this.pop(),this._buffer[(this._index+this._size++)%this._capacity]=e,this},e.prototype.forEach=function(e){for(var t=0;t<this._size;t++)e(this._buffer[(this._index+t)%this._capacity]);return this},e.prototype.clear=function(){for(var e=0;e<this._capacity;e++)this._buffer[e]=null;return this._size=0,this._index=0,this},e}();n.default=i},{}],18:[function(e,t,n){"use strict";function i(e,t){var n=r[e.charCodeAt(t)];if(n>63)throw new Error('invalid base64 character "'+e[t]+'" at index '+t);return n}Object.defineProperty(n,"__esModule",{value:!0});var r=new Uint8Array(256);!function(e){var t;for(t=0;t<256;t++)r[t]=255;for(t=0;t<64;t++)r["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charCodeAt(t)]=t;r["=".charCodeAt(0)]=0}(n.__init||(n.__init={})),n.decode=function(e){if(e.length%4!=0)throw new Error("invalid base64 data --- char count mismatch");for(var t=e.length/4,n=3*t-function(e){for(var t=0,n=e.length-1;n>=0&&"="===e[n--];)t++;return t}(e),r=new Uint8Array(n),o=0,s=0;s<t;s++)for(var a=function(e,t){return(i(e,t)<<18)+(i(e,t+1)<<12)+(i(e,t+2)<<6)+i(e,t+3)}(e,4*s),u=0;u<3&&o<n;u++)r[o++]=a>>>8*(2-u)&255;return r}},{}],19:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=e("microevent.ts"),r=e("./PoolMember"),o=function(){function e(e){this._factory=e,this.event={release:new i.Event,dispose:new i.Event},this._pool=[],this._poolSize=0}return e.prototype.get=function(){var e,t=this;if(0===this._poolSize){var n=this._factory();e=new r.default(n,function(e){return t._releaseMember(e)},function(e){return t._disposeMember(e)})}else(e=this._pool[--this._poolSize])._isAvailable=!1;return e},e.prototype._releaseMember=function(e){if(e._isAvailable)throw new Error("Trying to release an already released pool member");if(e._isDisposed)throw new Error("Trying to release an already disposed pool member");var t=this._poolSize++;this._pool[t]=e,e._isAvailable=!0,e._poolPosition=t,this.event.release.dispatch(e.get())},e.prototype._disposeMember=function(e){if(e._isDisposed)throw new Error("Trying to dispose of an already disposed pool member");e._isAvailable&&(this._poolSize>1&&(this._pool[e._poolPosition]=this._pool[this._poolSize-1]),this._poolSize--),e._isDisposed=!0,this.event.dispose.dispatch(e.get())},e}();n.default=o},{"./PoolMember":20,"microevent.ts":4}],20:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(e,t,n){this._value=e,this._releaseCB=t,this._disposeCB=n,this._isAvailable=!1,this._isDisposed=!1}return e.prototype.adopt=function(e){this._value=e},e.prototype.get=function(){return this._value},e.prototype.release=function(){this._releaseCB(this)},e.prototype.dispose=function(){this._disposeCB(this)},e}();n.default=i},{}],21:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=e("screenfull"),r=function(){function e(e){this._videoDriver=e,this._resizeListener=this._adjustSizeForFullscreen.bind(this),this._changeListener=this._onChange.bind(this),this._engaged=!1}return e.prototype.engage=function(){this._engaged||(this._engaged=!0,i.on("change",this._changeListener),i.request(this._videoDriver.getCanvas()))},e.prototype.disengage=function(){this._engaged&&i.exit()},e.prototype.toggle=function(){this._engaged?this.disengage():this.engage()},e.prototype.isEngaged=function(){return this._engaged},e.prototype._onChange=function(){i.isFullscreen?(window.addEventListener("resize",this._resizeListener),this._adjustSizeForFullscreen()):(this._resetSize(),window.removeEventListener("resize",this._resizeListener),i.off("change",this._changeListener),this._engaged=!1)},e.prototype._resetSize=function(){var e=this,t=this._videoDriver.getCanvas();t.style.width="",t.style.height="",setTimeout(function(){return e._videoDriver.resize()},0)},e.prototype._adjustSizeForFullscreen=function(){var e=this._videoDriver.getCanvas();this._videoDriver.resize(window.innerWidth,window.innerHeight),e.style.width=window.innerWidth+"px",e.style.height=window.innerHeight+"px"},e}();n.default=r},{screenfull:5}],22:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(){this._x=-1,this._listener=this._onDocumentMouseMove.bind(this)}return e.prototype.bind=function(e){this._paddle||(this._paddle=e,this._x=-1,document.addEventListener("mousemove",this._listener))},e.prototype.unbind=function(){this._paddle&&(document.removeEventListener("mousemove",this._listener),this._paddle=null)},e.prototype._onDocumentMouseMove=function(e){if(this._x>=0){var t=e.screenX-this._x,n=this._paddle.getValue();(n+=-t/window.innerWidth/.9)<0&&(n=0),n>1&&(n=1),this._paddle.setValue(n)}this._x=e.screenX},e}();n.default=i},{}],23:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=e("tslib"),r=["imageSmoothingEnabled","mozImageSmoothingEnabled","webkitImageSmoothingEnabled","msImageSmoothingEnabled"],o=100,s=function(){function e(e,t){void 0===t&&(t=4/3),this._canvas=e,this._aspect=t,this._syncRendering=!0,this._animationFrameHandle=0,this._pendingFrame=null,this._video=null,this._interpolate=!0,this._context=this._canvas.getContext("2d"),this._renderCanvas=document.createElement("canvas"),this._renderCanvas.width=this._renderCanvas.height=o,this._renderContext=this._renderCanvas.getContext("2d")}return e.prototype.resize=function(e,t){return void 0!==e&&void 0!==t||(e=this._canvas.clientWidth,t=this._canvas.clientHeight),this._canvas.width=e,this._canvas.height=t,this._clearCanvas(),this._recalculateBlittingMetrics(),this._applyInterpolationSettings(),this._video&&this._blitToCanvas(),this},e.prototype.init=function(){return this.enableInterpolation(!0),this._clearRenderCanvas(),this.resize(),this},e.prototype.close=function(){return this},e.prototype.enableSyncRendering=function(e){return e===this._syncRendering?this:(this._cancelPendingFrame(),this._syncRendering=e,this)},e.prototype.syncRenderingEnabled=function(){return this._syncRendering},e.prototype.bind=function(t){return this._video?this:(this._video=t,this._videoWidth=this._renderCanvas.width=this._video.getWidth(),this._videoHeight=this._renderCanvas.height=this._video.getHeight(),this.resize(),this._clearRenderCanvas(),this._video.newFrame.addHandler(e._frameHandler,this),this)},e.prototype.unbind=function(){return this._video?(this._video.newFrame.removeHandler(e._frameHandler,this),this._video=null,this._cancelPendingFrame(),this._clearCanvas(),this):this},e.prototype.enableInterpolation=function(e){return this._interpolate===e?this:(this._interpolate=e,this._applyInterpolationSettings(),this)},e.prototype.interpolationEnabled=function(){return this._interpolate},e.prototype.getCanvas=function(){return this._canvas},e._frameHandler=function(e,t){t._pendingFrame&&t._pendingFrame.release(),t._pendingFrame=e,t._syncRendering?t._animationFrameHandle||t._scheduleDraw():t._draw()},e.prototype._clearCanvas=function(){this._context.fillStyle="solid black",this._context.fillRect(0,0,this._canvas.width,this._canvas.height)},e.prototype._clearRenderCanvas=function(){this._renderContext.fillStyle="solid black",this._renderContext.fillRect(0,0,this._renderCanvas.width,this._renderCanvas.height)},e.prototype._draw=function(){this._blitToRenderCanvas(),this._blitToCanvas(),this._pendingFrame.release(),this._pendingFrame=null},e.prototype._blitToRenderCanvas=function(){this._renderContext.putImageData(this._pendingFrame.get(),0,0)},e.prototype._blitToCanvas=function(){this._context.drawImage(this._renderCanvas,0,0,this._videoWidth,this._videoHeight,this._renderX,this._renderY,this._renderWidth,this._renderHeight)},e.prototype._scheduleDraw=function(){var e=this;this._animationFrameHandle||(this._animationFrameHandle=requestAnimationFrame(function(){e._draw(),e._animationFrameHandle=0}))},e.prototype._cancelPendingFrame=function(){this._animationFrameHandle&&(cancelAnimationFrame(this._animationFrameHandle),this._animationFrameHandle=0),this._pendingFrame&&(this._pendingFrame.release(),this._pendingFrame=null)},e.prototype._recalculateBlittingMetrics=function(){var e=this._canvas.width,t=this._canvas.height;this._aspect*t<=e?(this._renderHeight=t,this._renderWidth=this._aspect*t,this._renderY=0,this._renderX=Math.floor((e-this._renderWidth)/2)):(this._renderHeight=e/this._aspect,this._renderWidth=e,this._renderY=Math.floor((t-this._renderHeight)/2),this._renderX=0)},e.prototype._applyInterpolationSettings=function(){try{for(var e=i.__values(r),t=e.next();!t.done;t=e.next()){var n=t.value;this._context[n]=this._interpolate}}catch(e){o={error:e}}finally{try{t&&!t.done&&(s=e.return)&&s.call(e)}finally{if(o)throw o.error}}var o,s},e}();n.default=s},{tslib:6}],24:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=e("tslib"),r=e("async-mutex"),o=e("./audio/WaveformChannel"),s=e("./audio/PCMChannel"),a=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),this._context=null,this._merger=null,this._waveformChannels=null,this._pcmChannels=null,this._channels=null,this._cache=new Map,this._mutex=new r.Mutex,this._isBound=!1,this._waveformChannels=new Array(e),this._pcmChannels=new Array(t);for(a=0;a<e;a++)this._waveformChannels[a]=new o.default(this._cache);for(var a=0;a<t;a++)this._pcmChannels[a]=new s.default(n);this._channels=i.__spread(this._waveformChannels,this._pcmChannels)}return e.prototype.init=function(){var e=this,t=window.AudioContext||window.webkitAudioContext;if(!t)throw new Error("web audio is not supported by runtime");this._context=new t;try{this._context.destination.channelCount=1}catch(e){console.warn("audio driver: failed to set channel count")}this._merger=this._context.createChannelMerger(this._channels.length),this._merger.connect(this._context.destination),this._channels.forEach(function(t){return t.init(e._context,e._merger)})},e.prototype.bind=function(e,t){if(void 0===e&&(e=[]),void 0===t&&(t=[]),!this._isBound){if(e.length!==this._waveformChannels.length)throw new Error("invalid number of waveform sources: expected "+this._waveformChannels.length+", got "+e.length);if(t.length!==this._pcmChannels.length)throw new Error("invalid number of waveform sources: expected "+this._pcmChannels.length+", got "+t.length);this._waveformChannels.forEach(function(t,n){return t.bind(e[n])}),this._pcmChannels.forEach(function(e,n){return e.bind(t[n])}),this._isBound=!0,this.resume()}},e.prototype.unbind=function(){this._isBound&&(this._channels.forEach(function(e){return e.unbind()}),this._isBound=!1,this.pause())},e.prototype.setMasterVolume=function(e,t){this._channels[e].setMasterVolume(t)},e.prototype.pause=function(){var e=this;return this._mutex.runExclusive(function(){return new Promise(function(t){e._context.suspend().then(t,t),setTimeout(t,200)})})},e.prototype.resume=function(){var e=this;return this._mutex.runExclusive(function(){return new Promise(function(t){e._context.resume().then(t,t),setTimeout(t,200)})})},e.prototype.close=function(){var e=this;this._mutex.runExclusive(function(){return e._context.close()})},e}();n.default=a},{"./audio/PCMChannel":26,"./audio/WaveformChannel":27,"async-mutex":2,tslib:6}],25:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(){this._buffer=new Float32Array(2),this._fractionalIndex=0,this._needsData=!1,this._ratio=0,this.reset(1,1)}return e.prototype.reset=function(e,t){this._ratio=e/t,this._needsData=!1,this._fractionalIndex=0;for(var n=0;n<2;n++)this._buffer[n]=0},e.prototype.get=function(){var e=(1-this._fractionalIndex)*this._buffer[0]+this._fractionalIndex*this._buffer[1];return this._fractionalIndex+=this._ratio,this._fractionalIndex>1&&(this._fractionalIndex-=1,this._needsData=!0),e},e.prototype.push=function(e){this._buffer[0]=this._buffer[1],this._buffer[1]=e,this._needsData=!1},e.prototype.needsData=function(){return this._needsData},e}();n.default=i},{}],26:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=e("../../../tools/RingBuffer"),r=e("./LinearResampler"),o=function(){function e(e){void 0===e&&(e=1024),this._hostFragmentSize=e,this._outputSampleRate=0,this._bufferSize=0,this._volume=1,this._gain=null,this._processor=null,this._bufferUnderrun=!1,this._fragmentRing=null,this._fragmentSize=0,this._inputSampleRate=0,this._fragmentIndex=0,this._currentFragment=null,this._lastFragment=null,this._resampler=new r.default}return e.prototype.init=function(e,t){var n=this;this._outputSampleRate=e.sampleRate,this._gain=e.createGain(),this._gain.gain.value=this._volume,this._gain.connect(t),this._processor=e.createScriptProcessor(this._hostFragmentSize,1,1),this._bufferSize=this._processor.bufferSize,this._processor.connect(this._gain),this._processor.onaudioprocess=function(e){return n._processAudio(e)},e.createBuffer(1,1,e.sampleRate).getChannelData(0).set([0])},e.prototype.bind=function(t){this.unbind(),this._audio=t,this._fragmentSize=t.getFrameSize(),this._inputSampleRate=t.getSampleRate(),this._fragmentIndex=0,this._lastFragment=null,this._bufferUnderrun=!0,this._fragmentRing=new i.default(Math.ceil(4*this._bufferSize/this._outputSampleRate/this._fragmentSize*this._inputSampleRate)),this._audio.newFrame.addHandler(e._onNewFragment,this),this._resampler.reset(this._inputSampleRate,this._outputSampleRate)},e.prototype.unbind=function(){this._audio&&(this._audio.newFrame.removeHandler(e._onNewFragment,this),this._lastFragment&&(this._lastFragment.release(),this._lastFragment=null),this._currentFragment&&(this._currentFragment.release(),this._currentFragment=null),this._fragmentRing&&(this._fragmentRing.forEach(function(e){return e.release()}),this._fragmentRing.clear(),this._fragmentRing=null))},e.prototype.setMasterVolume=function(e){this._volume=e},e._onNewFragment=function(e,t){t._fragmentRing.push(e),t._currentFragment||(t._currentFragment=t._fragmentRing.pop(),t._fragmentIndex=0)},e.prototype._processAudio=function(e){var t=this;if(this._audio){var n=e.outputBuffer.getChannelData(0),i=0,r=function(e){for(var r=t._lastFragment&&t._lastFragment.get();i<e;)t._resampler.needsData()&&(t._resampler.push(t._audio&&t._audio.isPaused()||!r?0:r[t._fragmentIndex++]*t._volume),t._fragmentIndex>=t._fragmentSize&&(t._fragmentIndex=0)),n[i++]=t._resampler.get()};this._currentFragment&&this._bufferUnderrun&&(r(this._bufferSize>>>1),this._bufferUnderrun=!1);for(var o=this._currentFragment&&this._currentFragment.get();i<this._bufferSize&&this._currentFragment;)this._resampler.needsData()&&(this._resampler.push(o[this._fragmentIndex++]*this._volume),this._fragmentIndex>=this._fragmentSize&&(this._fragmentIndex=0,this._lastFragment&&this._lastFragment.release(),this._lastFragment=this._currentFragment,this._currentFragment=this._fragmentRing.pop(),o=this._currentFragment&&this._currentFragment.get())),n[i++]=this._resampler.get();i<this._bufferSize&&(this._bufferUnderrun=!0),r(this._bufferSize)}},e}();n.default=o},{"../../../tools/RingBuffer":17,"./LinearResampler":25}],27:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(e){this._cache=e,this._context=null,this._source=null,this._gain=null,this._audio=null,this._volume=0,this._masterVolume=1}return e.prototype.init=function(e,t){this._context=e,this._gain=this._context.createGain(),this._gain.connect(t)},e.prototype.bind=function(t){this._audio||(this._audio=t,this._volume=this._audio.getVolume(),this._updateGain(),this._audio.volumeChanged.addHandler(e._onVolumeChanged,this),this._audio.bufferChanged.addHandler(e._onBufferChanged,this),this._audio.stop.addHandler(e._onStop,this))},e.prototype.unbind=function(){this._audio&&(this._audio.volumeChanged.removeHandler(e._onVolumeChanged,this),this._audio.bufferChanged.removeHandler(e._onBufferChanged,this),this._audio.stop.removeHandler(e._onStop,this),this._source&&(this._source.stop(),this._source=null),this._audio=null)},e.prototype.setMasterVolume=function(e){this._masterVolume=e,this._updateGain()},e._onVolumeChanged=function(e,t){t._volume=e,t._updateGain()},e._onBufferChanged=function(e,t){if(!t._cache.has(e)){var n=t._audio.getBuffer(e),i=t._context.createBuffer(1,n.getLength(),n.getSampleRate());i.getChannelData(0).set(n.getContent()),t._cache.set(e,i)}var r=t._cache.get(e),o=t._context.createBufferSource();t._source&&t._source.stop(),o.loop=!0,o.buffer=r,o.connect(t._gain),o.start(),t._source=o},e._onStop=function(e,t){t._source&&(t._source.stop(),t._source=null)},e.prototype._updateGain=function(){this._gain.gain.value=this._volume*this._masterVolume},e}();n.default=i},{}],28:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(e,t){void 0===t&&(t={}),this._canvas=e,this._gl=null,this._program=null,this._vertexBuffer=null,this._textureCoordinateBuffer=null,this._currentFrameIndex=0,this._frameCount=0,this._gamma=1,this._aspect=4/3,this._povEmulation=!0,this._animationFrameHandle=0,this._syncRendering=!0,this._video=null,this._interpolation=!0,void 0!==t.aspect&&(this._aspect=t.aspect),void 0!==t.gamma&&(this._gamma=t.gamma),void 0!==t.povEmulation&&(this._povEmulation=t.povEmulation),this._gl=this._canvas.getContext("webgl",{alpha:!1}),this._createTextureArrays()}return e.prototype.init=function(){return this._gl.clearColor(0,0,0,1),this._createProgram(),this._createBuffers(),this.resize(),this._allocateTextures(),this._configureTextures(),this._setupAttribs(),this.enableInterpolation(!0),this},e.prototype.close=function(){var e=this;return this._program&&this._gl.deleteProgram(this._program),this._vertexShader&&this._gl.deleteShader(this._vertexShader),this._fragmentShader&&this._gl.deleteShader(this._fragmentShader),this._textures&&this._textures.forEach(function(t){return t&&e._gl.deleteTexture(t)}),this._imageData&&this._imageData.forEach(function(e){return e&&e.release()}),this._vertexBuffer&&this._gl.deleteBuffer(this._vertexBuffer),this._textureCoordinateBuffer&&this._gl.deleteBuffer(this._textureCoordinateBuffer),this},e.prototype.resize=function(e,t){return void 0!==e&&void 0!==t||(e=this._canvas.clientWidth,t=this._canvas.clientHeight),this._canvas.width=e,this._canvas.height=t,this._gl.viewport(0,0,e,t),this._recalculateVertexBuffer(),this._video&&this._draw(),this},e.prototype.getCanvas=function(){return this._canvas},e.prototype.bind=function(t){return this._video?this:(this.resize(),this._video=t,this._video.newFrame.addHandler(e._frameHandler,this),this)},e.prototype.unbind=function(){return this._cancelDraw(),this._video?(this._video.newFrame.removeHandler(e._frameHandler,this),this._video=null,this):this},e.prototype.enableInterpolation=function(e){return e===this._interpolation?this:(this._interpolation=e,this._configureTextures(),this)},e.prototype.interpolationEnabled=function(){return this._interpolation},e.prototype.enableSyncRendering=function(e){return e===this._syncRendering?this:(e||this._cancelDraw(),this._syncRendering=e,this)},e.prototype.syncRenderingEnabled=function(){return this._syncRendering},e.prototype.setGamma=function(e){return this._gamma=e,this},e.prototype.getGamma=function(){return this._gamma},e.prototype.enablePovEmulation=function(e){if(e===this._povEmulation)return this;this._povEmulation=e,this._reinit()},e.prototype.povEmulationEnabled=function(){return this._povEmulation},e._frameHandler=function(e,t){var n=t._imageData[t._currentFrameIndex];t._imageData[t._currentFrameIndex]=e,t._imageDataGeneration[t._currentFrameIndex]++,t._currentFrameIndex=(t._currentFrameIndex+1)%t._numberOfFramesToCompose,t._frameCount<t._numberOfFramesToCompose?t._frameCount++:(t._syncRendering?t._scheduleDraw():t._draw(),n.release())},e.prototype._createTextureArrays=function(){var e=this;this._numberOfFramesToCompose=this._povEmulation?3:1,this._textures&&this._textures.forEach(function(t){return t&&e._gl.deleteTexture(t)}),this._imageData&&this._imageData.forEach(function(e){return e&&e.release()}),this._textures=new Array(this._numberOfFramesToCompose),this._imageData=new Array(this._numberOfFramesToCompose),this._imageDataGeneration=new Array(this._numberOfFramesToCompose),this._textureGeneration=new Array(this._numberOfFramesToCompose);for(var t=0;t<this._numberOfFramesToCompose;t++)this._imageDataGeneration[t]=0,this._textureGeneration[t]=-1},e.prototype._reinit=function(){this._createTextureArrays(),this._createProgram(),this._allocateTextures(),this._configureTextures(),this._setupAttribs()},e.prototype._scheduleDraw=function(){var e=this;this._animationFrameHandle||(this._animationFrameHandle=requestAnimationFrame(function(){return e._draw(),e._animationFrameHandle=0}))},e.prototype._cancelDraw=function(){0!==this._animationFrameHandle&&(cancelAnimationFrame(this._animationFrameHandle),this._animationFrameHandle=0)},e.prototype._draw=function(){if(!(this._frameCount<this._numberOfFramesToCompose)){for(var e=this._gl,t=0;t<this._numberOfFramesToCompose;t++){var n=(this._currentFrameIndex-t-1+this._numberOfFramesToCompose)%this._numberOfFramesToCompose;this._textureGeneration[n]!==this._imageDataGeneration[n]&&(e.activeTexture(e["TEXTURE"+n]),e.bindTexture(e.TEXTURE_2D,this._textures[n]),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,this._imageData[n].get()),this._textureGeneration[n]=this._imageDataGeneration[n])}for(t=0;t<this._numberOfFramesToCompose;t++)e.uniform1i(this._getUniformLocation("u_Sampler"+t),(this._currentFrameIndex+this._numberOfFramesToCompose-t-1)%this._numberOfFramesToCompose);e.uniform1f(this._getUniformLocation("u_Gamma"),this._gamma),e.clear(e.COLOR_BUFFER_BIT),e.drawArrays(e.TRIANGLE_STRIP,0,4)}},e.prototype._createProgram=function(){var e=this._gl,t=e.createShader(e.VERTEX_SHADER),n=e.createShader(e.FRAGMENT_SHADER),i=e.createProgram();if(e.shaderSource(t,"attribute vec2 a_VertexPosition;\nattribute vec2 a_TextureCoordinate;\n\nvarying vec2 v_TextureCoordinate;\n\nvoid main() {\n    v_TextureCoordinate = a_TextureCoordinate;\n    gl_Position = vec4(a_VertexPosition, 0, 1);\n}\n"),e.compileShader(t),!e.getShaderParameter(t,e.COMPILE_STATUS))throw new Error("failed to compile vertex shader: "+e.getShaderInfoLog(t));if(e.shaderSource(n,this._povEmulation?"precision mediump float;\n\nvarying vec2 v_TextureCoordinate;\n\nuniform sampler2D u_Sampler0, u_Sampler1, u_Sampler2;\nuniform float u_Gamma;\n\nvoid main() {\n    vec4 compositedTexel =\n        0.4 * texture2D(u_Sampler0, v_TextureCoordinate) +\n        0.4 * texture2D(u_Sampler1, v_TextureCoordinate) +\n        0.2 * texture2D(u_Sampler2, v_TextureCoordinate);\n\n    gl_FragColor = vec4(pow(compositedTexel.rgb, vec3(u_Gamma)), 1.);\n}\n":"precision mediump float;\n\nvarying vec2 v_TextureCoordinate;\n\nuniform sampler2D u_Sampler0;\nuniform float u_Gamma;\n\nvoid main() {\n    vec4 texel = texture2D(u_Sampler0, v_TextureCoordinate);\n\n    gl_FragColor = vec4(pow(texel.rgb, vec3(u_Gamma)), 1.);\n}\n"),e.compileShader(n),!e.getShaderParameter(t,e.COMPILE_STATUS))throw new Error("failed to compile fragment shader: "+e.getShaderInfoLog(n));if(e.attachShader(i,t),e.attachShader(i,n),e.linkProgram(i),!e.getProgramParameter(i,e.LINK_STATUS))throw new Error("failed to link program: "+e.getProgramInfoLog(i));e.useProgram(i),this._program&&e.deleteProgram(this._program),this._vertexShader&&e.deleteShader(this._vertexShader),this._fragmentShader&&e.deleteShader(this._fragmentShader),this._program=i,this._vertexShader=t,this._fragmentShader=n},e.prototype._allocateTextures=function(){for(var e=0;e<this._numberOfFramesToCompose;e++)this._allocateTexture(e)},e.prototype._configureTextures=function(){for(var e=0;e<this._numberOfFramesToCompose;e++)this._configureTexture(e)},e.prototype._allocateTexture=function(e){var t=this._gl,n=t.createTexture();t.activeTexture(t["TEXTURE"+e]),t.bindTexture(t.TEXTURE_2D,n),this._textures[e]=n},e.prototype._configureTexture=function(e){var t=this._gl;t.activeTexture(t["TEXTURE"+e]),t.bindTexture(t.TEXTURE_2D,this._textures[e]),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,this._interpolation?t.LINEAR:t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,this._interpolation?t.LINEAR:t.NEAREST),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,1)},e.prototype._createBuffers=function(){var e=this._gl,t=e.createBuffer(),n=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,n),e.bufferData(e.ARRAY_BUFFER,new Float32Array([1,1,0,1,1,0,0,0]),e.STATIC_DRAW),this._vertexBuffer=t,this._textureCoordinateBuffer=n},e.prototype._recalculateVertexBuffer=function(){var e,t,n,i,r=this._gl,o=this._canvas.width,s=this._canvas.height,a=o>0?2/o:1,u=s>0?2/s:1;this._aspect*s<=o?(t=2,e=this._aspect*s*a,i=1,n=Math.floor(-this._aspect*s)/2*a):(t=o/this._aspect*u,e=2,i=Math.floor(o/this._aspect)/2*u,n=-1);var c=[n+e,i,n,i,n+e,i-t,n,i-t];r.bindBuffer(r.ARRAY_BUFFER,this._vertexBuffer),r.bufferData(r.ARRAY_BUFFER,new Float32Array(c),r.STATIC_DRAW)},e.prototype._getAttribLocation=function(e){var t=this._gl.getAttribLocation(this._program,e);if(t<0)throw new Error("unable to locate attribute "+e);return t},e.prototype._getUniformLocation=function(e){var t=this._gl.getUniformLocation(this._program,e);if(t<0)throw new Error("unable to locate uniform "+e);return t},e.prototype._setupAttribs=function(){var e=this._gl;e.bindBuffer(e.ARRAY_BUFFER,this._vertexBuffer),e.enableVertexAttribArray(this._getAttribLocation("a_VertexPosition")),e.vertexAttribPointer(this._getAttribLocation("a_VertexPosition"),2,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,this._textureCoordinateBuffer),e.enableVertexAttribArray(this._getAttribLocation("a_TextureCoordinate")),e.vertexAttribPointer(this._getAttribLocation("a_TextureCoordinate"),2,e.FLOAT,!1,0,0)},e}();n.default=i},{}],29:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=e("tslib"),r=e("../../stella/service/EmulationServiceInterface"),o=e("../../stella/service/worker/EmulationService"),s=e("../../stella/service/DriverManager"),a=e("../../driver/SimpleCanvasVideo"),u=e("../../driver/webgl/WebglVideo"),c=e("../../stella/driver/WebAudio"),h=e("../../stella/driver/KeyboardIO"),l=e("../../driver/MouseAsPaddle"),_=e("../../driver/FullscreenVideo"),d=e("../../../machine/stella/cartridge/CartridgeInfo"),f=e("../../../machine/stella/Config"),p=e("../../../tools/base64"),g=function(){function e(e,t,n){void 0===n&&(n={}),this._canvasElt=e,this._config=null,this._emulationService=null,this._videoDriver=null,this._webglVideo=null,this._fullscreenVideo=null,this._audioDriver=null,this._keyboardIO=null,this._paddle=null,this._driverManager=new s.default,this._config=i.__assign({smoothScaling:!0,simulatePov:!0,gamma:1,audio:!0,volume:1,enableKeyboard:!0,keyboardTarget:document,fullscreenViaKeyboard:!0,paddleViaMouse:!0},n),this._emulationService=new o.default(t),this._createDrivers()}return e.prototype.setGamma=function(e){return this._webglVideo&&this._webglVideo.setGamma(e),this},e.prototype.getGamma=function(){return this._webglVideo?this._webglVideo.getGamma():1},e.prototype.enablePovSimulation=function(e){return this._webglVideo&&this._webglVideo.enablePovEmulation(e),this},e.prototype.povSimulationEnabled=function(){return!!this._webglVideo&&this._webglVideo.povEmulationEnabled()},e.prototype.enableSmoothScaling=function(e){return this._videoDriver.enableInterpolation(e),this},e.prototype.smoothScalingEnabled=function(){return this._videoDriver.interpolationEnabled()},e.prototype.toggleFullscreen=function(e){return void 0===e?this._fullscreenVideo.toggle():e?this._fullscreenVideo.engage():this._fullscreenVideo.disengage(),this},e.prototype.isFullscreen=function(){return this._fullscreenVideo.isEngaged()},e.prototype.setVolume=function(e){return this._audioDriver&&this._audioDriver.setMasterVolume(Math.max(Math.min(e,1),0)),this},e.prototype.audioEnabled=function(){return!!this._audioDriver},e.prototype.getVolume=function(){return this._audioDriver?this._audioDriver.getMasterVolume():0},e.prototype.start=function(e,t,n){return i.__awaiter(this,void 0,void 0,function(){var t,r;return i.__generator(this,function(i){switch(i.label){case 0:return"string"==typeof e&&(e=p.decode(e)),t=f.default.create(),void 0!==n.randomSeed&&n.randomSeed>0&&(t.randomSeed=n.randomSeed),void 0!==n.emulatePaddles&&(t.emulatePaddles=n.emulatePaddles),void 0!==n.frameStart&&(t.frameStart=n.frameStart),r=this._mapState,[4,this._emulationService.start(e,t,n.cartridgeType)];case 1:return[2,r.apply(this,[i.sent()])]}})})},e.prototype.pause=function(){return i.__awaiter(this,void 0,void 0,function(){var e;return i.__generator(this,function(t){switch(t.label){case 0:return e=this._mapState,[4,this._emulationService.pause()];case 1:return[2,e.apply(this,[t.sent()])]}})})},e.prototype.resume=function(){return i.__awaiter(this,void 0,void 0,function(){var e;return i.__generator(this,function(t){switch(t.label){case 0:return e=this._mapState,[4,this._emulationService.resume()];case 1:return[2,e.apply(this,[t.sent()])]}})})},e.prototype.stop=function(){return i.__awaiter(this,void 0,void 0,function(){var e;return i.__generator(this,function(t){switch(t.label){case 0:return e=this._mapState,[4,this._emulationService.stop()];case 1:return[2,e.apply(this,[t.sent()])]}})})},e.prototype.lastError=function(){return this._emulationService.getLastError()},e.prototype._createDrivers=function(){var e=this;try{this._webglVideo=this._videoDriver=new u.default(this._canvasElt,{povEmulation:this._config.simulatePov,gamma:this._config.gamma}).init()}catch(e){this._webglVideo=null,this._videoDriver=new a.default(this._canvasElt).init()}if(this._videoDriver.enableInterpolation(this._config.smoothScaling),this._driverManager.addDriver(this._videoDriver,function(t){return e._videoDriver.bind(t.getVideo())}),this._fullscreenVideo=new _.default(this._videoDriver),this._config.audio)try{this._audioDriver=new c.default,this._audioDriver.setMasterVolume(this._config.volume),this._driverManager.addDriver(this._audioDriver,function(t){return e._audioDriver.bind(!0,[t.getPCMChannel()])})}catch(e){console.error("failed to initialize audio: "+(e&&e.message))}this._config.enableKeyboard&&(this._keyboardIO=new h.default(this._config.keyboardTarget),this._driverManager.addDriver(this._keyboardIO,function(t){return e._keyboardIO.bind(t.getJoystick(0),t.getJoystick(1),t.getControlPanel())}),this._config.fullscreenViaKeyboard&&this._keyboardIO.toggleFullscreen.addHandler(function(){return e._fullscreenVideo.toggle()})),this._config.paddleViaMouse&&(this._paddle=new l.default,this._driverManager.addDriver(this._paddle,function(t){return e._paddle.bind(t.getPaddle(0))}))},e.prototype._mapState=function(t){switch(t){case r.default.State.stopped:return e.State.stopped;case r.default.State.running:return e.State.running;case r.default.State.paused:return e.State.paused;case r.default.State.error:return e.State.error;default:throw new Error("cannot happen")}},e}();!function(e){!function(e){e.ntsc="ntsc",e.pal="pal",e.secam="secam"}(e.TvMode||(e.TvMode={})),e.CartridgeType=d.default.CartridgeType,e.describeCartridgeType=d.default.CartridgeType,e.allCartridgeTypes=d.default.getAllTypes;!function(e){e.running="running",e.paused="paused",e.stopped="stopped",e.error="error"}(e.State||(e.State={}))}(g||(g={})),n.default=g},{"../../../machine/stella/Config":12,"../../../machine/stella/cartridge/CartridgeInfo":14,"../../../tools/base64":18,"../../driver/FullscreenVideo":21,"../../driver/MouseAsPaddle":22,"../../driver/SimpleCanvasVideo":23,"../../driver/webgl/WebglVideo":28,"../../stella/driver/KeyboardIO":31,"../../stella/driver/WebAudio":32,"../../stella/service/DriverManager":33,"../../stella/service/EmulationServiceInterface":34,"../../stella/service/worker/EmulationService":37,tslib:6}],30:[function(e,t,n){"use strict";var i=e("./Stellerator");t.exports={Stellerator:i.default}},{"./Stellerator":29}],31:[function(e,t,n){"use strict";function i(e){return{type:0,swtch:e}}function r(e){return{type:1,trigger:e}}Object.defineProperty(n,"__esModule",{value:!0});var o=e("tslib"),s=e("microevent.ts"),a=function(){function e(t,n){void 0===n&&(n=e.defaultMappings),this._target=t,this.toggleFullscreen=new s.Event,this.hardReset=new s.Event,this.togglePause=new s.Event,this._keydownListener=null,this._keyupListener=null,this._joystick0=null,this._joystick1=null,this._controlPanel=null,this._dispatchTable={},this._compiledMappings=new Map,this._compileMappings(n)}return e.prototype.bind=function(e,t,n){var i=this;this._joystick0||(this._joystick0=e,this._joystick1=t,this._controlPanel=n,this._updateActionTable(),this._keydownListener=function(e){if(i._compiledMappings.has(e.keyCode)){var t=(e.shiftKey?4:0)|(e.ctrlKey?1:0)|(e.altKey?2:0);if(i._compiledMappings.get(e.keyCode).has(t)){var n=i._compiledMappings.get(e.keyCode).get(t);if(void 0!==n){e.preventDefault();var r=i._dispatchTable[n];switch(r.type){case 0:r.swtch.toggle(!0);break;case 1:r.trigger.dispatch(void 0)}}}}},this._keyupListener=function(e){if(i._compiledMappings.has(e.keyCode)){try{for(var t=o.__values(i._compiledMappings.get(e.keyCode).values()),n=t.next();!n.done;n=t.next()){var r=n.value;e.preventDefault();var s=i._dispatchTable[r];switch(s.type){case 0:s.swtch.toggle(!1)}}}catch(e){a={error:e}}finally{try{n&&!n.done&&(u=t.return)&&u.call(t)}finally{if(a)throw a.error}}var a,u}},this._target.addEventListener("keydown",this._keydownListener),this._target.addEventListener("keyup",this._keyupListener))},e.prototype.unbind=function(){this._joystick0&&(this._target.removeEventListener("keydown",this._keydownListener),this._target.removeEventListener("keyup",this._keyupListener),this._joystick0=this._joystick1=this._controlPanel=null,this._keydownListener=this._keyupListener=null)},e.prototype._updateActionTable=function(){this._dispatchTable[12]=r(this.toggleFullscreen),this._dispatchTable[13]=r(this.hardReset),this._dispatchTable[14]=r(this.togglePause),this._dispatchTable[0]=i(this._controlPanel.getSelectSwitch()),this._dispatchTable[1]=i(this._controlPanel.getResetButton()),this._dispatchTable[2]=i(this._joystick0.getLeft()),this._dispatchTable[3]=i(this._joystick0.getRight()),this._dispatchTable[4]=i(this._joystick0.getUp()),this._dispatchTable[5]=i(this._joystick0.getDown()),this._dispatchTable[10]=i(this._joystick0.getFire()),this._dispatchTable[6]=i(this._joystick1.getLeft()),this._dispatchTable[7]=i(this._joystick1.getRight()),this._dispatchTable[8]=i(this._joystick1.getUp()),this._dispatchTable[9]=i(this._joystick1.getDown()),this._dispatchTable[11]=i(this._joystick1.getFire())},e.prototype._compileMappings=function(e){var t=this;e.forEach(function(e){var n=e.action;(Array.isArray(e.spec)?e.spec:[e.spec]).forEach(function(e){return function(e,n,i){if(0!=(-8&i))throw new Error("invalid modifier set "+i);t._compiledMappings.has(n)||t._compiledMappings.set(n,new Map),t._compiledMappings.get(n).set(i,e)}(n,"object"==typeof e?e.keycode:e,"object"==typeof e?e.modifiers:0)})})},e}();!function(e){e.defaultMappings=[{action:0,spec:{keycode:32,modifiers:4}},{action:1,spec:{keycode:13,modifiers:4}},{action:2,spec:[65,37]},{action:3,spec:[68,39]},{action:4,spec:[87,38]},{action:5,spec:[83,40]},{action:10,spec:[32,86]},{action:6,spec:74},{action:7,spec:76},{action:8,spec:73},{action:9,spec:75},{action:11,spec:66},{action:12,spec:13},{action:13,spec:{keycode:82,modifiers:4}},{action:14,spec:80}]}(a||(a={})),n.default=a},{"microevent.ts":4,tslib:6}],32:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=e("tslib"),r=e("../../driver/WebAudio"),o=function(){function e(e){this._fragmentSize=e,this._pcmAudio=!1,this._volume=1}return e.prototype.init=function(){},e.prototype.bind=function(e,t){if(!this._channels){this._channels=i.__spread(t),this._driver&&this._pcmAudio===e||(this._driver&&this._driver.close(),this._driver=e?new r.default(0,this._channels.length,this._fragmentSize):new r.default(this._channels.length,0,this._fragmentSize),this._driver.init()),e?this._driver.bind([],this._channels):this._driver.bind(this._channels,[]);for(var n=0;n<this._channels.length;n++)this._driver.setMasterVolume(n,this._volume);this._pcmAudio=e}},e.prototype.unbind=function(){this._channels&&(this._driver.unbind(),this._channels=null)},e.prototype.setMasterVolume=function(e){if(this._volume=e,this._channels)for(var t=0;t<this._channels.length;t++)this._driver.setMasterVolume(t,this._volume)},e.prototype.getMasterVolume=function(){return this._volume},e.prototype.pause=function(){return i.__awaiter(this,void 0,void 0,function(){return i.__generator(this,function(e){switch(e.label){case 0:return this._driver?[4,this._driver.pause()]:[3,2];case 1:e.sent(),e.label=2;case 2:return[2]}})})},e.prototype.resume=function(){return i.__awaiter(this,void 0,void 0,function(){return i.__generator(this,function(e){switch(e.label){case 0:return this._driver?[4,this._driver.resume()]:[3,2];case 1:e.sent(),e.label=2;case 2:return[2]}})})},e}();n.default=o},{"../../driver/WebAudio":24,tslib:6}],33:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=e("./EmulationServiceInterface"),r=function(){function e(){this._drivers=new Map,this._driversBound=!1}return e.prototype.bind=function(t){return this._driversBound?this:(this._emulationService=t,this._shouldBindDrivers()&&this._bindDrivers(),this._emulationService.stateChanged.addHandler(e._onEmuStateChange,this),this)},e.prototype.unbind=function(){return this._emulationService?(this._unbindDrivers(),this._emulationService.stateChanged.removeHandler(e._onEmuStateChange,this),this._emulationService=null,this):this},e.prototype.addDriver=function(t,n){return this._drivers.set(t,new e.DriverContext(t,n)),this._driversBound&&n(this._emulationService.getEmulationContext(),t),this},e.prototype.removeDriver=function(e){return this._drivers.get(e)?(e.unbind(),this._drivers.delete(e),this):this},e._onEmuStateChange=function(e,t){t._shouldBindDrivers(e)?t._bindDrivers():t._unbindDrivers()},e.prototype._shouldBindDrivers=function(e){return void 0===e&&(e=this._emulationService?this._emulationService.getState():void 0),this._emulationService&&(e===i.default.State.running||e===i.default.State.paused)},e.prototype._bindDrivers=function(){var e=this;this._driversBound||(this._drivers.forEach(function(t){return t.binder(e._emulationService.getEmulationContext(),t.driver)}),this._driversBound=!0)},e.prototype._unbindDrivers=function(){this._driversBound&&(this._drivers.forEach(function(e){return e.driver.unbind()}),this._driversBound=!1)},e}();!function(e){var t=function(){return function(e,t){this.driver=e,this.binder=t}}();e.DriverContext=t}(r||(r={})),n.default=r},{"./EmulationServiceInterface":34}],34:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i;!function(e){!function(e){e[e.stopped=0]="stopped",e[e.running=1]="running",e[e.paused=2]="paused",e[e.error=3]="error"}(e.State||(e.State={}))}(i||(i={})),n.default=i},{}],35:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=e("../../../../machine/io/DigitalJoystick"),r=e("../../../../machine/stella/ControlPanel"),o=e("../../../../machine/io/Paddle"),s=e("./messages"),a=function(){function e(e){this._rpc=e,this._joysticks=new Array(2),this._paddles=new Array(4),this._controlPanel=new r.default;for(t=0;t<2;t++)this._joysticks[t]=new i.default;for(var t=0;t<4;t++)this._paddles[t]=new o.default}return e.prototype.sendUpdate=function(){this._rpc.signal(s.SIGNAL_TYPE.controlStateUpdate,{joystickState:this._joysticks.map(e._joystickState),paddleState:this._paddles.map(e._paddleState),controlPanelState:e._controlPanelState(this._controlPanel)})},e.prototype.getJoystick=function(e){if(e<0||e>1)throw new Error("invalid joystick index "+e);return this._joysticks[e]},e.prototype.getControlPanel=function(){return this._controlPanel},e.prototype.getPaddle=function(e){if(e<0||e>3)throw new Error("invalid paddle index "+e);return this._paddles[e]},e._joystickState=function(e){return{up:e.getUp().read(),down:e.getDown().read(),left:e.getLeft().read(),right:e.getRight().read(),fire:e.getFire().read()}},e._paddleState=function(e){return{value:e.getValue(),fire:e.getFire().read()}},e._controlPanelState=function(e){return{difficulty0:e.getDifficultySwitchP0().read(),difficulty1:e.getDifficultySwitchP1().read(),select:e.getSelectSwitch().read(),reset:e.getResetButton().read(),color:e.getColorSwitch().read()}},e}();n.default=a},{"../../../../machine/io/DigitalJoystick":9,"../../../../machine/io/Paddle":10,"../../../../machine/stella/ControlPanel":13,"./messages":41}],36:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(e,t,n,i){if(this._videoProxy=e,this._controlProxy=t,this._waveformChannels=n,this._pcmChannel=i,this._config=null,2!==this._waveformChannels.length)throw new Error("invalid channel count "+this._waveformChannels.length)}return e.prototype.setConfig=function(e){this._config=e},e.prototype.getConfig=function(){return this._config},e.prototype.getVideo=function(){return this._videoProxy},e.prototype.getJoystick=function(e){return this._controlProxy.getJoystick(e)},e.prototype.getControlPanel=function(){return this._controlProxy.getControlPanel()},e.prototype.getPaddle=function(e){return this._controlProxy.getPaddle(e)},e.prototype.getWaveformChannels=function(){return this._waveformChannels},e.prototype.getPCMChannel=function(){return this._pcmChannel},e.prototype.getVideoProxy=function(){return this._videoProxy},e}();n.default=i},{}],37:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=e("tslib"),r=e("microevent.ts"),o=e("worker-rpc"),s=e("../EmulationServiceInterface"),a=e("./EmulationContext"),u=e("./VideoProxy"),c=e("./ControlProxy"),h=e("./WaveformAudioProxy"),l=e("./PCMAudioProxy"),_=e("async-mutex"),d=e("./messages"),f=function(){function e(e,t){this._stellaWorkerUri=e,this._videoWorkerUri=t,this.stateChanged=new r.Event,this.frequencyUpdate=new r.Event,this._rateLimitEnforced=!0,this._mutex=new _.Mutex,this._worker=null,this._rpc=null,this._state=s.default.State.stopped,this._lastError=null,this._emulationContext=null,this._frequency=0,this._waveformChannels=new Array(2),this._pcmChannel=null,this._controlProxy=null,this._controlProxyUpdateHandle=null,this._proxyState=0,this._saveConfig=null}return e.prototype.init=function(){var e=this;this._worker=new Worker(this._stellaWorkerUri),this._rpc=new o.RpcProvider(function(t,n){return e._worker.postMessage(t,n)}),this._pcmChannel=new l.default(0,this._rpc).init();for(var t=0;t<2;t++)this._waveformChannels[t]=new h.default(t,this._rpc).init();var n=new u.default(this._rpc),i=new c.default(this._rpc);return n.init(),this._emulationContext=new a.default(n,i,this._waveformChannels,this._pcmChannel),this._worker.onmessage=function(t){return e._rpc.dispatch(t.data)},this._rpc.registerSignalHandler(d.SIGNAL_TYPE.emulationFrequencyUpdate,this._onFrequencyUpdate.bind(this)).registerSignalHandler(d.SIGNAL_TYPE.emulationError,this._onEmulationError.bind(this)),this._controlProxy=i,this._startVideoProcessingPipeline().then(function(){return e.setRateLimit(e._rateLimitEnforced)})},e.prototype.start=function(e,t,n,r){return i.__awaiter(this,void 0,void 0,function(){var o=this;return i.__generator(this,function(a){switch(a.label){case 0:return[4,this.stop()];case 1:return a.sent(),[2,this._mutex.runExclusive(function(){return i.__awaiter(o,void 0,void 0,function(){var o;return i.__generator(this,function(i){switch(i.label){case 0:return[4,this._rpc.rpc(d.RPC_TYPE.emulationStart,{buffer:e,config:t,cartridgeType:n,videoProcessing:r})];case 1:return(o=i.sent())!==s.default.State.paused?[3,3]:(this._saveConfig=t,this._emulationContext.setConfig(t),[4,this._startProxies(t)]);case 2:return i.sent(),[3,4];case 3:this._saveConfig=null,i.label=4;case 4:return[2,this._applyState(o)]}})})})]}})})},e.prototype.pause=function(){var e=this;return this._mutex.runExclusive(function(){return e._rpc.rpc(d.RPC_TYPE.emulationPause).then(function(t){return e._pauseProxies(),e._applyState(t)})})},e.prototype.stop=function(){var e=this;return this._mutex.runExclusive(function(){return e._rpc.rpc(d.RPC_TYPE.emulationStop).then(function(t){return e._stopProxies(),e._applyState(t)})})},e.prototype.reset=function(){var e=this;return this._mutex.runExclusive(function(){return i.__awaiter(e,void 0,void 0,function(){var e;return i.__generator(this,function(t){switch(t.label){case 0:return[4,this._rpc.rpc(d.RPC_TYPE.emulationReset)];case 1:return e=t.sent(),this._state!==s.default.State.error||e!==s.default.State.running&&e!==s.default.State.paused||!this._saveConfig?[3,3]:[4,this._startProxies(this._saveConfig)];case 2:t.sent(),t.label=3;case 3:return[2,this._applyState(e)]}})})})},e.prototype.resume=function(){var e=this;return this._mutex.runExclusive(function(){return e._rpc.rpc(d.RPC_TYPE.emulationResume).then(function(t){return e._resumeProxies(),e._applyState(t)})})},e.prototype.setRateLimit=function(e){return this._rateLimitEnforced=e,this._rpc.rpc(d.RPC_TYPE.emulationSetRateLimit,e)},e.prototype.getFrequency=function(){return this._frequency},e.prototype.getRateLimit=function(){return this._rateLimitEnforced},e.prototype.getState=function(){return this._state},e.prototype.getLastError=function(){return this._lastError},e.prototype.getEmulationContext=function(){switch(this._state){case s.default.State.running:case s.default.State.paused:return this._emulationContext;default:return null}},e.prototype._fetchLastError=function(){return this._rpc.rpc(d.RPC_TYPE.emulationFetchLastError).then(function(e){return e?new Error(e):null})},e.prototype._applyState=function(e){var t=this;return e===s.default.State.error?this._fetchLastError().then(function(n){return t._state=e,t._lastError=n,t._stopProxies(),t.stateChanged.dispatch(e),e}):(this._state=e,this.stateChanged.dispatch(e),e)},e.prototype._onFrequencyUpdate=function(e){this._frequency=e,this.frequencyUpdate.dispatch(this._frequency)},e.prototype._onEmulationError=function(e){this._lastError=new Error(e||""),this._stopProxies(),this._state=s.default.State.error,this.stateChanged.dispatch(this._state)},e.prototype._startProxies=function(e){return i.__awaiter(this,void 0,void 0,function(){var t;return i.__generator(this,function(n){switch(n.label){case 0:return[4,this._emulationContext.getVideoProxy().start()];case 1:n.sent(),t=0,n.label=2;case 2:return t<this._waveformChannels.length?[4,this._waveformChannels[t].start(e)]:[3,5];case 3:n.sent(),n.label=4;case 4:return t++,[3,2];case 5:return[4,this._pcmChannel.start()];case 6:return n.sent(),this._startControlUpdates(),this._proxyState=1,[2]}})})},e.prototype._stopProxies=function(){0!==this._proxyState&&(this._emulationContext.getVideoProxy().stop(),this._pcmChannel.stop(),this._stopControlUpdates(),this._proxyState=0)},e.prototype._pauseProxies=function(){1===this._proxyState&&(this._stopControlUpdates(),this._proxyState=2)},e.prototype._resumeProxies=function(){2===this._proxyState&&(this._startControlUpdates(),this._proxyState=1)},e.prototype._startControlUpdates=function(){var e=this;null===this._controlProxyUpdateHandle&&(this._controlProxyUpdateHandle=setInterval(function(){return e._controlProxy.sendUpdate()},25))},e.prototype._stopControlUpdates=function(){null!==this._controlProxyUpdateHandle&&(clearInterval(this._controlProxyUpdateHandle),this._controlProxyUpdateHandle=null)},e.prototype._startVideoProcessingPipeline=function(){return i.__awaiter(this,void 0,void 0,function(){var e,t,n;return i.__generator(this,function(i){switch(i.label){case 0:return e=null,this._videoWorkerUri?(e=new MessageChannel,t=new Worker(this._videoWorkerUri),n=new o.RpcProvider(function(e,n){return t.postMessage(e,n)}),t.onmessage=function(e){return n.dispatch(e.data)},[4,n.rpc("/use-port",e.port1,[e.port1])]):[3,2];case 1:i.sent(),i.label=2;case 2:return[4,this._rpc.rpc(d.RPC_TYPE.setup,{videoProcessorPort:e&&e.port2},e?[e.port2]:[])];case 3:return i.sent(),[2]}})})},e}();n.default=f},{"../EmulationServiceInterface":34,"./ControlProxy":35,"./EmulationContext":36,"./PCMAudioProxy":38,"./VideoProxy":39,"./WaveformAudioProxy":40,"./messages":41,"async-mutex":2,"microevent.ts":4,tslib:6,"worker-rpc":8}],38:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=e("tslib"),r=e("microevent.ts"),o=e("../../../../tools/pool/Pool"),s=e("./messages"),a=function(){function e(t,n){this._index=t,this._rpc=n,this.newFrame=new r.Event,this.togglePause=new r.Event,this._sampleRate=0,this._frameSize=0,this._paused=!1,this._framePool=new o.default(function(){return null}),this._frameMap=new WeakMap,this._enabled=!1,this._signalReturnFrame="",this._framePool.event.release.addHandler(e._onReleaseFragment,this),this._signalReturnFrame=s.SIGNAL_TYPE.pcmAudioReturnFrame(this._index)}return e.prototype.init=function(){return this._rpc.registerSignalHandler(s.SIGNAL_TYPE.pcmAudioNewFrame(this._index),this._onNewFrame.bind(this)).registerSignalHandler(s.SIGNAL_TYPE.pcmAudioTogglePause(this._index),this._onTogglePause.bind(this)),this},e.prototype.start=function(){return i.__awaiter(this,void 0,void 0,function(){var e;return i.__generator(this,function(t){switch(t.label){case 0:return this._enabled?[2]:[4,this._rpc.rpc(s.RPC_TYPE.getPCMAudioParameters(this._index))];case 1:return e=t.sent(),this._sampleRate=e.sampleRate,this._frameSize=e.frameSize,this._paused=e.paused,this._enabled=!0,[2]}})})},e.prototype.stop=function(){this._enabled=!1},e.prototype.isPaused=function(){return this._paused},e.prototype.getSampleRate=function(){return this._sampleRate},e.prototype.getFrameSize=function(){return this._frameSize},e._onReleaseFragment=function(e,t){t._frameMap.has(e)&&t._rpc.signal(t._signalReturnFrame,{id:t._frameMap.get(e),buffer:e.buffer},[e.buffer])},e.prototype._onNewFrame=function(e){if(this._enabled){var t=this._framePool.get(),n=new Float32Array(e.buffer);t.adopt(n),this._frameMap.set(n,e.id),this.newFrame.dispatch(t)}},e.prototype._onTogglePause=function(e){e.paused!==this._paused&&(this._paused=e.paused,this.togglePause.dispatch(this._paused))},e}();n.default=a},{"../../../../tools/pool/Pool":19,"./messages":41,"microevent.ts":4,tslib:6}],39:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=e("tslib"),r=e("microevent.ts"),o=e("./messages"),s=function(){function e(e){this._rpc=e,this.newFrame=new r.Event,this._active=!1,this._width=0,this._height=0,this._ids=null}return e.prototype.init=function(){this._rpc.registerSignalHandler(o.SIGNAL_TYPE.videoNewFrame,this._onNewFrame.bind(this))},e.prototype.start=function(){return i.__awaiter(this,void 0,void 0,function(){var e;return i.__generator(this,function(t){switch(t.label){case 0:return this._active&&this.stop(),[4,this._rpc.rpc(o.RPC_TYPE.getVideoParameters)];case 1:return e=t.sent(),this._active=!0,this._width=e.width,this._height=e.height,this._ids=new Set,[2]}})})},e.prototype.stop=function(){this._active=!1,this._ids=null},e.prototype.getWidth=function(){return this._width},e.prototype.getHeight=function(){return this._height},e.prototype._onNewFrame=function(e){var t=this;if(this._active)if(this._width===e.width&&this._height===e.height){this._ids.add(e.id);var n=new ImageData(new Uint8ClampedArray(e.buffer),e.width,e.height);this.newFrame.dispatch({get:function(){return n},release:function(){t._active&&t._ids.has(e.id)&&t._rpc.signal(o.SIGNAL_TYPE.videoReturnSurface,{id:e.id,buffer:e.buffer},[e.buffer])},dispose:function(){},adopt:function(){throw new Error("adopt is not implemented")}})}else console.warn("surface dimensions do not match; ignoring frame");else console.warn("video proxy deactivated: ignoring frame")},e}();n.default=s},{"./messages":41,"microevent.ts":4,tslib:6}],40:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=e("tslib"),r=e("microevent.ts"),o=e("../../../../machine/stella/tia/ToneGenerator"),s=e("./messages"),a=function(){function e(e,t){this._index=e,this._rpc=t,this.bufferChanged=new r.Event,this.volumeChanged=new r.Event,this.stop=new r.Event,this._toneGenerator=new o.default,this._volume=0}return e.prototype.init=function(){return this._rpc.registerSignalHandler(s.SIGNAL_TYPE.waveformAudioBufferChange,this._onBufferChangeSignal.bind(this)).registerSignalHandler(s.SIGNAL_TYPE.waveformAudioVolumeChange,this._onVolumeChangeSignal.bind(this)).registerSignalHandler(s.SIGNAL_TYPE.audioStop,this._onStopSignal.bind(this)),this},e.prototype.start=function(e){return i.__awaiter(this,void 0,void 0,function(){var t;return i.__generator(this,function(n){switch(n.label){case 0:return[4,this._rpc.rpc(s.RPC_TYPE.getWaveformAudioParameters(this._index))];case 1:return t=n.sent(),this._toneGenerator.setConfig(e),this.setVolume(t.volume),[2]}})})},e.prototype.setVolume=function(e){return this._volume=e,this},e.prototype.getVolume=function(){return this._volume},e.prototype.getBuffer=function(e){return this._toneGenerator.getBuffer(e)},e.prototype._onVolumeChangeSignal=function(e){e.index===this._index&&(this._volume=e.value,this.volumeChanged.dispatch(this._volume))},e.prototype._onBufferChangeSignal=function(e){e.index===this._index&&this.bufferChanged.dispatch(e.key)},e.prototype._onStopSignal=function(e){e===this._index&&this.stop.dispatch(void 0)},e}();n.default=a},{"../../../../machine/stella/tia/ToneGenerator":15,"./messages":41,"microevent.ts":4,tslib:6}],41:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.RPC_TYPE={emulationPause:"emulation/pause",emulationReset:"emulation/reset",emulationResume:"emulation/resume",emulationSetRateLimit:"emulation/setRateLimit",emulationStart:"emulation/start",emulationStop:"emulation/stop",emulationFetchLastError:"emulation/fetchLastError",getVideoParameters:"video/getParameters",getWaveformAudioParameters:function(e){return"audio/waveform/getParameters/"+e},getPCMAudioParameters:function(e){return"audio/pcm/getParameters/"+e},setup:"/setup"},Object.freeze(n.RPC_TYPE),n.SIGNAL_TYPE={emulationError:"emulation/error",emulationFrequencyUpdate:"emulation/frequencyUpdate",videoNewFrame:"video/newFrame",videoReturnSurface:"video/returnSurface",controlStateUpdate:"control/stateUpdate",waveformAudioVolumeChange:"audio/waveform/volumeChange",waveformAudioBufferChange:"audio/waveform/bufferChange",pcmAudioNewFrame:function(e){return"audio/pcm/newFrame/"+e},pcmAudioTogglePause:function(e){return"audio/pcm/togglePause/"+e},pcmAudioReturnFrame:function(e){return"audio/pcm/returnFrame/"+e},audioStop:"audio/stop"},Object.freeze(n.SIGNAL_TYPE)},{}]},{},[30])(30)});
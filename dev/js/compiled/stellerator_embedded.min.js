
/*
 *   This file is part of 6502.ts, an emulator for 6502 based systems built
 *   in Typescript.
 *
 *   Copyright (C) 2014 - 2018 Christian Speckner & contributors
 *
 *   This program is free software; you can redistribute it and/or modify
 *   it under the terms of the GNU General Public License as published by
 *   the Free Software Foundation; either version 2 of the License, or
 *   (at your option) any later version.
 *
 *   This program is distributed in the hope that it will be useful,
 *   but WITHOUT ANY WARRANTY; without even the implied warranty of
 *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *   GNU General Public License for more details.
 *
 *   Please go to the project's github page at
 *
 *   https://github.com/6502ts/6502.ts
 *
 *   for more details and for a copy of the GNU General Public License v2.
 */

!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).$6502=t()}}(function(){return function o(s,a,u){function c(e,t){if(!a[e]){if(!s[e]){var i="function"==typeof require&&require;if(!t&&i)return i(e,!0);if(h)return h(e,!0);var n=new Error("Cannot find module '"+e+"'");throw n.code="MODULE_NOT_FOUND",n}var r=a[e]={exports:{}};s[e][0].call(r.exports,function(t){return c(s[e][1][t]||t)},r,r.exports,o,s,a,u)}return a[e].exports}for(var h="function"==typeof require&&require,t=0;t<u.length;t++)c(u[t]);return c}({1:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n=function(){function t(){this._queue=[],this._pending=!1}return t.prototype.isLocked=function(){return this._pending},t.prototype.acquire=function(){var e=this,t=new Promise(function(t){return e._queue.push(t)});return this._pending||this._dispatchNext(),t},t.prototype.runExclusive=function(i){return this.acquire().then(function(e){var t;try{t=i()}catch(t){throw e(),t}return Promise.resolve(t).then(function(t){return e(),t},function(t){throw e(),t})})},t.prototype._dispatchNext=function(){0<this._queue.length?(this._pending=!0,this._queue.shift()(this._dispatchNext.bind(this))):this._pending=!1},t}();i.default=n},{}],2:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n=t("./Mutex");i.Mutex=n.default},{"./Mutex":1}],3:[function(t,e,i){"use strict";var n=[];function r(t){return n[t]||(n[t]=function(t){for(var e="return function dispatcher"+t+"(payload) {\n",i=[],n=[],r=0;r<t;r++)i.push("cb"+r),n.push("ctx"+r),e+="    cb"+r+"(payload, ctx"+r+");\n";return e+="};",new(Function.bind.apply(Function,[void 0].concat(i.concat(n),[e])))}(t)),n[t]}n[0]=function(){return function(){}},n[1]=function(e,i){return void 0===i?e:function(t){e(t,i)}};var o=function(){function t(){this.hasHandlers=!1,this._handlers=[],this._contexts=[],this._createDispatcher()}return t.prototype.addHandler=function(t,e){return this.isHandlerAttached(t,e)||(this._handlers.push(t),this._contexts.push(e),this._createDispatcher(),this._updateHasHandlers()),this},t.prototype.removeHandler=function(t,e){var i=this._getHandlerIndex(t,e);return void 0!==i&&(this._handlers.splice(i,1),this._contexts.splice(i,1),this._createDispatcher(),this._updateHasHandlers()),this},t.prototype.isHandlerAttached=function(t,e){return void 0!==this._getHandlerIndex(t,e)},t.prototype._updateHasHandlers=function(){this.hasHandlers=!!this._handlers.length},t.prototype._getHandlerIndex=function(t,e){var i,n=this._handlers.length;for(i=0;i<n&&(this._handlers[i]!==t||this._contexts[i]!==e);i++);return i<n?i:void 0},t.prototype._createDispatcher=function(){this.dispatch=r(this._handlers.length).apply(this,this._handlers.concat(this._contexts))},t}();Object.defineProperty(i,"__esModule",{value:!0}),i.default=o},{}],4:[function(t,e,i){"use strict";var n=t("./Event");i.Event=n.default},{"./Event":3}],5:[function(t,s,e){!function(){"use strict";var o="undefined"!=typeof window&&void 0!==window.document?window.document:{},t=void 0!==s&&s.exports,i="undefined"!=typeof Element&&"ALLOW_KEYBOARD_INPUT"in Element,n=function(){for(var t,e=[["requestFullscreen","exitFullscreen","fullscreenElement","fullscreenEnabled","fullscreenchange","fullscreenerror"],["webkitRequestFullscreen","webkitExitFullscreen","webkitFullscreenElement","webkitFullscreenEnabled","webkitfullscreenchange","webkitfullscreenerror"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitCurrentFullScreenElement","webkitCancelFullScreen","webkitfullscreenchange","webkitfullscreenerror"],["mozRequestFullScreen","mozCancelFullScreen","mozFullScreenElement","mozFullScreenEnabled","mozfullscreenchange","mozfullscreenerror"],["msRequestFullscreen","msExitFullscreen","msFullscreenElement","msFullscreenEnabled","MSFullscreenChange","MSFullscreenError"]],i=0,n=e.length,r={};i<n;i++)if((t=e[i])&&t[1]in o){for(i=0;i<t.length;i++)r[e[0][i]]=t[i];return r}return!1}(),r={change:n.fullscreenchange,error:n.fullscreenerror},e={request:function(t){var e=n.requestFullscreen;t=t||o.documentElement,/ Version\/5\.1(?:\.\d+)? Safari\//.test(navigator.userAgent)?t[e]():t[e](i&&Element.ALLOW_KEYBOARD_INPUT)},exit:function(){o[n.exitFullscreen]()},toggle:function(t){this.isFullscreen?this.exit():this.request(t)},onchange:function(t){this.on("change",t)},onerror:function(t){this.on("error",t)},on:function(t,e){var i=r[t];i&&o.addEventListener(i,e,!1)},off:function(t,e){var i=r[t];i&&o.removeEventListener(i,e,!1)},raw:n};n?(Object.defineProperties(e,{isFullscreen:{get:function(){return Boolean(o[n.fullscreenElement])}},element:{enumerable:!0,get:function(){return o[n.fullscreenElement]}},enabled:{enumerable:!0,get:function(){return Boolean(o[n.fullscreenEnabled])}}}),t?s.exports=e:window.screenfull=e):t?s.exports=!1:window.screenfull=!1}()},{}],6:[function(t,b,e){(function(n){var e,i,r,o,s,a,u,c,h,l,_,d,f,p,g,v,m,y,w;!function(t){var e="object"==typeof n?n:"object"==typeof self?self:"object"==typeof this?this:{};function i(i,n){return i!==e&&("function"==typeof Object.create?Object.defineProperty(i,"__esModule",{value:!0}):i.__esModule=!0),function(t,e){return i[t]=n?n(t,e):e}}"object"==typeof b&&"object"==typeof b.exports?t(i(e,i(b.exports))):t(i(e))}(function(t){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])};e=function(t,e){function i(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},i=Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++)for(var r in e=arguments[i])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t},r=function(t,e){var i={};for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.indexOf(n)<0&&(i[n]=t[n]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(n=Object.getOwnPropertySymbols(t);r<n.length;r++)e.indexOf(n[r])<0&&(i[n[r]]=t[n[r]])}return i},o=function(t,e,i,n){var r,o=arguments.length,s=o<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,i,n);else for(var a=t.length-1;0<=a;a--)(r=t[a])&&(s=(o<3?r(s):3<o?r(e,i,s):r(e,i))||s);return 3<o&&s&&Object.defineProperty(e,i,s),s},s=function(i,n){return function(t,e){n(t,e,i)}},a=function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},u=function(o,s,a,u){return new(a||(a=Promise))(function(t,e){function i(t){try{r(u.next(t))}catch(t){e(t)}}function n(t){try{r(u.throw(t))}catch(t){e(t)}}function r(e){e.done?t(e.value):new a(function(t){t(e.value)}).then(i,n)}r((u=u.apply(o,s||[])).next())})},c=function(i,n){var r,o,s,t,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return t={next:e(0),throw:e(1),return:e(2)},"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function(e){if(r)throw new TypeError("Generator is already executing.");for(;a;)try{if(r=1,o&&(s=2&e[0]?o.return:e[0]?o.throw||((s=o.return)&&s.call(o),0):o.next)&&!(s=s.call(o,e[1])).done)return s;switch(o=0,s&&(e=[2&e[0],s.value]),e[0]){case 0:case 1:s=e;break;case 4:return a.label++,{value:e[1],done:!1};case 5:a.label++,o=e[1],e=[0];continue;case 7:e=a.ops.pop(),a.trys.pop();continue;default:if(!(s=0<(s=a.trys).length&&s[s.length-1])&&(6===e[0]||2===e[0])){a=0;continue}if(3===e[0]&&(!s||e[1]>s[0]&&e[1]<s[3])){a.label=e[1];break}if(6===e[0]&&a.label<s[1]){a.label=s[1],s=e;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(e);break}s[2]&&a.ops.pop(),a.trys.pop();continue}e=n.call(i,a)}catch(t){e=[6,t],o=0}finally{r=s=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,t])}}},h=function(t,e){for(var i in t)e.hasOwnProperty(i)||(e[i]=t[i])},l=function(t){var e="function"==typeof Symbol&&t[Symbol.iterator],i=0;return e?e.call(t):{next:function(){return t&&i>=t.length&&(t=void 0),{value:t&&t[i++],done:!t}}}},_=function(t,e){var i="function"==typeof Symbol&&t[Symbol.iterator];if(!i)return t;var n,r,o=i.call(t),s=[];try{for(;(void 0===e||0<e--)&&!(n=o.next()).done;)s.push(n.value)}catch(t){r={error:t}}finally{try{n&&!n.done&&(i=o.return)&&i.call(o)}finally{if(r)throw r.error}}return s},d=function(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(_(arguments[e]));return t},f=function(t){return this instanceof f?(this.v=t,this):new f(t)},p=function(t,e,i){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r,o=i.apply(t,e||[]),s=[];return r={},n("next"),n("throw"),n("return"),r[Symbol.asyncIterator]=function(){return this},r;function n(n){o[n]&&(r[n]=function(i){return new Promise(function(t,e){1<s.push([n,i,t,e])||a(n,i)})})}function a(t,e){try{(i=o[t](e)).value instanceof f?Promise.resolve(i.value.v).then(u,c):h(s[0][2],i)}catch(t){h(s[0][3],t)}var i}function u(t){a("next",t)}function c(t){a("throw",t)}function h(t,e){t(e),s.shift(),s.length&&a(s[0][0],s[0][1])}},g=function(n){var t,r;return t={},e("next"),e("throw",function(t){throw t}),e("return"),t[Symbol.iterator]=function(){return this},t;function e(e,i){t[e]=n[e]?function(t){return(r=!r)?{value:f(n[e](t)),done:"return"===e}:i?i(t):t}:i}},v=function(u){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,e=u[Symbol.asyncIterator];return e?e.call(u):(u=l(u),t={},i("next"),i("throw"),i("return"),t[Symbol.asyncIterator]=function(){return this},t);function i(a){t[a]=u[a]&&function(s){return new Promise(function(t,e){var i,n,r,o;s=u[a](s),i=t,n=e,r=s.done,o=s.value,Promise.resolve(o).then(function(t){i({value:t,done:r})},n)})}}},m=function(t,e){return Object.defineProperty?Object.defineProperty(t,"raw",{value:e}):t.raw=e,t},y=function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var i in t)Object.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e.default=t,e},w=function(t){return t&&t.__esModule?t:{default:t}},t("__extends",e),t("__assign",i),t("__rest",r),t("__decorate",o),t("__param",s),t("__metadata",a),t("__awaiter",u),t("__generator",c),t("__exportStar",h),t("__values",l),t("__read",_),t("__spread",d),t("__await",f),t("__asyncGenerator",p),t("__asyncDelegator",g),t("__asyncValues",v),t("__makeTemplateObject",m),t("__importStar",y),t("__importDefault",w)})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],7:[function(t,e,i){"use strict";var n,r=t("microevent.ts"),s="resolve_transaction",a="reject_transaction";!function(t){var e;(e=t.MessageType||(t.MessageType={}))[e.signal=0]="signal",e[e.rpc=1]="rpc",e[e.internal=2]="internal";t.MessageType}((n=function(){function o(t,e){void 0===e&&(e=0),this._dispatch=t,this._rpcTimeout=e,this.error=new r.Event,this._rpcHandlers={},this._signalHandlers={},this._pendingTransactions={},this._nextTransactionId=0}return o.prototype.dispatch=function(t){var e=t;switch(e.type){case o.MessageType.signal:return this._handleSignal(e);case o.MessageType.rpc:return this._handeRpc(e);case o.MessageType.internal:return this._handleInternal(e);default:this._raiseError("invalid message type "+e.type)}},o.prototype.rpc=function(t,e,i){var n=this,r=this._nextTransactionId++;return this._dispatch({type:o.MessageType.rpc,transactionId:r,id:t,payload:e},i||void 0),new Promise(function(t,e){var i=n._pendingTransactions[r]={id:r,resolve:t,reject:e};0<n._rpcTimeout&&(n._pendingTransactions[r].timeoutHandle=setTimeout(function(){return n._transactionTimeout(i)},n._rpcTimeout))})},o.prototype.signal=function(t,e,i){return this._dispatch({type:o.MessageType.signal,id:t,payload:e},i||void 0),this},o.prototype.registerRpcHandler=function(t,e){if(this._rpcHandlers[t])throw new Error("rpc handler for "+t+" already registered");return this._rpcHandlers[t]=e,this},o.prototype.registerSignalHandler=function(t,e){return this._signalHandlers[t]||(this._signalHandlers[t]=[]),this._signalHandlers[t].push(e),this},o.prototype.deregisterRpcHandler=function(t,e){return this._rpcHandlers[t]&&delete this._rpcHandlers[t],this},o.prototype.deregisterSignalHandler=function(t,e){return this._signalHandlers[t]&&(this._signalHandlers[t]=this._signalHandlers[t].filter(function(t){return e!==t})),this},o.prototype._raiseError=function(t){this.error.dispatch(new Error(t)),this._dispatch({type:o.MessageType.internal,id:"error",payload:t})},o.prototype._handleSignal=function(e){if(!this._signalHandlers[e.id])return this._raiseError("invalid signal "+e.id);this._signalHandlers[e.id].forEach(function(t){return t(e.payload)})},o.prototype._handeRpc=function(e){var i=this;if(!this._rpcHandlers[e.id])return this._raiseError("invalid rpc "+e.id);Promise.resolve(this._rpcHandlers[e.id](e.payload)).then(function(t){return i._dispatch({type:o.MessageType.internal,id:s,transactionId:e.transactionId,payload:t})},function(t){return i._dispatch({type:o.MessageType.internal,id:a,transactionId:e.transactionId,payload:t})})},o.prototype._handleInternal=function(t){switch(t.id){case s:if(!this._pendingTransactions[t.transactionId])return this._raiseError("no pending transaction with id "+t.transactionId);this._pendingTransactions[t.transactionId].resolve(t.payload),this._clearTransaction(this._pendingTransactions[t.transactionId]);break;case a:if(!this._pendingTransactions[t.transactionId])return this._raiseError("no pending transaction with id "+t.transactionId);this._pendingTransactions[t.transactionId].reject(t.payload),this._clearTransaction(this._pendingTransactions[t.transactionId]);break;case"error":this.error.dispatch(new Error("remote error: "+t.payload));break;default:this._raiseError("unhandled internal message "+t.id)}},o.prototype._transactionTimeout=function(t){t.reject("transaction timed out"),this._raiseError("transaction "+t.id+" timed out"),delete this._pendingTransactions[t.id]},o.prototype._clearTransaction=function(t){void 0!==t.timeoutHandle&&clearTimeout(t.timeoutHandle),delete this._pendingTransactions[t.id]},o}())||(n={})),Object.defineProperty(i,"__esModule",{value:!0}),i.default=n},{"microevent.ts":4}],8:[function(t,e,i){"use strict";var n=t("./RpcProvider");i.RpcProvider=n.default},{"./RpcProvider":7}],9:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n=t("./Switch"),r=function(){function t(){this._left=new n.default,this._right=new n.default,this._up=new n.default,this._down=new n.default,this._fire=new n.default}return t.prototype.getLeft=function(){return this._left},t.prototype.getRight=function(){return this._right},t.prototype.getUp=function(){return this._up},t.prototype.getDown=function(){return this._down},t.prototype.getFire=function(){return this._fire},t}();i.default=r},{"./Switch":11}],10:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n=t("microevent.ts"),r=t("./Switch"),o=function(){function t(){this.valueChanged=new n.Event,this._fireSwitch=new r.default,this._value=.5}return t.prototype.setValue=function(t){this._value=t,this.valueChanged.dispatch(t)},t.prototype.getValue=function(){return this._value},t.prototype.getFire=function(){return this._fireSwitch},t}();i.default=o},{"./Switch":11,"microevent.ts":4}],11:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n=t("microevent.ts"),r=function(){function t(t){void 0===t&&(t=!1),this._state=t,this.stateChanged=new n.Event,this.beforeRead=new n.Event}return t.prototype.read=function(){return this.beforeRead.dispatch(this),this._state},t.prototype.peek=function(){return this._state},t.prototype.toggle=function(t){this._state!==t&&(this._state=t,this.stateChanged.dispatch(t))},t}();i.default=r},{"microevent.ts":4}],12:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n,r,o=t("tslib");(r=n||(n={})).create=function(t){return void 0===t&&(t={}),o.__assign({tvMode:0,enableAudio:!0,randomSeed:-1,emulatePaddles:!0,frameStart:-1,pcmAudio:!1},t)},r.getClockHz=function(t){switch(t.tvMode){case 0:return 3584160;case 1:case 2:return 3556800}},i.default=n},{tslib:6}],13:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n=t("../io/Switch"),r=function(){function t(){this._selectSwitch=new n.default,this._resetButton=new n.default,this._colorSwitch=new n.default,this._difficutlyP0=new n.default,this._difficutlyP1=new n.default}return t.prototype.getSelectSwitch=function(){return this._selectSwitch},t.prototype.getResetButton=function(){return this._resetButton},t.prototype.getColorSwitch=function(){return this._colorSwitch},t.prototype.getDifficultySwitchP0=function(){return this._difficutlyP0},t.prototype.getDifficultySwitchP1=function(){return this._difficutlyP1},t}();i.default=r},{"../io/Switch":11}],14:[function(t,e,i){"use strict";var n,r,o,s;Object.defineProperty(i,"__esModule",{value:!0}),r=n||(n={}),(s=o=r.CartridgeType||(r.CartridgeType={})).vanilla_2k="vanilla_2k",s.vanilla_4k="vanilla_4k",s.bankswitch_8k_F8="bankswitch_8k_F8",s.bankswitch_8k_E0="bankswitch_8k_E0",s.bankswitch_8k_3F="bankswitch_8k_3F",s.bankswitch_8k_FE="bankswitch_8k_FE",s.bankswitch_8k_UA="bankswitch_8k_UA",s.bankswitch_8k_DPC="bankswitch_8k_DPC",s.bankswitch_8k_econobanking="bankswitch_8k_econobanking",s.bankswitch_12k_FA="bankswitch_12k_FA",s.bankswitch_16k_F6="bankswitch_16k_F6",s.bankswitch_16k_E7="bankswitch_16k_E7",s.bankswitch_FA2="bankswitch_FA2",s.bankswitch_32k_F4="bankswitch_32k_F4",s.bankswitch_64k_F0="bankswitch_64k_F0",s.bankswitch_64k_EF="bankswitch_64k_EF",s.bankswitch_3E="bankswitch_3E",s.bankswitch_supercharger="bankswitch_supercharger",s.bankswitch_dpc_plus="bankswitch_dpc_plus",s.bankswitch_cdf="bankswitch_cdf",s.unknown="unknown",r.getAllTypes=function(){return[o.vanilla_2k,o.vanilla_4k,o.bankswitch_8k_F8,o.bankswitch_8k_E0,o.bankswitch_8k_3F,o.bankswitch_8k_FE,o.bankswitch_8k_UA,o.bankswitch_8k_econobanking,o.bankswitch_12k_FA,o.bankswitch_8k_DPC,o.bankswitch_16k_F6,o.bankswitch_16k_E7,o.bankswitch_FA2,o.bankswitch_32k_F4,o.bankswitch_3E,o.bankswitch_64k_F0,o.bankswitch_64k_EF,o.bankswitch_supercharger,o.bankswitch_dpc_plus,o.bankswitch_cdf,o.unknown]},r.describeCartridgeType=function(t){switch(t){case o.vanilla_2k:return"plain 2k";case o.vanilla_4k:return"plain 4k";case o.bankswitch_8k_F8:return"bankswitched 8k, F8 (Atari) scheme";case o.bankswitch_8k_E0:return"bankswitched 8k, E0 (Parker Bros.) scheme";case o.bankswitch_8k_3F:return"bankswitched 8k, 3F (Tigervision) scheme";case o.bankswitch_8k_FE:return"bankswitched 8k, FE (Activision) scheme";case o.bankswitch_8k_UA:return"bankswitched 8k, UA (Pleiades) scheme";case o.bankswitch_12k_FA:return"bankswitched 12k, FA (CBS) scheme";case o.bankswitch_8k_DPC:return"bankswitched 8k + DPC";case o.bankswitch_8k_econobanking:return"bankswitched 8k, econobanking scheme";case o.bankswitch_16k_F6:return"bankswitched 16k, F6 (Atari) scheme";case o.bankswitch_16k_E7:return"bankswitched 16k, E7 (M-Network) scheme";case o.bankswitch_FA2:return"bankswitched 28k/29k, FA2 (modified CBS) scheme";case o.bankswitch_32k_F4:return"bankswitched 32k, F4 (Atari) scheme";case o.bankswitch_3E:return"bankswitched 3E (Tigervision + RAM) scheme";case o.bankswitch_64k_F0:return"bankswitched 64k, F0 (Megaboy) scheme";case o.bankswitch_64k_EF:return"bankswitched 64k, EFSC (Homestar Runner) scheme";case o.bankswitch_supercharger:return"bankswitched supercharger";case o.bankswitch_dpc_plus:return"bankswitched DPC+";case o.bankswitch_cdf:return"bankswitched CDF";case o.unknown:return"unknown"}},i.default=n},{}],15:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var _=t("../Config"),d=t("../../../tools/AudioOutputBuffer"),n=t("../../../tools/base64"),f=n.decode("AQEPAQEBAQEBAQEBAwMDAQ=="),r=new Int8Array([1]),o=new Int8Array([1,1]),s=new Int8Array([16,15]),a=n.decode("AQICAQEBBAM="),u=n.decode("AQIBAQICBQQCAQMBAQEBBA=="),c=n.decode("AQQBAwIEAQIDAgEBAQEBAQIEAgEEAQECAgEDAgEDAQEBBAEBAQECAQECBgECAgECAQIBAQIBBgIBAgIBAQEBAgICAgcCAwICAQEBAwIBAQIBAQcBAQMBAQIDAwEBAQICAQECAgQDBQEDAQEFAgEBAQIBAgEDAQIFAQECAQEBBQEBAQEBAQEBBgEBAQIBAQEBBAIBAQMBAwYDAgMBAQIBAgQBAQEDAQEBAQMBAgEEAgIDBAEBBAECAQICAgEBBAMBBAQJBQQBBQMBAQMCAgIBBQECAQEBAgMBAgEBAwQCBQICAQIDAQEBAQECAQMDAwIBAgEBAQEBAwMBAgIDAQMBCA=="),h=n.decode("BQYEBQoFAwcECgYDBgQJBg=="),p=[r,a,a,n.decode("AgMCAQQBBgoCBAIBAQQFCQMDBAEBAQgFBQUEAQEBCAQCCAMDAQEHBAIHBQEDAQcEAQQIAgEDBAcBAwcDAgEGBgICBAUDAgYGAQMDAgUDBwMEAwICAgUJAwEFAwECAgsFAQUDAQECDAUBAgUCAQEMBgECBQECAQoGAwICBAECBgo="),o,o,s,u,c,u,s,r,o,o,s,h],l=function(){function t(t){this._config=t}return t.prototype.setConfig=function(t){this._config=t},t.prototype.getKey=function(t,e){return p[t]===o&&f[t]*(e+1)==1?0:t<<5|e},t.prototype.getBuffer=function(t){for(var e=t>>>5&15,i=31&t,n=p[e],r=0,o=0;o<n.length;o++)r+=n[o];r=r*f[e]*(i+1);var s=new Float32Array(r),a=_.default.getClockHz(this._config)/114,u=0,c=0,h=0,l=!0;for(o=0;o<r;o++)++u===f[e]*(i+1)&&(u=0,++c===n[h]&&(h++,c=0,n.length===h&&(h=0)),l=!(1&h)),s[o]=l?1:-1;return new d.default(s,a)},t}();i.default=l},{"../../../tools/AudioOutputBuffer":16,"../../../tools/base64":18,"../Config":12}],16:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n=function(){function t(t,e){this._content=t,this._sampleRate=e}return t.prototype.getLength=function(){return this._content.length},t.prototype.getContent=function(){return this._content},t.prototype.getSampleRate=function(){return this._sampleRate},t.prototype.replaceUnderlyingBuffer=function(t){this._content=t},t}();i.default=n},{}],17:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n=function(){function t(t){this._capacity=t,this._size=0,this._index=0,this._buffer=new Array(this._capacity);for(var e=0;e<this._capacity;e++)this._buffer[e]=null}return t.prototype.size=function(){return this._size},t.prototype.pop=function(){if(0!==this._size){var t=this._buffer[this._index];return this._buffer[this._index]=null,this._index=(this._index+1)%this._capacity,this._size--,t}},t.prototype.push=function(t){return this._size===this._capacity&&this.pop(),this._buffer[(this._index+this._size++)%this._capacity]=t,this},t.prototype.forEach=function(t){for(var e=0;e<this._size;e++)t(this._buffer[(this._index+e)%this._capacity]);return this},t.prototype.clear=function(){for(var t=0;t<this._capacity;t++)this._buffer[t]=null;return this._size=0,this._index=0,this},t}();i.default=n},{}],18:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n=new Uint8Array(256);function h(t,e){var i=n[t.charCodeAt(e)];if(63<i)throw new Error('invalid base64 character "'+t[e]+'" at index '+e);return i}!function(t){var e;for(e=0;e<256;e++)n[e]=255;for(e=0;e<64;e++)n["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charCodeAt(e)]=e;n["=".charCodeAt(0)]=0}(i.__init||(i.__init={})),i.decode=function(t){if(t.length%4!=0)throw new Error("invalid base64 data --- char count mismatch");for(var e,i,n=t.length/4,r=3*n-function(t){for(var e=0,i=t.length-1;0<=i&&"="===t[i--];)e++;return e}(t),o=new Uint8Array(r),s=0,a=0;a<n;a++)for(var u=(h(e=t,i=4*a)<<18)+(h(e,i+1)<<12)+(h(e,i+2)<<6)+h(e,i+3),c=0;c<3&&s<r;c++)o[s++]=u>>>8*(2-c)&255;return o}},{}],19:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n=t("microevent.ts"),r=t("./PoolMember"),o=function(){function t(t){this._factory=t,this.event={release:new n.Event,dispose:new n.Event},this._pool=[],this._poolSize=0}return t.prototype.get=function(){var t,e=this;if(0===this._poolSize){var i=this._factory();t=new r.default(i,function(t){return e._releaseMember(t)},function(t){return e._disposeMember(t)})}else(t=this._pool[--this._poolSize])._isAvailable=!1;return t},t.prototype._releaseMember=function(t){if(t._isAvailable)throw new Error("Trying to release an already released pool member");if(t._isDisposed)throw new Error("Trying to release an already disposed pool member");var e=this._poolSize++;(this._pool[e]=t)._isAvailable=!0,t._poolPosition=e,this.event.release.dispatch(t.get())},t.prototype._disposeMember=function(t){if(t._isDisposed)throw new Error("Trying to dispose of an already disposed pool member");t._isAvailable&&(1<this._poolSize&&(this._pool[t._poolPosition]=this._pool[this._poolSize-1]),this._poolSize--),t._isDisposed=!0,this.event.dispose.dispatch(t.get())},t}();i.default=o},{"./PoolMember":20,"microevent.ts":4}],20:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n=function(){function t(t,e,i){this._value=t,this._releaseCB=e,this._disposeCB=i,this._isAvailable=!1,this._isDisposed=!1}return t.prototype.adopt=function(t){this._value=t},t.prototype.get=function(){return this._value},t.prototype.release=function(){this._releaseCB(this)},t.prototype.dispose=function(){this._disposeCB(this)},t}();i.default=n},{}],21:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n=t("screenfull"),r=!!navigator.platform.match(/iPhone|iPad|iPod/),o=function(){function t(t,e,i){void 0===e&&(e=1e5),void 0===i&&(i="stellerator-fullscreen");var n=this;this._videoDriver=t,this._zIndex=e,this._fullscreenClass=i,this._resizeListener=function(){n._resizeHandle||(n._resizeHandle=setTimeout(function(){n._resizeHandle=null,n._adjustSizeForFullscreen()},100))},this._resizeHandle=null,this._changeListener=this._onChange.bind(this),this._engaged=!1}return t.prototype.engage=function(){this._engaged||(this._engaged=!0,r?(this._adjustSizeForFullscreen(),window.addEventListener("resize",this._resizeListener),this._engaged=!0):(n.on("change",this._changeListener),n.request(this._videoDriver.getCanvas())))},t.prototype.disengage=function(){this._engaged&&(r?(this._resetSize(),window.removeEventListener("resize",this._resizeListener),this._engaged=!1):n.exit())},t.prototype.toggle=function(){this._engaged?this.disengage():this.engage()},t.prototype.isEngaged=function(){return this._engaged},t.prototype._onChange=function(){n.isFullscreen?(window.addEventListener("resize",this._resizeListener),this._adjustSizeForFullscreen()):(this._resetSize(),window.removeEventListener("resize",this._resizeListener),n.off("change",this._changeListener),this._engaged=!1)},t.prototype._resetSize=function(){var t=this,e=this._videoDriver.getCanvas();this._resizeHandle&&(clearTimeout(this._resizeHandle),this._resizeHandle=null),e.style.width="",e.style.height="",e.style.maxWidth="",e.style.maxHeight="",r&&(e.style.position="",e.style.top="",e.style.left="",e.style.zIndex=""),document.body.classList.remove(this._fullscreenClass),setTimeout(function(){return t._videoDriver.resize()},0)},t.prototype._adjustSizeForFullscreen=function(){var t=this._videoDriver.getCanvas();this._videoDriver.resize(window.innerWidth,window.innerHeight),t.style.width=window.innerWidth+"px",t.style.height=window.innerHeight+"px",t.style.maxWidth=window.innerWidth+"px",t.style.maxHeight=window.innerHeight+"px",r&&(t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.zIndex=""+this._zIndex),document.body.classList.add(this._fullscreenClass)},t}();i.default=o},{screenfull:5}],22:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n,s=t("tslib"),r=t("microevent.ts"),h=((n={}).up=[12],n.down=[13],n.left=[14],n.right=[15],n.fire=[0,1,2,3,10,11],n.select=[8],n.start=[9],n),o=function(){function u(){var t=this;this._onGamepadConnect=function(){return t._probeGamepads()},this._onGamepadDisconnect=function(){return t._probeGamepads()},this.gamepadCountChanged=new r.Event,this._bound=!1,this._gamepadCount=0,this._lastPoll=0,this._joysticks=null,this._start=null,this._select=null,this._joysticksShadow=null,this._startShadow=null,this._selectShadow=null}return u.prototype.init=function(){if(!navigator.getGamepads)throw new Error("gamepad API not available");this._probeGamepads(),window.addEventListener("gamepadconnected",this._onGamepadConnect),window.addEventListener("gamepaddisconnected",this._onGamepadDisconnect)},u.prototype.deinit=function(){this.unbind(),window.removeEventListener("gamepadconnected",this._onGamepadConnect),window.removeEventListener("gamepaddisconnected",this._onGamepadDisconnect)},u.prototype.bind=function(t){var e=this,i=t.joysticks,n=void 0===i?null:i,r=t.start,o=void 0===r?null:r,s=t.select,a=void 0===s?null:s;this._bound||(this._joysticks=n||[],this._start=o,this._select=a,this._bound=!0,this._joysticksShadow=this._joysticks.map(function(t){return(e={}).left=new c,e.right=new c,e.up=new c,e.down=new c,e.fire=new c,e;var e}),this._startShadow=this._start?new c:null,this._selectShadow=this._select?new c:null,this._controlledSwitches().forEach(function(t){return t.beforeRead.addHandler(u._onBeforeSwitchRead,e)}),this._initShadows())},u.prototype.unbind=function(){var e=this;this._bound&&(this._controlledSwitches().forEach(function(t){return t.beforeRead.removeHandler(u._onBeforeSwitchRead,e)}),this._joysticks=this._start=this._select=null,this._bound=!1)},u.prototype.getGamepadCount=function(){return this._gamepadCount},u._onBeforeSwitchRead=function(t,e){var i=Date.now();if(!(0===e._gamepadCount||i-e._lastPoll<50)){e._lastPoll=i;for(var n=0,r=0,o=!1,s=!1,a=navigator.getGamepads(),u=0;u<a.length;u++){var c=a[u];c&&(n++,e._updateJoystickState(c,r++),o=o||e._readState(h.start,c),s=s||e._readState(h.select,c))}0<n&&(e._start&&e._startShadow.toggle(o),e._select&&e._selectShadow.toggle(s)),e._syncShadows()}},u.prototype._controlledSwitches=function(){var e,t,i=[];try{for(var n=s.__values(this._joysticks),r=n.next();!r.done;r=n.next()){var o=r.value;i.push(o.getLeft(),o.getRight(),o.getUp(),o.getDown(),o.getFire())}}catch(t){e={error:t}}finally{try{r&&!r.done&&(t=n.return)&&t.call(n)}finally{if(e)throw e.error}}return this._select&&i.push(this._select),this._start&&i.push(this._start),i},u.prototype._readState=function(t,e){for(var i=!1,n=0;n<t.length;n++){var r=e.buttons[t[n]];i=i||("object"==typeof r?r.pressed:.5<=r)}return i},u.prototype._updateJoystickState=function(t,e){if(this._joysticks&&!(e>=this._joysticks.length)){var i=this._joysticksShadow[e];i.left.toggle(this._readState(h.left,t)),i.right.toggle(this._readState(h.right,t)),i.up.toggle(this._readState(h.up,t)),i.down.toggle(this._readState(h.down,t)),i.fire.toggle(this._readState(h.fire,t)),(t.axes[0]<-.5||t.axes[2]<-.5)&&i.left.toggle(!0),(.5<t.axes[0]||.5<t.axes[2])&&i.right.toggle(!0),(t.axes[1]<-.5||t.axes[3]<-.5)&&i.up.toggle(!0),(.5<t.axes[1]||.5<t.axes[3])&&i.down.toggle(!0)}},u.prototype._initShadows=function(){if(this._joysticks)for(var t=0;t<this._joysticks.length;t++){var e=this._joysticks[t],i=this._joysticksShadow[t];i.left.setState(e.getLeft().peek()),i.right.setState(e.getRight().peek()),i.up.setState(e.getUp().peek()),i.down.setState(e.getDown().peek()),i.fire.setState(e.getFire().peek())}this._start&&this._startShadow.setState(this._start.peek()),this._select&&this._selectShadow.setState(this._select.peek())},u.prototype._syncShadows=function(){if(this._joysticks)for(var t=0;t<this._joysticks.length;t++){var e=this._joysticks[t],i=this._joysticksShadow[t];i.left.sync(e.getLeft()),i.right.sync(e.getRight()),i.up.sync(e.getUp()),i.down.sync(e.getDown()),i.fire.sync(e.getFire())}this._start&&this._startShadow.sync(this._start),this._select&&this._selectShadow.sync(this._select)},u.prototype._probeGamepads=function(){for(var t=0,e=navigator.getGamepads(),i=0;i<e.length;i++)e[i]&&t++;t!==this._gamepadCount&&(this._gamepadCount=t,this.gamepadCountChanged.dispatch(this._gamepadCount))},u}();i.default=o;var c=function(){function t(){this._state=!1,this._dirty=!1}return t.prototype.toggle=function(t){t!==this._state&&(this._state=t,this._dirty=!0)},t.prototype.setState=function(t){this._state=t,this._dirty=!1},t.prototype.sync=function(t){this._dirty&&(t.toggle(this._state),this._dirty=!1)},t}()},{"microevent.ts":4,tslib:6}],23:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n=function(){function t(){this._x=-1,this._listener=this._onDocumentMouseMove.bind(this)}return t.prototype.bind=function(t){this._paddle||(this._paddle=t,this._x=-1,document.addEventListener("mousemove",this._listener))},t.prototype.unbind=function(){this._paddle&&(document.removeEventListener("mousemove",this._listener),this._paddle=null)},t.prototype._onDocumentMouseMove=function(t){if(0<=this._x){var e=t.screenX-this._x,i=this._paddle.getValue();(i+=-e/window.innerWidth/.9)<0&&(i=0),1<i&&(i=1),this._paddle.setValue(i)}this._x=t.screenX},t}();i.default=n},{}],24:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var o=t("tslib"),s=["imageSmoothingEnabled","mozImageSmoothingEnabled","webkitImageSmoothingEnabled","msImageSmoothingEnabled"],n=function(){function e(t,e){void 0===e&&(e=4/3),this._canvas=t,this._aspect=e,this._syncRendering=!0,this._animationFrameHandle=0,this._pendingFrame=null,this._video=null,this._interpolate=!0,this._context=this._canvas.getContext("2d"),this._renderCanvas=document.createElement("canvas"),this._renderCanvas.width=this._renderCanvas.height=100,this._renderContext=this._renderCanvas.getContext("2d")}return e.prototype.resize=function(t,e){void 0!==t&&void 0!==e||(t=this._canvas.clientWidth,e=this._canvas.clientHeight);var i=window.devicePixelRatio||1;if(this._video){var n=this._video.getWidth(),r=this._video.getHeight();e*this._aspect<=t?3*r<=e&&e*this._aspect>=3*n&&(i=1):3*n<=t&&t/this._aspect>=3*r&&(i=1)}return this._canvas.width=t*i,this._canvas.height=e*i,this._clearCanvas(),this._recalculateBlittingMetrics(),this._applyInterpolationSettings(),this._video&&this._blitToCanvas(),this},e.prototype.init=function(){return this.enableInterpolation(!0),this._clearRenderCanvas(),this.resize(),this},e.prototype.close=function(){return this},e.prototype.enableSyncRendering=function(t){return t===this._syncRendering||(this._cancelPendingFrame(),this._syncRendering=t),this},e.prototype.syncRenderingEnabled=function(){return this._syncRendering},e.prototype.bind=function(t){return this._video||(this._video=t,this._videoWidth=this._renderCanvas.width=this._video.getWidth(),this._videoHeight=this._renderCanvas.height=this._video.getHeight(),this.resize(),this._clearRenderCanvas(),this._video.newFrame.addHandler(e._frameHandler,this)),this},e.prototype.unbind=function(){return this._video&&(this._video.newFrame.removeHandler(e._frameHandler,this),this._video=null,this._cancelPendingFrame(),this._clearCanvas()),this},e.prototype.enableInterpolation=function(t){return this._interpolate===t||(this._interpolate=t,this._applyInterpolationSettings()),this},e.prototype.interpolationEnabled=function(){return this._interpolate},e.prototype.getCanvas=function(){return this._canvas},e._frameHandler=function(t,e){e._pendingFrame&&e._pendingFrame.release(),e._pendingFrame=t,e._syncRendering?e._animationFrameHandle||e._scheduleDraw():e._draw()},e.prototype._clearCanvas=function(){this._context.fillStyle="solid black",this._context.fillRect(0,0,this._canvas.width,this._canvas.height)},e.prototype._clearRenderCanvas=function(){this._renderContext.fillStyle="solid black",this._renderContext.fillRect(0,0,this._renderCanvas.width,this._renderCanvas.height)},e.prototype._draw=function(){this._blitToRenderCanvas(),this._blitToCanvas(),this._pendingFrame.release(),this._pendingFrame=null},e.prototype._blitToRenderCanvas=function(){this._renderContext.putImageData(this._pendingFrame.get(),0,0)},e.prototype._blitToCanvas=function(){this._context.drawImage(this._renderCanvas,0,0,this._videoWidth,this._videoHeight,this._renderX,this._renderY,this._renderWidth,this._renderHeight)},e.prototype._scheduleDraw=function(){var t=this;this._animationFrameHandle||(this._animationFrameHandle=requestAnimationFrame(function(){t._draw(),t._animationFrameHandle=0}))},e.prototype._cancelPendingFrame=function(){this._animationFrameHandle&&(cancelAnimationFrame(this._animationFrameHandle),this._animationFrameHandle=0),this._pendingFrame&&(this._pendingFrame.release(),this._pendingFrame=null)},e.prototype._recalculateBlittingMetrics=function(){var t=this._canvas.width,e=this._canvas.height;this._aspect*e<=t?(this._renderHeight=e,this._renderWidth=this._aspect*e,this._renderY=0,this._renderX=Math.floor((t-this._renderWidth)/2)):(this._renderHeight=t/this._aspect,this._renderWidth=t,this._renderY=Math.floor((e-this._renderHeight)/2),this._renderX=0)},e.prototype._applyInterpolationSettings=function(){var e,t;try{for(var i=o.__values(s),n=i.next();!n.done;n=i.next()){var r=n.value;this._context[r]=this._interpolate}}catch(t){e={error:t}}finally{try{n&&!n.done&&(t=i.return)&&t.call(i)}finally{if(e)throw e.error}}},e}();i.default=n},{tslib:6}],25:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var o=t("tslib"),s=t("async-mutex"),a=t("./audio/WaveformChannel"),u=t("./audio/PCMChannel"),n=!!navigator.platform.match(/iPhone|iPad|iPod/),r=function(){function t(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0);var n=this;this._touchListener=function(){document.removeEventListener("touchstart",n._touchListener,!0),n._context&&(n._context.resume(),setTimeout(function(){n._mutex.runExclusive(function(){return n._suspended?n._context.suspend():n._context.resume()})},10))},this._context=null,this._merger=null,this._waveformChannels=null,this._pcmChannels=null,this._channels=null,this._cache=new Map,this._mutex=new s.Mutex,this._suspended=!0,this._isBound=!1,this._waveformChannels=new Array(t),this._pcmChannels=new Array(e);for(var r=0;r<t;r++)this._waveformChannels[r]=new a.default(this._cache);for(r=0;r<e;r++)this._pcmChannels[r]=new u.default(i);this._channels=o.__spread(this._waveformChannels,this._pcmChannels)}return t.prototype.init=function(){var e=this,t=window.AudioContext||window.webkitAudioContext;if(!t)throw new Error("web audio is not supported by runtime");this._context=new t;try{this._context.destination.channelCount=1}catch(t){console.warn("audio driver: failed to set channel count")}this._merger=this._context.createChannelMerger(this._channels.length),this._merger.connect(this._context.destination),this._channels.forEach(function(t){return t.init(e._context,e._merger)}),n&&document.addEventListener("touchstart",this._touchListener,!0)},t.prototype.bind=function(i,n){if(void 0===i&&(i=[]),void 0===n&&(n=[]),!this._isBound){if(i.length!==this._waveformChannels.length)throw new Error("invalid number of waveform sources: expected "+this._waveformChannels.length+", got "+i.length);if(n.length!==this._pcmChannels.length)throw new Error("invalid number of waveform sources: expected "+this._pcmChannels.length+", got "+n.length);this._waveformChannels.forEach(function(t,e){return t.bind(i[e])}),this._pcmChannels.forEach(function(t,e){return t.bind(n[e])}),this._isBound=!0,this.resume()}},t.prototype.unbind=function(){this._isBound&&(this._channels.forEach(function(t){return t.unbind()}),this._isBound=!1,this.pause())},t.prototype.setMasterVolume=function(t,e){this._channels[t].setMasterVolume(e)},t.prototype.pause=function(){var e=this;return this._mutex.runExclusive(function(){return e._suspended=!0,new Promise(function(t){e._context.suspend().then(t,t),setTimeout(t,200)})})},t.prototype.resume=function(){var e=this;return this._mutex.runExclusive(function(){return e._suspended=!1,new Promise(function(t){e._context.resume().then(t,t),setTimeout(t,200)})})},t.prototype.close=function(){var t=this;this._mutex.runExclusive(function(){return t._context.close()})},t}();i.default=r},{"./audio/PCMChannel":27,"./audio/WaveformChannel":28,"async-mutex":2,tslib:6}],26:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n=function(){function t(){this._buffer=new Float32Array(2),this._fractionalIndex=0,this._needsData=!1,this._ratio=0,this.reset(1,1)}return t.prototype.reset=function(t,e){this._ratio=t/e,this._needsData=!1;for(var i=this._fractionalIndex=0;i<2;i++)this._buffer[i]=0},t.prototype.get=function(){var t=(1-this._fractionalIndex)*this._buffer[0]+this._fractionalIndex*this._buffer[1];return this._fractionalIndex+=this._ratio,1<this._fractionalIndex&&(this._fractionalIndex-=1,this._needsData=!0),t},t.prototype.push=function(t){this._buffer[0]=this._buffer[1],this._buffer[1]=t,this._needsData=!1},t.prototype.needsData=function(){return this._needsData},t}();i.default=n},{}],27:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n=t("../../../tools/RingBuffer"),r=t("./LinearResampler"),o=function(){function e(t){void 0===t&&(t=1024),this._hostFragmentSize=t,this._outputSampleRate=0,this._bufferSize=0,this._volume=1,this._gain=null,this._processor=null,this._bufferUnderrun=!1,this._fragmentRing=null,this._fragmentSize=0,this._inputSampleRate=0,this._fragmentIndex=0,this._currentFragment=null,this._lastFragment=null,this._resampler=new r.default}return e.prototype.init=function(t,e){var i=this;this._outputSampleRate=t.sampleRate,this._gain=t.createGain(),this._gain.gain.value=this._volume,this._gain.connect(e),this._processor=t.createScriptProcessor(this._hostFragmentSize,1,1),this._bufferSize=this._processor.bufferSize,this._processor.connect(this._gain),this._processor.onaudioprocess=function(t){return i._processAudio(t)},t.createBuffer(1,1,t.sampleRate).getChannelData(0).set([0])},e.prototype.bind=function(t){this.unbind(),this._audio=t,this._fragmentSize=t.getFrameSize(),this._inputSampleRate=t.getSampleRate(),this._fragmentIndex=0,this._lastFragment=null,this._bufferUnderrun=!0,this._fragmentRing=new n.default(Math.ceil(4*this._bufferSize/this._outputSampleRate/this._fragmentSize*this._inputSampleRate)),this._audio.newFrame.addHandler(e._onNewFragment,this),this._resampler.reset(this._inputSampleRate,this._outputSampleRate)},e.prototype.unbind=function(){this._audio&&(this._audio.newFrame.removeHandler(e._onNewFragment,this),this._lastFragment&&(this._lastFragment.release(),this._lastFragment=null),this._currentFragment&&(this._currentFragment.release(),this._currentFragment=null),this._fragmentRing&&(this._fragmentRing.forEach(function(t){return t.release()}),this._fragmentRing.clear(),this._fragmentRing=null))},e.prototype.setMasterVolume=function(t){this._volume=t},e._onNewFragment=function(t,e){e._fragmentRing.push(t),e._currentFragment||(e._currentFragment=e._fragmentRing.pop(),e._fragmentIndex=0)},e.prototype._processAudio=function(t){var i=this;if(this._audio){var n=t.outputBuffer.getChannelData(0),r=0,e=function(t){for(var e=i._lastFragment&&i._lastFragment.get();r<t;)i._resampler.needsData()&&(i._resampler.push(i._audio&&i._audio.isPaused()||!e?0:e[i._fragmentIndex++]*i._volume),i._fragmentIndex>=i._fragmentSize&&(i._fragmentIndex=0)),n[r++]=i._resampler.get()};this._currentFragment&&this._bufferUnderrun&&(e(this._bufferSize>>>1),this._bufferUnderrun=!1);for(var o=this._currentFragment&&this._currentFragment.get();r<this._bufferSize&&this._currentFragment;)this._resampler.needsData()&&(this._resampler.push(o[this._fragmentIndex++]*this._volume),this._fragmentIndex>=this._fragmentSize&&(this._fragmentIndex=0,this._lastFragment&&this._lastFragment.release(),this._lastFragment=this._currentFragment,this._currentFragment=this._fragmentRing.pop(),o=this._currentFragment&&this._currentFragment.get())),n[r++]=this._resampler.get();r<this._bufferSize&&(this._bufferUnderrun=!0),e(this._bufferSize)}},e}();i.default=o},{"../../../tools/RingBuffer":17,"./LinearResampler":26}],28:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n=function(){function e(t){this._cache=t,this._context=null,this._source=null,this._gain=null,this._audio=null,this._volume=0,this._masterVolume=1}return e.prototype.init=function(t,e){this._context=t,this._gain=this._context.createGain(),this._gain.connect(e)},e.prototype.bind=function(t){this._audio||(this._audio=t,this._volume=this._audio.getVolume(),this._updateGain(),this._audio.volumeChanged.addHandler(e._onVolumeChanged,this),this._audio.bufferChanged.addHandler(e._onBufferChanged,this),this._audio.stop.addHandler(e._onStop,this))},e.prototype.unbind=function(){this._audio&&(this._audio.volumeChanged.removeHandler(e._onVolumeChanged,this),this._audio.bufferChanged.removeHandler(e._onBufferChanged,this),this._audio.stop.removeHandler(e._onStop,this),this._source&&(this._source.stop(),this._source=null),this._audio=null)},e.prototype.setMasterVolume=function(t){this._masterVolume=t,this._updateGain()},e._onVolumeChanged=function(t,e){e._volume=t,e._updateGain()},e._onBufferChanged=function(t,e){if(!e._cache.has(t)){var i=e._audio.getBuffer(t),n=e._context.createBuffer(1,i.getLength(),i.getSampleRate());n.getChannelData(0).set(i.getContent()),e._cache.set(t,n)}var r=e._cache.get(t),o=e._context.createBufferSource();e._source&&e._source.stop(),o.loop=!0,o.buffer=r,o.connect(e._gain),o.start(),e._source=o},e._onStop=function(t,e){e._source&&(e._source.stop(),e._source=null)},e.prototype._updateGain=function(){this._gain.gain.value=this._volume*this._masterVolume},e}();i.default=n},{}],29:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var a=t("tslib"),r=t("./shader"),u=["webgl","experimental-webgl"],n=function(){function e(t,e){var i,n;void 0===e&&(e={}),this._canvas=t,this._gl=null,this._program=null,this._vertexBuffer=null,this._textureCoordinateBuffer=null,this._currentFrameIndex=0,this._frameCount=0,this._gamma=1,this._aspect=4/3,this._povEmulation=!0,this._animationFrameHandle=0,this._syncRendering=!0,this._video=null,this._interpolation=!0,void 0!==e.aspect&&(this._aspect=e.aspect),void 0!==e.gamma&&(this._gamma=e.gamma),void 0!==e.povEmulation&&(this._povEmulation=e.povEmulation);try{for(var r=a.__values(u),o=r.next();!o.done;o=r.next()){var s=o.value;if(this._gl)break;this._gl=this._canvas.getContext(s,{alpha:!1})}}catch(t){i={error:t}}finally{try{o&&!o.done&&(n=r.return)&&n.call(r)}finally{if(i)throw i.error}}if(!this._gl)throw new Error("unable to acquire WebGL context");this._createTextureArrays()}return e.prototype.init=function(){return this._gl.clearColor(0,0,0,1),this._createProgram(),this._createBuffers(),this.resize(),this._allocateTextures(),this._configureTextures(),this._setupAttribs(),this.enableInterpolation(!0),this},e.prototype.close=function(){var e=this;return this._program&&this._gl.deleteProgram(this._program),this._vertexShader&&this._gl.deleteShader(this._vertexShader),this._fragmentShader&&this._gl.deleteShader(this._fragmentShader),this._textures&&this._textures.forEach(function(t){return t&&e._gl.deleteTexture(t)}),this._imageData&&this._imageData.forEach(function(t){return t&&t.release()}),this._vertexBuffer&&this._gl.deleteBuffer(this._vertexBuffer),this._textureCoordinateBuffer&&this._gl.deleteBuffer(this._textureCoordinateBuffer),this},e.prototype.resize=function(t,e){void 0!==t&&void 0!==e||(t=this._canvas.clientWidth,e=this._canvas.clientHeight);var i=window.devicePixelRatio||1;if(this._video){var n=this._video.getWidth(),r=this._video.getHeight();e*this._aspect<=t?3*r<=e&&e*this._aspect>=3*n&&(i=1):3*n<=t&&t/this._aspect>=3*r&&(i=1)}return this._canvas.width=t*i,this._canvas.height=e*i,this._gl.viewport(0,0,t*i,e*i),this._recalculateVertexBuffer(),this._video&&this._draw(),this},e.prototype.getCanvas=function(){return this._canvas},e.prototype.bind=function(t){return this._video||(this.resize(),this._video=t,this._video.newFrame.addHandler(e._frameHandler,this)),this},e.prototype.unbind=function(){return this._cancelDraw(),this._video&&(this._video.newFrame.removeHandler(e._frameHandler,this),this._video=null),this},e.prototype.enableInterpolation=function(t){return t===this._interpolation||(this._interpolation=t,this._configureTextures()),this},e.prototype.interpolationEnabled=function(){return this._interpolation},e.prototype.enableSyncRendering=function(t){return t===this._syncRendering||(t||this._cancelDraw(),this._syncRendering=t),this},e.prototype.syncRenderingEnabled=function(){return this._syncRendering},e.prototype.setGamma=function(t){return this._gamma=t,this},e.prototype.getGamma=function(){return this._gamma},e.prototype.enablePovEmulation=function(t){if(t===this._povEmulation)return this;this._povEmulation=t,this._reinit()},e.prototype.povEmulationEnabled=function(){return this._povEmulation},e._frameHandler=function(t,e){var i=e._imageData[e._currentFrameIndex];e._imageData[e._currentFrameIndex]=t,e._imageDataGeneration[e._currentFrameIndex]++,e._currentFrameIndex=(e._currentFrameIndex+1)%e._numberOfFramesToCompose,e._frameCount<e._numberOfFramesToCompose?e._frameCount++:(e._syncRendering?e._scheduleDraw():e._draw(),i.release())},e.prototype._createTextureArrays=function(){var e=this;this._numberOfFramesToCompose=this._povEmulation?3:1,this._textures&&this._textures.forEach(function(t){return t&&e._gl.deleteTexture(t)}),this._imageData&&this._imageData.forEach(function(t){return t&&t.release()}),this._textures=new Array(this._numberOfFramesToCompose),this._imageData=new Array(this._numberOfFramesToCompose),this._imageDataGeneration=new Array(this._numberOfFramesToCompose),this._textureGeneration=new Array(this._numberOfFramesToCompose);for(var t=0;t<this._numberOfFramesToCompose;t++)this._imageDataGeneration[t]=0,this._textureGeneration[t]=-1},e.prototype._reinit=function(){this._createTextureArrays(),this._createProgram(),this._allocateTextures(),this._configureTextures(),this._setupAttribs(),this._frameCount=0,this._currentFrameIndex=0},e.prototype._scheduleDraw=function(){var t=this;this._animationFrameHandle||(this._animationFrameHandle=requestAnimationFrame(function(){return t._draw(),t._animationFrameHandle=0}))},e.prototype._cancelDraw=function(){0!==this._animationFrameHandle&&(cancelAnimationFrame(this._animationFrameHandle),this._animationFrameHandle=0)},e.prototype._draw=function(){if(!(this._frameCount<this._numberOfFramesToCompose)){for(var t=this._gl,e=0;e<this._numberOfFramesToCompose;e++){var i=(this._currentFrameIndex-e-1+this._numberOfFramesToCompose)%this._numberOfFramesToCompose;this._textureGeneration[i]!==this._imageDataGeneration[i]&&(t.activeTexture(t["TEXTURE"+i]),t.bindTexture(t.TEXTURE_2D,this._textures[i]),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this._imageData[i].get()),this._textureGeneration[i]=this._imageDataGeneration[i])}for(e=0;e<this._numberOfFramesToCompose;e++)t.uniform1i(this._getUniformLocation("u_Sampler"+e),(this._currentFrameIndex+this._numberOfFramesToCompose-e-1)%this._numberOfFramesToCompose);t.uniform1f(this._getUniformLocation("u_Gamma"),this._gamma),t.clear(t.COLOR_BUFFER_BIT),t.drawArrays(t.TRIANGLE_STRIP,0,4)}},e.prototype._createProgram=function(){var t=this._gl,e=t.createShader(t.VERTEX_SHADER),i=t.createShader(t.FRAGMENT_SHADER),n=t.createProgram();if(t.shaderSource(e,r.vertexShader),t.compileShader(e),!t.getShaderParameter(e,t.COMPILE_STATUS))throw new Error("failed to compile vertex shader: "+t.getShaderInfoLog(e));if(t.shaderSource(i,this._povEmulation?r.fragmentShaderPov:r.fragmentShaderPlain),t.compileShader(i),!t.getShaderParameter(e,t.COMPILE_STATUS))throw new Error("failed to compile fragment shader: "+t.getShaderInfoLog(i));if(t.attachShader(n,e),t.attachShader(n,i),t.linkProgram(n),!t.getProgramParameter(n,t.LINK_STATUS))throw new Error("failed to link program: "+t.getProgramInfoLog(n));t.useProgram(n),this._program&&t.deleteProgram(this._program),this._vertexShader&&t.deleteShader(this._vertexShader),this._fragmentShader&&t.deleteShader(this._fragmentShader),this._program=n,this._vertexShader=e,this._fragmentShader=i},e.prototype._allocateTextures=function(){for(var t=0;t<this._numberOfFramesToCompose;t++)this._allocateTexture(t)},e.prototype._configureTextures=function(){for(var t=0;t<this._numberOfFramesToCompose;t++)this._configureTexture(t)},e.prototype._allocateTexture=function(t){var e=this._gl,i=e.createTexture();e.activeTexture(e["TEXTURE"+t]),e.bindTexture(e.TEXTURE_2D,i),this._textures[t]=i},e.prototype._configureTexture=function(t){var e=this._gl;e.activeTexture(e["TEXTURE"+t]),e.bindTexture(e.TEXTURE_2D,this._textures[t]),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,this._interpolation?e.LINEAR:e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,this._interpolation?e.LINEAR:e.NEAREST),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,1)},e.prototype._createBuffers=function(){var t=this._gl,e=t.createBuffer(),i=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,i),t.bufferData(t.ARRAY_BUFFER,new Float32Array([1,1,0,1,1,0,0,0]),t.STATIC_DRAW),this._vertexBuffer=e,this._textureCoordinateBuffer=i},e.prototype._recalculateVertexBuffer=function(){var t,e,i,n,r=this._gl,o=this._canvas.width,s=this._canvas.height,a=0<o?2/o:1,u=0<s?2/s:1;this._aspect*s<=o?(e=2,t=this._aspect*s*a,n=1,i=Math.floor(-this._aspect*s)/2*a):(e=o/this._aspect*u,t=2,n=Math.floor(o/this._aspect)/2*u,i=-1);var c=[i+t,n,i,n,i+t,n-e,i,n-e];r.bindBuffer(r.ARRAY_BUFFER,this._vertexBuffer),r.bufferData(r.ARRAY_BUFFER,new Float32Array(c),r.STATIC_DRAW)},e.prototype._getAttribLocation=function(t){var e=this._gl.getAttribLocation(this._program,t);if(e<0)throw new Error("unable to locate attribute "+t);return e},e.prototype._getUniformLocation=function(t){var e=this._gl.getUniformLocation(this._program,t);if(e<0)throw new Error("unable to locate uniform "+t);return e},e.prototype._setupAttribs=function(){var t=this._gl;t.bindBuffer(t.ARRAY_BUFFER,this._vertexBuffer),t.enableVertexAttribArray(this._getAttribLocation("a_VertexPosition")),t.vertexAttribPointer(this._getAttribLocation("a_VertexPosition"),2,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this._textureCoordinateBuffer),t.enableVertexAttribArray(this._getAttribLocation("a_TextureCoordinate")),t.vertexAttribPointer(this._getAttribLocation("a_TextureCoordinate"),2,t.FLOAT,!1,0,0)},e}();i.default=n},{"./shader":30,tslib:6}],30:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.vertexShader="\n    attribute vec2 a_VertexPosition;\n    attribute vec2 a_TextureCoordinate;\n\n    varying vec2 v_TextureCoordinate;\n\n    void main() {\n        v_TextureCoordinate = a_TextureCoordinate;\n        gl_Position = vec4(a_VertexPosition, 0, 1);\n    }\n",i.fragmentShaderPlain="\n    precision mediump float;\n\n    varying vec2 v_TextureCoordinate;\n\n    uniform sampler2D u_Sampler0;\n    uniform float u_Gamma;\n\n    void main() {\n        vec4 texel = texture2D(u_Sampler0, v_TextureCoordinate);\n\n        gl_FragColor = vec4(pow(texel.rgb, vec3(u_Gamma)), 1.);\n    }\n",i.fragmentShaderPov="\n    precision mediump float;\n\n    varying vec2 v_TextureCoordinate;\n\n    uniform sampler2D u_Sampler0, u_Sampler1, u_Sampler2;\n    uniform float u_Gamma;\n\n    void main() {\n        vec4 compositedTexel =\n            0.4 * texture2D(u_Sampler0, v_TextureCoordinate) +\n            0.4 * texture2D(u_Sampler1, v_TextureCoordinate) +\n            0.2 * texture2D(u_Sampler2, v_TextureCoordinate);\n\n        gl_FragColor = vec4(pow(compositedTexel.rgb, vec3(u_Gamma)), 1.);\n    }\n"},{}],31:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n=t("./SwitchProxy"),r=function(){function t(){this._reset=new n.default,this._select=new n.default,this._difficultyPlayer1=new n.default,this._difficultyPlayer2=new n.default,this._color=new n.default,this._boundControlPanel=null}return t.prototype.bind=function(t){this.unbind(),this._boundControlPanel=t,this._reset.bind(this._boundControlPanel.getResetButton()),this._select.bind(this._boundControlPanel.getSelectSwitch()),this._difficultyPlayer1.bind(this._boundControlPanel.getDifficultySwitchP0()),this._difficultyPlayer2.bind(this._boundControlPanel.getDifficultySwitchP1()),this._color.bind(this._boundControlPanel.getColorSwitch()),this._difficultyPlayer1.toggle(!0),this._difficultyPlayer2.toggle(!0)},t.prototype.unbind=function(){this._boundControlPanel&&(this._reset.unbind(),this._select.unbind(),this._difficultyPlayer1.unbind(),this._difficultyPlayer2.unbind(),this._color.unbind(),this._boundControlPanel=null)},t.prototype.reset=function(){return this._reset},t.prototype.select=function(){return this._select},t.prototype.difficultyPlayer1=function(){return this._difficultyPlayer1},t.prototype.difficultyPlayer2=function(){return this._difficultyPlayer2},t.prototype.color=function(){return this._color},t}();i.default=r},{"./SwitchProxy":33}],32:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n,r,o,a=t("tslib"),s=t("async-mutex"),u=t("microevent.ts"),c=t("../../stella/service/EmulationServiceInterface"),h=t("../../stella/service/worker/EmulationService"),l=t("../../stella/service/DriverManager"),_=t("../../driver/SimpleCanvasVideo"),d=t("../../driver/webgl/WebglVideo"),f=t("../../stella/driver/WebAudio"),p=t("../../stella/driver/KeyboardIO"),g=t("../../stella/driver/TouchIO"),v=t("../../driver/MouseAsPaddle"),m=t("../../driver/Gamepad"),y=t("../../driver/FullscreenVideo"),w=t("../../../machine/stella/cartridge/CartridgeInfo"),b=t("../../../machine/stella/Config"),S=t("../../../tools/base64"),E=t("./ControlPanelProxy"),x=function(){function o(t,e,i){void 0===i&&(i={});var n=this;this._config=null,this._emulationService=null,this._serviceInitialized=null,this._videoDriver=null,this._webglVideo=null,this._fullscreenVideo=null,this._audioDriver=null,this._keyboardIO=null,this._touchIO=null,this._paddle=null,this._gamepad=null,this._controlPanel=new E.default,this._state=o.State.stopped,this._driverManager=new l.default,this._mutex=new s.Mutex,this._canvasElt=t,this._config=a.__assign({smoothScaling:!0,simulatePov:!0,gamma:1,audio:!0,volume:.5,enableKeyboard:!0,enableTouch:!0,touchLeftHanded:!1,touchJoystickSensitivity:15,keyboardTarget:document,fullscreenViaKeyboard:!0,paddleViaMouse:!0,pauseViaKeyboard:!0,pauseViaTouch:!0,fullscreenViaTouch:!0,enableGamepad:!0,resetViaKeyboard:!0},i),this._emulationService=new h.default(e),this.frequencyUpdate=this._emulationService.frequencyUpdate;var r=new u.Event;this._emulationService.stateChanged.addHandler(function(t){return r.dispatch(n._mapState(t))}),this.stateChange=r,this._createDrivers(),this._driverManager.addDriver(this._controlPanel,function(t){return n._controlPanel.bind(t.getControlPanel())}),this._driverManager.bind(this._emulationService),this._serviceInitialized=this._emulationService.init().then(void 0,function(t){throw console.log(t),t})}return o.prototype.setGamma=function(t){return this._webglVideo&&this._webglVideo.setGamma(t),this},o.prototype.getGamma=function(){return this._webglVideo?this._webglVideo.getGamma():1},o.prototype.enablePovSimulation=function(t){return this._webglVideo&&this._webglVideo.enablePovEmulation(t),this},o.prototype.isPovSimulationEnabled=function(){return!!this._webglVideo&&this._webglVideo.povEmulationEnabled()},o.prototype.enableSmoothScaling=function(t){return this._videoDriver.enableInterpolation(t),this},o.prototype.smoothScalingEnabled=function(){return this._videoDriver.interpolationEnabled()},o.prototype.toggleFullscreen=function(t){return void 0===t?this._fullscreenVideo.toggle():t?this._fullscreenVideo.engage():this._fullscreenVideo.disengage(),this},o.prototype.isFullscreen=function(){return this._fullscreenVideo.isEngaged()},o.prototype.setVolume=function(t){return this._audioDriver&&this._audioDriver.setMasterVolume(Math.max(Math.min(t,1),0)),this},o.prototype.audioEnabled=function(){return!!this._audioDriver},o.prototype.getVolume=function(){return this._audioDriver?this._audioDriver.getMasterVolume():0},o.prototype.resize=function(){return this._videoDriver.resize(),this},o.prototype.getState=function(){return this._state},o.prototype.getControlPanel=function(){return this._controlPanel},o.prototype.start=function(r,o,s){var t=this;return void 0===s&&(s={}),this._mutex.runExclusive(function(){return a.__awaiter(t,void 0,void 0,function(){var e,i,n;return a.__generator(this,function(t){switch(t.label){case 0:return"string"==typeof r&&(r=S.decode(r)),e=b.default.create({tvMode:this._convertTvMode(o),pcmAudio:!0}),void 0!==s.randomSeed&&0<s.randomSeed&&(e.randomSeed=s.randomSeed),void 0!==s.emulatePaddles&&(e.emulatePaddles=s.emulatePaddles),void 0!==s.frameStart&&(e.frameStart=s.frameStart),[4,this._serviceInitialized];case 1:return t.sent(),n=(i=this)._mapState,[4,this._emulationService.start(r,e,s.cartridgeType)];case 2:return[2,i._state=n.apply(this,[t.sent()])]}})})})},o.prototype.run=function(e,i,n){return void 0===n&&(n={}),a.__awaiter(this,void 0,void 0,function(){return a.__generator(this,function(t){switch(t.label){case 0:return[4,this.start(e,i,n)];case 1:return t.sent()===o.State.paused?[2,this.resume()]:[2]}})})},o.prototype.pause=function(){return a.__awaiter(this,void 0,void 0,function(){var e=this;return a.__generator(this,function(t){switch(t.label){case 0:return[4,this._serviceInitialized];case 1:return t.sent(),[2,this._mutex.runExclusive(function(){return a.__awaiter(e,void 0,void 0,function(){var e,i;return a.__generator(this,function(t){switch(t.label){case 0:return i=(e=this)._mapState,[4,this._emulationService.pause()];case 1:return[2,e._state=i.apply(this,[t.sent()])]}})})})]}})})},o.prototype.resume=function(){return a.__awaiter(this,void 0,void 0,function(){var e=this;return a.__generator(this,function(t){switch(t.label){case 0:return[4,this._serviceInitialized];case 1:return t.sent(),[2,this._mutex.runExclusive(function(){return a.__awaiter(e,void 0,void 0,function(){var e,i;return a.__generator(this,function(t){switch(t.label){case 0:return i=(e=this)._mapState,[4,this._emulationService.resume()];case 1:return[2,e._state=i.apply(this,[t.sent()])]}})})})]}})})},o.prototype.stop=function(){return a.__awaiter(this,void 0,void 0,function(){var e=this;return a.__generator(this,function(t){switch(t.label){case 0:return[4,this._serviceInitialized];case 1:return t.sent(),[2,this._mutex.runExclusive(function(){return a.__awaiter(e,void 0,void 0,function(){var e,i;return a.__generator(this,function(t){switch(t.label){case 0:return i=(e=this)._mapState,[4,this._emulationService.stop()];case 1:return[2,e._state=i.apply(this,[t.sent()])]}})})})]}})})},o.prototype.reset=function(){return a.__awaiter(this,void 0,void 0,function(){var e=this;return a.__generator(this,function(t){switch(t.label){case 0:return[4,this._serviceInitialized];case 1:return t.sent(),[2,this._mutex.runExclusive(function(){return a.__awaiter(e,void 0,void 0,function(){var e,i;return a.__generator(this,function(t){switch(t.label){case 0:return i=(e=this)._mapState,[4,this._emulationService.reset()];case 1:return[2,e._state=i.apply(this,[t.sent()])]}})})})]}})})},o.prototype.lastError=function(){return this._emulationService.getLastError()},o.prototype._convertTvMode=function(t){switch(t){case o.TvMode.ntsc:return 0;case o.TvMode.pal:return 1;case o.TvMode.secam:return 2;default:throw new Error("invalid TV mode '"+t+"'")}},o.prototype._createDrivers=function(){var e=this;try{this._webglVideo=this._videoDriver=new d.default(this._canvasElt,{povEmulation:this._config.simulatePov,gamma:this._config.gamma}).init()}catch(t){this._webglVideo=null,this._videoDriver=new _.default(this._canvasElt).init()}if(this._videoDriver.enableInterpolation(this._config.smoothScaling),this._driverManager.addDriver(this._videoDriver,function(t){return e._videoDriver.bind(t.getVideo())}),this._fullscreenVideo=new y.default(this._videoDriver),this._config.audio)try{this._audioDriver=new f.default,this._audioDriver.init(),this._audioDriver.setMasterVolume(this._config.volume),this._driverManager.addDriver(this._audioDriver,function(t){return e._audioDriver.bind(!0,[t.getPCMChannel()])})}catch(t){console.error("failed to initialize audio: "+(t&&t.message))}var t=function(){switch(e._emulationService.getState()){case c.default.State.paused:e.resume();break;case c.default.State.running:e.pause()}};this._config.enableKeyboard&&(this._keyboardIO=new p.default(this._config.keyboardTarget),this._driverManager.addDriver(this._keyboardIO,function(t){return e._keyboardIO.bind(t.getJoystick(0),t.getJoystick(1),t.getControlPanel())}),this._config.fullscreenViaKeyboard&&this._keyboardIO.toggleFullscreen.addHandler(function(){return e._fullscreenVideo.toggle()}),this._config.pauseViaKeyboard&&this._keyboardIO.togglePause.addHandler(t)),this._config.resetViaKeyboard&&this._keyboardIO.hardReset.addHandler(function(){return e.reset()}),this._config.enableTouch&&(this._touchIO=new g.default(this._canvasElt,this._config.touchJoystickSensitivity,this._config.touchLeftHanded),this._driverManager.addDriver(this._touchIO,function(t){return e._touchIO.bind(t.getJoystick(0),t.getControlPanel())}),this._config.pauseViaTouch&&this._touchIO.togglePause.addHandler(t),this._config.fullscreenViaTouch&&this._touchIO.toggleFullscreen.addHandler(function(){return e._fullscreenVideo.toggle()})),this._config.enableGamepad&&(this._gamepad=new m.default,this._gamepad.init(),this._driverManager.addDriver(this._gamepad,function(t){return e._gamepad.bind({joysticks:[t.getJoystick(0),t.getJoystick(1)],start:t.getControlPanel().getResetButton(),select:t.getControlPanel().getSelectSwitch()})})),this._config.paddleViaMouse&&(this._paddle=new v.default,this._driverManager.addDriver(this._paddle,function(t){return e._paddle.bind(t.getPaddle(0))}))},o.prototype._mapState=function(t){switch(t){case c.default.State.stopped:return o.State.stopped;case c.default.State.running:return o.State.running;case c.default.State.paused:return o.State.paused;case c.default.State.error:return o.State.error;default:throw new Error("cannot happen")}},o}();i.default=x,n=x||(x={}),(r=n.TvMode||(n.TvMode={})).ntsc="ntsc",r.pal="pal",r.secam="secam",n.CartridgeType=w.default.CartridgeType,n.describeCartridgeType=w.default.describeCartridgeType,n.allCartridgeTypes=w.default.getAllTypes,(o=n.State||(n.State={})).running="running",o.paused="paused",o.stopped="stopped",o.error="error",i.default=x},{"../../../machine/stella/Config":12,"../../../machine/stella/cartridge/CartridgeInfo":14,"../../../tools/base64":18,"../../driver/FullscreenVideo":21,"../../driver/Gamepad":22,"../../driver/MouseAsPaddle":23,"../../driver/SimpleCanvasVideo":24,"../../driver/webgl/WebglVideo":29,"../../stella/driver/KeyboardIO":35,"../../stella/driver/TouchIO":36,"../../stella/driver/WebAudio":37,"../../stella/service/DriverManager":39,"../../stella/service/EmulationServiceInterface":40,"../../stella/service/worker/EmulationService":43,"./ControlPanelProxy":31,"async-mutex":2,"microevent.ts":4,tslib:6}],33:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n=t("microevent.ts"),r=function(){function e(){this.stateChange=new n.Event,this._state=!1,this._boundSwitch=null}return e.prototype.bind=function(t){this.unbind(),this._boundSwitch=t,this._boundSwitch.toggle(this._state),this._boundSwitch.stateChanged.addHandler(e._onBoundStateChange,this),this._setState(this._boundSwitch.read())},e.prototype.unbind=function(){this._boundSwitch&&(this._boundSwitch.stateChanged.removeHandler(e._onBoundStateChange,this),this._boundSwitch=null)},e.prototype.toggle=function(t){return this._boundSwitch?this._boundSwitch.toggle(t):this._setState(t),this},e.prototype.read=function(){return this._state},e._onBoundStateChange=function(t,e){e._setState(t)},e.prototype._setState=function(t){t!==this._state&&(this._state=t,this.stateChange.dispatch(this._state))},e}();i.default=r},{"microevent.ts":4}],34:[function(t,e,i){"use strict";var n=t("./Stellerator");e.exports={Stellerator:n.default}},{"./Stellerator":32}],35:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var u=t("tslib"),n=t("microevent.ts");function r(t){return{type:0,swtch:t}}function o(t){return{type:1,trigger:t}}var s=function(){function i(t,e){void 0===e&&(e=i.defaultMappings),this._target=t,this.toggleFullscreen=new n.Event,this.hardReset=new n.Event,this.togglePause=new n.Event,this._keydownListener=null,this._keyupListener=null,this._joystick0=null,this._joystick1=null,this._controlPanel=null,this._dispatchTable={},this._compiledMappings=new Map,this._compileMappings(e)}return i.prototype.bind=function(t,e,i){var a=this;this._joystick0||(this._joystick0=t,this._joystick1=e,this._controlPanel=i,this._updateActionTable(),this._keydownListener=function(t){if(a._compiledMappings.has(t.keyCode)){var e=(t.shiftKey?4:0)|(t.ctrlKey?1:0)|(t.altKey?2:0);if(a._compiledMappings.get(t.keyCode).has(e)){var i=a._compiledMappings.get(t.keyCode).get(e);if(void 0!==i){t.preventDefault();var n=a._dispatchTable[i];switch(n.type){case 0:n.swtch.toggle(!0);break;case 1:n.trigger.dispatch(void 0)}}}}},this._keyupListener=function(t){var e,i;if(a._compiledMappings.has(t.keyCode))try{for(var n=u.__values(a._compiledMappings.get(t.keyCode).values()),r=n.next();!r.done;r=n.next()){var o=r.value;t.preventDefault();var s=a._dispatchTable[o];switch(s.type){case 0:s.swtch.toggle(!1)}}}catch(t){e={error:t}}finally{try{r&&!r.done&&(i=n.return)&&i.call(n)}finally{if(e)throw e.error}}},this._target.addEventListener("keydown",this._keydownListener),this._target.addEventListener("keyup",this._keyupListener))},i.prototype.unbind=function(){this._joystick0&&(this._target.removeEventListener("keydown",this._keydownListener),this._target.removeEventListener("keyup",this._keyupListener),this._joystick0=this._joystick1=this._controlPanel=null,this._keydownListener=this._keyupListener=null)},i.prototype._updateActionTable=function(){this._dispatchTable[12]=o(this.toggleFullscreen),this._dispatchTable[13]=o(this.hardReset),this._dispatchTable[14]=o(this.togglePause),this._dispatchTable[0]=r(this._controlPanel.getSelectSwitch()),this._dispatchTable[1]=r(this._controlPanel.getResetButton()),this._dispatchTable[2]=r(this._joystick0.getLeft()),this._dispatchTable[3]=r(this._joystick0.getRight()),this._dispatchTable[4]=r(this._joystick0.getUp()),this._dispatchTable[5]=r(this._joystick0.getDown()),this._dispatchTable[10]=r(this._joystick0.getFire()),this._dispatchTable[6]=r(this._joystick1.getLeft()),this._dispatchTable[7]=r(this._joystick1.getRight()),this._dispatchTable[8]=r(this._joystick1.getUp()),this._dispatchTable[9]=r(this._joystick1.getDown()),this._dispatchTable[11]=r(this._joystick1.getFire())},i.prototype._compileMappings=function(t){var n=this;t.forEach(function(t){var e=t.action;(Array.isArray(t.spec)?t.spec:[t.spec]).forEach(function(t){return function(t,e,i){if(0!=(-8&i))throw new Error("invalid modifier set "+i);n._compiledMappings.has(e)||n._compiledMappings.set(e,new Map),n._compiledMappings.get(e).set(i,t)}(e,"object"==typeof t?t.keycode:t,"object"==typeof t?t.modifiers:0)})})},i}();((i.default=s)||(s={})).defaultMappings=[{action:0,spec:{keycode:32,modifiers:4}},{action:1,spec:{keycode:13,modifiers:4}},{action:2,spec:[65,37]},{action:3,spec:[68,39]},{action:4,spec:[87,38]},{action:5,spec:[83,40]},{action:10,spec:[32,86]},{action:6,spec:74},{action:7,spec:76},{action:8,spec:73},{action:9,spec:75},{action:11,spec:66},{action:12,spec:13},{action:13,spec:{keycode:82,modifiers:4}},{action:14,spec:80}],i.default=s},{"microevent.ts":4,tslib:6}],36:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n=t("microevent.ts"),r=t("./touch/DoubleTapDetector"),o=function(){function t(t,e,i){void 0===e&&(e=15),void 0===i&&(i=!1);var l=this;this._canvas=t,this._joystickSensitivity=e,this._leftHanded=i,this._onTouchStart=function(t){for(var e=!1,i=0;i<t.changedTouches.length;i++){var n=new s(t.changedTouches.item(i),l._canvas),r=n.touch.identifier;if((l._leftHanded?.5<n.x:n.x<=.5)?n.y<=.5?n.type="alt":n.type=l._isAlt?"pause":"fire":n.y<=.5?n.type=l._isAlt?"select":"joystick":n.type=l._isAlt?"reset":"joystick",!l._pendingTouches.has(r)&&!l._pendingTouches.has(n.type)){switch(l._pendingTouches.set(r,n),l._pendingTouches.set(n.type,n),n.type){case"alt":l._isAlt=!0,l._fullscreenDoubleTapDetector.startTouch();break;case"fire":l._joystick.getFire().toggle(!0);break;case"pause":l.togglePause.dispatch(void 0),l._fullscreenDoubleTapDetector.cancelTouch();break;case"select":l._select.toggle(!0),l._fullscreenDoubleTapDetector.cancelTouch();break;case"reset":l._reset.toggle(!0),l._fullscreenDoubleTapDetector.cancelTouch();break;case"joystick":break;default:throw new Error("invalid touch type")}(l._cancelEvent(n)||l._fullscreenDoubleTapDetector.isDispatching())&&(e=!0)}}e&&t.preventDefault()},this._onTouchEnd=function(t){for(var e=!1,i=0;i<t.changedTouches.length;i++){var n=l._pendingTouches.get(t.changedTouches.item(i).identifier);if(n){switch((l._cancelEvent(n)||l._fullscreenDoubleTapDetector.isDispatching())&&(e=!0),n.type){case"alt":l._isAlt=!1,l._fullscreenDoubleTapDetector.endTouch();break;case"fire":l._joystick.getFire().toggle(!1);break;case"select":l._select.toggle(!1);break;case"reset":l._reset.toggle(!1);break;case"joystick":l._joystick.getDown().toggle(!1),l._joystick.getUp().toggle(!1),l._joystick.getLeft().toggle(!1),l._joystick.getRight().toggle(!1);break;case"pause":break;default:throw new Error("invalid touch type")}l._pendingTouches.delete(n.type),l._pendingTouches.delete(n.touch.identifier)}}e&&t.preventDefault()},this._onTouchMove=function(t){for(var e=!1,i=0;i<t.changedTouches.length;i++){var n=t.changedTouches.item(i),r=l._pendingTouches.get(n.identifier);if(r&&(l._cancelEvent(r)&&(e=!0),"joystick"===r.type)){var o=n.clientX-r.touch.clientX,s=n.clientY-r.touch.clientY,a=Math.sqrt(o*o+s*s),u=Math.abs(s/a),c=Math.abs(o/a),h=a>l._joystickSensitivity;l._joystick.getLeft().toggle(h&&o<0&&.5<c),l._joystick.getRight().toggle(h&&0<o&&.5<c),l._joystick.getUp().toggle(h&&s<0&&.5<u),l._joystick.getDown().toggle(h&&0<s&&.5<u)}}e&&t.preventDefault()},this.togglePause=new n.Event,this._fullscreenDoubleTapDetector=new r.default,this._bound=!1,this._joystick=null,this._select=null,this._reset=null,this._isAlt=!1,this._pendingTouches=new Map,this.toggleFullscreen=this._fullscreenDoubleTapDetector.trigger}return t.prototype.bind=function(t,e){this._bound||(this._bound=!0,this._joystick=t,this._select=e.getSelectSwitch(),this._reset=e.getResetButton(),this._bindListeners())},t.prototype.unbind=function(){this._bound&&(this._unbindListeners(),this._bound=!1,this._joystick=this._reset=this._select=null)},t.prototype._bindListeners=function(){this._canvas.addEventListener("touchstart",this._onTouchStart),this._canvas.addEventListener("touchend",this._onTouchEnd),this._canvas.addEventListener("touchmove",this._onTouchMove)},t.prototype._unbindListeners=function(){this._canvas.removeEventListener("touchstart",this._onTouchStart),this._canvas.removeEventListener("touchend",this._onTouchEnd),this._canvas.removeEventListener("touchmove",this._onTouchMove)},t.prototype._cancelEvent=function(t){return"alt"!==t.type},t}(),s=function(t,e){this.touch=t,this.type="unknown";var i=e.getBoundingClientRect();this.x=(t.clientX-i.left)/i.width,this.y=(t.clientY-i.top)/i.height};i.default=o},{"./touch/DoubleTapDetector":38,"microevent.ts":4}],37:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n=t("tslib"),r=t("../../driver/WebAudio"),o=function(){function t(t){this._fragmentSize=t,this._pcmAudio=!1,this._volume=1}return t.prototype.init=function(){},t.prototype.bind=function(t,e){if(!this._channels){this._channels=n.__spread(e),this._driver&&this._pcmAudio===t||(this._driver&&this._driver.close(),this._driver=t?new r.default(0,this._channels.length,this._fragmentSize):new r.default(this._channels.length,0,this._fragmentSize),this._driver.init()),t?this._driver.bind([],this._channels):this._driver.bind(this._channels,[]);for(var i=0;i<this._channels.length;i++)this._driver.setMasterVolume(i,this._volume);this._pcmAudio=t}},t.prototype.unbind=function(){this._channels&&(this._driver.unbind(),this._channels=null)},t.prototype.setMasterVolume=function(t){if(this._volume=t,this._channels)for(var e=0;e<this._channels.length;e++)this._driver.setMasterVolume(e,this._volume)},t.prototype.getMasterVolume=function(){return this._volume},t.prototype.pause=function(){return n.__awaiter(this,void 0,void 0,function(){return n.__generator(this,function(t){switch(t.label){case 0:return this._driver?[4,this._driver.pause()]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}})})},t.prototype.resume=function(){return n.__awaiter(this,void 0,void 0,function(){return n.__generator(this,function(t){switch(t.label){case 0:return this._driver?[4,this._driver.resume()]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}})})},t}();i.default=o},{"../../driver/WebAudio":25,tslib:6}],38:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n=t("microevent.ts"),r=function(){function t(t,e){void 0===t&&(t=500),void 0===e&&(e=200),this._maxTapLength=t,this._timeout=e,this.trigger=new n.Event,this._dispatch=!1,this._touching=!1,this._lastTouchEligible=!1,this._lastTouchStart=0,this._lastTouchEnd=0}return t.prototype.startTouch=function(){this._lastTouchStart=Date.now(),this._touching||(this._touching=!0,this._dispatch=this._lastTouchEligible&&this._lastTouchStart-this._lastTouchEnd<this._timeout)},t.prototype.endTouch=function(){this._lastTouchEnd=Date.now(),this._dispatch&&(this._dispatch=!1,this.trigger.dispatch(void 0)),this._touching&&(this._touching=!1,this._lastTouchEligible=this._lastTouchStart-this._lastTouchEnd<this._maxTapLength)},t.prototype.cancelTouch=function(){this.endTouch(),this._lastTouchEligible=!1},t.prototype.isDispatching=function(){return this._dispatch},t}();i.default=r},{"microevent.ts":4}],39:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n,r=t("./EmulationServiceInterface"),o=function(){function i(){this._drivers=new Map,this._driversBound=!1}return i.prototype.bind=function(t){return this._driversBound||(this._emulationService=t,this._shouldBindDrivers()&&this._bindDrivers(),this._emulationService.stateChanged.addHandler(i._onEmuStateChange,this)),this},i.prototype.unbind=function(){return this._emulationService&&(this._unbindDrivers(),this._emulationService.stateChanged.removeHandler(i._onEmuStateChange,this),this._emulationService=null),this},i.prototype.addDriver=function(t,e){return this._drivers.set(t,new i.DriverContext(t,e)),this._driversBound&&e(this._emulationService.getEmulationContext(),t),this},i.prototype.removeDriver=function(t){return this._drivers.get(t)&&(t.unbind(),this._drivers.delete(t)),this},i._onEmuStateChange=function(t,e){e._shouldBindDrivers(t)?e._bindDrivers():e._unbindDrivers()},i.prototype._shouldBindDrivers=function(t){return void 0===t&&(t=this._emulationService?this._emulationService.getState():void 0),this._emulationService&&(t===r.default.State.running||t===r.default.State.paused)},i.prototype._bindDrivers=function(){var e=this;this._driversBound||(this._drivers.forEach(function(t){return t.binder(e._emulationService.getEmulationContext(),t.driver)}),this._driversBound=!0)},i.prototype._unbindDrivers=function(){this._driversBound&&(this._drivers.forEach(function(t){return t.driver.unbind()}),this._driversBound=!1)},i}();i.default=o,n=function(t,e){this.driver=t,this.binder=e},(o||(o={})).DriverContext=n,i.default=o},{"./EmulationServiceInterface":40}],40:[function(t,e,i){"use strict";var n,r,o;Object.defineProperty(i,"__esModule",{value:!0}),r=n||(n={}),(o=r.State||(r.State={}))[o.stopped=0]="stopped",o[o.running=1]="running",o[o.paused=2]="paused",o[o.error=3]="error",i.default=n},{}],41:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n=t("../../../../machine/io/DigitalJoystick"),r=t("../../../../machine/stella/ControlPanel"),o=t("../../../../machine/io/Paddle"),s=t("./messages"),a=function(){function t(t){this._rpc=t,this._joysticks=new Array(2),this._paddles=new Array(4),this._controlPanel=new r.default;for(var e=0;e<2;e++)this._joysticks[e]=new n.default;for(e=0;e<4;e++)this._paddles[e]=new o.default}return t.prototype.sendUpdate=function(){this._rpc.signal(s.SIGNAL_TYPE.controlStateUpdate,{joystickState:this._joysticks.map(t._joystickState),paddleState:this._paddles.map(t._paddleState),controlPanelState:t._controlPanelState(this._controlPanel)})},t.prototype.getJoystick=function(t){if(t<0||1<t)throw new Error("invalid joystick index "+t);return this._joysticks[t]},t.prototype.getControlPanel=function(){return this._controlPanel},t.prototype.getPaddle=function(t){if(t<0||3<t)throw new Error("invalid paddle index "+t);return this._paddles[t]},t._joystickState=function(t){return{up:t.getUp().read(),down:t.getDown().read(),left:t.getLeft().read(),right:t.getRight().read(),fire:t.getFire().read()}},t._paddleState=function(t){return{value:t.getValue(),fire:t.getFire().read()}},t._controlPanelState=function(t){return{difficulty0:t.getDifficultySwitchP0().read(),difficulty1:t.getDifficultySwitchP1().read(),select:t.getSelectSwitch().read(),reset:t.getResetButton().read(),color:t.getColorSwitch().read()}},t}();i.default=a},{"../../../../machine/io/DigitalJoystick":9,"../../../../machine/io/Paddle":10,"../../../../machine/stella/ControlPanel":13,"./messages":47}],42:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n=function(){function t(t,e,i,n){if(this._videoProxy=t,this._controlProxy=e,this._waveformChannels=i,this._pcmChannel=n,this._config=null,2!==this._waveformChannels.length)throw new Error("invalid channel count "+this._waveformChannels.length)}return t.prototype.setConfig=function(t){this._config=t},t.prototype.getConfig=function(){return this._config},t.prototype.getVideo=function(){return this._videoProxy},t.prototype.getJoystick=function(t){return this._controlProxy.getJoystick(t)},t.prototype.getControlPanel=function(){return this._controlProxy.getControlPanel()},t.prototype.getPaddle=function(t){return this._controlProxy.getPaddle(t)},t.prototype.getWaveformChannels=function(){return this._waveformChannels},t.prototype.getPCMChannel=function(){return this._pcmChannel},t.prototype.getVideoProxy=function(){return this._videoProxy},t}();i.default=n},{}],43:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var s=t("tslib"),n=t("microevent.ts"),r=t("worker-rpc"),a=t("../EmulationServiceInterface"),o=t("./EmulationContext"),u=t("./VideoProxy"),c=t("./ControlProxy"),h=t("./WaveformAudioProxy"),l=t("./PCMAudioProxy"),_=t("async-mutex"),d=t("./messages"),f=function(){function t(t,e){this._stellaWorkerUri=t,this._videoWorkerUri=e,this.stateChanged=new n.Event,this.frequencyUpdate=new n.Event,this._rateLimitEnforced=!0,this._mutex=new _.Mutex,this._worker=null,this._rpc=null,this._state=a.default.State.stopped,this._lastError=null,this._emulationContext=null,this._frequency=0,this._waveformChannels=new Array(2),this._pcmChannel=null,this._controlProxy=null,this._controlProxyUpdateHandle=null,this._proxyState=0,this._saveConfig=null}return t.prototype.init=function(){var i=this;this._worker=new Worker(this._stellaWorkerUri),this._rpc=new r.RpcProvider(function(t,e){return i._worker.postMessage(t,e)}),this._pcmChannel=new l.default(0,this._rpc).init();for(var t=0;t<2;t++)this._waveformChannels[t]=new h.default(t,this._rpc).init();var e=new u.default(this._rpc),n=new c.default(this._rpc);return e.init(),this._emulationContext=new o.default(e,n,this._waveformChannels,this._pcmChannel),this._worker.onmessage=function(t){return i._rpc.dispatch(t.data)},this._rpc.registerSignalHandler(d.SIGNAL_TYPE.emulationFrequencyUpdate,this._onFrequencyUpdate.bind(this)).registerSignalHandler(d.SIGNAL_TYPE.emulationError,this._onEmulationError.bind(this)),this._controlProxy=n,this._startVideoProcessingPipeline().then(function(){return i.setRateLimit(i._rateLimitEnforced)})},t.prototype.start=function(i,n,r,o){return s.__awaiter(this,void 0,void 0,function(){var e=this;return s.__generator(this,function(t){switch(t.label){case 0:return[4,this.stop()];case 1:return t.sent(),[2,this._mutex.runExclusive(function(){return s.__awaiter(e,void 0,void 0,function(){var e;return s.__generator(this,function(t){switch(t.label){case 0:return[4,this._rpc.rpc(d.RPC_TYPE.emulationStart,{buffer:i,config:n,cartridgeType:r,videoProcessing:o})];case 1:return(e=t.sent())!==a.default.State.paused?[3,3]:(this._saveConfig=n,this._emulationContext.setConfig(n),[4,this._startProxies(n)]);case 2:return t.sent(),[3,4];case 3:this._saveConfig=null,t.label=4;case 4:return[2,this._applyState(e)]}})})})]}})})},t.prototype.pause=function(){var e=this;return this._mutex.runExclusive(function(){return e._rpc.rpc(d.RPC_TYPE.emulationPause).then(function(t){return e._pauseProxies(),e._applyState(t)})})},t.prototype.stop=function(){var e=this;return this._mutex.runExclusive(function(){return e._rpc.rpc(d.RPC_TYPE.emulationStop).then(function(t){return e._stopProxies(),e._applyState(t)})})},t.prototype.reset=function(){var t=this;return this._mutex.runExclusive(function(){return s.__awaiter(t,void 0,void 0,function(){var e;return s.__generator(this,function(t){switch(t.label){case 0:return[4,this._rpc.rpc(d.RPC_TYPE.emulationReset)];case 1:return e=t.sent(),this._state!==a.default.State.error||e!==a.default.State.running&&e!==a.default.State.paused||!this._saveConfig?[3,3]:[4,this._startProxies(this._saveConfig)];case 2:t.sent(),t.label=3;case 3:return[2,this._applyState(e)]}})})})},t.prototype.resume=function(){var e=this;return this._mutex.runExclusive(function(){return e._rpc.rpc(d.RPC_TYPE.emulationResume).then(function(t){return e._resumeProxies(),e._applyState(t)})})},t.prototype.setRateLimit=function(t){return this._rateLimitEnforced=t,this._rpc.rpc(d.RPC_TYPE.emulationSetRateLimit,t)},t.prototype.getFrequency=function(){return this._frequency},t.prototype.getRateLimit=function(){return this._rateLimitEnforced},t.prototype.getState=function(){return this._state},t.prototype.getLastError=function(){return this._lastError},t.prototype.getEmulationContext=function(){switch(this._state){case a.default.State.running:case a.default.State.paused:return this._emulationContext;default:return null}},t.prototype._fetchLastError=function(){return this._rpc.rpc(d.RPC_TYPE.emulationFetchLastError).then(function(t){return t?new Error(t):null})},t.prototype._applyState=function(e){var i=this;return e===a.default.State.error?this._fetchLastError().then(function(t){return i._state=e,i._lastError=t,i._stopProxies(),i.stateChanged.dispatch(e),e}):(this._state=e,this.stateChanged.dispatch(e),e)},t.prototype._onFrequencyUpdate=function(t){this._frequency=t,this.frequencyUpdate.dispatch(this._frequency)},t.prototype._onEmulationError=function(t){this._lastError=new Error(t||""),this._stopProxies(),this._state=a.default.State.error,this.stateChanged.dispatch(this._state)},t.prototype._startProxies=function(i){return s.__awaiter(this,void 0,void 0,function(){var e;return s.__generator(this,function(t){switch(t.label){case 0:return[4,this._emulationContext.getVideoProxy().start()];case 1:t.sent(),e=0,t.label=2;case 2:return e<this._waveformChannels.length?[4,this._waveformChannels[e].start(i)]:[3,5];case 3:t.sent(),t.label=4;case 4:return e++,[3,2];case 5:return[4,this._pcmChannel.start()];case 6:return t.sent(),this._startControlUpdates(),this._proxyState=1,[2]}})})},t.prototype._stopProxies=function(){0!==this._proxyState&&(this._emulationContext.getVideoProxy().stop(),this._pcmChannel.stop(),this._stopControlUpdates(),this._proxyState=0)},t.prototype._pauseProxies=function(){1===this._proxyState&&(this._stopControlUpdates(),this._proxyState=2)},t.prototype._resumeProxies=function(){2===this._proxyState&&(this._startControlUpdates(),this._proxyState=1)},t.prototype._startControlUpdates=function(){var t=this;null===this._controlProxyUpdateHandle&&(this._controlProxyUpdateHandle=setInterval(function(){return t._controlProxy.sendUpdate()},25))},t.prototype._stopControlUpdates=function(){null!==this._controlProxyUpdateHandle&&(clearInterval(this._controlProxyUpdateHandle),this._controlProxyUpdateHandle=null)},t.prototype._startVideoProcessingPipeline=function(){return s.__awaiter(this,void 0,void 0,function(){var e,i,n;return s.__generator(this,function(t){switch(t.label){case 0:return e=null,this._videoWorkerUri?(e=new MessageChannel,i=new Worker(this._videoWorkerUri),n=new r.RpcProvider(function(t,e){return i.postMessage(t,e)}),i.onmessage=function(t){return n.dispatch(t.data)},[4,n.rpc("/use-port",e.port1,[e.port1])]):[3,2];case 1:t.sent(),t.label=2;case 2:return[4,this._rpc.rpc(d.RPC_TYPE.setup,{videoProcessorPort:e&&e.port2},e?[e.port2]:[])];case 3:return t.sent(),[2]}})})},t}();i.default=f},{"../EmulationServiceInterface":40,"./ControlProxy":41,"./EmulationContext":42,"./PCMAudioProxy":44,"./VideoProxy":45,"./WaveformAudioProxy":46,"./messages":47,"async-mutex":2,"microevent.ts":4,tslib:6,"worker-rpc":8}],44:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n=t("tslib"),r=t("microevent.ts"),o=t("../../../../tools/pool/Pool"),s=t("./messages"),a=function(){function i(t,e){this._index=t,this._rpc=e,this.newFrame=new r.Event,this.togglePause=new r.Event,this._sampleRate=0,this._frameSize=0,this._paused=!1,this._framePool=new o.default(function(){return null}),this._frameMap=new WeakMap,this._enabled=!1,this._signalReturnFrame="",this._framePool.event.release.addHandler(i._onReleaseFragment,this),this._signalReturnFrame=s.SIGNAL_TYPE.pcmAudioReturnFrame(this._index)}return i.prototype.init=function(){return this._rpc.registerSignalHandler(s.SIGNAL_TYPE.pcmAudioNewFrame(this._index),this._onNewFrame.bind(this)).registerSignalHandler(s.SIGNAL_TYPE.pcmAudioTogglePause(this._index),this._onTogglePause.bind(this)),this},i.prototype.start=function(){return n.__awaiter(this,void 0,void 0,function(){var e;return n.__generator(this,function(t){switch(t.label){case 0:return this._enabled?[2]:[4,this._rpc.rpc(s.RPC_TYPE.getPCMAudioParameters(this._index))];case 1:return e=t.sent(),this._sampleRate=e.sampleRate,this._frameSize=e.frameSize,this._paused=e.paused,this._enabled=!0,[2]}})})},i.prototype.stop=function(){this._enabled=!1},i.prototype.isPaused=function(){return this._paused},i.prototype.getSampleRate=function(){return this._sampleRate},i.prototype.getFrameSize=function(){return this._frameSize},i._onReleaseFragment=function(t,e){e._frameMap.has(t)&&e._rpc.signal(e._signalReturnFrame,{id:e._frameMap.get(t),buffer:t.buffer},[t.buffer])},i.prototype._onNewFrame=function(t){if(this._enabled){var e=this._framePool.get(),i=new Float32Array(t.buffer);e.adopt(i),this._frameMap.set(i,t.id),this.newFrame.dispatch(e)}},i.prototype._onTogglePause=function(t){t.paused!==this._paused&&(this._paused=t.paused,this.togglePause.dispatch(this._paused))},i}();i.default=a},{"../../../../tools/pool/Pool":19,"./messages":47,"microevent.ts":4,tslib:6}],45:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n=t("tslib"),r=t("microevent.ts"),o=t("./messages"),s=function(){function t(t){this._rpc=t,this.newFrame=new r.Event,this._active=!1,this._width=0,this._height=0,this._ids=null}return t.prototype.init=function(){this._rpc.registerSignalHandler(o.SIGNAL_TYPE.videoNewFrame,this._onNewFrame.bind(this))},t.prototype.start=function(){return n.__awaiter(this,void 0,void 0,function(){var e;return n.__generator(this,function(t){switch(t.label){case 0:return this._active&&this.stop(),[4,this._rpc.rpc(o.RPC_TYPE.getVideoParameters)];case 1:return e=t.sent(),this._active=!0,this._width=e.width,this._height=e.height,this._ids=new Set,[2]}})})},t.prototype.stop=function(){this._active=!1,this._ids=null},t.prototype.getWidth=function(){return this._width},t.prototype.getHeight=function(){return this._height},t.prototype._onNewFrame=function(t){var e=this;if(this._active)if(this._width===t.width&&this._height===t.height){this._ids.add(t.id);var i=new ImageData(new Uint8ClampedArray(t.buffer),t.width,t.height);this.newFrame.dispatch({get:function(){return i},release:function(){e._active&&e._ids.has(t.id)&&e._rpc.signal(o.SIGNAL_TYPE.videoReturnSurface,{id:t.id,buffer:t.buffer},[t.buffer])},dispose:function(){},adopt:function(){throw new Error("adopt is not implemented")}})}else console.warn("surface dimensions do not match; ignoring frame");else console.warn("video proxy deactivated: ignoring frame")},t}();i.default=s},{"./messages":47,"microevent.ts":4,tslib:6}],46:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n=t("tslib"),r=t("microevent.ts"),o=t("../../../../machine/stella/tia/ToneGenerator"),s=t("./messages"),a=function(){function t(t,e){this._index=t,this._rpc=e,this.bufferChanged=new r.Event,this.volumeChanged=new r.Event,this.stop=new r.Event,this._toneGenerator=new o.default,this._volume=0}return t.prototype.init=function(){return this._rpc.registerSignalHandler(s.SIGNAL_TYPE.waveformAudioBufferChange,this._onBufferChangeSignal.bind(this)).registerSignalHandler(s.SIGNAL_TYPE.waveformAudioVolumeChange,this._onVolumeChangeSignal.bind(this)).registerSignalHandler(s.SIGNAL_TYPE.audioStop,this._onStopSignal.bind(this)),this},t.prototype.start=function(i){return n.__awaiter(this,void 0,void 0,function(){var e;return n.__generator(this,function(t){switch(t.label){case 0:return[4,this._rpc.rpc(s.RPC_TYPE.getWaveformAudioParameters(this._index))];case 1:return e=t.sent(),this._toneGenerator.setConfig(i),this.setVolume(e.volume),[2]}})})},t.prototype.setVolume=function(t){return this._volume=t,this},t.prototype.getVolume=function(){return this._volume},t.prototype.getBuffer=function(t){return this._toneGenerator.getBuffer(t)},t.prototype._onVolumeChangeSignal=function(t){t.index===this._index&&(this._volume=t.value,this.volumeChanged.dispatch(this._volume))},t.prototype._onBufferChangeSignal=function(t){t.index===this._index&&this.bufferChanged.dispatch(t.key)},t.prototype._onStopSignal=function(t){t===this._index&&this.stop.dispatch(void 0)},t}();i.default=a},{"../../../../machine/stella/tia/ToneGenerator":15,"./messages":47,"microevent.ts":4,tslib:6}],47:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.RPC_TYPE={emulationPause:"emulation/pause",emulationReset:"emulation/reset",emulationResume:"emulation/resume",emulationSetRateLimit:"emulation/setRateLimit",emulationStart:"emulation/start",emulationStop:"emulation/stop",emulationFetchLastError:"emulation/fetchLastError",getVideoParameters:"video/getParameters",getWaveformAudioParameters:function(t){return"audio/waveform/getParameters/"+t},getPCMAudioParameters:function(t){return"audio/pcm/getParameters/"+t},setup:"/setup"},Object.freeze(i.RPC_TYPE),i.SIGNAL_TYPE={emulationError:"emulation/error",emulationFrequencyUpdate:"emulation/frequencyUpdate",videoNewFrame:"video/newFrame",videoReturnSurface:"video/returnSurface",controlStateUpdate:"control/stateUpdate",waveformAudioVolumeChange:"audio/waveform/volumeChange",waveformAudioBufferChange:"audio/waveform/bufferChange",pcmAudioNewFrame:function(t){return"audio/pcm/newFrame/"+t},pcmAudioTogglePause:function(t){return"audio/pcm/togglePause/"+t},pcmAudioReturnFrame:function(t){return"audio/pcm/returnFrame/"+t},audioStop:"audio/stop"},Object.freeze(i.SIGNAL_TYPE)},{}]},{},[34])(34)});
//# sourceMappingURL=stellerator_embedded.min.js.map
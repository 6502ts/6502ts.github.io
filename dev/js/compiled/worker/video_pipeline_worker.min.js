
/*
 *   This file is part of 6502.ts, an emulator for 6502 based systems built
 *   in Typescript.
 *
 *   Copyright (C) 2014 - 2018 Christian Speckner & contributors
 *
 *   This program is free software; you can redistribute it and/or modify
 *   it under the terms of the GNU General Public License as published by
 *   the Free Software Foundation; either version 2 of the License, or
 *   (at your option) any later version.
 *
 *   This program is distributed in the hope that it will be useful,
 *   but WITHOUT ANY WARRANTY; without even the implied warranty of
 *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *   GNU General Public License for more details.
 *
 *   Please go to the project's github page at
 *
 *   https://github.com/6502ts/6502.ts
 *
 *   for more details and for a copy of the GNU General Public License v2.
 */

!function s(o,a,c){function u(t,e){if(!a[t]){if(!o[t]){var r="function"==typeof require&&require;if(!e&&r)return r(t,!0);if(p)return p(t,!0);var n=new Error("Cannot find module '"+t+"'");throw n.code="MODULE_NOT_FOUND",n}var i=a[t]={exports:{}};o[t][0].call(i.exports,function(e){return u(o[t][1][e]||e)},i,i.exports,s,o,a,c)}return a[t].exports}for(var p="function"==typeof require&&require,e=0;e<c.length;e++)u(c[e]);return u}({1:[function(e,t,r){"use strict";var n=[];function i(e){return n[e]||(n[e]=function(e){for(var t="return function dispatcher"+e+"(payload) {\n",r=[],n=[],i=0;i<e;i++)r.push("cb"+i),n.push("ctx"+i),t+="    cb"+i+"(payload, ctx"+i+");\n";return t+="};",new(Function.bind.apply(Function,[void 0].concat(r.concat(n),[t])))}(e)),n[e]}n[0]=function(){return function(){}},n[1]=function(t,r){return void 0===r?t:function(e){t(e,r)}};var s=function(){function e(){this.hasHandlers=!1,this._handlers=[],this._contexts=[],this._createDispatcher()}return e.prototype.addHandler=function(e,t){return this.isHandlerAttached(e,t)||(this._handlers.push(e),this._contexts.push(t),this._createDispatcher(),this._updateHasHandlers()),this},e.prototype.removeHandler=function(e,t){var r=this._getHandlerIndex(e,t);return void 0!==r&&(this._handlers.splice(r,1),this._contexts.splice(r,1),this._createDispatcher(),this._updateHasHandlers()),this},e.prototype.isHandlerAttached=function(e,t){return void 0!==this._getHandlerIndex(e,t)},e.prototype._updateHasHandlers=function(){this.hasHandlers=!!this._handlers.length},e.prototype._getHandlerIndex=function(e,t){var r,n=this._handlers.length;for(r=0;r<n&&(this._handlers[r]!==e||this._contexts[r]!==t);r++);return r<n?r:void 0},e.prototype._createDispatcher=function(){this.dispatch=i(this._handlers.length).apply(this,this._handlers.concat(this._contexts))},e}();Object.defineProperty(r,"__esModule",{value:!0}),r.default=s},{}],2:[function(e,t,r){"use strict";var n=e("./Event");r.Event=n.default},{"./Event":1}],3:[function(e,t,r){"use strict";var n,i=e("microevent.ts"),o="resolve_transaction",a="reject_transaction",c="error";!function(e){var t;(t=e.MessageType||(e.MessageType={}))[t.signal=0]="signal",t[t.rpc=1]="rpc",t[t.internal=2]="internal";e.MessageType}((n=function(){function s(e,t){void 0===t&&(t=0),this._dispatch=e,this._rpcTimeout=t,this.error=new i.Event,this._rpcHandlers={},this._signalHandlers={},this._pendingTransactions={},this._nextTransactionId=0}return s.prototype.dispatch=function(e){var t=e;switch(t.type){case s.MessageType.signal:return this._handleSignal(t);case s.MessageType.rpc:return this._handeRpc(t);case s.MessageType.internal:return this._handleInternal(t);default:this._raiseError("invalid message type "+t.type)}},s.prototype.rpc=function(e,t,r){var n=this,i=this._nextTransactionId++;return this._dispatch({type:s.MessageType.rpc,transactionId:i,id:e,payload:t},r||void 0),new Promise(function(e,t){var r=n._pendingTransactions[i]={id:i,resolve:e,reject:t};0<n._rpcTimeout&&(n._pendingTransactions[i].timeoutHandle=setTimeout(function(){return n._transactionTimeout(r)},n._rpcTimeout))})},s.prototype.signal=function(e,t,r){return this._dispatch({type:s.MessageType.signal,id:e,payload:t},r||void 0),this},s.prototype.registerRpcHandler=function(e,t){if(this._rpcHandlers[e])throw new Error("rpc handler for "+e+" already registered");return this._rpcHandlers[e]=t,this},s.prototype.registerSignalHandler=function(e,t){return this._signalHandlers[e]||(this._signalHandlers[e]=[]),this._signalHandlers[e].push(t),this},s.prototype.deregisterRpcHandler=function(e,t){return this._rpcHandlers[e]&&delete this._rpcHandlers[e],this},s.prototype.deregisterSignalHandler=function(e,t){return this._signalHandlers[e]&&(this._signalHandlers[e]=this._signalHandlers[e].filter(function(e){return t!==e})),this},s.prototype._raiseError=function(e){this.error.dispatch(new Error(e)),this._dispatch({type:s.MessageType.internal,id:c,payload:e})},s.prototype._handleSignal=function(t){if(!this._signalHandlers[t.id])return this._raiseError("invalid signal "+t.id);this._signalHandlers[t.id].forEach(function(e){return e(t.payload)})},s.prototype._handeRpc=function(t){var r=this;if(!this._rpcHandlers[t.id])return this._raiseError("invalid rpc "+t.id);Promise.resolve(this._rpcHandlers[t.id](t.payload)).then(function(e){return r._dispatch({type:s.MessageType.internal,id:o,transactionId:t.transactionId,payload:e})},function(e){return r._dispatch({type:s.MessageType.internal,id:a,transactionId:t.transactionId,payload:e})})},s.prototype._handleInternal=function(e){switch(e.id){case o:if(!this._pendingTransactions[e.transactionId])return this._raiseError("no pending transaction with id "+e.transactionId);this._pendingTransactions[e.transactionId].resolve(e.payload),this._clearTransaction(this._pendingTransactions[e.transactionId]);break;case a:if(!this._pendingTransactions[e.transactionId])return this._raiseError("no pending transaction with id "+e.transactionId);this._pendingTransactions[e.transactionId].reject(e.payload),this._clearTransaction(this._pendingTransactions[e.transactionId]);break;case c:this.error.dispatch(new Error("remote error: "+e.payload));break;default:this._raiseError("unhandled internal message "+e.id)}},s.prototype._transactionTimeout=function(e){e.reject("transaction timed out"),this._raiseError("transaction "+e.id+" timed out"),delete this._pendingTransactions[e.id]},s.prototype._clearTransaction=function(e){void 0!==e.timeoutHandle&&clearTimeout(e.timeoutHandle),delete this._pendingTransactions[e.id]},s}())||(n={})),Object.defineProperty(r,"__esModule",{value:!0}),r.default=n},{"microevent.ts":2}],4:[function(e,t,r){"use strict";var n=e("./RpcProvider");r.RpcProvider=n.default},{"./RpcProvider":3}],5:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n=e("microevent.ts"),i=e("./PoolMember"),s=function(){function e(e){this._factory=e,this.event={release:new n.Event,dispose:new n.Event},this._pool=[],this._poolSize=0}return e.prototype.get=function(){var e,t=this;if(0===this._poolSize){var r=this._factory();e=new i.default(r,function(e){return t._releaseMember(e)},function(e){return t._disposeMember(e)})}else(e=this._pool[--this._poolSize])._isAvailable=!1;return e},e.prototype._releaseMember=function(e){if(e._isAvailable)throw new Error("Trying to release an already released pool member");if(e._isDisposed)throw new Error("Trying to release an already disposed pool member");var t=this._poolSize++;(this._pool[t]=e)._isAvailable=!0,e._poolPosition=t,this.event.release.dispatch(e.get())},e.prototype._disposeMember=function(e){if(e._isDisposed)throw new Error("Trying to dispose of an already disposed pool member");e._isAvailable&&(1<this._poolSize&&(this._pool[e._poolPosition]=this._pool[this._poolSize-1]),this._poolSize--),e._isDisposed=!0,this.event.dispose.dispatch(e.get())},e}();r.default=s},{"./PoolMember":6,"microevent.ts":2}],6:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t,r){this._value=e,this._releaseCB=t,this._disposeCB=r,this._isAvailable=!1,this._isDisposed=!1}return e.prototype.adopt=function(e){this._value=e},e.prototype.get=function(){return this._value},e.prototype.release=function(){this._releaseCB(this)},e.prototype.dispose=function(){this._disposeCB(this)},e}();r.default=n},{}],7:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n=e("microevent.ts"),i=function(){function e(){this.emit=new n.Event,this._framesOnHold=new Array(2),this._nFramesOnHold=0,this._width=0,this._height=0}return e.prototype.init=function(e,t){this.flush(),this._width=e,this._height=t},e.prototype.flush=function(){for(var e=0;e<this._nFramesOnHold;e++)this._framesOnHold[e].release(),this._framesOnHold[e]=null;this._nFramesOnHold=0},e.prototype.processSurface=function(e){var t=e.get();if(t.getHeight()!==this._height||t.getWidth()!==this._width)throw new Error("surface dimensions do not match");this._framesOnHold[this._nFramesOnHold++]=e,2===this._nFramesOnHold&&this._process()},e.prototype._process=function(){for(var e=this._framesOnHold[0].get().getBuffer(),t=this._framesOnHold[1].get().getBuffer(),r=0;r<this._width*this._height;r++)e[r]=4278190080|(16711680&e[r])+(16711680&t[r])>>>1&16711680|(65280&e[r])+(65280&t[r])>>>1&65280|(255&e[r])+(255&t[r])>>>1&255;this.emit.dispatch(this._framesOnHold[0]),this._framesOnHold[1].release(),this._nFramesOnHold=0},e}();r.default=i},{"microevent.ts":2}],8:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n=e("microevent.ts"),i=function(){function e(){this.emit=new n.Event}return e.prototype.init=function(){},e.prototype.flush=function(){},e.prototype.processSurface=function(e){this.emit.dispatch(e)},e}();r.default=i},{"microevent.ts":2}],9:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n=e("./PassthroughProcessor"),i=e("./FrameMergeProcessor"),s=function(){function e(){}return e.prototype.create=function(e){switch(e.type){case 0:return new n.default;case 1:return new i.default;default:throw new Error("cannot happen: invalid processor type")}},e}();r.default=s},{"./FrameMergeProcessor":7,"./PassthroughProcessor":8}],10:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var o=e("./ProcessorFactory"),n=function(){function e(e){var r=this;e&&0!==e.length||(e=[{type:0}]);var t=new o.default;this._processors=e.map(function(e){return t.create(e)});for(var n=function(t){i._processors[t-1].emit.addHandler(function(e){return r._processors[t].processSurface(e)})},i=this,s=1;s<this._processors.length;s++)n(s);this.emit=this._processors[this._processors.length-1].emit}return e.prototype.init=function(t,r){this._processors.forEach(function(e){return e.init(t,r)})},e.prototype.flush=function(){this._processors.forEach(function(e){return e.flush()})},e.prototype.processSurface=function(e){this._processors[0].processSurface(e)},e}();r.default=n},{"./ProcessorFactory":9}],11:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n=e("../../surface/ArrayBufferSurface"),i=e("../../../tools/pool/Pool"),s=e("./messages"),o=e("../ProcessorPipeline"),a=function(){function t(e){this._rpc=e,this._pipeline=null,this._surfacePool=new i.default(function(){return new n.default}),this._bufferIds=new WeakMap,this._rpc.registerRpcHandler(s.messageIds.configure,this._onConfigure.bind(this)).registerRpcHandler(s.messageIds.flush,this._onFlush.bind(this)).registerSignalHandler(s.messageIds.process,this._onProcess.bind(this)),this._surfacePool.event.release.addHandler(t._onReleaseSurface,this)}return t._onReleaseSurface=function(e,t){var r=e.getUnderlyingBuffer();if(r){if(!t._bufferIds.has(r))throw new Error("double release");var n=t._bufferIds.get(r);t._bufferIds.delete(r),t._rpc.signal(s.messageIds.release,{id:n,buffer:r},[r])}},t._onEmitSurface=function(e,t){var r=e.get().getUnderlyingBuffer();if(!t._bufferIds.has(r))throw new Error("double release");var n=t._bufferIds.get(r);t._bufferIds.delete(r),t._rpc.signal(s.messageIds.emit,{id:n,buffer:r},[r]),e.get().resetUnderlyingBuffer(),e.release()},t.prototype._onConfigure=function(e){this._pipeline&&(this._pipeline.flush(),this._pipeline.emit.removeHandler(t._onEmitSurface,this)),this._pipeline=new o.default(e.config),this._pipeline.init(e.width,e.height),this._pipeline.emit.addHandler(t._onEmitSurface,this)},t.prototype._onFlush=function(e){this._pipeline&&this._pipeline.flush()},t.prototype._onProcess=function(e){if(this._pipeline){this._bufferIds.set(e.buffer,e.id);var t=this._surfacePool.get();t.get().replaceUnderlyingBuffer(e.width,e.height,e.buffer),this._pipeline.processSurface(t)}},t}();r.default=a},{"../../../tools/pool/Pool":5,"../../surface/ArrayBufferSurface":13,"../ProcessorPipeline":10,"./messages":12}],12:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.messageIds={configure:"pipeline/configure",flush:"pipeline/flush",process:"pipeline/process",emit:"pipeline/emit",release:"pipeline/release"},Object.freeze(r.messageIds)},{}],13:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function n(){this._height=0,this._width=0,this._buffer=null}return n.createFromArrayBuffer=function(e,t,r){return(new n).replaceUnderlyingBuffer(e,t,r)},n.prototype.replaceUnderlyingBuffer=function(e,t,r){if(e*t*4!==r.byteLength)throw new Error("surface size mismatch");return this._width=e,this._height=t,this._underlyingBuffer=r,this._buffer=new Uint32Array(this._underlyingBuffer),this},n.prototype.getUnderlyingBuffer=function(){return this._underlyingBuffer},n.prototype.resetUnderlyingBuffer=function(){return this._width=this._height=0,this._underlyingBuffer=this._buffer=null,this},n.prototype.getWidth=function(){return this._width},n.prototype.getHeight=function(){return this._height},n.prototype.getBuffer=function(){return this._buffer},n.prototype.getByteOrder=function(){return 0},n.prototype.fill=function(e){for(var t=0;t<this._buffer.length;t++)this._buffer[t]=e;return this},n}();r.default=n},{}],14:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n=e("../rpc"),i=e("../../../src/video/processing/worker/PipelineHost");r.pipelineHost=new i.default(n.getRpc())},{"../../../src/video/processing/worker/PipelineHost":11,"../rpc":15}],15:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n=e("worker-rpc"),i=null,s=null,o=null;(i=new n.RpcProvider(function(e,t){s?s.postMessage(e,t):postMessage(e,t),o&&((s=o).onmessage=function(e){return i.dispatch(e.data)}),o=null})).error.addHandler(function(e){console.log(e?e.message:"unknown rpc error")}),onmessage=function(e){return s||i.dispatch(e.data)},i.registerRpcHandler("/use-port",function(e){return s||o?Promise.reject("RPC already switched to message port"):(o=e,Promise.resolve())}),r.getRpc=function(){return i}},{"worker-rpc":4}]},{},[14]);
//# sourceMappingURL=video_pipeline_worker.min.js.map